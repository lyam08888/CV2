<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Créateur de CV IA - Pro Recruteur</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&family=Montserrat:wght@400;500;700;800&family=Playfair+Display:ital,wght@0,400..900;1,400..900&family=Roboto+Mono:wght@400;700&family=Merriweather:wght@400;700&family=Oswald:wght@400;700&family=Cormorant+Garamond:wght@400;700&family=Open+Sans:wght@400;700&family=Source+Sans+Pro:wght@400;700&family=Nunito+Sans:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    
    <style>
        /* RESET COMPLET */
        * {
            box-sizing: border-box !important;
        }
        
        html, body {
            margin: 0 !important;
            padding: 0 !important;
            height: 100% !important;
            overflow: hidden !important;
        }
        
        /* LAYOUT PRINCIPAL - TOUJOURS CÔTE À CÔTE */
        .app-container {
            display: flex !important;
            height: 100vh !important;
            width: 100vw !important;
            overflow: hidden !important;
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            z-index: 1 !important;
        }
        
        /* PANNEAU DE CONTRÔLES REDIMENSIONNABLE */
        .controls-panel {
            min-width: 280px !important;
            max-width: 350px !important;
            width: 320px !important;
            height: 100vh !important;
            background: white !important;
            border-right: 2px solid #e5e7eb !important;
            overflow-y: auto !important;
            overflow-x: hidden !important;
            resize: horizontal !important;
            position: relative !important;
            display: flex !important;
            flex-direction: column !important;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1) !important;
            z-index: 10 !important;
            flex-shrink: 0 !important;
        }

        /* Contenu du panneau de contrôles */
        .controls-panel > div {
            padding: 1rem !important;
            flex: 1 !important;
            overflow-y: auto !important;
            overflow-x: hidden !important;
            box-sizing: border-box !important;
        }

        /* Assurer que tous les éléments restent dans le panneau */
        .controls-panel * {
            box-sizing: border-box !important;
            max-width: 100% !important;
        }

        /* Empêcher le débordement horizontal sur tous les éléments de contenu */
        .controls-panel .control-group-content *,
        .controls-panel details *,
        .controls-panel .bg-gray-50 *,
        .controls-panel .bg-orange-50 *,
        .controls-panel .bg-purple-50 *,
        .controls-panel .bg-red-50 *,
        .controls-panel .bg-green-50 * {
            word-wrap: break-word !important;
            overflow-wrap: break-word !important;
            max-width: 100% !important;
            box-sizing: border-box !important;
        }

        /* Forcer les grilles à se comporter en colonnes sur les petits écrans */
        .controls-panel .grid {
            display: flex !important;
            flex-direction: column !important;
            gap: 0.5rem !important;
        }

        /* Boutons et inputs - largeur complète dans le panneau */
        .controls-panel input,
        .controls-panel select,
        .controls-panel button,
        .controls-panel textarea {
            width: 100% !important;
            max-width: 100% !important;
            box-sizing: border-box !important;
        }

        /* STRICT: Empêcher TOUT débordement horizontal */
        .controls-panel,
        .controls-panel > *,
        .controls-panel .control-group-content,
        .controls-panel details,
        .controls-panel summary {
            overflow-x: hidden !important;
            max-width: 320px !important;
            word-break: break-word !important;
        }

        /* Forcer les flex en colonne dans le panneau */
        .controls-panel .flex:not(.zoom-controls) {
            flex-direction: column !important;
            align-items: stretch !important;
        }

        /* Espacements compacts pour éviter débordement */
        .controls-panel .gap-2 { gap: 0.25rem !important; }
        .controls-panel .gap-3 { gap: 0.5rem !important; }
        .controls-panel .gap-4 { gap: 0.75rem !important; }

        /* Textes longs - coupure forcée */
        .controls-panel p,
        .controls-panel span,
        .controls-panel label {
            word-break: break-word !important;
            hyphens: auto !important;
        }

        /* Onglets - ajustement pour éviter le débordement */
        #tab-navigation {
            flex-wrap: wrap !important;
            max-width: 100% !important;
            overflow: hidden !important;
        }

        /* Boutons d'onglets plus compacts */
        #tab-navigation .tab-button {
            font-size: 0.75rem !important;
            padding: 0.5rem 0.75rem !important;
            white-space: nowrap !important;
            max-width: 100px !important;
            overflow: hidden !important;
            text-overflow: ellipsis !important;
        }

        /* Groupes de contrôles - espacement réduit */
        .control-group {
            margin-bottom: 12px !important;
            border: 1px solid #e5e7eb !important;
            border-radius: 8px !important;
            overflow: hidden !important;
            max-width: 100% !important;
        }

        .control-group-content {
            padding: 12px !important;
            background-color: white !important;
            max-width: 100% !important;
            overflow-x: hidden !important;
        }

        /* Summary compacts */
        .control-group summary {
            padding: 8px 12px !important;
            font-size: 0.875rem !important;
            font-weight: 600 !important;
            cursor: pointer !important;
            background: #f8f9fa !important;
            border-bottom: 1px solid #e5e7eb !important;
            max-width: 100% !important;
            overflow: hidden !important;
            text-overflow: ellipsis !important;
        }

        .tab-btn {
            flex-shrink: 1 !important;
            min-width: 0 !important;
            white-space: nowrap !important;
            overflow: hidden !important;
            text-overflow: ellipsis !important;
            max-width: 120px !important;
        }

        /* Groupes de contrôles */
        .control-group {
            margin-bottom: 1rem !important;
            max-width: 100% !important;
        }

        .control-group-content {
            max-width: 100% !important;
            overflow: hidden !important;
        }

        /* Inputs et éléments de formulaire */
        .cv-input, .banner-input, .custom-section-input {
            max-width: 100% !important;
            box-sizing: border-box !important;
        }

        /* Grilles et flexbox */
        .grid {
            max-width: 100% !important;
        }

        .flex {
            max-width: 100% !important;
            flex-wrap: wrap !important;
        }
        
        /* POIGNÉE DE REDIMENSIONNEMENT */
        .resize-handle {
            position: absolute !important;
            right: -5px !important;
            top: 0 !important;
            bottom: 0 !important;
            width: 10px !important;
            cursor: ew-resize !important;
            background: linear-gradient(90deg, transparent, #3b82f6, transparent) !important;
            opacity: 0 !important;
            transition: opacity 0.2s !important;
            z-index: 1000 !important;
        }
        
        .controls-panel:hover .resize-handle {
            opacity: 1 !important;
        }
        
        /* PANNEAU D'APERÇU AVEC ZOOM */
        .preview-panel {
            flex: 1 !important;
            height: 100vh !important;
            background: #f3f4f6 !important;
            overflow: hidden !important;
            position: relative !important;
            display: flex !important;
            flex-direction: column !important;
        }
        
        /* CONTRÔLES DE ZOOM */
        .zoom-controls {
            position: absolute !important;
            top: 20px !important;
            right: 20px !important;
            z-index: 100 !important;
            background: white !important;
            border-radius: 8px !important;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important;
            padding: 8px !important;
            display: flex !important;
            gap: 8px !important;
            align-items: center !important;
        }
        
        .zoom-btn {
            width: 36px !important;
            height: 36px !important;
            border: none !important;
            background: #3b82f6 !important;
            color: white !important;
            border-radius: 6px !important;
            cursor: pointer !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            font-size: 18px !important;
            transition: background 0.2s !important;
        }
        
        .zoom-btn:hover {
            background: #2563eb !important;
        }
        
        .zoom-level {
            font-size: 14px !important;
            font-weight: 600 !important;
            color: #374151 !important;
            min-width: 50px !important;
            text-align: center !important;
        }
        
        /* CONTENEUR D'APERÇU ZOOMABLE */
        .preview-container {
            flex: 1 !important;
            overflow: auto !important;
            padding: 20px !important;
            display: flex !important;
            justify-content: center !important;
            align-items: flex-start !important;
        }
        
        .cv-preview-wrapper {
            transform-origin: top center !important;
            transition: transform 0.3s ease !important;
        }
        
        /* ZOOM LEVELS */
        .zoom-50 { transform: scale(0.5) !important; }
        .zoom-75 { transform: scale(0.75) !important; }
        .zoom-100 { transform: scale(1) !important; }
        .zoom-125 { transform: scale(1.25) !important; }
        .zoom-150 { transform: scale(1.5) !important; }
        .zoom-200 { transform: scale(2) !important; }
        
        /* RESPONSIVE - GARDE LE LAYOUT CÔTE À CÔTE */
        @media (max-width: 768px) {
            .controls-panel {
                min-width: 250px !important;
                width: 300px !important;
            }
        }
        
        :root {
            --page-margin: 2cm;
            --primary-color: #2563eb;
            --secondary-color: #334155;
            --body-text-color: #334155;
            --font-family-h1: 'Montserrat', sans-serif;
            --font-family-h2: 'Montserrat', sans-serif;
            --font-family-body: 'Lato', sans-serif;
            --font-size-h1: 40pt;
            --font-size-h2: 21pt;
            --font-size-p: 10pt;
            --font-size-banner: 9pt;
            --line-height: 1.6;
            --paragraph-spacing: 0.5rem;
            --module-spacing: 1.5rem;
            --item-spacing: 0.5rem;
            --banner-element-spacing: 1rem;
        }

        #cv-preview-wrapper { width: 100%; display: flex; flex-direction: column; align-items: center; gap: 20px; }
        .a4-page-container { position: relative; }
        /* CORRECTIF : Remplacement de min-height par height pour une détection de dépassement fiable */
        .a4-page { width: 21cm; height: 29.7cm; box-shadow: 0 10px 30px rgba(0,0,0,0.15); background-color: white; overflow: hidden; display: flex; flex-direction: column; transition: all 0.3s ease; font-family: var(--font-family-body); color: var(--body-text-color); position: relative; outline: 2px solid transparent; outline-offset: -2px; padding: var(--page-margin); box-sizing: border-box; }
        body.overflow-check-active .is-overflowing { outline: 3px solid #ef4444 !important; box-shadow: 0 0 20px 8px rgba(239, 68, 68, 0.3) !important; }
        
        .remove-page-btn { position: absolute; top: -10px; right: -10px; width: 30px; height: 30px; background-color: #ef4444; color: white; border: none; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; opacity: 0.5; transition: opacity 0.2s, transform 0.2s; z-index: 10; }
        .remove-page-btn:hover { opacity: 1; transform: scale(1.1); }
        .a4-page-container:first-child .remove-page-btn { display: none; }

        #add-page-btn-wrapper { width: 21cm; text-align: center; padding: 10px 0; }
        #add-page-btn { width: 50px; height: 50px; background-color: #3b82f6; color: white; border-radius: 50%; border: none; cursor: pointer; font-size: 24px; transition: transform 0.2s; }
        #add-page-btn:hover { transform: scale(1.1); }

        .cv-body-container { display: grid; gap: 1rem; height: 100%; flex-grow: 1; position: relative; }
        .layout-1-col { grid-template-columns: 1fr; }
        .layout-2-col-33-67 { grid-template-columns: 1fr 2fr; }
        .layout-2-col-50-50 { grid-template-columns: 1fr 1fr; }
        .layout-2-col-67-33 { grid-template-columns: 2fr 1fr; }

        .cv-column { min-height: 150px; height: 100%; border: 1px dotted #ccc; padding: 5px; }
        .cv-module { position: relative; margin-bottom: var(--module-spacing); }
        .cv-module .drag-handle { position: absolute; top: 10px; left: -25px; cursor: grab; color: #d1d5db; opacity: 0; transition: opacity 0.2s; font-size: 1.2rem; }
        .cv-module:hover .drag-handle { opacity: 1; }
        .sortable-ghost { opacity: 0.4; background: #cce7ff; border: 1px dashed var(--primary-color); }

        [contenteditable="true"]:hover { outline: 1px dashed #3b82f6; background-color: #eff6ff; }
        [contenteditable="true"]:focus { outline: 2px solid #3b82f6; background-color: #dbeafe; }

        .cv-header h1 { font-family: var(--font-family-h1); font-weight: 800; font-size: var(--font-size-h1); color: var(--primary-color); margin-bottom: 0.25rem; }
        .cv-header p { font-family: var(--font-family-body); font-size: 1.2rem; color: var(--secondary-color); }
        .section-title { font-family: var(--font-family-h2); font-weight: 700; font-size: var(--font-size-h2); margin-bottom: 0.8rem; padding-bottom: 0.4rem; color: var(--primary-color); display: flex; align-items: center; gap: 0.5rem; transition: opacity 0.3s; }
        .section-title.style-underline { border-bottom: 2px solid var(--primary-color); }
        .section-title.style-side-line { border-left: 4px solid var(--primary-color); border-bottom: none; padding-left: 0.5rem; }
        .section-title.style-background { background-color: var(--primary-color); color: white; padding: 0.3rem 0.6rem; margin-bottom: 1rem; border-radius: 0.25rem; }
        .section-title.style-background .section-icon { color: white !important; }
        .section-title.style-boxed { border: 2px solid var(--primary-color); padding: 0.3rem 0.6rem; }

        .section-title .section-icon { cursor: pointer; transition: transform 0.2s; }
        .section-title .section-icon:hover { transform: scale(1.1); }
        .a4-page p, .a4-page li, #cv-description-preview, #cv-experience-preview, #cv-formation-preview { font-size: var(--font-size-p); line-height: var(--line-height); }
        .a4-page p { margin-bottom: var(--paragraph-spacing); }
        .a4-page ul { list-style: none; padding-left: 0;}
        #cv-competences-preview[data-style="simple"] ul li,
        .a4-page ul li { padding-left: 1.4em; position: relative; margin-bottom: 0.25rem; }
        #cv-competences-preview[data-style="simple"] ul li::before,
        .a4-page ul li::before { content: '›'; font-weight: bold; position: absolute; left: 0; color: var(--primary-color); font-size: 1.2em; top: -0.1em; }
        
        .item-title { font-weight: 700; color: var(--secondary-color); }
        .item-meta { font-size: calc(var(--font-size-p) * 0.9); font-style: italic; }

        #recruiter-banner { display: flex; align-items: center; padding: 0.5rem; box-sizing: border-box; width: 100%; font-size: var(--font-size-banner); position: relative; overflow: hidden; }
        .banner-content-wrapper { position: relative; z-index: 1; display: flex; align-items: center; width: 100%; height: 100%; gap: var(--banner-element-spacing); }
        #banner-bg-img-preview { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: 0; transition: opacity 0.3s, filter 0.3s; }
        #fixed-banner-top { margin-bottom: var(--module-spacing); display: none; }
        #fixed-banner-bottom { margin-top: auto; padding-top: var(--module-spacing); display: none; }
        #banner-img-preview { border-radius: 50%; object-fit: cover; flex-shrink: 0; transition: width 0.3s, height 0.3s; background-color: rgba(255,255,255,0.5); }
        #banner-img-preview.logo-sm { width: 40px; height: 40px; }
        #banner-img-preview.logo-md { width: 60px; height: 60px; }
        #banner-img-preview.logo-lg { width: 80px; height: 80px; }
        #banner-img-preview.logo-xl { width: 100px; height: 100px; }
        #banner-img-preview.logo-xxl { width: 120px; height: 120px; }
        #banner-nom-preview { font-weight: 700; }
        .banner-align-left { justify-content: flex-start; text-align: left; }
        .banner-align-center { justify-content: center; text-align: center; }
        .banner-align-right { justify-content: flex-end; text-align: right; }
        .banner-layout-inverted { flex-direction: row-reverse; }
        .banner-style-elegant { border-top: 2px solid var(--primary-color); border-bottom: 2px solid var(--primary-color); background: transparent; }
        .banner-style-modern { background-color: var(--primary-color); color: white; border-radius: 0.5rem; }
        .banner-style-modern p, .banner-style-modern span { color: white !important; }
        .banner-style-discret { border-left: 4px solid #d1d5db; background: transparent; }
        .banner-style-carte { box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); border-radius: 0.5rem; background: #f9fafb; }
        .banner-style-degrade { background: linear-gradient(to right, var(--primary-color), #a5b4fc); color: white; border-radius: 0.5rem; }
        .banner-style-degrade p, .banner-style-degrade span { color: white !important; }
        .banner-style-premium { background-color: #1e293b; color: #fde68a; border: 1px solid #fde68a; border-radius: 0.25rem; }
        .banner-style-premium p, .banner-style-premium span { color: #f1f5f9 !important; }
        .banner-style-minimal { border-bottom: 2px solid var(--primary-color); }
        .banner-style-encadre { border: 2px solid var(--primary-color); border-radius: 0.5rem; }
        .banner-style-ligne-haute { border-top: 4px solid var(--primary-color); padding-top: 0.8rem !important; }

        #notification { position: fixed; top: 20px; right: 20px; z-index: 10000; }
        .toast { background-color: white; color: #111827; padding: 1rem 1.5rem; border-radius: 0.5rem; box-shadow: 0 5px 15px rgba(0,0,0,0.1); display: flex; align-items: center; gap: 0.75rem; transition: all 0.3s ease; transform: translateX(120%); }
        .toast.show { transform: translateX(0); }

        /* Styles for collapsible control panel sections */
        details.control-group {
            background-color: #f9fafb;
            border: 1px solid #f3f4f6;
            border-radius: 0.5rem;
            transition: background-color 0.2s;
        }
        details.control-group[open] {
            background-color: white;
            border-color: #e5e7eb;
        }
        details.control-group summary {
            list-style: none;
            cursor: pointer;
            padding: 1rem;
            font-weight: 600;
            color: #374151;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        details.control-group summary::-webkit-details-marker {
            display: none;
        }
        details.control-group .control-group-content {
            padding: 0 1rem 1rem 1rem;
            border-top: 1px solid #f3f4f6;
            margin-top: -0.5rem;
            padding-top: 1rem;
        }
        .completion-label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.75rem;
            font-weight: 400;
            color: #6b7280;
            cursor: pointer;
        }

        /* Styles pour les sélecteurs d'API améliorés */
        .api-selector {
            cursor: pointer;
            transition: all 0.3s ease;
            transform: scale(1);
        }
        .api-selector:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .api-selector.active {
            transform: scale(1.01);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }
        .api-selector .status-indicator {
            transition: all 0.3s ease;
        }
        .api-selector .selection-indicator {
            transition: all 0.3s ease;
        }
        
        /* 🎯 NOUVEAUX STYLES POUR LE SÉLECTEUR D'API UNIFIÉ */
        .api-selector-card .api-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
        .api-selector-card .api-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }
        
        .api-radio:checked + .api-card {
            border-color: #3b82f6 !important;
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
            box-shadow: 0 4px 20px rgba(59, 130, 246, 0.3);
        }
        
        .api-radio:checked + .api-card .api-status-dot {
            background-color: #10b981 !important;
            animation: pulse 2s infinite;
        }
        
        .api-status-dot.online {
            background-color: #10b981 !important;
        }
        
        .api-status-dot.offline {
            background-color: #ef4444 !important;
        }
        
        .api-status-dot.testing {
            background-color: #f59e0b !important;
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        /* Styles spéciaux pour l'auto-fallback */
        #select-auto-fallback:checked + .api-card {
            border-color: #10b981 !important;
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
            box-shadow: 0 4px 20px rgba(16, 185, 129, 0.3);
        }
        
        /* Fallback settings */
        #fallback-settings {
            transition: all 0.3s ease;
        }
        
        #fallback-settings.hidden {
            opacity: 0;
            max-height: 0;
            overflow: hidden;
            padding: 0;
            margin: 0;
        }
        
        /* Animation pour le statut global */
        #global-api-status {
            transition: all 0.3s ease;
        }
        #active-model-badge {
            transition: all 0.3s ease;
            font-family: 'Roboto Mono', monospace;
        }
        
        /* Style pour les détails de configuration */
        #gemini-config, #openai-config {
            transition: all 0.3s ease;
        }
        
        /* Gradient pour le bouton GPT-5 */
        option[value="gpt-5"] {
            background: linear-gradient(45deg, #fef3c7, #fde68a) !important;
            font-weight: bold !important;
        }
        .completion-checkbox {
            height: 1rem;
            width: 1rem;
            border-radius: 0.25rem;
            border-color: #d1d5db;
            color: #4f46e5;
            cursor: pointer;
        }
        .completion-checkbox:focus {
            outline: 2px solid #4f46e5;
            outline-offset: 2px;
        }
        
        #ai-summarize-btn { position: fixed; bottom: 30px; right: 30px; width: 60px; height: 60px; background-color: #2563eb; color: white; border-radius: 50%; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(0,0,0,0.2); font-size: 24px; z-index: 999; transition: transform 0.2s ease-in-out; }
        #ai-summarize-btn:hover { transform: scale(1.1); }

        /* --- Specific styles for skills section --- */
        #cv-competences-preview h3.skill-category { font-family: var(--font-family-h2); font-weight: 700; color: var(--secondary-color); margin-top: 0.8rem; margin-bottom: 0.4rem; padding-bottom: 0.2rem; border-bottom: 1px solid #e5e7eb; font-size: calc(var(--font-size-p) * 1.05); text-transform: uppercase; letter-spacing: 0.5px; }
        #cv-competences-preview .skill-category:hover { background-color: #f3f4f6; }
        #cv-competences-preview[data-style="tags"] ul { padding-left: 0; list-style: none; margin-top: 0.25rem; margin-bottom: 0.5rem; line-height: 1.5; }
        #cv-competences-preview[data-style="tags"] ul li.skill-item { display: inline-block; margin: 0 8px 6px 0; padding: 3px 20px 3px 10px; border-radius: 12px; background-color: #f3f4f6; font-size: calc(var(--font-size-p) * 0.95); position: relative; cursor: grab; }
        #cv-competences-preview[data-style="tags"] ul li.skill-item:hover { background-color: #e5e7eb; }
        #cv-competences-preview[data-style="tags"] ul li::before { content: none; }
        .skills-ghost { opacity: 0.4; background: #cce7ff; border-radius: 12px; }
        .skill-item .delete-skill-btn { display: none; position: absolute; top: 50%; right: 5px; transform: translateY(-50%); cursor: pointer; font-size: 14px; line-height: 1; color: #9ca3af; padding: 2px; }
        .skill-item:hover .delete-skill-btn { display: inline-block; }
        .skill-item .delete-skill-btn:hover { color: #ef4444; }
        .style-toggle-btn.active, .skill-style-btn.active, .section-title-style-btn.active, .layout-btn.active, .banner-align-btn.active, .logo-size-btn.active, .theme-btn.active, #banner-invert-btn.active, .gauge-style-btn.active, #toggle-overflow-btn.active { background-color: #3b82f6; color: white; }
        .skill-level { display: flex; align-items: center; margin-bottom: 6px; gap: 8px; }
        .skill-level-label { width: 120px; flex-shrink: 0; font-size: var(--font-size-p); }
        
        /* Gauge Styles */
        .gauge-container { flex-grow: 1; }
        .gauge-bar-bg { background-color: #e5e7eb; border-radius: 4px; height: 8px; overflow: hidden;}
        .gauge-bar-fill { background-color: var(--primary-color); height: 100%; border-radius: 4px; transition: width 0.3s ease; }
        .gauge-dots, .gauge-stars, .gauge-squares { display: flex; gap: 4px; font-size: 1.2em; color: #d1d5db; }
        .gauge-dots .filled, .gauge-stars .filled, .gauge-squares .filled { color: var(--primary-color); }
        .gauge-number { font-weight: bold; color: var(--secondary-color); }

        .editable-wrapper { position: relative; }
        .editable-wrapper .delete-line-btn { display: none; position: absolute; top: 50%; right: 2px; transform: translateY(-50%); cursor: pointer; color: #ef4444; background-color: white; border-radius: 50%; width: 18px; height: 18px; text-align: center; line-height: 18px; font-size: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); z-index: 5; }
        .editable-wrapper:hover .delete-line-btn { display: flex; align-items: center; justify-content: center; }
        .history-btn:disabled { opacity: 0.4; cursor: not-allowed; }
        .insert-line-wrapper { position: relative; height: 0.5rem; opacity: 0; transition: opacity 0.2s; margin: 0; display: flex; justify-content: center; align-items: center; }
        .dynamic-item-container:hover .insert-line-wrapper { opacity: 1; }
        .add-line-preview-btn { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: #eef2ff; color: #4f46e5; border: 1px dashed #a5b4fc; width: 24px; height: 24px; border-radius: 50%; cursor: pointer; z-index: 5; display: flex; align-items: center; justify-content: center; font-size: 12px; transition: all 0.2s; }
        .add-line-preview-btn:hover { background: #c7d2fe; border-style: solid; transform: translate(-50%, -50%) scale(1.1); }
        
        .add-desc-line-btn { display: none; font-size: 0.8rem; color: #4f46e5; cursor: pointer; margin-top: 0.25rem; padding: 2px 4px; border-radius: 4px; background: transparent; border: none; }
        .add-desc-line-btn:hover { background-color: #eef2ff; }
        .dynamic-preview-item:hover .add-desc-line-btn { display: inline-block; }

        .dynamic-preview-item { position: relative; border: 1px solid transparent; border-radius: 0.375rem; padding: 0.5rem; margin-bottom: var(--item-spacing); transition: border-color 0.2s, background-color 0.2s, opacity 0.3s; }
        .dynamic-preview-item:hover { background-color: #fafafa; border-color: #e5e7eb; }

        .delete-block-btn { display: none; position: absolute; top: 4px; right: 4px; width: 24px; height: 24px; background-color: #fee2e2; color: #b91c1c; border: none; border-radius: 50%; cursor: pointer; align-items: center; justify-content: center; z-index: 6; }
        .dynamic-preview-item:hover .delete-block-btn { display: flex; }
        .delete-block-btn:hover { background-color: #fecaca; color: #991b1b; }
        .new-badge { background-color: #ef4444; color: white; font-size: 0.6rem; font-weight: bold; padding: 2px 5px; border-radius: 4px; margin-left: 6px; vertical-align: middle; }
        
        /* Modal Styles */
        .modal-overlay { position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.5); display: flex; align-items: center; justify-content: center; z-index: 5000; opacity: 0; transition: opacity 0.2s; pointer-events: none; }
        .modal-overlay.active { opacity: 1; pointer-events: auto; }
        .modal-content { background: white; padding: 2rem; border-radius: 0.5rem; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 90%; max-width: 500px; transform: scale(0.95); transition: transform 0.2s; }
        .modal-overlay.active .modal-content { transform: scale(1); }
        
        /* Icon Picker Modal */
        #icon-picker-modal .modal-content { max-width: 700px; }
        #icon-picker-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(50px, 1fr)); gap: 0.5rem; max-height: 60vh; overflow-y: auto; }
        #icon-picker-grid i { font-size: 1.5rem; padding: 0.75rem; border-radius: 0.25rem; cursor: pointer; text-align: center; transition: background-color 0.2s, color 0.2s; }
        #icon-picker-grid i:hover { background-color: #eef2ff; color: #4f46e5; }
        
        /* In-Preview AI Buttons */
        .section-ai-actions { margin-left: auto; display: flex; gap: 0.5rem; opacity: 0; transition: opacity 0.2s; }
        .cv-module:hover .section-ai-actions { opacity: 1; }
        .ai-action-btn { background: #e0e7ff; color: #4338ca; border: none; border-radius: 50%; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 0.8rem; }
        .ai-action-btn:hover { background: #c7d2fe; }

        /* Styles for hiding sections */
        .cv-module.section-hidden > *:not(h2) {
            display: none;
        }
        .cv-module.section-hidden > h2 {
            opacity: 0.5;
        }

        /* For column resizing */
        .column-resizer {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 10px; /* Wider grab area */
            cursor: col-resize;
            transform: translateX(-50%);
            z-index: 20; /* High z-index */
        }
        .column-resizer::after {
            content: '';
            position: absolute;
            top: 0;
            bottom: 0;
            left: 4px; /* Centered 2px line in a 10px div */
            width: 2px;
            background-color: #d1d5db;
            transition: background-color 0.2s ease;
        }
        .column-resizer:hover::after,
        body.is-resizing .column-resizer::after {
            background-color: #3b82f6;
        }
        body.is-resizing {
            cursor: col-resize;
            user-select: none;
        }

        /* Presentation Mode & Print Styles */
        body.presentation-mode .cv-column {
            border-color: transparent;
        }
        body.presentation-mode .column-resizer,
        body.presentation-mode .drag-handle,
        body.presentation-mode #ai-summarize-btn,
        body.presentation-mode .remove-page-btn,
        body.presentation-mode #add-page-btn-wrapper,
        body.presentation-mode .section-ai-actions,
        body.presentation-mode .delete-block-btn,
        body.presentation-mode .delete-line-btn,
        body.presentation-mode .insert-line-wrapper {
            display: none !important;
        }
        /* NEW: Completely hide the module in presentation mode if hidden */
        body.presentation-mode .cv-module.section-hidden {
            display: none !important;
        }

        @media print {
            body {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            .column-resizer,
            .drag-handle {
                display: none !important;
            }
            .cv-column {
                border-color: transparent !important;
            }
            .no-print {
                display: none !important;
            }
            .cv-module.section-hidden {
                display: none !important;
            }
            .a4-page {
                box-shadow: none !important;
                margin: 0;
                overflow: visible;
                height: auto;
                break-inside: avoid-page;
            }
            #cv-preview-wrapper {
                gap: 0;
            }
        }

        /* Assurer que no-print est visible en mode normal */
        @media screen {
            .no-print {
                display: block !important;
            }
            .controls-panel.no-print {
                display: flex !important;
            }
        }

        /* DEBUG: Forcer l'affichage du panneau de contrôles */
        #controls {
            display: flex !important;
            visibility: visible !important;
            opacity: 1 !important;
        }

        /* 🚀 STYLES POUR CLÉS MULTIPLES GEMINI */
        .gemini-key-item {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border: 1px solid #cbd5e1;
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 8px;
            transition: all 0.3s ease;
        }
        
        .gemini-key-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border-color: #3b82f6;
        }
        
        .gemini-key-status {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-active { background-color: #10b981; }
        .status-error { background-color: #ef4444; }
        .status-untested { background-color: #6b7280; }
        
        .key-actions {
            display: flex;
            gap: 4px;
        }
        
        .key-action-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .key-action-btn:hover {
            background: rgba(0,0,0,0.1);
        }
        
        .quota-indicator {
            font-size: 10px;
            color: #6b7280;
            background: #f1f5f9;
            padding: 2px 6px;
            border-radius: 10px;
        }

    </style>
</head>
<body style="margin: 0; padding: 0; font-family: sans-serif; background-color: #f3f4f6;">

    <!-- OVERLAYS AND MODALS -->
    <div id="loader-overlay" class="hidden fixed inset-0 bg-white bg-opacity-75 flex-col items-center justify-center z-[9999]">
        <div class="h-16 w-16 rounded-full border-4 border-gray-200 border-t-blue-600 animate-spin"></div>
        <p id="loader-text" class="mt-4 text-gray-600 font-medium">Chargement...</p>
    </div>

    <div id="notification"></div>

    <div class="app-container">
        <!-- PANNEAU DE CONTRÔLES REDIMENSIONNABLE -->
        <div class="controls-panel no-print" id="controls">
            <div class="resize-handle" id="resize-handle"></div>
            
            <div style="padding: 1.5rem; flex: 1; overflow-y: auto;">
            <div class="flex justify-between items-center mb-4 flex-shrink-0">
                <div class="flex items-center gap-3"><i class="fas fa-magic-wand-sparkles text-3xl text-blue-600"></i><h1 class="text-2xl font-bold text-gray-800">Créateur de CV</h1></div>
                <div class="flex items-center gap-2">
                    <!-- Save status removed -->
                    <button id="undo-btn" class="history-btn text-xl text-gray-600 hover:text-gray-900 disabled:text-gray-300" title="Annuler (Ctrl+Z)"><i class="fas fa-undo"></i></button>
                    <button id="redo-btn" class="history-btn text-xl text-gray-600 hover:text-gray-900 disabled:text-gray-300" title="Rétablir (Ctrl+Y)"><i class="fas fa-redo"></i></button>
                </div>
            </div>
            
            <!-- NEW: Progress Bar -->
            <div class="mb-4 flex-shrink-0">
                <label class="text-sm font-medium text-gray-600">Progression</label>
                <div id="progress-bar-container" class="w-full bg-gray-200 rounded-full h-2.5 mt-1">
                    <div id="progress-bar" class="bg-green-500 h-2.5 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
                <p id="progress-text" class="text-xs text-right text-gray-500 mt-1">0/X sections complétées</p>
            </div>

            <!-- NEW: API Status Indicator -->
            <div class="mb-4 flex-shrink-0">
                <label class="text-sm font-medium text-gray-600 mb-2 block">Statut API</label>
                <div id="sidebar-api-status" class="bg-white border border-gray-200 rounded-lg p-3 space-y-2">
                    <!-- API Active -->
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <div id="active-api-dot" class="w-3 h-3 bg-gray-400 rounded-full transition-colors"></div>
                            <span id="active-api-name" class="text-sm font-medium text-gray-600">Aucune API</span>
                        </div>
                        <span id="active-api-badge" class="px-2 py-1 bg-gray-100 text-gray-600 text-xs rounded-full font-mono">N/A</span>
                    </div>
                    
                    <!-- Statut détaillé -->
                    <div class="grid grid-cols-2 gap-2 text-xs">
                        <div class="flex items-center justify-between">
                            <span class="text-gray-500">Gemini:</span>
                            <span id="gemini-status-dot" class="w-2 h-2 bg-gray-300 rounded-full"></span>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-gray-500">OpenAI:</span>
                            <span id="openai-status-dot" class="w-2 h-2 bg-gray-300 rounded-full"></span>
                        </div>
                    </div>
                    
                    <!-- Compteur de requêtes -->
                    <div class="pt-2 border-t border-gray-100">
                        <div class="flex items-center justify-between text-xs">
                            <span class="text-gray-500">Requêtes aujourd'hui:</span>
                            <span id="daily-requests-count" class="font-mono text-gray-700">0</span>
                        </div>
                        <div class="w-full bg-gray-100 rounded-full h-1.5 mt-1">
                            <div id="daily-requests-bar" class="bg-blue-500 h-1.5 rounded-full transition-all duration-300" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <!-- Log des dernières activités -->
                    <div class="pt-2 border-t border-gray-100">
                        <div class="flex items-center justify-between mb-1">
                            <span class="text-xs text-gray-500">Dernière activité:</span>
                            <button id="view-api-logs" class="text-xs text-blue-600 hover:text-blue-800">
                                <i class="fas fa-list-ul"></i> Logs
                            </button>
                        </div>
                        <div id="last-api-activity" class="text-xs text-gray-600 truncate">
                            Aucune activité récente
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal des logs API -->
            <div id="api-logs-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
                <div class="fixed inset-4 bg-white rounded-lg shadow-xl flex flex-col max-w-4xl mx-auto">
                    <div class="flex items-center justify-between p-4 border-b">
                        <h2 class="text-lg font-bold">📊 Logs d'Activité API</h2>
                        <button id="close-api-logs" class="text-gray-500 hover:text-gray-700">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                    <div class="flex-1 overflow-auto p-4">
                        <div id="api-logs-content" class="space-y-2 font-mono text-sm">
                            <!-- Les logs seront générés dynamiquement -->
                        </div>
                    </div>
                    <div class="p-4 border-t bg-gray-50">
                        <div class="flex gap-2">
                            <button id="clear-api-logs" class="px-3 py-1 bg-red-100 text-red-700 rounded text-sm hover:bg-red-200">
                                <i class="fas fa-trash"></i> Vider les logs
                            </button>
                            <button id="export-api-logs" class="px-3 py-1 bg-blue-100 text-blue-700 rounded text-sm hover:bg-blue-200">
                                <i class="fas fa-download"></i> Exporter
                            </button>
                            <div class="ml-auto text-xs text-gray-500 flex items-center">
                                Auto-refresh: <span id="logs-auto-refresh" class="ml-1 font-medium">ON</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>


            <!-- TABS -->
            <div id="tab-navigation" class="flex flex-wrap -mb-px border-b border-gray-200">
                <button class="tab-btn -mb-px py-3 px-4 text-sm font-medium border-b-2 whitespace-nowrap" data-target="#panel-ia"><i class="fa-solid fa-robot mr-1"></i> IA</button>
                <button class="tab-btn -mb-px py-3 px-4 text-sm font-medium border-b-2 whitespace-nowrap" data-target="#panel-api"><i class="fa-solid fa-key mr-1"></i> API</button>
                <button class="tab-btn -mb-px py-3 px-4 text-sm font-medium border-b-2 whitespace-nowrap" data-target="#panel-content"><i class="fa-solid fa-file-lines mr-1"></i> Contenu</button>
                <button class="tab-btn -mb-px py-3 px-4 text-sm font-medium border-b-2 whitespace-nowrap" data-target="#panel-layout"><i class="fa-solid fa-columns mr-1"></i> Mise en Page</button>
                <button class="tab-btn -mb-px py-3 px-4 text-sm font-medium border-b-2 whitespace-nowrap" data-target="#panel-styles"><i class="fa-solid fa-palette mr-1"></i> Styles</button>
                <button class="tab-btn -mb-px py-3 px-4 text-sm font-medium border-b-2 whitespace-nowrap" data-target="#panel-recrutement"><i class="fa-solid fa-briefcase mr-1"></i> Recrutement</button>
                <button class="tab-btn -mb-px py-3 px-4 text-sm font-medium border-b-2 whitespace-nowrap" data-target="#panel-settings"><i class="fa-solid fa-cog mr-1"></i> Paramètres</button>
            </div>

            <!-- COLLAPSE ALL BUTTON -->
            <div class="px-4 pt-2 pb-1">
                <button id="collapse-all-btn" class="w-full bg-gray-100 hover:bg-gray-200 text-gray-700 py-2 px-3 rounded-md text-sm font-medium flex items-center justify-center gap-2 transition-colors">
                    <i class="fa-solid fa-compress" id="collapse-icon"></i>
                    <span id="collapse-text">Replier tous les volets</span>
                </button>
            </div>

            <div id="tab-content" class="px-4 flex-grow overflow-y-auto">
                <!-- TAB: IA -->
                <div id="panel-ia" class="tab-panel space-y-4 pt-3">
                    <details class="control-group" open>
                        <summary><span>Analyse IA</span><label class="completion-label"><input type="checkbox" id="completion-ia-analyse" class="completion-checkbox"><span>Fait ✅</span></label></summary>
                        <div class="control-group-content space-y-2">
                            <textarea id="ai-input" rows="6" class="w-full p-2 border rounded-md" placeholder="Collez ici une description de poste, un CV brut..."></textarea>
                            <button id="analyze-btn" class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 flex items-center justify-center gap-2"><i class="fa-solid fa-wand-magic-sparkles"></i> Analyser & Remplir</button>
                        </div>
                    </details>
                    <details class="control-group" open>
                        <summary><span>Actions IA</span><label class="completion-label"><input type="checkbox" id="completion-ia-actions" class="completion-checkbox"><span>Fait ✅</span></label></summary>
                        <div class="control-group-content space-y-2">
                            <button id="ai-synthesize-skills-btn" class="w-full bg-teal-600 text-white py-2 px-4 rounded-md hover:bg-teal-700 flex items-center justify-center gap-2"><i class="fas fa-magic-wand-sparkles"></i> Synthétiser les compétences</button>
                            <button id="ai-limit-skills-btn" class="w-full bg-orange-600 text-white py-2 px-4 rounded-md hover:bg-orange-700 flex items-center justify-center gap-2"><i class="fas fa-filter"></i> Limiter les compétences</button>
                            <button id="floating-ai-btn" class="w-full bg-gradient-to-r from-indigo-500 to-purple-600 text-white py-2 px-4 rounded-md hover:from-indigo-600 hover:to-purple-700 flex items-center justify-center gap-2"><i class="fas fa-magic-wand-sparkles"></i> Synthétise IA</button>
                        </div>
                    </details>
                </div>

                <!-- TAB: API -->
                <div id="panel-api" class="tab-panel hidden space-y-4 pt-3">
                    
                    <!-- Sélecteur API Principal -->
                    <div class="bg-gradient-to-r from-blue-50 to-purple-50 border border-blue-200 rounded-lg p-4 mb-6">
                        <h3 class="text-lg font-bold text-gray-800 mb-3 flex items-center gap-2">
                            <i class="fas fa-robot text-blue-600"></i>
                            Choisir votre Assistant IA
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <!-- Bouton Gemini -->
                            <button id="select-gemini-api" class="api-selector p-4 border-2 border-blue-300 rounded-lg hover:border-blue-500 transition-all duration-200 bg-white active" data-api="gemini">
                                <div class="flex items-center justify-between mb-2">
                                    <div class="flex items-center gap-2">
                                        <i class="fab fa-google text-2xl text-blue-600"></i>
                                        <span class="font-bold text-lg">Google Gemini</span>
                                    </div>
                                    <i class="selection-indicator fas fa-check-circle text-green-500 text-xl"></i>
                                </div>
                                <p class="text-sm text-gray-600 text-left">✨ Gratuit • 🚀 Rapide • 🔥 Intelligent</p>
                                <div class="status-indicator mt-2 px-2 py-1 rounded text-xs font-medium bg-green-100 text-green-700">
                                    <i class="fas fa-circle text-green-500"></i> API Sélectionnée
                                </div>
                            </button>
                            
                            <!-- Bouton OpenAI -->
                            <button id="select-openai-api" class="api-selector p-4 border-2 border-gray-300 rounded-lg hover:border-green-500 transition-all duration-200 bg-white" data-api="openai">
                                <div class="flex items-center justify-between mb-2">
                                    <div class="flex items-center gap-2">
                                        <i class="fas fa-brain text-2xl text-green-600"></i>
                                        <span class="font-bold text-lg">OpenAI ChatGPT</span>
                                    </div>
                                    <i class="selection-indicator fas fa-circle text-gray-300 text-xl"></i>
                                </div>
                                <p class="text-sm text-gray-600 text-left">🎯 Précis • 💡 Créatif • 🚀 GPT-5 Ready</p>
                                <div class="status-indicator mt-2 px-2 py-1 rounded text-xs font-medium bg-gray-100 text-gray-500">
                                    <i class="fas fa-circle text-gray-400"></i> Non sélectionnée
                                </div>
                            </button>
                        </div>
                        
                        <!-- Statut Global -->
                        <div id="global-api-status" class="mt-4 p-3 bg-white rounded-lg border">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-2">
                                    <i id="global-status-icon" class="fas fa-circle text-green-500"></i>
                                    <span id="global-status-text" class="font-medium text-green-700">Google Gemini activé</span>
                                </div>
                                <span id="active-model-badge" class="px-2 py-1 bg-blue-100 text-blue-700 text-xs rounded-full">gemini-1.5-flash</span>
                            </div>
                        </div>
                    </div>

                    <!-- 🤖 CONFIGURATION GEMINI -->
                    <details id="gemini-config" class="control-group" open>
                        <summary>
                            <span class="flex items-center gap-2">
                                <i class="fas fa-brain text-blue-600"></i>
                                🤖 Clés Gemini
                                <span class="px-2 py-1 bg-green-100 text-green-700 text-xs rounded-full ml-auto">GRATUIT</span>
                            </span>
                        </summary>
                        <div class="control-group-content space-y-4">
                            <div class="bg-blue-50 border border-blue-200 rounded-md p-3">
                                <p class="text-sm text-blue-800">
                                    <strong>Créez autant de clés que vous voulez</strong> sur <a href="https://aistudio.google.com/app/apikey" target="_blank" class="underline font-medium">aistudio.google.com</a>
                                </p>
                                <div class="text-xs bg-blue-100 p-2 rounded mt-2">
                                    💡 Ajoutez 5+ clés pour usage illimité !
                                </div>
                            </div>

                            <!-- Interface multi-clés simplifiée -->
                            <div>
                                <div class="flex gap-2 mb-3">
                                    <input 
                                        type="password" 
                                        id="new-gemini-key" 
                                        placeholder="AIza..." 
                                        class="flex-1 p-3 border-2 border-gray-300 rounded-lg text-sm font-mono focus:border-blue-500"
                                    >
                                    <button 
                                        id="add-gemini-key" 
                                        type="button" 
                                        class="bg-blue-600 text-white px-4 py-3 rounded-lg hover:bg-blue-700"
                                    >
                                        <i class="fa-solid fa-plus mr-1"></i> Ajouter
                                    </button>
                                </div>
                                
                                <!-- Liste des clés -->
                                <div id="gemini-keys-list" class="space-y-2 mb-4"></div>
                                
                                <!-- Statut compact -->
                                <div class="bg-blue-50 p-3 rounded-lg">
                                    <div class="grid grid-cols-3 gap-4 text-sm">
                                        <div class="text-center">
                                            <div id="active-gemini-keys-count" class="font-bold text-blue-600">0</div>
                                            <div class="text-xs text-gray-500">Clés actives</div>
                                        </div>
                                        <div class="text-center">
                                            <div id="total-gemini-requests" class="font-bold text-green-600">0</div>
                                            <div class="text-xs text-gray-500">Aujourd'hui</div>
                                        </div>
                                        <div class="text-center">
                                            <div class="font-bold text-purple-600" id="theoretical-limit">∞</div>
                                            <div class="text-xs text-gray-500">Limite</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                                    <div class="text-sm text-blue-800">
                                        <p class="font-bold mb-1">Google AI Studio - API Gratuite</p>
                                </div>
                            </div>
                        </div>
                    </details>

                    <!-- 🟢 CONFIGURATION OPENAI -->
                    <details class="control-group">
                        <summary>
                            <span class="flex items-center gap-2">
                                <i class="fas fa-brain text-green-600"></i>
                                🟢 OpenAI
                                <span class="px-2 py-1 bg-orange-100 text-orange-700 text-xs rounded-full ml-auto">PAYANT</span>
                            </span>
                        </summary>
                        <div class="control-group-content space-y-4">
                            <div class="bg-green-50 border border-green-200 rounded-md p-3">
                                <p class="text-sm text-green-800">
                                    <strong>Créez votre compte</strong> sur <a href="https://platform.openai.com/api-keys" target="_blank" class="underline font-medium">platform.openai.com</a>
                                </p>
                                <div class="text-xs bg-green-100 p-2 rounded mt-2">
                                    💳 Facturation à l'usage • $5 gratuit au début
                                </div>
                            </div>
                            
                            <div class="space-y-3">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Clé API OpenAI</label>
                                    <div class="flex gap-2">
                                        <input 
                                            type="password" 
                                            id="openai-api-key" 
                                            placeholder="sk-..." 
                                            class="flex-1 p-3 border-2 border-gray-300 rounded-lg text-sm font-mono focus:border-green-500"
                                        >
                                        <button id="save-openai-api-key" class="bg-green-600 text-white px-4 py-3 rounded-lg hover:bg-green-700">
                                            Sauver
                                        </button>
                                    </div>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Modèle</label>
                                    <select id="openai-model" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-green-500">
                                        <option value="gpt-3.5-turbo">GPT-3.5 Turbo (Économique)</option>
                                        <option value="gpt-4o">GPT-4o (Recommandé)</option>
                                        <option value="gpt-4o-mini">GPT-4o Mini (Rapide)</option>
                                        <option value="gpt-4">GPT-4 (Premium)</option>
                                        <option value="gpt-5">🚀 GPT-5 (Nouveau)</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </details>

                    <!-- 🇫🇷 APIS FRANÇAISES -->
                    <details class="control-group">
                        <summary>
                            <span class="flex items-center gap-2">
                                <i class="fas fa-flag text-blue-600"></i>
                                🇫🇷 APIs Françaises
                                <span class="px-2 py-1 bg-green-100 text-green-700 text-xs rounded-full ml-auto">GRATUIT</span>
                            </span>
                        </summary>
                        <div class="control-group-content space-y-4">
                            
                            <!-- Configuration responsive simplifiée -->
                            <div class="space-y-4">
                                
                                <!-- Hugging Face -->
                                <div class="bg-orange-50 border border-orange-200 rounded-lg p-3">
                                    <h4 class="font-bold text-orange-800 mb-2 text-sm">🤗 Hugging Face</h4>
                                    <input 
                                        type="password" 
                                        id="huggingface-token" 
                                        placeholder="hf_..." 
                                        class="w-full p-2 border border-gray-300 rounded text-sm font-mono mb-2"
                                    >
                                    <select id="huggingface-model" class="w-full p-2 border border-gray-300 rounded text-xs">
                                        <option value="microsoft/DialoGPT-large">DialoGPT Large</option>
                                        <option value="bigscience/bloom-560m">BLOOM (Français)</option>
                                        <option value="EleutherAI/gpt-j-6B">GPT-J 6B</option>
                                    </select>
                                    <a href="https://huggingface.co/settings/tokens" target="_blank" class="text-xs text-orange-600 underline block mt-1">Créer compte</a>
                                </div>
                                
                                <!-- Mistral AI -->
                                <div class="bg-purple-50 border border-purple-200 rounded-lg p-3">
                                    <h4 class="font-bold text-purple-800 mb-2 text-sm">🇫🇷 Mistral AI</h4>
                                    <input 
                                        type="password" 
                                        id="mistral-api-key" 
                                        placeholder="..." 
                                        class="w-full p-2 border border-gray-300 rounded text-sm font-mono mb-2"
                                    >
                                    <select id="mistral-model" class="w-full p-2 border border-gray-300 rounded text-xs">
                                        <option value="mistral-tiny">Mistral Tiny</option>
                                        <option value="mistral-small">Mistral Small</option>
                                        <option value="mistral-medium">Mistral Medium</option>
                                    </select>
                                    <a href="https://console.mistral.ai/" target="_blank" class="text-xs text-purple-600 underline block mt-1">Créer compte</a>
                                </div>
                                
                                <!-- Groq -->
                                <div class="bg-red-50 border border-red-200 rounded-lg p-3">
                                    <h4 class="font-bold text-red-800 mb-2 text-sm">⚡ Groq</h4>
                                    <input 
                                        type="password" 
                                        id="groq-api-key" 
                                        placeholder="gsk_..." 
                                        class="w-full p-2 border border-gray-300 rounded text-sm font-mono mb-2"
                                    >
                                    <select id="groq-model" class="w-full p-2 border border-gray-300 rounded text-xs">
                                        <option value="llama3-70b-8192">Llama 3 70B</option>
                                        <option value="llama3-8b-8192">Llama 3 8B</option>
                                        <option value="mixtral-8x7b-32768">Mixtral 8x7B</option>
                                    </select>
                                    <a href="https://console.groq.com/keys" target="_blank" class="text-xs text-red-600 underline block mt-1">Créer compte</a>
                                </div>
                            </div>
                            
                            <!-- Test et statut français -->
                            <div class="bg-gray-50 rounded-lg p-3">
                                <div class="flex items-center justify-between mb-2">
                                    <h5 class="font-medium text-gray-800 text-sm">Tests & Statut</h5>
                                </div>
                                
                                <!-- Boutons de test en colonne -->
                                <div class="space-y-2 mb-3">
                                    <button id="test-huggingface" class="w-full bg-orange-600 text-white py-2 px-3 rounded text-xs hover:bg-orange-700">
                                        <i class="fas fa-flask mr-1"></i> Test Hugging Face
                                    </button>
                                    <button id="test-mistral" class="w-full bg-purple-600 text-white py-2 px-3 rounded text-xs hover:bg-purple-700">
                                        <i class="fas fa-flask mr-1"></i> Test Mistral
                                    </button>
                                    <button id="test-groq" class="w-full bg-red-600 text-white py-2 px-3 rounded text-xs hover:bg-red-700">
                                        <i class="fas fa-flask mr-1"></i> Test Groq
                                    </button>
                                </div>
                                
                                <!-- Statuts en colonne -->
                                <div class="space-y-1 text-xs">
                                    <div id="huggingface-status" class="text-gray-500 p-1 bg-white rounded">HF: Non testé</div>
                                    <div id="mistral-status" class="text-gray-500 p-1 bg-white rounded">Mistral: Non testé</div>
                                    <div id="groq-status" class="text-gray-500 p-1 bg-white rounded">Groq: Non testé</div>
                                </div>
                            </div>
                        </div>
                    </details>

                    <!-- Configuration OpenAI ChatGPT -->
                    <details id="openai-config" class="control-group">
                        <summary>
                            <span class="flex items-center gap-2">
                                <i class="fas fa-brain text-green-600"></i>
                                Configuration OpenAI ChatGPT
                                <span class="px-2 py-1 bg-orange-100 text-orange-700 text-xs rounded-full ml-auto">PAYANT</span>
                            </span>
                            <label class="completion-label">
                                <input type="checkbox" id="completion-openai-config" class="completion-checkbox">
                                <span>Fait ✅</span>
                            </label>
                        </summary>
                        <div class="control-group-content space-y-4">
                            <div class="bg-green-50 border border-green-200 rounded-md p-4">
                                <div class="flex items-start gap-3">
                                    <i class="fas fa-brain text-green-600 text-xl mt-1"></i>
                                    <div class="text-sm text-green-800">
                                        <p class="font-bold mb-1">OpenAI Platform - API Professionnelle</p>
                                        <p class="mb-2">Créez votre compte et obtenez une clé API sur <a href="https://platform.openai.com/api-keys" target="_blank" class="underline hover:text-green-900 font-medium">platform.openai.com</a></p>
                                        <div class="text-xs bg-green-100 p-2 rounded">
                                            💳 <strong>Facturation à l'usage</strong> • $5 de crédit gratuit pour commencer
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div>
                                <label for="openai-api-key" class="block text-sm font-bold text-gray-700 mb-2">
                                    <i class="fas fa-key text-green-600 mr-1"></i>
                                    Clé API OpenAI
                                </label>
                                <div class="flex gap-2">
                                    <input 
                                        type="password" 
                                        id="openai-api-key" 
                                        placeholder="sk-..." 
                                        class="flex-1 p-3 border-2 border-gray-300 rounded-lg text-sm font-mono focus:border-green-500 focus:ring-2 focus:ring-green-200"
                                    >
                                    <button 
                                        id="toggle-openai-key" 
                                        type="button" 
                                        class="px-4 py-3 text-gray-500 hover:text-gray-700 border-2 border-gray-300 rounded-lg hover:border-gray-400 transition-colors"
                                        title="Afficher/Masquer la clé"
                                    >
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button 
                                        id="save-openai-api-key" 
                                        type="button" 
                                        class="bg-green-600 text-white px-4 py-3 rounded-lg hover:bg-green-700 transition-colors font-medium"
                                    >
                                        <i class="fa-solid fa-save mr-1"></i> Sauver
                                    </button>
                                </div>
                                <p class="text-xs text-gray-500 mt-2">🔒 Stockage sécurisé local uniquement</p>
                            </div>

                            <!-- Modèle OpenAI -->
                            <div>
                                <label for="openai-model" class="block text-sm font-bold text-gray-700 mb-2">
                                    <i class="fas fa-microchip text-green-600 mr-1"></i>
                                    Modèle ChatGPT
                                </label>
                                <select 
                                    id="openai-model" 
                                    class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-green-500 focus:ring-2 focus:ring-green-200"
                                >
                                    <option value="gpt-3.5-turbo">GPT-3.5 Turbo (Rapide & Économique) - $0.001/1k tokens</option>
                                    <option value="gpt-4">GPT-4 (Haute Qualité) - $0.03/1k tokens</option>
                                    <option value="gpt-4-turbo">GPT-4 Turbo (Équilibré) - $0.01/1k tokens</option>
                                    <option value="gpt-4o">GPT-4o (Optimisé - Recommandé) - $0.005/1k tokens</option>
                                    <option value="gpt-4o-mini">GPT-4o Mini (Rapide & Efficace) - $0.0015/1k tokens</option>
                                    <option value="gpt-5" style="background: linear-gradient(45deg, #fef3c7, #fde68a); font-weight: bold;">🚀 GPT-5 (Nouvelle Génération) - Prix à venir</option>
                                </select>
                                <p class="text-xs text-gray-500 mt-2">
                                    💡 <strong>GPT-4o</strong> offre le meilleur rapport qualité/prix. <strong>GPT-5</strong> pour les tâches les plus avancées.
                                </p>
                            </div>

                            <!-- Test OpenAI -->
                            <button 
                                id="test-openai-connection" 
                                type="button" 
                                class="w-full bg-green-600 text-white py-3 px-4 rounded-lg hover:bg-green-700 flex items-center justify-center gap-2 font-medium transition-colors"
                            >
                                <i class="fas fa-plug"></i> Tester la Connexion OpenAI
                            </button>

                            <!-- Statut OpenAI -->
                            <div id="combined-api-status" class="hidden p-4 rounded-lg border-2">
                                <div class="flex items-center gap-3">
                                    <i id="combined-status-icon" class="text-xl"></i>
                                    <span id="combined-status-text" class="font-medium"></span>
                                </div>
                            </div>
                        </div>
                    </details>

                    <!-- 🇫🇷 APIs GRATUITES ALTERNATIVES (FRANCE) -->
                    <details class="control-group">
                        <summary>
                            <span class="flex items-center gap-2">
                                <i class="fas fa-flag text-blue-600"></i>
                                APIs Gratuites Alternatives 🇫🇷
                                <span class="px-2 py-1 bg-green-100 text-green-700 text-xs rounded-full ml-auto">100% GRATUIT</span>
                            </span>
                            <label class="completion-label">
                                <input type="checkbox" id="completion-free-apis" class="completion-checkbox">
                                <span>Configuré ✅</span>
                            </label>
                        </summary>
                        <div class="control-group-content space-y-4">
                            <!-- Info générale -->
                            <div class="bg-green-50 border border-green-200 rounded-md p-4">
                                <div class="flex items-start gap-3">
                                    <i class="fas fa-gift text-green-600 text-xl mt-1"></i>
                                    <div class="text-sm text-green-800">
                                        <p class="font-bold mb-1">Solutions 100% Gratuites en France</p>
                                        <p class="mb-2">Utilisez ces APIs quand vos quotas Gemini et OpenAI sont épuisés</p>
                                        <div class="text-xs bg-green-100 p-2 rounded">
                                            🇫🇷 <strong>Conformes RGPD</strong> • Pas de carte bancaire • Quotas généreux
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Hugging Face -->
                            <div class="bg-orange-50 border border-orange-200 rounded-lg p-4">
                                <h4 class="font-bold text-orange-800 mb-2 flex items-center">
                                    <i class="fas fa-robot text-orange-600 mr-2"></i>
                                    Hugging Face (Gratuit)
                                </h4>
                                <p class="text-xs text-orange-700 mb-3">
                                    🤗 Plateforme française d'IA • 1000+ modèles gratuits • Pas de limite stricte
                                </p>
                                <div class="space-y-3">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Token API Hugging Face</label>
                                        <div class="flex gap-2">
                                            <input 
                                                type="password" 
                                                id="huggingface-token" 
                                                placeholder="hf_..." 
                                                class="flex-1 p-2 border border-gray-300 rounded text-sm font-mono"
                                            >
                                            <button 
                                                id="save-huggingface-token" 
                                                class="bg-orange-600 text-white px-3 py-2 rounded hover:bg-orange-700 text-sm"
                                            >
                                                Sauver
                                            </button>
                                        </div>
                                        <p class="text-xs text-gray-500 mt-1">
                                            Créez un compte sur <a href="https://huggingface.co/settings/tokens" target="_blank" class="text-orange-600 underline">huggingface.co</a>
                                        </p>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Modèle Hugging Face</label>
                                        <select id="huggingface-model" class="w-full p-2 border border-gray-300 rounded text-sm">
                                            <option value="microsoft/DialoGPT-large">DialoGPT Large (Conversationnel)</option>
                                            <option value="bigscience/bloom-560m">BLOOM 560M (Français natif)</option>
                                            <option value="EleutherAI/gpt-j-6B">GPT-J 6B (Polyvalent)</option>
                                            <option value="facebook/blenderbot-400M-distill">BlenderBot (Dialogue)</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <!-- Mistral AI -->
                            <div class="bg-purple-50 border border-purple-200 rounded-lg p-4">
                                <h4 class="font-bold text-purple-800 mb-2 flex items-center">
                                    <i class="fas fa-wind text-purple-600 mr-2"></i>
                                    Mistral AI (Français)
                                </h4>
                                <p class="text-xs text-purple-700 mb-3">
                                    🇫🇷 IA Française • Quota gratuit généreux • Performance européenne
                                </p>
                                <div class="space-y-3">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Clé API Mistral</label>
                                        <div class="flex gap-2">
                                            <input 
                                                type="password" 
                                                id="mistral-api-key" 
                                                placeholder="..." 
                                                class="flex-1 p-2 border border-gray-300 rounded text-sm font-mono"
                                            >
                                            <button 
                                                id="save-mistral-key" 
                                                class="bg-purple-600 text-white px-3 py-2 rounded hover:bg-purple-700 text-sm"
                                            >
                                                Sauver
                                            </button>
                                        </div>
                                        <p class="text-xs text-gray-500 mt-1">
                                            Créez un compte sur <a href="https://console.mistral.ai/" target="_blank" class="text-purple-600 underline">console.mistral.ai</a>
                                        </p>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Modèle Mistral</label>
                                        <select id="mistral-model" class="w-full p-2 border border-gray-300 rounded text-sm">
                                            <option value="mistral-tiny">Mistral Tiny (Gratuit)</option>
                                            <option value="mistral-small">Mistral Small (Gratuit)</option>
                                            <option value="mistral-medium">Mistral Medium</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <!-- Groq -->
                            <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                                <h4 class="font-bold text-red-800 mb-2 flex items-center">
                                    <i class="fas fa-bolt text-red-600 mr-2"></i>
                                    Groq (Ultra-Rapide)
                                </h4>
                                <p class="text-xs text-red-700 mb-3">
                                    ⚡ Inférence ultra-rapide • Quota gratuit • Llama 3 disponible
                                </p>
                                <div class="space-y-3">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Clé API Groq</label>
                                        <div class="flex gap-2">
                                            <input 
                                                type="password" 
                                                id="groq-api-key" 
                                                placeholder="gsk_..." 
                                                class="flex-1 p-2 border border-gray-300 rounded text-sm font-mono"
                                            >
                                            <button 
                                                id="save-groq-key" 
                                                class="bg-red-600 text-white px-3 py-2 rounded hover:bg-red-700 text-sm"
                                            >
                                                Sauver
                                            </button>
                                        </div>
                                        <p class="text-xs text-gray-500 mt-1">
                                            Créez un compte sur <a href="https://console.groq.com/keys" target="_blank" class="text-red-600 underline">console.groq.com</a>
                                        </p>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Modèle Groq</label>
                                        <select id="groq-model" class="w-full p-2 border border-gray-300 rounded text-sm">
                                            <option value="llama3-70b-8192">Llama 3 70B (Le plus puissant)</option>
                                            <option value="llama3-8b-8192">Llama 3 8B (Rapide)</option>
                                            <option value="mixtral-8x7b-32768">Mixtral 8x7B (Équilibré)</option>
                                            <option value="gemma-7b-it">Gemma 7B (Google)</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <!-- Test toutes les APIs gratuites -->
                            <div class="space-y-2">
                                <button id="test-huggingface" class="w-full bg-orange-600 text-white py-2 px-3 rounded text-sm hover:bg-orange-700">
                                    <i class="fas fa-flask mr-1"></i> Test Hugging Face
                                </button>
                                <button id="test-mistral" class="w-full bg-purple-600 text-white py-2 px-3 rounded text-sm hover:bg-purple-700">
                                    <i class="fas fa-flask mr-1"></i> Test Mistral
                                </button>
                                <button id="test-groq" class="w-full bg-red-600 text-white py-2 px-3 rounded text-sm hover:bg-red-700">
                                    <i class="fas fa-flask mr-1"></i> Test Groq
                                </button>
                            </div>

                            <!-- Statut des APIs gratuites -->
                            <div class="bg-gray-50 rounded-lg p-3">
                                <h5 class="font-semibold text-gray-800 mb-2">Statut APIs Gratuites</h5>
                                <div class="space-y-1 text-sm">
                                    <div class="flex justify-between">
                                        <span>Hugging Face:</span>
                                        <span id="hf-status" class="text-gray-500">Non testé</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>Mistral AI:</span>
                                        <span id="mistral-status" class="text-gray-500">Non testé</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>Groq:</span>
                                        <span id="groq-status" class="text-gray-500">Non testé</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </details>

                    <!-- 🚀 SÉLECTEUR D'API UNIFIÉ ET SIMPLIFIÉ -->
                    <details class="control-group" open>
                        <summary>
                            <span class="flex items-center gap-2">
                                <i class="fas fa-rocket text-purple-600"></i>
                                🚀 Sélection d'API
                            </span>
                        </summary>
                        <div class="control-group-content space-y-4">
                            
                            <!-- SÉLECTEUR PRINCIPAL COMPACT -->
                            <div class="bg-gradient-to-r from-blue-50 to-purple-50 p-4 rounded-lg border-2 border-blue-200">
                                <label class="block text-sm font-bold text-gray-700 mb-3">
                                    <i class="fas fa-brain text-blue-600 mr-1"></i>
                                    🎯 API Active
                                </label>
                                <div class="grid grid-cols-1 gap-2">
                                    
                                    <!-- Gemini -->
                                    <label class="api-selector-card cursor-pointer">
                                        <input type="radio" name="primary-api" value="gemini-multi" id="select-gemini-multi" class="sr-only api-radio">
                                        <div class="api-card p-3 border-2 border-gray-200 rounded-lg hover:border-blue-400 transition-all">
                                            <div class="flex items-center justify-between">
                                                <div class="flex items-center gap-3">
                                                    <div class="api-status-dot w-3 h-3 bg-gray-400 rounded-full"></div>
                                                    <div>
                                                        <div class="font-semibold text-gray-800">🤖 Gemini (Gratuit)</div>
                                                        <div class="text-xs text-gray-500">Multi-clés • Unlimited</div>
                                                    </div>
                                                </div>
                                                <div class="text-right">
                                                    <div class="text-xs font-mono bg-green-100 text-green-700 px-2 py-1 rounded" id="gemini-keys-count">0 clés</div>
                                                </div>
                                            </div>
                                        </div>
                                    </label>
                                    
                                    <!-- OpenAI -->
                                    <label class="api-selector-card cursor-pointer">
                                        <input type="radio" name="primary-api" value="openai" id="select-openai" class="sr-only api-radio">
                                        <div class="api-card p-3 border-2 border-gray-200 rounded-lg hover:border-green-400 transition-all">
                                            <div class="flex items-center justify-between">
                                                <div class="flex items-center gap-3">
                                                    <div class="api-status-dot w-3 h-3 bg-gray-400 rounded-full"></div>
                                                    <div>
                                                        <div class="font-semibold text-gray-800">🟢 OpenAI (Payant)</div>
                                                        <div class="text-xs text-gray-500">Haute qualité</div>
                                                    </div>
                                                </div>
                                                <div class="text-right">
                                                    <div class="text-xs font-mono bg-blue-100 text-blue-700 px-2 py-1 rounded" id="openai-model-display">GPT-4o</div>
                                                </div>
                                            </div>
                                        </div>
                                    </label>
                                    
                                    <!-- APIs Françaises -->
                                    <label class="api-selector-card cursor-pointer">
                                        <input type="radio" name="primary-api" value="french-apis" id="select-french-apis" class="sr-only api-radio">
                                        <div class="api-card p-3 border-2 border-gray-200 rounded-lg hover:border-red-400 transition-all">
                                            <div class="flex items-center justify-between">
                                                <div class="flex items-center gap-3">
                                                    <div class="api-status-dot w-3 h-3 bg-gray-400 rounded-full"></div>
                                                    <div>
                                                        <div class="font-semibold text-gray-800">🇫🇷 APIs Françaises</div>
                                                        <div class="text-xs text-gray-500">HF • Mistral • Groq • Gratuit</div>
                                                    </div>
                                                </div>
                                                <div class="text-right">
                                                    <div class="text-xs font-mono bg-green-100 text-green-700 px-2 py-1 rounded">FREE</div>
                                                </div>
                                            </div>
                                        </div>
                                    </label>
                                    
                                    <!-- Auto-Fallback -->
                                    <label class="api-selector-card cursor-pointer">
                                        <input type="radio" name="primary-api" value="auto-fallback" id="select-auto-fallback" class="sr-only api-radio" checked>
                                        <div class="api-card p-3 border-2 border-green-300 bg-green-50 rounded-lg hover:border-green-500 transition-all">
                                            <div class="flex items-center justify-between">
                                                <div class="flex items-center gap-3">
                                                    <div class="api-status-dot w-3 h-3 bg-green-500 rounded-full animate-pulse"></div>
                                                    <div>
                                                        <div class="font-semibold text-green-800">🎯 Auto-Fallback (Recommandé)</div>
                                                        <div class="text-xs text-green-600">Sélection intelligente automatique</div>
                                                    </div>
                                                </div>
                                                <div class="text-right">
                                                    <div class="text-xs font-mono bg-green-200 text-green-800 px-2 py-1 rounded">SMART</div>
                                                </div>
                                            </div>
                                        </div>
                                    </label>
                                </div>
                                
                                <!-- Test et ordre -->
                                <div class="mt-4 pt-3 border-t border-gray-200 space-y-3">
                                    <button id="test-selected-api" class="w-full bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors text-sm font-medium">
                                        <i class="fas fa-play-circle mr-1"></i> Tester l'API Sélectionnée
                                    </button>
                                    <div id="selected-api-test-result" class="text-sm hidden"></div>
                                    
                                    <!-- Ordre de priorité -->
                                    <div id="fallback-settings" class="bg-gray-50 p-3 rounded-lg">
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Ordre de Priorité (Auto-Fallback)</label>
                                        <select id="api-priority" class="w-full p-2 border border-gray-300 rounded text-sm">
                                            <option value="gemini-first">🤖 Gemini → 🟢 OpenAI → 🇫🇷 Français</option>
                                            <option value="openai-first">🟢 OpenAI → 🤖 Gemini → 🇫🇷 Français</option>
                                            <option value="french-first">🇫🇷 Français → 🤖 Gemini → 🟢 OpenAI</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="ai-temperature" class="block text-sm font-medium text-gray-700 mb-1">Créativité</label>
                                    <div class="flex items-center gap-2">
                                        <input type="range" id="ai-temperature" min="0" max="1" step="0.1" value="0.7" class="flex-1">
                                        <span id="temperature-value" class="text-sm font-mono bg-gray-100 px-2 py-1 rounded">0.7</span>
                                    </div>
                                    <p class="text-xs text-gray-500">0 = Précis, 1 = Créatif</p>
                                </div>
                                <div>
                                    <label for="ai-max-tokens" class="block text-sm font-medium text-gray-700 mb-1">Longueur Max</label>
                                    <div class="flex items-center gap-2">
                                        <input type="range" id="ai-max-tokens" min="100" max="2000" step="100" value="1000" class="flex-1">
                                        <span id="max-tokens-value" class="text-sm font-mono bg-gray-100 px-2 py-1 rounded">1000</span>
                                    </div>
                                    <p class="text-xs text-gray-500">Limite de mots pour les réponses</p>
                                </div>
                            </div>

                            <!-- Statut Quota -->
                            <div class="bg-gray-50 p-4 rounded-lg border">
                                <div class="flex items-center justify-between mb-3">
                                    <span class="text-sm font-bold text-gray-700">
                                        <i class="fas fa-chart-line text-purple-600 mr-1"></i>
                                        Statut des Quotas
                                    </span>
                                    <button id="check-quota-status" class="text-xs bg-purple-100 text-purple-700 px-3 py-1 rounded-full hover:bg-purple-200 transition-colors">
                                        <i class="fas fa-sync-alt"></i> Actualiser
                                    </button>
                                </div>
                                <div id="quota-details" class="space-y-2">
                                    <div class="flex justify-between text-sm">
                                        <span>Gemini (Gratuit):</span>
                                        <span id="gemini-quota-status" class="px-2 py-1 rounded-full bg-green-100 text-green-700 text-xs">✅ Disponible</span>
                                    </div>
                                    <div class="flex justify-between text-sm">
                                        <span>OpenAI (Payant):</span>
                                        <span id="openai-quota-status" class="px-2 py-1 rounded-full bg-gray-100 text-gray-500 text-xs">❓ Non configuré</span>
                                    </div>
                                </div>
                                <div id="quota-reset-info" class="mt-3 text-xs text-gray-500 hidden">
                                    📅 Réinitialisation Gemini: <span id="quota-reset-time" class="font-mono"></span>
                                </div>
                            </div>

                            <!-- Reset -->
                            <button id="reset-api-settings" class="w-full bg-red-100 text-red-700 py-2 px-4 rounded-lg hover:bg-red-200 transition-colors text-sm font-medium">
                                <i class="fas fa-trash-alt mr-1"></i> Réinitialiser toute la configuration API
                            </button>
                        </div>
                    </details>
                    
                </div>

                <!-- TAB: Contenu -->
                <div id="panel-content" class="tab-panel hidden space-y-4 pt-3">
                    <details class="control-group" open>
                        <summary><span>Informations Principales</span><label class="completion-label"><input type="checkbox" id="completion-content-infos" class="completion-checkbox"><span>Fait ✅</span></label></summary>
                        <div class="control-group-content space-y-3">
                            <input type="text" id="nom" placeholder="Nom" class="cv-input w-full p-2 border rounded-md">
                            <input type="text" id="prenom" placeholder="Prénom" class="cv-input w-full p-2 border rounded-md">
                            <input type="text" id="poste" placeholder="Poste recherché" class="cv-input w-full p-2 border rounded-md">
                            <textarea id="description" placeholder="Description du profil" rows="4" class="cv-input w-full p-2 border rounded-md"></textarea>
                        </div>
                    </details>
                     <details class="control-group" open>
                        <summary><span>Expériences</span><label class="completion-label"><input type="checkbox" id="completion-content-exp" class="completion-checkbox"><span>Fait ✅</span></label></summary>
                        <div class="control-group-content space-y-2">
                            <div class="flex justify-end mb-2"><button id="add-experience" class="text-sm text-blue-600 hover:text-blue-800 font-medium"><i class="fas fa-circle-plus"></i> Ajouter un bloc</button></div>
                            <div id="experience-list" class="space-y-2"></div>
                        </div>
                    </details>
                     <details class="control-group" open>
                        <summary><span>Formations</span><label class="completion-label"><input type="checkbox" id="completion-content-form" class="completion-checkbox"><span>Fait ✅</span></label></summary>
                        <div class="control-group-content space-y-2">
                            <div class="flex justify-end mb-2"><button id="add-formation" class="text-sm text-blue-600 hover:text-blue-800 font-medium"><i class="fas fa-circle-plus"></i> Ajouter un bloc</button></div>
                            <div id="formation-list" class="space-y-2"></div>
                        </div>
                    </details>
                    
                    <!-- Compétences (fusionné) -->
                     <details class="control-group" open>
                        <summary><span>Compétences</span><label class="completion-label"><input type="checkbox" id="completion-skills" class="completion-checkbox"><span>Fait ✅</span></label></summary>
                        <div class="control-group-content space-y-3">
                            <p class="text-sm font-medium">Style de Présentation</p>
                            <div class="flex gap-2">
                                <button data-skill-style="tags" class="skill-style-btn flex-1 bg-gray-200 p-2 rounded-md text-sm active">Tags</button>
                                <button data-skill-style="levels" class="skill-style-btn flex-1 bg-gray-200 p-2 rounded-md text-sm">Niveaux</button>
                                <button data-skill-style="simple" class="skill-style-btn flex-1 bg-gray-200 p-2 rounded-md text-sm">Simple</button>
                            </div>
                            
                            <div id="skills-text-controls">
                                <div class="flex justify-between items-center"><label for="competences" class="font-medium">Liste des compétences</label><div class="flex gap-2"><button id="ai-limit-skills-btn" class="text-blue-600 hover:text-blue-800" title="Limiter à 10 compétences par l'IA"><i class="fas fa-filter"></i> 10</button><button id="ai-synthesize-skills-btn" class="text-blue-600 hover:text-blue-800" title="Synthétiser et ranger les compétences par l'IA"><i class="fas fa-brain"></i></button></div></div>
                                <textarea id="competences" placeholder="Compétences (séparées par des virgules)..." rows="4" class="cv-input w-full p-2 border rounded-md"></textarea>
                            </div>

                            <div id="skills-level-controls" class="hidden space-y-3">
                                <p class="text-sm font-medium">Style de Jauge</p>
                                <div class="grid grid-cols-5 gap-2 text-center">
                                    <button data-gauge-style="bar" class="gauge-style-btn bg-gray-200 p-2 rounded-md text-sm active" title="Barre"><i class="fas fa-bars"></i></button>
                                    <button data-gauge-style="dots" class="gauge-style-btn bg-gray-200 p-2 rounded-md text-sm" title="Points"><i class="fas fa-circle"></i></button>
                                    <button data-gauge-style="stars" class="gauge-style-btn bg-gray-200 p-2 rounded-md text-sm" title="Étoiles"><i class="fas fa-star"></i></button>
                                    <button data-gauge-style="squares" class="gauge-style-btn bg-gray-200 p-2 rounded-md text-sm" title="Carrés"><i class="fas fa-square"></i></button>
                                    <button data-gauge-style="number" class="gauge-style-btn bg-gray-200 p-2 rounded-md text-sm font-bold" title="Chiffres">⅗</button>
                                </div>
                                <div id="skills-level-list" class="space-y-2 border-t pt-3"></div>
                                <button id="add-skill-level-btn" class="w-full bg-blue-100 text-blue-800 py-2 px-4 rounded-md hover:bg-blue-200 flex items-center justify-center gap-2 text-sm"><i class="fas fa-plus-circle"></i> Ajouter une compétence</button>
                            </div>
                        </div>
                    </details>
                    
                    <!-- Sections Personnalisées (fusionné) -->
                    <details class="control-group" open>
                        <summary><span>Sections Personnalisées</span><label class="completion-label"><input type="checkbox" id="completion-custom" class="completion-checkbox"><span>Fait ✅</span></label></summary>
                        <div class="control-group-content space-y-3">
                            <div class="space-y-2">
                                <label class="text-sm font-medium">Ajouter une nouvelle section</label>
                                <select id="section-suggestion-select" class="w-full p-2 border rounded-md text-sm">
                                    <option value="">-- Choisir une suggestion --</option>
                                    <option value="Langues 🌐">Langues 🌐</option>
                                    <option value="Centres d'intérêt 🎨">Centres d'intérêt 🎨</option>
                                    <option value="Certifications 📜">Certifications 📜</option>
                                    <option value="Projets Personnels 💡">Projets Personnels 💡</option>
                                    <option value="Bénévolat ❤️">Bénévolat ❤️</option>
                                </select>
                                <div class="flex gap-2">
                                    <input type="text" id="new-section-title-input" class="flex-grow p-2 border rounded-md text-sm" placeholder="Ou tapez un titre personnalisé...">
                                    <button id="add-section-btn" class="bg-indigo-500 text-white py-2 px-4 rounded-md hover:bg-indigo-600"><i class="fas fa-plus"></i></button>
                                </div>
                            </div>
                            <div id="custom-sections-list" class="space-y-2 mt-2 border-t pt-2"></div>
                        </div>
                    </details>
                </div>
                
                <!-- TAB: Compétences -->
                
                <!-- TAB: Mise en Page -->
                <div id="panel-layout" class="tab-panel hidden space-y-4 pt-3">
                    <!-- IA LAYOUT GENERATOR -->
                    <details class="control-group" open>
                        <summary><span>🤖 Générateur IA de Mise en Page</span><label class="completion-label"><input type="checkbox" id="completion-layout-ai" class="completion-checkbox"><span>Fait ✅</span></label></summary>
                        <div class="control-group-content space-y-3">
                            <button id="ai-layout-professional" class="w-full bg-gradient-to-r from-blue-600 to-indigo-600 text-white py-3 px-4 rounded-md hover:from-blue-700 hover:to-indigo-700 flex items-center justify-center gap-2">
                                <i class="fas fa-magic-wand-sparkles"></i> Mise en Page Professionnelle IA
                            </button>
                            <button id="ai-layout-creative" class="w-full bg-gradient-to-r from-purple-600 to-pink-600 text-white py-3 px-4 rounded-md hover:from-purple-700 hover:to-pink-700 flex items-center justify-center gap-2">
                                <i class="fas fa-palette"></i> Mise en Page Créative IA
                            </button>
                            <button id="ai-layout-modern" class="w-full bg-gradient-to-r from-teal-600 to-cyan-600 text-white py-3 px-4 rounded-md hover:from-teal-700 hover:to-cyan-700 flex items-center justify-center gap-2">
                                <i class="fas fa-rocket"></i> Mise en Page Moderne IA
                            </button>
                            <button id="ai-layout-random" class="w-full bg-gradient-to-r from-orange-600 to-red-600 text-white py-3 px-4 rounded-md hover:from-orange-700 hover:to-red-700 flex items-center justify-center gap-2">
                                <i class="fas fa-dice"></i> Mise en Page Aléatoire Intelligente
                            </button>
                        </div>
                    </details>

                    <!-- LAYOUT STRUCTURE -->
                    <details class="control-group" open>
                        <summary><span>Structure & Colonnes</span><label class="completion-label"><input type="checkbox" id="completion-layout-structure" class="completion-checkbox"><span>Fait ✅</span></label></summary>
                        <div class="control-group-content space-y-4">
                            <div>
                                <label class="text-sm font-medium text-gray-700 mb-2 block">Disposition générale</label>
                                <div class="grid grid-cols-2 gap-2">
                                    <button data-layout="layout-1-col" class="layout-btn bg-gray-200 p-3 rounded-md text-sm">📄 1 Colonne</button>
                                    <button data-layout="layout-2-col-33-67" class="layout-btn bg-gray-200 p-3 rounded-md text-sm">📊 33/67</button>
                                    <button data-layout="layout-2-col-50-50" class="layout-btn bg-gray-200 p-3 rounded-md text-sm">⚖️ 50/50</button>
                                    <button data-layout="layout-2-col-67-33" class="layout-btn bg-gray-200 p-3 rounded-md text-sm">📈 67/33</button>
                                    <button data-layout="layout-3-col" class="layout-btn bg-gray-200 p-3 rounded-md text-sm">🏛️ 3 Colonnes</button>
                                    <button data-layout="layout-zigzag" class="layout-btn bg-gray-200 p-3 rounded-md text-sm">⚡ Zigzag</button>
                                </div>
                            </div>
                            <div>
                                <label class="text-sm font-medium text-gray-700 mb-2 block">Ordre des sections</label>
                                <div class="grid grid-cols-1 gap-2">
                                    <button id="shuffle-sections" class="bg-indigo-500 text-white py-2 px-4 rounded-md hover:bg-indigo-600">🔀 Réorganiser aléatoirement</button>
                                    <button id="optimize-sections" class="bg-green-500 text-white py-2 px-4 rounded-md hover:bg-green-600">🎯 Optimiser l'ordre IA</button>
                                </div>
                            </div>
                        </div>
                    </details>

                    <!-- ADVANCED SPACING -->
                    <details class="control-group" open>
                        <summary><span>Espacements Avancés</span><label class="completion-label"><input type="checkbox" id="completion-layout-spacing" class="completion-checkbox"><span>Fait ✅</span></label></summary>
                        <div class="control-group-content space-y-4">
                            <div class="grid grid-cols-2 gap-4">
                                <div><label for="page-margin-top" class="block text-sm font-medium text-gray-700">Marge Haut: <span id="page-margin-top-value">2</span>cm</label><input type="range" id="page-margin-top" min="0" max="5" step="0.1" value="2" class="cv-input w-full h-2 bg-gray-200 rounded-lg cursor-pointer"></div>
                                <div><label for="page-margin-bottom" class="block text-sm font-medium text-gray-700">Marge Bas: <span id="page-margin-bottom-value">2</span>cm</label><input type="range" id="page-margin-bottom" min="0" max="5" step="0.1" value="2" class="cv-input w-full h-2 bg-gray-200 rounded-lg cursor-pointer"></div>
                                <div><label for="page-margin-left" class="block text-sm font-medium text-gray-700">Marge Gauche: <span id="page-margin-left-value">2</span>cm</label><input type="range" id="page-margin-left" min="0" max="5" step="0.1" value="2" class="cv-input w-full h-2 bg-gray-200 rounded-lg cursor-pointer"></div>
                                <div><label for="page-margin-right" class="block text-sm font-medium text-gray-700">Marge Droite: <span id="page-margin-right-value">2</span>cm</label><input type="range" id="page-margin-right" min="0" max="5" step="0.1" value="2" class="cv-input w-full h-2 bg-gray-200 rounded-lg cursor-pointer"></div>
                            </div>
                            <div><label for="column-gap" class="block text-sm font-medium text-gray-700">Espace entre Colonnes: <span id="column-gap-value">2</span>rem</label><input type="range" id="column-gap" min="0.5" max="5" step="0.1" value="2" class="cv-input w-full h-2 bg-gray-200 rounded-lg cursor-pointer"></div>
                            <div><label for="section-spacing" class="block text-sm font-medium text-gray-700">Espace Sections: <span id="section-spacing-value">1.5</span>rem</label><input type="range" id="section-spacing" min="0" max="6" step="0.1" value="1.5" class="cv-input w-full h-2 bg-gray-200 rounded-lg cursor-pointer"></div>
                            <div><label for="subsection-spacing" class="block text-sm font-medium text-gray-700">Espace Sous-sections: <span id="subsection-spacing-value">1</span>rem</label><input type="range" id="subsection-spacing" min="0" max="4" step="0.1" value="1" class="cv-input w-full h-2 bg-gray-200 rounded-lg cursor-pointer"></div>
                            <div><label for="item-spacing" class="block text-sm font-medium text-gray-700">Espace Éléments: <span id="item-spacing-value">0.5</span>rem</label><input type="range" id="item-spacing" min="0" max="3" step="0.1" value="0.5" class="cv-input w-full h-2 bg-gray-200 rounded-lg cursor-pointer"></div>
                        </div>
                    </details>

                    <!-- TYPOGRAPHY ADVANCED -->
                    <details class="control-group" open>
                        <summary><span>Typographie Avancée</span><label class="completion-label"><input type="checkbox" id="completion-layout-typography" class="completion-checkbox"><span>Fait ✅</span></label></summary>
                        <div class="control-group-content space-y-4">
                            <div class="grid grid-cols-2 gap-4">
                                <div><label for="font-size-h1" class="block text-sm font-medium text-gray-700">Titre Principal: <span id="font-size-h1-value">40</span>pt</label><input type="range" id="font-size-h1" min="16" max="60" step="0.5" value="40" class="cv-input w-full h-2 bg-gray-200 rounded-lg cursor-pointer"></div>
                                <div><label for="font-size-h2" class="block text-sm font-medium text-gray-700">Titres Section: <span id="font-size-h2-value">21</span>pt</label><input type="range" id="font-size-h2" min="12" max="36" step="0.5" value="21" class="cv-input w-full h-2 bg-gray-200 rounded-lg cursor-pointer"></div>
                                <div><label for="font-size-h3" class="block text-sm font-medium text-gray-700">Sous-titres: <span id="font-size-h3-value">16</span>pt</label><input type="range" id="font-size-h3" min="10" max="24" step="0.5" value="16" class="cv-input w-full h-2 bg-gray-200 rounded-lg cursor-pointer"></div>
                                <div><label for="font-size-p" class="block text-sm font-medium text-gray-700">Paragraphe: <span id="font-size-p-value">10</span>pt</label><input type="range" id="font-size-p" min="8" max="16" step="0.25" value="10" class="cv-input w-full h-2 bg-gray-200 rounded-lg cursor-pointer"></div>
                                <div><label for="font-size-small" class="block text-sm font-medium text-gray-700">Texte petit: <span id="font-size-small-value">8</span>pt</label><input type="range" id="font-size-small" min="6" max="12" step="0.25" value="8" class="cv-input w-full h-2 bg-gray-200 rounded-lg cursor-pointer"></div>
                                <div><label for="font-size-caption" class="block text-sm font-medium text-gray-700">Légendes: <span id="font-size-caption-value">7</span>pt</label><input type="range" id="font-size-caption" min="5" max="10" step="0.25" value="7" class="cv-input w-full h-2 bg-gray-200 rounded-lg cursor-pointer"></div>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div><label for="line-height-headings" class="block text-sm font-medium text-gray-700">Interligne Titres: <span id="line-height-headings-value">1.2</span></label><input type="range" id="line-height-headings" min="0.8" max="2" step="0.05" value="1.2" class="cv-input w-full h-2 bg-gray-200 rounded-lg cursor-pointer"></div>
                                <div><label for="line-height-body" class="block text-sm font-medium text-gray-700">Interligne Corps: <span id="line-height-body-value">1.6</span></label><input type="range" id="line-height-body" min="1" max="3" step="0.05" value="1.6" class="cv-input w-full h-2 bg-gray-200 rounded-lg cursor-pointer"></div>
                                <div><label for="letter-spacing" class="block text-sm font-medium text-gray-700">Espacement Lettres: <span id="letter-spacing-value">0</span>px</label><input type="range" id="letter-spacing" min="-2" max="5" step="0.1" value="0" class="cv-input w-full h-2 bg-gray-200 rounded-lg cursor-pointer"></div>
                                <div><label for="word-spacing" class="block text-sm font-medium text-gray-700">Espacement Mots: <span id="word-spacing-value">0</span>px</label><input type="range" id="word-spacing" min="-5" max="10" step="0.5" value="0" class="cv-input w-full h-2 bg-gray-200 rounded-lg cursor-pointer"></div>
                            </div>
                        </div>
                    </details>

                    <!-- ADVANCED LAYOUT OPTIONS -->
                    <details class="control-group" open>
                        <summary><span>Options Avancées</span><label class="completion-label"><input type="checkbox" id="completion-layout-advanced" class="completion-checkbox"><span>Fait ✅</span></label></summary>
                        <div class="control-group-content space-y-4">
                            <div>
                                <label class="text-sm font-medium text-gray-700 mb-2 block">Alignements</label>
                                <div class="grid grid-cols-3 gap-2">
                                    <button data-text-align="left" class="text-align-btn bg-gray-200 p-2 rounded-md text-sm">⬅️ Gauche</button>
                                    <button data-text-align="center" class="text-align-btn bg-gray-200 p-2 rounded-md text-sm">⬌ Centré</button>
                                    <button data-text-align="right" class="text-align-btn bg-gray-200 p-2 rounded-md text-sm">➡️ Droite</button>
                                    <button data-text-align="justify" class="text-align-btn bg-gray-200 p-2 rounded-md text-sm">⬌ Justifié</button>
                                    <button data-text-align="mixed" class="text-align-btn bg-gray-200 p-2 rounded-md text-sm">🎨 Mixte</button>
                                    <button data-text-align="dynamic" class="text-align-btn bg-gray-200 p-2 rounded-md text-sm">🤖 IA</button>
                                </div>
                            </div>
                            <div>
                                <label class="text-sm font-medium text-gray-700 mb-2 block">Indentations</label>
                                <div class="grid grid-cols-2 gap-4">
                                    <div><label for="paragraph-indent" class="block text-xs text-gray-600">Retrait Paragraphe: <span id="paragraph-indent-value">0</span>rem</label><input type="range" id="paragraph-indent" min="0" max="3" step="0.1" value="0" class="cv-input w-full h-2 bg-gray-200 rounded-lg cursor-pointer"></div>
                                    <div><label for="list-indent" class="block text-xs text-gray-600">Retrait Listes: <span id="list-indent-value">1</span>rem</label><input type="range" id="list-indent" min="0.5" max="4" step="0.1" value="1" class="cv-input w-full h-2 bg-gray-200 rounded-lg cursor-pointer"></div>
                                </div>
                            </div>
                            <div>
                                <label class="text-sm font-medium text-gray-700 mb-2 block">Effets visuels</label>
                                <div class="grid grid-cols-2 gap-2">
                                    <label class="flex items-center gap-2 text-sm"><input type="checkbox" id="drop-shadows" class="cv-input">Ombres portées</label>
                                    <label class="flex items-center gap-2 text-sm"><input type="checkbox" id="rounded-corners" class="cv-input">Coins arrondis</label>
                                    <label class="flex items-center gap-2 text-sm"><input type="checkbox" id="section-borders" class="cv-input">Bordures sections</label>
                                    <label class="flex items-center gap-2 text-sm"><input type="checkbox" id="alternating-bg" class="cv-input">Fond alterné</label>
                                </div>
                            </div>
                        </div>
                    </details>
                </div>
                    </details>
                </div>
                
                <!-- TAB: Styles Globaux -->
                <div id="panel-styles" class="tab-panel hidden space-y-4 pt-3">
                    <!-- IA STYLE GENERATOR -->
                    <details class="control-group" open>
                        <summary><span>🎨 Générateur IA de Styles</span><label class="completion-label"><input type="checkbox" id="completion-styles-ai" class="completion-checkbox"><span>Fait ✅</span></label></summary>
                        <div class="control-group-content space-y-3">
                            <button id="ai-style-professional" class="w-full bg-gradient-to-r from-gray-700 to-blue-800 text-white py-3 px-4 rounded-md hover:from-gray-800 hover:to-blue-900 flex items-center justify-center gap-2">
                                <i class="fas fa-briefcase"></i> Style Professionnel IA
                            </button>
                            <button id="ai-style-creative" class="w-full bg-gradient-to-r from-purple-600 to-pink-600 text-white py-3 px-4 rounded-md hover:from-purple-700 hover:to-pink-700 flex items-center justify-center gap-2">
                                <i class="fas fa-paint-brush"></i> Style Créatif IA
                            </button>
                            <button id="ai-style-minimalist" class="w-full bg-gradient-to-r from-gray-400 to-gray-600 text-white py-3 px-4 rounded-md hover:from-gray-500 hover:to-gray-700 flex items-center justify-center gap-2">
                                <i class="fas fa-minus"></i> Style Minimaliste IA
                            </button>
                            <button id="ai-style-luxury" class="w-full bg-gradient-to-r from-yellow-600 to-yellow-800 text-white py-3 px-4 rounded-md hover:from-yellow-700 hover:to-yellow-900 flex items-center justify-center gap-2">
                                <i class="fas fa-crown"></i> Style Luxe IA
                            </button>
                            <button id="ai-style-random" class="w-full bg-gradient-to-r from-green-600 to-teal-600 text-white py-3 px-4 rounded-md hover:from-green-700 hover:to-teal-700 flex items-center justify-center gap-2">
                                <i class="fas fa-magic-wand-sparkles"></i> Style Surprise IA
                            </button>
                        </div>
                    </details>

                    <!-- ADVANCED THEMES -->
                    <details class="control-group" open>
                        <summary><span>Thèmes Avancés</span><label class="completion-label"><input type="checkbox" id="completion-styles-themes" class="completion-checkbox"><span>Fait ✅</span></label></summary>
                        <div class="control-group-content space-y-4">
                            <div id="theme-buttons" class="grid grid-cols-3 gap-2">
                                <button data-theme="professional" class="theme-btn bg-gray-200 p-3 rounded-md text-sm">💼 Pro</button>
                                <button data-theme="creative" class="theme-btn bg-gray-200 p-3 rounded-md text-sm">🎨 Créatif</button>
                                <button data-theme="modern" class="theme-btn bg-gray-200 p-3 rounded-md text-sm">🚀 Moderne</button>
                                <button data-theme="elegant" class="theme-btn bg-gray-200 p-3 rounded-md text-sm">✨ Élégant</button>
                                <button data-theme="tech" class="theme-btn bg-gray-200 p-3 rounded-md text-sm">💻 Tech</button>
                                <button data-theme="artistic" class="theme-btn bg-gray-200 p-3 rounded-md text-sm">🎭 Artistique</button>
                                <button data-theme="minimalist" class="theme-btn bg-gray-200 p-3 rounded-md text-sm">⚪ Minimal</button>
                                <button data-theme="luxury" class="theme-btn bg-gray-200 p-3 rounded-md text-sm">👑 Luxe</button>
                                <button data-theme="vintage" class="theme-btn bg-gray-200 p-3 rounded-md text-sm">📜 Vintage</button>
                            </div>
                            <button id="random-theme" class="w-full bg-purple-500 text-white py-2 px-4 rounded-md hover:bg-purple-600 mt-3">🎲 Thème Aléatoire</button>
                        </div>
                    </details>

                    <!-- ADVANCED COLORS -->
                    <details class="control-group" open>
                        <summary><span>Palette de Couleurs Avancée</span><label class="completion-label"><input type="checkbox" id="completion-styles-colors" class="completion-checkbox"><span>Fait ✅</span></label></summary>
                        <div class="control-group-content space-y-4">
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label for="primary-color-picker" class="block text-sm font-medium text-gray-700">Couleur Principale</label>
                                    <input type="color" id="primary-color-picker" value="#2563eb" class="cv-input w-full h-12 p-1 border rounded-md">
                                </div>
                                <div>
                                    <label for="secondary-color-picker" class="block text-sm font-medium text-gray-700">Couleur Secondaire</label>
                                    <input type="color" id="secondary-color-picker" value="#334155" class="cv-input w-full h-12 p-1 border rounded-md">
                                </div>
                                <div>
                                    <label for="accent-color-picker" class="block text-sm font-medium text-gray-700">Couleur d'Accent</label>
                                    <input type="color" id="accent-color-picker" value="#f59e0b" class="cv-input w-full h-12 p-1 border rounded-md">
                                </div>
                                <div>
                                    <label for="neutral-color-picker" class="block text-sm font-medium text-gray-700">Couleur Neutre</label>
                                    <input type="color" id="neutral-color-picker" value="#6b7280" class="cv-input w-full h-12 p-1 border rounded-md">
                                </div>
                                <div>
                                    <label for="background-color-picker" class="block text-sm font-medium text-gray-700">Arrière-plan</label>
                                    <input type="color" id="background-color-picker" value="#ffffff" class="cv-input w-full h-12 p-1 border rounded-md">
                                </div>
                                <div>
                                    <label for="text-color-picker" class="block text-sm font-medium text-gray-700">Texte Principal</label>
                                    <input type="color" id="text-color-picker" value="#1f2937" class="cv-input w-full h-12 p-1 border rounded-md">
                                </div>
                            </div>
                            <div class="grid grid-cols-3 gap-2 mt-4">
                                <button id="ai-harmonious-colors" class="bg-blue-500 text-white py-2 px-3 rounded-md hover:bg-blue-600 text-sm">🎨 Harmonie IA</button>
                                <button id="ai-contrast-colors" class="bg-purple-500 text-white py-2 px-3 rounded-md hover:bg-purple-600 text-sm">⚡ Contraste IA</button>
                                <button id="random-palette" class="bg-orange-500 text-white py-2 px-3 rounded-md hover:bg-orange-600 text-sm">🎲 Palette Aléatoire</button>
                            </div>
                            <!-- Palettes pré-définies -->
                            <div>
                                <label class="text-sm font-medium text-gray-700 mb-2 block">Palettes Pré-définies</label>
                                <div class="grid grid-cols-4 gap-2">
                                    <button data-palette="ocean" class="palette-btn h-8 rounded-md" style="background: linear-gradient(90deg, #0ea5e9, #06b6d4, #10b981);"></button>
                                    <button data-palette="sunset" class="palette-btn h-8 rounded-md" style="background: linear-gradient(90deg, #f59e0b, #ef4444, #ec4899);"></button>
                                    <button data-palette="forest" class="palette-btn h-8 rounded-md" style="background: linear-gradient(90deg, #16a34a, #84cc16, #65a30d);"></button>
                                    <button data-palette="royal" class="palette-btn h-8 rounded-md" style="background: linear-gradient(90deg, #7c3aed, #a855f7, #3b82f6);"></button>
                                    <button data-palette="autumn" class="palette-btn h-8 rounded-md" style="background: linear-gradient(90deg, #dc2626, #ea580c, #d97706);"></button>
                                    <button data-palette="mono" class="palette-btn h-8 rounded-md" style="background: linear-gradient(90deg, #374151, #6b7280, #9ca3af);"></button>
                                    <button data-palette="pastel" class="palette-btn h-8 rounded-md" style="background: linear-gradient(90deg, #fbbf24, #f472b6, #a78bfa);"></button>
                                    <button data-palette="neon" class="palette-btn h-8 rounded-md" style="background: linear-gradient(90deg, #06ffa5, #00d4ff, #ff006e);"></button>
                                </div>
                            </div>
                        </div>
                    </details>

                    <!-- ADVANCED FONTS -->
                    <details class="control-group" open>
                        <summary><span>Typographie Professionnelle</span><label class="completion-label"><input type="checkbox" id="completion-styles-fonts" class="completion-checkbox"><span>Fait ✅</span></label></summary>
                        <div class="control-group-content space-y-4">
                            <div class="grid grid-cols-1 gap-4">
                                <div>
                                    <label for="font-family-h1-select" class="block text-sm font-medium text-gray-700">Titre Principal (H1)</label>
                                    <select id="font-family-h1-select" class="cv-input w-full p-2 border rounded-md"></select>
                                </div>
                                <div>
                                    <label for="font-family-h2-select" class="block text-sm font-medium text-gray-700">Titres de Section (H2)</label>
                                    <select id="font-family-h2-select" class="cv-input w-full p-2 border rounded-md"></select>
                                </div>
                                <div>
                                    <label for="font-family-h3-select" class="block text-sm font-medium text-gray-700">Sous-titres (H3)</label>
                                    <select id="font-family-h3-select" class="cv-input w-full p-2 border rounded-md"></select>
                                </div>
                                <div>
                                    <label for="font-family-body-select" class="block text-sm font-medium text-gray-700">Corps de Texte</label>
                                    <select id="font-family-body-select" class="cv-input w-full p-2 border rounded-md"></select>
                                </div>
                                <div>
                                    <label for="font-family-accent-select" class="block text-sm font-medium text-gray-700">Texte d'Accent</label>
                                    <select id="font-family-accent-select" class="cv-input w-full p-2 border rounded-md"></select>
                                </div>
                            </div>
                            <div class="grid grid-cols-3 gap-2">
                                <button id="ai-font-pairing" class="bg-indigo-500 text-white py-2 px-3 rounded-md hover:bg-indigo-600 text-sm">🤖 Pairing IA</button>
                                <button id="random-fonts" class="bg-purple-500 text-white py-2 px-3 rounded-md hover:bg-purple-600 text-sm">🎲 Polices Aléatoires</button>
                                <button id="reset-fonts" class="bg-gray-500 text-white py-2 px-3 rounded-md hover:bg-gray-600 text-sm">↺ Reset</button>
                            </div>
                        </div>
                    </details>

                    <!-- VISUAL EFFECTS -->
                    <details class="control-group" open>
                        <summary><span>Effets Visuels</span><label class="completion-label"><input type="checkbox" id="completion-styles-effects" class="completion-checkbox"><span>Fait ✅</span></label></summary>
                        <div class="control-group-content space-y-4">
                            <div>
                                <label class="text-sm font-medium text-gray-700 mb-2 block">Style des Titres de Section</label>
                                <div class="grid grid-cols-2 gap-2">
                                    <button data-title-style="style-underline" class="section-title-style-btn bg-gray-200 p-3 rounded-md text-sm">📝 Souligné</button>
                                    <button data-title-style="style-side-line" class="section-title-style-btn bg-gray-200 p-3 rounded-md text-sm">📏 Ligne Côté</button>
                                    <button data-title-style="style-background" class="section-title-style-btn bg-gray-200 p-3 rounded-md text-sm">🎨 Fond Coloré</button>
                                    <button data-title-style="style-boxed" class="section-title-style-btn bg-gray-200 p-3 rounded-md text-sm">📦 Encadré</button>
                                    <button data-title-style="style-gradient" class="section-title-style-btn bg-gray-200 p-3 rounded-md text-sm">🌈 Dégradé</button>
                                    <button data-title-style="style-shadow" class="section-title-style-btn bg-gray-200 p-3 rounded-md text-sm">👤 Ombre</button>
                                    <button data-title-style="style-3d" class="section-title-style-btn bg-gray-200 p-3 rounded-md text-sm">🔮 3D</button>
                                    <button data-title-style="style-neon" class="section-title-style-btn bg-gray-200 p-3 rounded-md text-sm">💡 Néon</button>
                                </div>
                            </div>
                            <div>
                                <label class="text-sm font-medium text-gray-700 mb-2 block">Effets Globaux</label>
                                <div class="grid grid-cols-2 gap-2">
                                    <label class="flex items-center gap-2 text-sm"><input type="checkbox" id="global-shadows" class="cv-input">🌑 Ombres globales</label>
                                    <label class="flex items-center gap-2 text-sm"><input type="checkbox" id="global-gradients" class="cv-input">🌈 Dégradés</label>
                                    <label class="flex items-center gap-2 text-sm"><input type="checkbox" id="global-borders" class="cv-input">🔲 Bordures</label>
                                    <label class="flex items-center gap-2 text-sm"><input type="checkbox" id="global-rounded" class="cv-input">🔘 Coins arrondis</label>
                                    <label class="flex items-center gap-2 text-sm"><input type="checkbox" id="global-animation" class="cv-input">⚡ Animations</label>
                                    <label class="flex items-center gap-2 text-sm"><input type="checkbox" id="global-texture" class="cv-input">🎨 Textures</label>
                                </div>
                            </div>
                            <div>
                                <label class="text-sm font-medium text-gray-700 mb-2 block">Opacité et Transparence</label>
                                <div class="grid grid-cols-2 gap-4">
                                    <div><label for="section-opacity" class="block text-xs text-gray-600">Opacité Sections: <span id="section-opacity-value">1</span></label><input type="range" id="section-opacity" min="0.1" max="1" step="0.05" value="1" class="cv-input w-full h-2 bg-gray-200 rounded-lg cursor-pointer"></div>
                                    <div><label for="background-opacity" class="block text-xs text-gray-600">Opacité Fond: <span id="background-opacity-value">1</span></label><input type="range" id="background-opacity" min="0.1" max="1" step="0.05" value="1" class="cv-input w-full h-2 bg-gray-200 rounded-lg cursor-pointer"></div>
                                </div>
                            </div>
                        </div>
                    </details>

                    <!-- PATTERN & TEXTURE -->
                    <details class="control-group" open>
                        <summary><span>Motifs & Textures</span><label class="completion-label"><input type="checkbox" id="completion-styles-patterns" class="completion-checkbox"><span>Fait ✅</span></label></summary>
                        <div class="control-group-content space-y-4">
                            <div>
                                <label class="text-sm font-medium text-gray-700 mb-2 block">Motifs de Fond</label>
                                <div class="grid grid-cols-3 gap-2">
                                    <button data-pattern="none" class="pattern-btn bg-gray-200 p-3 rounded-md text-sm">🚫 Aucun</button>
                                    <button data-pattern="dots" class="pattern-btn bg-gray-200 p-3 rounded-md text-sm">⚫ Points</button>
                                    <button data-pattern="lines" class="pattern-btn bg-gray-200 p-3 rounded-md text-sm">📏 Lignes</button>
                                    <button data-pattern="grid" class="pattern-btn bg-gray-200 p-3 rounded-md text-sm">⚏ Grille</button>
                                    <button data-pattern="waves" class="pattern-btn bg-gray-200 p-3 rounded-md text-sm">🌊 Vagues</button>
                                    <button data-pattern="geometric" class="pattern-btn bg-gray-200 p-3 rounded-md text-sm">🔷 Géométrique</button>
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div><label for="pattern-opacity" class="block text-xs text-gray-600">Opacité Motif: <span id="pattern-opacity-value">0.1</span></label><input type="range" id="pattern-opacity" min="0" max="0.5" step="0.01" value="0.1" class="cv-input w-full h-2 bg-gray-200 rounded-lg cursor-pointer"></div>
                                <div><label for="pattern-scale" class="block text-xs text-gray-600">Échelle Motif: <span id="pattern-scale-value">1</span></label><input type="range" id="pattern-scale" min="0.5" max="3" step="0.1" value="1" class="cv-input w-full h-2 bg-gray-200 rounded-lg cursor-pointer"></div>
                            </div>
                        </div>
                    </details>
                </div>
                
                <!-- TAB: Recrutement -->
                <div id="panel-recrutement" class="tab-panel hidden space-y-4 pt-3">
                    <details class="control-group" open>
                        <summary><span>Présentation Recruteur</span><label class="completion-label"><input type="checkbox" id="completion-ia-presentation" class="completion-checkbox"><span>Fait ✅</span></label></summary>
                        <div class="control-group-content space-y-3">
                            <input type="text" id="qualification-dispo" placeholder="Disponibilité" class="cv-input w-full p-2 border rounded-md">
                            <input type="text" id="qualification-salaire" placeholder="Prétentions salariales" class="cv-input w-full p-2 border rounded-md">
                            <input type="text" id="qualification-loc" placeholder="Localisation" class="cv-input w-full p-2 border rounded-md">
                            <button id="generate-mail-btn" class="mt-2 w-full bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700 flex items-center justify-center gap-2"><i class="fas fa-wand-magic-sparkles"></i> Générer le mail</button>
                            <textarea id="recruiter-mail-content" rows="8" class="cv-input w-full p-2 border rounded-md mt-2" placeholder="Le mail de présentation apparaîtra ici..."></textarea>
                        </div>
                    </details>
                    <details class="control-group" open>
                        <summary><span>Bannière Recruteur</span><label class="completion-label"><input type="checkbox" id="completion-banner-main" class="completion-checkbox"><span>Fait ✅</span></label></summary>
                        <div class="control-group-content space-y-3">
                            <div class="flex justify-between items-center">
                                <h3 class="font-semibold text-gray-700">Bannière Recruteur</h3>
                                <button id="reset-recruiter-btn" class="text-sm text-gray-500 hover:text-red-600" title="Réinitialiser les informations recruteur"><i class="fas fa-undo"></i></button>
                            </div>
                            <div id="banner-fix-controls">
                                <button id="fix-banner-top-btn" class="w-full bg-teal-600 text-white py-2 px-4 rounded-md hover:bg-teal-700 flex items-center justify-center gap-2">
                                    <i class="fas fa-arrow-up"></i>Fixer en haut
                                </button>
                                <button id="fix-banner-bottom-btn" class="w-full bg-teal-600 text-white py-2 px-4 rounded-md hover:bg-teal-700 flex items-center justify-center gap-2 mt-2">
                                    <i class="fas fa-arrow-down"></i>Fixer en bas
                                </button>
                            </div>
                            
                            <button id="modular-banner-btn" class="cv-input w-full bg-orange-500 text-white py-2 px-4 rounded-md hover:bg-orange-600 flex items-center justify-center gap-2 hidden">
                                <i class="fas fa-arrows-up-down-left-right"></i>Rendre modulaire
                            </button>
                            
                            <label class="flex items-center gap-2 text-sm">
                                <input type="checkbox" id="toggle-banner-checkbox" class="cv-input">
                                Afficher la bannière
                            </label>
                            
                            <label for="banner-style-select" class="text-sm font-medium">Style de Bannière</label>
                            <select id="banner-style-select" class="cv-input w-full p-2 border rounded-md">
                                <option value="banner-style-modern">Moderne</option>
                                <option value="banner-style-elegant">Élégant</option>
                                <option value="banner-style-discret">Discret</option>
                                <option value="banner-style-carte">Carte</option>
                                <option value="banner-style-degrade">Dégradé</option>
                                <option value="banner-style-premium">Premium</option>
                                <option value="banner-style-minimal">Minimal</option>
                                <option value="banner-style-encadre">Encadré</option>
                                <option value="banner-style-ligne-haute">Ligne Haute</option>
                            </select>
                            
                            <p class="text-sm font-medium">Alignement</p>
                            <div class="flex gap-2">
                                <button data-banner-align="left" class="banner-align-btn flex-1 bg-gray-200 p-2 rounded-md text-sm">
                                    <i class="fas fa-align-left"></i>
                                </button>
                                <button data-banner-align="center" class="banner-align-btn flex-1 bg-gray-200 p-2 rounded-md text-sm">
                                    <i class="fas fa-align-center"></i>
                                </button>
                                <button data-banner-align="right" class="banner-align-btn flex-1 bg-gray-200 p-2 rounded-md text-sm">
                                    <i class="fas fa-align-right"></i>
                                </button>
                                <button id="banner-invert-btn" class="p-2 bg-gray-200 rounded-md text-sm" title="Inverser Logo/Texte">
                                    <i class="fas fa-right-left"></i>
                                </button>
                            </div>
                            
                            <p class="text-sm font-medium">Taille Logo</p>
                            <div class="flex gap-2">
                                <button data-logo-size="sm" class="logo-size-btn flex-1 bg-gray-200 p-2 rounded-md text-sm">P</button>
                                <button data-logo-size="md" class="logo-size-btn flex-1 bg-gray-200 p-2 rounded-md text-sm">M</button>
                                <button data-logo-size="lg" class="logo-size-btn flex-1 bg-gray-200 p-2 rounded-md text-sm">G</button>
                                <button data-logo-size="xl" class="logo-size-btn flex-1 bg-gray-200 p-2 rounded-md text-sm">XL</button>
                                <button data-logo-size="xxl" class="logo-size-btn flex-1 bg-gray-200 p-2 rounded-md text-sm">XXL</button>
                            </div>
                            
                            <div>
                                <label for="banner-element-spacing" class="block text-sm font-medium text-gray-700">
                                    Espace Bannière: <span id="banner-element-spacing-value">1</span>rem
                                </label>
                                <input type="range" id="banner-element-spacing" min="0.5" max="4" step="0.1" value="1" class="cv-input w-full h-2 bg-gray-200 rounded-lg cursor-pointer">
                            </div>
                            
                            <input type="text" id="banner-nom" placeholder="Votre Nom & Prénom" class="banner-input w-full p-2 border rounded-md">
                            <input type="text" id="banner-poste" placeholder="Votre Poste" class="banner-input w-full p-2 border rounded-md">
                            <input type="email" id="banner-email" placeholder="Email" class="banner-input w-full p-2 border rounded-md">
                            <input type="tel" id="banner-tel" placeholder="Téléphone" class="banner-input w-full p-2 border rounded-md">
                            
                            <div>
                                <label for="banner-image" class="block text-sm font-medium text-gray-700">Photo/Logo</label>
                                <input type="file" id="banner-image" accept="image/*" class="banner-input mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                            </div>
                        </div>
                    </details>
                    <details class="control-group" open>
                        <summary><span>Image de Fond Bannière</span><label class="completion-label"><input type="checkbox" id="completion-banner-bg" class="completion-checkbox"><span>Fait ✅</span></label></summary>
                        <div class="control-group-content space-y-4">
                            <div>
                                <label for="banner-bg-image" class="block text-sm font-medium text-gray-700">Télécharger une image</label>
                                <input type="file" id="banner-bg-image" accept="image/*" class="banner-input mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                            </div>
                            <div>
                                <label for="banner-bg-opacity" class="block text-sm font-medium text-gray-700">Opacité: <span id="banner-bg-opacity-value">1</span></label>
                                <input type="range" id="banner-bg-opacity" min="0" max="1" step="0.05" value="1" class="cv-input w-full h-2 bg-gray-200 rounded-lg cursor-pointer">
                            </div>
                            <div>
                                <label for="banner-bg-blur" class="block text-sm font-medium text-gray-700">Flou: <span id="banner-bg-blur-value">0</span>px</label>
                                <input type="range" id="banner-bg-blur" min="0" max="20" step="1" value="0" class="cv-input w-full h-2 bg-gray-200 rounded-lg cursor-pointer">
                            </div>
                            <label class="flex items-center gap-2 text-sm"><input type="checkbox" id="banner-bg-grayscale" class="cv-input">Image en noir et blanc</label>
                            <button id="remove-banner-bg-btn" class="w-full bg-red-500 text-white py-2 px-4 rounded-md hover:bg-red-600 flex items-center justify-center gap-2"><i class="fas fa-trash"></i> Supprimer l'image de fond</button>
                        </div>
                    </details>
                    <details class="control-group" open>
                        <summary><span>Style du Texte Bannière</span><label class="completion-label"><input type="checkbox" id="completion-banner-text" class="completion-checkbox"><span>Fait ✅</span></label></summary>
                        <div class="control-group-content space-y-4">
                            <button id="randomize-banner-style-btn" class="w-full bg-indigo-500 text-white py-2 px-4 rounded-md hover:bg-indigo-600 flex items-center justify-center gap-2"><i class="fas fa-dice"></i> Style Aléatoire</button><div class="border-t pt-4 mt-4"><h4 class="font-semibold text-sm mb-2">Nom & Prénom</h4><label class="text-xs">Police</label><select id="banner-nom-font" class="cv-input w-full p-1 border text-sm rounded-md"><option value="'Montserrat', sans-serif">Montserrat</option><option value="'Playfair Display', serif">Playfair Display</option><option value="'Oswald', sans-serif">Oswald</option><option value="'Cormorant Garamond', serif">Cormorant Garamond</option><option value="'Merriweather', serif">Merriweather</option><option value="'Lato', sans-serif">Lato</option></select><label class="text-xs mt-2 block">Taille: <span id="banner-nom-size-value">24</span>pt</label><input type="range" id="banner-nom-size" min="14" max="40" step="1" value="24" class="cv-input w-full h-2 bg-gray-200 rounded-lg cursor-pointer"><div class="flex items-center gap-2 mt-2"><label class="text-xs">Couleur:</label><input type="color" id="banner-nom-color" value="#334155" class="cv-input w-full h-8 p-1 border rounded-md"><button id="banner-nom-bold" class="style-toggle-btn p-1 px-2 rounded-md bg-gray-200 text-sm"><i class="fas fa-bold"></i></button><button id="banner-nom-italic" class="style-toggle-btn p-1 px-2 rounded-md bg-gray-200 text-sm"><i class="fas fa-italic"></i></button></div></div><div class="border-t pt-4 mt-4"><h4 class="font-semibold text-sm mb-2">Poste</h4><label class="text-xs mt-2 block">Taille: <span id="banner-poste-size-value">12</span>pt</label><input type="range" id="banner-poste-size" min="8" max="20" step="0.5" value="12" class="cv-input w-full h-2 bg-gray-200 rounded-lg cursor-pointer"><div class="flex items-center gap-2 mt-2"><label class="text-xs">Couleur:</label><input type="color" id="banner-poste-color" value="#334155" class="cv-input w-full h-8 p-1 border rounded-md"><button id="banner-poste-bold" class="style-toggle-btn p-1 px-2 rounded-md bg-gray-200 text-sm"><i class="fas fa-bold"></i></button><button id="banner-poste-italic" class="style-toggle-btn p-1 px-2 rounded-md bg-gray-200 text-sm"><i class="fas fa-italic"></i></button></div></div><div class="border-t pt-4 mt-4"><h4 class="font-semibold text-sm mb-2">Coordonnées</h4><label class="text-xs mt-2 block">Taille: <span id="banner-contact-size-value">9</span>pt</label><input type="range" id="banner-contact-size" min="7" max="14" step="0.5" value="9" class="cv-input w-full h-2 bg-gray-200 rounded-lg cursor-pointer"><div class="flex items-center gap-2 mt-2"><label class="text-xs">Couleur:</label><input type="color" id="banner-contact-color" value="#334155" class="cv-input w-full h-8 p-1 border rounded-md"><button id="banner-contact-bold" class="style-toggle-btn p-1 px-2 rounded-md bg-gray-200 text-sm"><i class="fas fa-bold"></i></button><button id="banner-contact-italic" class="style-toggle-btn p-1 px-2 rounded-md bg-gray-200 text-sm"><i class="fas fa-italic"></i></button></div></div>
                        </div>
                    </details>
                </div>
                
                <!-- TAB: Paramètres -->
                <div id="panel-settings" class="tab-panel hidden space-y-4 pt-3">
                    <details class="control-group" open>
                        <summary><span>Actions CV</span><label class="completion-label"><input type="checkbox" id="completion-actions" class="completion-checkbox"><span>Fait ✅</span></label></summary>
                        <div class="control-group-content space-y-3">
                            <div class="grid grid-cols-2 gap-2">
                                <button id="download-pdf-btn" class="w-full bg-gray-800 text-white py-2 px-4 rounded-md hover:bg-gray-900 flex items-center justify-center gap-2"><i class="fa-solid fa-download"></i> PDF</button>
                                <button id="share-btn" class="w-full bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700 flex items-center justify-center gap-2"><i class="fa-solid fa-share-alt"></i> Partager</button>
                            </div>
                            <button id="anonymize-btn" class="w-full bg-slate-500 text-white py-2 px-4 rounded-md hover:bg-slate-600 flex items-center justify-center gap-2"><i class="fa-solid fa-user-secret"></i> Anonymiser le CV</button>
                            <button id="reset-cv-btn" class="w-full bg-red-600 text-white py-2 px-4 rounded-md hover:bg-red-700 flex items-center justify-center gap-2"><i class="fa-solid fa-file-circle-plus"></i> Nouveau CV</button>
                        </div>
                    </details>
                    
                    <details class="control-group" open>
                        <summary><span>Outils</span><label class="completion-label"><input type="checkbox" id="completion-tools" class="completion-checkbox"><span>Fait ✅</span></label></summary>
                        <div class="control-group-content space-y-3">
                            <button id="toggle-overflow-btn" class="w-full bg-yellow-500 text-white py-2 px-4 rounded-md hover:bg-yellow-600 flex items-center justify-center gap-2"><i class="fa-solid fa-ruler-combined"></i> Détection Dépassement</button>
                            <button id="toggle-presentation-mode-btn" class="w-full bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 flex items-center justify-center gap-2"><i class="fa-solid fa-eye"></i> Mode Présentation</button>
                        </div>
                    </details>
                </div>
            </div>
        </div>

        <!-- PANNEAU D'APERÇU AVEC ZOOM -->
        <div class="preview-panel" id="preview-area">
            <!-- CONTRÔLES DE ZOOM -->
            <div class="zoom-controls">
                <button class="zoom-btn" id="zoom-out" title="Zoom arrière">−</button>
                <span class="zoom-level" id="zoom-level">100%</span>
                <button class="zoom-btn" id="zoom-in" title="Zoom avant">+</button>
                <button class="zoom-btn" id="zoom-reset" title="Zoom réel" style="width: auto; padding: 0 12px; font-size: 12px;">1:1</button>
            </div>
            
            <!-- CONTENEUR D'APERÇU -->
            <div class="preview-container">
                <div class="cv-preview-wrapper zoom-100" id="cv-preview-wrapper">
                <div class="a4-page-container">
                    <div id="page-1" class="a4-page">
                        <div id="fixed-banner-top"></div>
                        <div class="cv-body-container layout-1-col">
                            <div id="cv-col-1-1" class="cv-column">
                                <div id="banner-module" class="cv-module">
                                    <div class="drag-handle"><i class="fas fa-grip-vertical"></i></div>
                                    <div id="recruiter-banner" class="banner-align-left">
                                        <img id="banner-bg-img-preview" src="" alt="Banner background" class="absolute top-0 left-0 w-full h-full object-cover z-0 transition-all duration-300">
                                        <div class="banner-content-wrapper">
                                            <img id="banner-img-preview" class="logo-md" src="https://placehold.co/100x100/EFEFEF/AAAAAA&text=Photo" alt="Photo recruteur" onerror="this.onerror=null; this.src='https://placehold.co/100x100/EFEFEF/AAAAAA&text=Photo';">
                                            <div class="banner-content">
                                                <p id="banner-nom-preview" class="item-title" contenteditable="true"></p>
                                                <p id="banner-poste-preview" contenteditable="true"></p>
                                                <p id="banner-contact-preview"><span id="banner-email-preview" contenteditable="true"></span> | <span id="banner-tel-preview" contenteditable="true"></span></p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div id="header-module" class="cv-module"><div class="drag-handle"><i class="fas fa-grip-vertical"></i></div><div class="cv-header text-center"><div class="editable-wrapper"><h1 id="cv-nom-prenom-preview" contenteditable="true">Prénom NOM</h1><span class="delete-line-btn"><i class="fas fa-times"></i></span></div><div class="editable-wrapper"><p id="cv-poste-preview" contenteditable="true">Poste Recherché</p><span class="delete-line-btn"><i class="fas fa-times"></i></span></div></div></div>
                                <div id="qualification-module" class="cv-module"><div class="drag-handle"><i class="fas fa-grip-vertical"></i></div><div id="qualification-preview" class="flex justify-center gap-4 text-center text-sm p-2 bg-slate-50 rounded-md"></div></div>
                                <div id="description-module" class="cv-module"><div class="drag-handle"><i class="fas fa-grip-vertical"></i></div><h2 class="section-title style-underline" data-section-id="description"><i class="fas fa-user-circle section-icon"></i><span contenteditable="true">Profil</span><div class="section-ai-actions"><button class="ai-action-btn toggle-visibility-btn" title="Masquer/Afficher la section"><i class="fas fa-eye"></i></button><button class="ai-action-btn" data-action="rewrite-profile" title="Réécrire le profil avec l'IA"><i class="fas fa-magic-wand-sparkles"></i></button></div></h2><div id="cv-description-preview"></div></div>
                                <div id="experience-module" class="cv-module"><div class="drag-handle"><i class="fas fa-grip-vertical"></i></div><h2 class="section-title style-underline" data-section-id="experience"><i class="fas fa-briefcase section-icon"></i><span contenteditable="true">Expérience</span><div class="section-ai-actions"><button class="ai-action-btn toggle-visibility-btn" title="Masquer/Afficher la section"><i class="fas fa-eye"></i></button><button class="ai-action-btn" data-action="summarize-experience" title="Synthétiser les expériences avec l'IA (5 lignes max)"><i class="fas fa-magic-wand-sparkles"></i></button></div></h2><div id="cv-experience-preview"></div></div>
                                <div id="formation-module" class="cv-module"><div class="drag-handle"><i class="fas fa-grip-vertical"></i></div><h2 class="section-title style-underline" data-section-id="formation"><i class="fas fa-graduation-cap section-icon"></i><span contenteditable="true">Formation</span><div class="section-ai-actions"><button class="ai-action-btn toggle-visibility-btn" title="Masquer/Afficher la section"><i class="fas fa-eye"></i></button><button class="ai-action-btn" data-action="rewrite-formation" title="Améliorer les formations avec l'IA"><i class="fas fa-magic-wand-sparkles"></i></button></div></h2><div id="cv-formation-preview"></div></div>
                                <div id="competences-module" class="cv-module"><div class="drag-handle"><i class="fas fa-grip-vertical"></i></div><h2 class="section-title style-underline" data-section-id="competences"><i class="fas fa-star section-icon"></i><span contenteditable="true">Compétences</span><div class="section-ai-actions"><button class="ai-action-btn toggle-visibility-btn" title="Masquer/Afficher la section"><i class="fas fa-eye"></i></button><button class="ai-action-btn" data-action="rewrite-skills" title="Améliorer les compétences avec l'IA"><i class="fas fa-magic-wand-sparkles"></i></button></div></h2><div id="cv-competences-preview" data-style="tags"></div></div>
                            </div>
                            <div id="cv-col-1-2" class="cv-column"></div>
                        </div>
                        <div id="fixed-banner-bottom"></div>
                    </div>
                     <button class="remove-page-btn no-print"><i class="fas fa-trash-can"></i></button>
                </div>
                 <div id="add-page-btn-wrapper" class="no-print">
                     <button id="add-page-btn" title="Ajouter une page"><i class="fas fa-plus"></i></button>
                 </div>
            </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- MODALS -->
    <div id="share-modal" class="modal-overlay">
        <div class="modal-content">
            <h2 class="text-xl font-bold mb-4">Partager le CV</h2>
            <p class="text-sm text-gray-600 mb-2">Copiez ce lien unique pour partager une version en lecture seule de ce CV.</p>
            <div class="flex items-center border rounded-md p-2 bg-gray-50">
                <input type="text" id="share-link-input" readonly class="flex-grow bg-transparent outline-none text-sm">
                <button id="copy-share-link-btn" class="ml-2 px-3 py-1 bg-blue-500 text-white text-sm rounded-md hover:bg-blue-600">Copier</button>
            </div>
            <div class="text-right mt-4">
                 <button id="close-share-modal" class="px-4 py-2 bg-gray-200 text-sm rounded-md hover:bg-gray-300">Fermer</button>
            </div>
        </div>
    </div>
    
    <div id="icon-picker-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">Choisir une icône</h2>
                <button id="close-icon-picker-modal" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
            </div>
            <div class="mb-4">
                <input type="text" id="icon-search-input" placeholder="Rechercher une icône..." class="w-full p-2 border rounded-md">
            </div>
            <div id="icon-picker-grid"></div>
        </div>
    </div>

    <div id="confirm-modal" class="modal-overlay">
        <div class="modal-content">
            <h2 id="confirm-modal-title" class="text-xl font-bold mb-4">Confirmation</h2>
            <p id="confirm-modal-text" class="text-gray-600 mb-6">Êtes-vous sûr ?</p>
            <div class="flex justify-end gap-4">
                <button id="confirm-modal-cancel-btn" class="px-4 py-2 bg-gray-200 text-sm rounded-md hover:bg-gray-300">Annuler</button>
                <button id="confirm-modal-ok-btn" class="px-4 py-2 bg-red-600 text-white text-sm rounded-md hover:bg-red-700">Confirmer</button>
            </div>
        </div>
    </div>

    <script type="module">
        // This script is now self-contained and does not use Firebase for saving.
        
        document.addEventListener('DOMContentLoaded', function() {
            // --- GLOBAL SELECTORS (STATIC) ---
            const controls = {
                aiInput: document.getElementById('ai-input'), analyzeBtn: document.getElementById('analyze-btn'), loader: document.getElementById('loader-overlay'), loaderText: document.getElementById('loader-text'),
                nom: document.getElementById('nom'), prenom: document.getElementById('prenom'), poste: document.getElementById('poste'),
                description: document.getElementById('description'), competences: document.getElementById('competences'), aiSynthesizeSkillsBtn: document.getElementById('ai-synthesize-skills-btn'),
                experienceList: document.getElementById('experience-list'), addExperienceBtn: document.getElementById('add-experience'),
                formationList: document.getElementById('formation-list'), addFormationBtn: document.getElementById('add-formation'),
                toggleBanner: document.getElementById('toggle-banner-checkbox'), bannerNom: document.getElementById('banner-nom'), bannerPoste: document.getElementById('banner-poste'), bannerEmail: document.getElementById('banner-email'), bannerTel: document.getElementById('banner-tel'), bannerImage: document.getElementById('banner-image'),
                bannerStyleSelect: document.getElementById('banner-style-select'), bannerInvertBtn: document.getElementById('banner-invert-btn'),
                fixBannerTopBtn: document.getElementById('fix-banner-top-btn'), fixBannerBottomBtn: document.getElementById('fix-banner-bottom-btn'), modularBannerBtn: document.getElementById('modular-banner-btn'),
                qualificationDispo: document.getElementById('qualification-dispo'), qualificationSalaire: document.getElementById('qualification-salaire'), qualificationLoc: document.getElementById('qualification-loc'),
                generateMailBtn: document.getElementById('generate-mail-btn'), recruiterMailContent: document.getElementById('recruiter-mail-content'),
                anonymizeBtn: document.getElementById('anonymize-btn'), downloadPdfBtn: document.getElementById('download-pdf-btn'),
                resetCvBtn: document.getElementById('reset-cv-btn'),
                togglePresentationModeBtn: document.getElementById('toggle-presentation-mode-btn'),
                toggleOverflowBtn: document.getElementById('toggle-overflow-btn'),
                collapseAllBtn: document.getElementById('collapse-all-btn'),
                // API Controls
                geminiApiKey: document.getElementById('gemini-api-key'),
                toggleApiKeyVisibility: document.getElementById('toggle-api-key-visibility'),
                saveGeminiApiKey: document.getElementById('save-gemini-api-key'),
                testGeminiApi: document.getElementById('test-gemini-api'),
                // Multiple Gemini Keys
                geminiKeysContainer: document.getElementById('gemini-keys-container'),
                addGeminiKey: document.getElementById('add-gemini-key'),
                testAllGeminiKeys: document.getElementById('test-all-gemini-keys'),
                activeGeminiKeysCount: document.getElementById('active-gemini-keys-count'),
                totalGeminiRequests: document.getElementById('total-gemini-requests'),
                // OpenAI Controls
                openaiApiKey: document.getElementById('openai-api-key'),
                toggleOpenaiKey: document.getElementById('toggle-openai-key'),
                openaiModel: document.getElementById('openai-model'),
                apiPriority: document.getElementById('api-priority'),
                testOpenaiConnection: document.getElementById('test-openai-connection'),
                combinedApiStatus: document.getElementById('combined-api-status'),
                combinedStatusIcon: document.getElementById('combined-status-icon'),
                combinedStatusText: document.getElementById('combined-status-text'),
                activeApiIndicator: document.getElementById('active-api-indicator'),
                // API Status
                apiStatus: document.getElementById('api-status'),
                apiStatusIcon: document.getElementById('api-status-icon'),
                apiStatusText: document.getElementById('api-status-text'),
                aiSummarizeBtn: document.getElementById('ai-summarize-btn'),
                resetRecruiterBtn: document.getElementById('reset-recruiter-btn'),
                aiLimitSkillsBtn: document.getElementById('ai-limit-skills-btn'),
                pageMargin: document.getElementById('page-margin'), pageMarginValue: document.getElementById('page-margin-value'),
                moduleSpacing: document.getElementById('module-spacing'), moduleSpacingValue: document.getElementById('module-spacing-value'),
                itemSpacing: document.getElementById('item-spacing'), itemSpacingValue: document.getElementById('item-spacing-value'),
                fontSizeH1: document.getElementById('font-size-h1'), fontSizeH1Value: document.getElementById('font-size-h1-value'),
                fontSizeH2: document.getElementById('font-size-h2'), fontSizeH2Value: document.getElementById('font-size-h2-value'),
                fontSizeP: document.getElementById('font-size-p'), fontSizePValue: document.getElementById('font-size-p-value'),
                fontSizeBanner: document.getElementById('font-size-banner'), fontSizeBannerValue: document.getElementById('font-size-banner-value'),
                bannerElementSpacing: document.getElementById('banner-element-spacing'), bannerElementSpacingValue: document.getElementById('banner-element-spacing-value'),
                lineHeight: document.getElementById('line-height'), lineHeightValue: document.getElementById('line-height-value'),
                paragraphSpacing: document.getElementById('paragraph-spacing'), paragraphSpacingValue: document.getElementById('paragraph-spacing-value'),
                randomizeBannerStyleBtn: document.getElementById('randomize-banner-style-btn'),
                bannerNomFont: document.getElementById('banner-nom-font'), bannerNomSize: document.getElementById('banner-nom-size'), bannerNomSizeValue: document.getElementById('banner-nom-size-value'), bannerNomColor: document.getElementById('banner-nom-color'), bannerNomBold: document.getElementById('banner-nom-bold'), bannerNomItalic: document.getElementById('banner-nom-italic'),
                bannerPosteSize: document.getElementById('banner-poste-size'), bannerPosteSizeValue: document.getElementById('banner-poste-size-value'), bannerPosteColor: document.getElementById('banner-poste-color'), bannerPosteBold: document.getElementById('banner-poste-bold'), bannerPosteItalic: document.getElementById('banner-poste-italic'),
                bannerContactSize: document.getElementById('banner-contact-size'), bannerContactSizeValue: document.getElementById('banner-contact-size-value'), bannerContactColor: document.getElementById('banner-contact-color'), bannerContactBold: document.getElementById('banner-contact-bold'), bannerContactItalic: document.getElementById('banner-contact-italic'),
                undoBtn: document.getElementById('undo-btn'), redoBtn: document.getElementById('redo-btn'),
                addSectionBtn: document.getElementById('add-section-btn'), customSectionsList: document.getElementById('custom-sections-list'), sectionSuggestionSelect: document.getElementById('section-suggestion-select'), newSectionTitleInput: document.getElementById('new-section-title-input'),
                primaryColorPicker: document.getElementById('primary-color-picker'),
                secondaryColorPicker: document.getElementById('secondary-color-picker'),
                aiColorBtn: document.getElementById('ai-color-btn'),
                bodyTextColorPicker: document.getElementById('body-text-color-picker'),
                fontFamilyH1Select: document.getElementById('font-family-h1-select'),
                fontFamilyH2Select: document.getElementById('font-family-h2-select'),
                fontFamilyBodySelect: document.getElementById('font-family-body-select'),
                shareBtn: document.getElementById('share-btn'), shareModal: document.getElementById('share-modal'), closeShareModal: document.getElementById('close-share-modal'), shareLinkInput: document.getElementById('share-link-input'), copyShareLinkBtn: document.getElementById('copy-share-link-btn'),
                iconPickerModal: document.getElementById('icon-picker-modal'), closeIconPickerModal: document.getElementById('close-icon-picker-modal'), iconPickerGrid: document.getElementById('icon-picker-grid'), iconSearchInput: document.getElementById('icon-search-input'),
                addPageBtn: document.getElementById('add-page-btn'),
                bannerBgImage: document.getElementById('banner-bg-image'),
                bannerBgOpacity: document.getElementById('banner-bg-opacity'),
                bannerBgOpacityValue: document.getElementById('banner-bg-opacity-value'),
                bannerBgBlur: document.getElementById('banner-bg-blur'),
                bannerBgBlurValue: document.getElementById('banner-bg-blur-value'),
                bannerBgGrayscale: document.getElementById('banner-bg-grayscale'),
                removeBannerBgBtn: document.getElementById('remove-banner-bg-btn'),
                skillsTextControls: document.getElementById('skills-text-controls'),
                skillsLevelControls: document.getElementById('skills-level-controls'),
                skillsLevelList: document.getElementById('skills-level-list'),
                addSkillLevelBtn: document.getElementById('add-skill-level-btn'),
                // AI Layout Buttons
                aiLayoutProfessional: document.getElementById('ai-layout-professional'),
                aiLayoutCreative: document.getElementById('ai-layout-creative'),
                aiLayoutModern: document.getElementById('ai-layout-modern'),
                aiLayoutRandom: document.getElementById('ai-layout-random'),
                // AI Style Buttons
                aiStyleProfessional: document.getElementById('ai-style-professional'),
                aiStyleCreative: document.getElementById('ai-style-creative'),
                aiStyleMinimalist: document.getElementById('ai-style-minimalist'),
                aiStyleLuxury: document.getElementById('ai-style-luxury'),
                aiStyleRandom: document.getElementById('ai-style-random'),
                confirmModal: {
                    overlay: document.getElementById('confirm-modal'),
                    title: document.getElementById('confirm-modal-title'),
                    text: document.getElementById('confirm-modal-text'),
                    okBtn: document.getElementById('confirm-modal-ok-btn'),
                    cancelBtn: document.getElementById('confirm-modal-cancel-btn'),
                }
            };

            // === INITIALISATION DU SYSTÈME DE LOGGING API ===
            
            // Initialiser le système de logging dès le démarrage
            setTimeout(() => {
                APILogger.init();
                console.log('🔧 Système de logging API initialisé');
            }, 1000); // Attendre que tous les éléments soient chargés

            // === FIN INITIALISATION LOGGING ===

            // --- DYNAMIC SELECTORS ---
            let preview = {};
            function reinitializePreviewSelectors() {
                preview.previewWrapper = document.getElementById('cv-preview-wrapper');
                preview.cvNomPrenom = document.getElementById('cv-nom-prenom-preview');
                preview.cvPoste = document.getElementById('cv-poste-preview');
                preview.cvDescription = document.getElementById('cv-description-preview');
                preview.cvFormation = document.getElementById('cv-formation-preview');
                preview.cvCompetences = document.getElementById('cv-competences-preview');
                preview.cvExperience = document.getElementById('cv-experience-preview');
                preview.bannerModule = document.getElementById('banner-module');
                preview.banner = document.getElementById('recruiter-banner');
                preview.bannerImg = document.getElementById('banner-img-preview');
                preview.bannerNom = document.getElementById('banner-nom-preview');
                preview.bannerPoste = document.getElementById('banner-poste-preview');
                preview.bannerContact = document.getElementById('banner-contact-preview');
                preview.bannerEmail = document.getElementById('banner-email-preview');
                preview.bannerTel = document.getElementById('banner-tel-preview');
                preview.qualificationModule = document.getElementById('qualification-module');
                preview.qualificationPreview = document.getElementById('qualification-preview');
                preview.fixedBannerTop = document.getElementById('fixed-banner-top');
                preview.fixedBannerBottom = document.getElementById('fixed-banner-bottom');
                preview.bannerBgImg = document.getElementById('banner-bg-img-preview');
            }
            
            // --- CONFIGURATION OBJECTS ---
            const sliders = {
                bannerElementSpacing: { el: controls.bannerElementSpacing, valueEl: controls.bannerElementSpacingValue, property: '--banner-element-spacing', unit: 'rem' },
                // Commenté temporairement les sliders qui n'existent plus dans l'interface actuelle
                // pageMargin: { el: controls.pageMargin, valueEl: controls.pageMarginValue, property: '--page-margin', unit: 'cm' },
                // moduleSpacing: { el: controls.moduleSpacing, valueEl: controls.moduleSpacingValue, property: '--module-spacing', unit: 'rem' },
                // itemSpacing: { el: controls.itemSpacing, valueEl: controls.itemSpacingValue, property: '--item-spacing', unit: 'rem' },
                // fontSizeH1: { el: controls.fontSizeH1, valueEl: controls.fontSizeH1Value, property: '--font-size-h1', unit: 'pt' },
                // fontSizeH2: { el: controls.fontSizeH2, valueEl: controls.fontSizeH2Value, property: '--font-size-h2', unit: 'pt' },
                // fontSizeP: { el: controls.fontSizeP, valueEl: controls.fontSizePValue, property: '--font-size-p', unit: 'pt' },
                // fontSizeBanner: { el: controls.fontSizeBanner, valueEl: controls.fontSizeBannerValue, property: '--font-size-banner', unit: 'pt' },
                // lineHeight: { el: controls.lineHeight, valueEl: controls.lineHeightValue, property: '--line-height', unit: '' },
                // paragraphSpacing: { el: controls.paragraphSpacing, valueEl: controls.paragraphSpacingValue, property: '--paragraph-spacing', unit: 'rem' },
            };

            const bannerStyleControls = {
                nomFont: { el: controls.bannerNomFont, event: 'change', stateKey: 'nomFont' },
                nomSize: { el: controls.bannerNomSize, event: 'input', valueEl: controls.bannerNomSizeValue, stateKey: 'nomSize' },
                nomColor: { el: controls.bannerNomColor, event: 'input', stateKey: 'nomColor' },
                nomBold: { el: controls.bannerNomBold, event: 'click', toggle: true, stateKey: 'nomBold' },
                nomItalic: { el: controls.bannerNomItalic, event: 'click', toggle: true, stateKey: 'nomItalic' },
                posteSize: { el: controls.bannerPosteSize, event: 'input', valueEl: controls.bannerPosteSizeValue, stateKey: 'posteSize' },
                posteColor: { el: controls.bannerPosteColor, event: 'input', stateKey: 'posteColor' },
                posteBold: { el: controls.bannerPosteBold, event: 'click', toggle: true, stateKey: 'posteBold' },
                posteItalic: { el: controls.bannerPosteItalic, event: 'click', toggle: true, stateKey: 'posteItalic' },
                contactSize: { el: controls.bannerContactSize, event: 'input', valueEl: controls.bannerContactSizeValue, stateKey: 'contactSize' },
                contactColor: { el: controls.bannerContactColor, event: 'input', stateKey: 'contactColor' },
                contactBold: { el: controls.bannerContactBold, event: 'click', toggle: true, stateKey: 'contactBold' },
                contactItalic: { el: controls.bannerContactItalic, event: 'click', toggle: true, stateKey: 'contactItalic' },
            };

            // === SYSTÈME DE LOGGING ET VÉRIFICATION API ===
            
            const APILogger = {
                logs: JSON.parse(localStorage.getItem('api-logs') || '[]'),
                dailyRequests: JSON.parse(localStorage.getItem('daily-requests') || '{}'),
                
                // Initialiser le système
                init() {
                    this.cleanOldLogs();
                    this.updateSidebarStatus();
                    this.bindEvents();
                    this.startAutoRefresh();
                    this.checkDailyReset();
                },
                
                // Nettoyer les anciens logs (garder seulement les 7 derniers jours)
                cleanOldLogs() {
                    const sevenDaysAgo = Date.now() - (7 * 24 * 60 * 60 * 1000);
                    this.logs = this.logs.filter(log => log.timestamp > sevenDaysAgo);
                    this.saveLogs();
                },
                
                // Réinitialiser le compteur quotidien si nécessaire
                checkDailyReset() {
                    const today = new Date().toDateString();
                    const savedDate = localStorage.getItem('last-request-date');
                    if (savedDate !== today) {
                        this.dailyRequests = {};
                        localStorage.setItem('last-request-date', today);
                        localStorage.setItem('daily-requests', '{}');
                    }
                },
                
                // Enregistrer un événement API
                log(type, api, action, details = {}) {
                    const logEntry = {
                        id: Date.now(),
                        timestamp: Date.now(),
                        type: type, // 'success', 'error', 'warning', 'info'
                        api: api, // 'gemini', 'openai'
                        action: action, // 'test', 'analyze', 'rewrite', etc.
                        details: details,
                        message: this.formatMessage(type, api, action, details)
                    };
                    
                    this.logs.unshift(logEntry);
                    this.logs = this.logs.slice(0, 100); // Garder seulement les 100 derniers
                    this.saveLogs();
                    
                    // Compter les requêtes quotidiennes
                    if (type === 'success') {
                        this.dailyRequests[api] = (this.dailyRequests[api] || 0) + 1;
                        localStorage.setItem('daily-requests', JSON.stringify(this.dailyRequests));
                    }
                    
                    this.updateSidebarStatus();
                    this.notifyLogUpdate();
                },
                
                // Formater le message de log
                formatMessage(type, api, action, details) {
                    const time = new Date().toLocaleTimeString();
                    const icons = { success: '✅', error: '❌', warning: '⚠️', info: 'ℹ️' };
                    const apiName = api === 'gemini' ? 'Gemini' : 'OpenAI';
                    
                    let message = `${icons[type]} [${time}] ${apiName} - ${action}`;
                    
                    if (details.model) message += ` (${details.model})`;
                    if (details.tokens) message += ` - ${details.tokens} tokens`;
                    if (details.duration) message += ` - ${details.duration}ms`;
                    if (details.error) message += ` - ${details.error}`;
                    
                    return message;
                },
                
                // Sauvegarder les logs
                saveLogs() {
                    localStorage.setItem('api-logs', JSON.stringify(this.logs));
                },
                
                // Vérifier le statut des APIs
                async checkAPIStatus() {
                    const status = {
                        gemini: { active: false, configured: false, quota: 'unknown' },
                        openai: { active: false, configured: false, quota: 'unknown' }
                    };
                    
                    // Vérifier Gemini
                    const geminiKey = localStorage.getItem('gemini-api-key');
                    if (geminiKey) {
                        status.gemini.configured = true;
                        try {
                            // Test simple et rapide
                            await this.quickTestAPI('gemini');
                            status.gemini.active = true;
                            status.gemini.quota = 'available';
                        } catch (error) {
                            if (error.message.includes('QUOTA_EXCEEDED') || error.message.includes('429')) {
                                status.gemini.quota = 'exceeded';
                            } else {
                                status.gemini.quota = 'error';
                            }
                        }
                    }
                    
                    // Vérifier OpenAI
                    const openaiKey = localStorage.getItem('openai-api-key');
                    if (openaiKey) {
                        status.openai.configured = true;
                        try {
                            await this.quickTestAPI('openai');
                            status.openai.active = true;
                            status.openai.quota = 'available';
                        } catch (error) {
                            if (error.message.includes('429') || error.message.includes('quota')) {
                                status.openai.quota = 'exceeded';
                            } else {
                                status.openai.quota = 'error';
                            }
                        }
                    }
                    
                    return status;
                },
                
                // Test rapide d'API (sans enregistrer de log)
                async quickTestAPI(api) {
                    if (api === 'gemini') {
                        const apiKey = localStorage.getItem('gemini-api-key');
                        if (!apiKey) throw new Error('Clé non configurée');
                        
                        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                contents: [{ role: "user", parts: [{ text: "Hi" }] }],
                                generationConfig: { maxOutputTokens: 5 }
                            })
                        });
                        
                        if (!response.ok) {
                            const error = await response.text();
                            throw new Error(error);
                        }
                    } else {
                        const apiKey = localStorage.getItem('openai-api-key');
                        if (!apiKey) throw new Error('Clé non configurée');
                        
                        const response = await fetch('https://api.openai.com/v1/chat/completions', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${apiKey}`
                            },
                            body: JSON.stringify({
                                model: 'gpt-3.5-turbo',
                                messages: [{ role: 'user', content: 'Hi' }],
                                max_tokens: 5
                            })
                        });
                        
                        if (!response.ok) {
                            const error = await response.text();
                            throw new Error(error);
                        }
                    }
                },
                
                // Mettre à jour le statut dans la sidebar
                async updateSidebarStatus() {
                    const activeApiDot = document.getElementById('active-api-dot');
                    const activeApiName = document.getElementById('active-api-name');
                    const activeApiBadge = document.getElementById('active-api-badge');
                    const geminiStatusDot = document.getElementById('gemini-status-dot');
                    const openaiStatusDot = document.getElementById('openai-status-dot');
                    const dailyRequestsCount = document.getElementById('daily-requests-count');
                    const dailyRequestsBar = document.getElementById('daily-requests-bar');
                    const lastApiActivity = document.getElementById('last-api-activity');
                    
                    if (!activeApiDot) return;
                    
                    try {
                        const status = await this.checkAPIStatus();
                        const preferredApi = localStorage.getItem('preferred-api') || 'gemini';
                        const activeApi = status[preferredApi].active ? preferredApi : 
                                        (status.gemini.active ? 'gemini' : 
                                        (status.openai.active ? 'openai' : null));
                        
                        // Statut principal
                        if (activeApi) {
                            const apiName = activeApi === 'gemini' ? 'Google Gemini' : 'OpenAI ChatGPT';
                            const model = activeApi === 'gemini' ? 
                                        (controls.aiModelSelect?.value || 'gemini-1.5-flash') :
                                        (controls.openaiModel?.value || 'gpt-4o');
                            
                            activeApiDot.className = `w-3 h-3 rounded-full transition-colors ${activeApi === 'gemini' ? 'bg-blue-500' : 'bg-green-500'}`;
                            activeApiName.textContent = apiName;
                            activeApiName.className = `text-sm font-medium ${activeApi === 'gemini' ? 'text-blue-700' : 'text-green-700'}`;
                            activeApiBadge.textContent = model;
                            activeApiBadge.className = `px-2 py-1 text-xs rounded-full font-mono ${activeApi === 'gemini' ? 'bg-blue-100 text-blue-700' : 'bg-green-100 text-green-700'}`;
                        } else {
                            activeApiDot.className = 'w-3 h-3 bg-red-400 rounded-full transition-colors';
                            activeApiName.textContent = 'Aucune API active';
                            activeApiName.className = 'text-sm font-medium text-red-600';
                            activeApiBadge.textContent = 'Erreur';
                            activeApiBadge.className = 'px-2 py-1 bg-red-100 text-red-600 text-xs rounded-full font-mono';
                        }
                        
                        // Statuts individuels
                        geminiStatusDot.className = `w-2 h-2 rounded-full ${this.getStatusColor(status.gemini)}`;
                        openaiStatusDot.className = `w-2 h-2 rounded-full ${this.getStatusColor(status.openai)}`;
                        
                        // Compteur de requêtes
                        const totalRequests = (this.dailyRequests.gemini || 0) + (this.dailyRequests.openai || 0);
                        dailyRequestsCount.textContent = totalRequests;
                        const percentage = Math.min((totalRequests / 50) * 100, 100); // Limite à 50 par jour
                        dailyRequestsBar.style.width = `${percentage}%`;
                        dailyRequestsBar.className = `h-1.5 rounded-full transition-all duration-300 ${percentage > 80 ? 'bg-red-500' : percentage > 60 ? 'bg-yellow-500' : 'bg-blue-500'}`;
                        
                        // Dernière activité
                        if (this.logs.length > 0) {
                            const lastLog = this.logs[0];
                            const timeAgo = this.getTimeAgo(lastLog.timestamp);
                            lastApiActivity.textContent = `${lastLog.api.toUpperCase()} - ${lastLog.action} (${timeAgo})`;
                        }
                        
                    } catch (error) {
                        console.error('Erreur lors de la mise à jour du statut:', error);
                        activeApiDot.className = 'w-3 h-3 bg-gray-400 rounded-full transition-colors';
                        activeApiName.textContent = 'Vérification...';
                    }
                },
                
                // Obtenir la couleur de statut
                getStatusColor(status) {
                    if (!status.configured) return 'bg-gray-300';
                    if (status.active) return 'bg-green-500';
                    if (status.quota === 'exceeded') return 'bg-red-500';
                    return 'bg-yellow-500';
                },
                
                // Calculer le temps écoulé
                getTimeAgo(timestamp) {
                    const diff = Date.now() - timestamp;
                    const minutes = Math.floor(diff / 60000);
                    if (minutes < 1) return 'maintenant';
                    if (minutes < 60) return `${minutes}min`;
                    const hours = Math.floor(minutes / 60);
                    if (hours < 24) return `${hours}h`;
                    return `${Math.floor(hours / 24)}j`;
                },
                
                // Lier les événements
                bindEvents() {
                    const viewLogsBtn = document.getElementById('view-api-logs');
                    const closeLogsBtn = document.getElementById('close-api-logs');
                    const clearLogsBtn = document.getElementById('clear-api-logs');
                    const exportLogsBtn = document.getElementById('export-api-logs');
                    const logsModal = document.getElementById('api-logs-modal');
                    
                    if (viewLogsBtn) {
                        viewLogsBtn.addEventListener('click', () => {
                            this.showLogsModal();
                            logsModal.classList.remove('hidden');
                        });
                    }
                    
                    if (closeLogsBtn) {
                        closeLogsBtn.addEventListener('click', () => {
                            logsModal.classList.add('hidden');
                        });
                    }
                    
                    if (clearLogsBtn) {
                        clearLogsBtn.addEventListener('click', () => {
                            this.logs = [];
                            this.dailyRequests = {};
                            this.saveLogs();
                            localStorage.setItem('daily-requests', '{}');
                            this.showLogsModal();
                            this.updateSidebarStatus();
                            showNotification('📋 Logs effacés', 'success');
                        });
                    }
                    
                    if (exportLogsBtn) {
                        exportLogsBtn.addEventListener('click', () => {
                            this.exportLogs();
                        });
                    }
                },
                
                // Afficher le modal des logs
                showLogsModal() {
                    const logsContent = document.getElementById('api-logs-content');
                    if (!logsContent) return;
                    
                    if (this.logs.length === 0) {
                        logsContent.innerHTML = '<div class="text-center text-gray-500 py-8">Aucun log disponible</div>';
                        return;
                    }
                    
                    logsContent.innerHTML = this.logs.map(log => {
                        const date = new Date(log.timestamp).toLocaleString();
                        const typeClass = {
                            success: 'text-green-600 bg-green-50',
                            error: 'text-red-600 bg-red-50',
                            warning: 'text-yellow-600 bg-yellow-50',
                            info: 'text-blue-600 bg-blue-50'
                        }[log.type] || 'text-gray-600 bg-gray-50';
                        
                        return `
                            <div class="p-2 rounded border-l-4 ${typeClass.includes('green') ? 'border-green-500' : 
                                                                typeClass.includes('red') ? 'border-red-500' :
                                                                typeClass.includes('yellow') ? 'border-yellow-500' : 'border-blue-500'} ${typeClass}">
                                <div class="flex justify-between items-start">
                                    <span class="flex-1">${log.message}</span>
                                    <span class="text-xs opacity-75 ml-2">${date}</span>
                                </div>
                                ${log.details.error ? `<div class="text-xs mt-1 opacity-75">${log.details.error}</div>` : ''}
                            </div>
                        `;
                    }).join('');
                },
                
                // Exporter les logs
                exportLogs() {
                    const data = {
                        logs: this.logs,
                        dailyRequests: this.dailyRequests,
                        exported: new Date().toISOString()
                    };
                    
                    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `api-logs-${new Date().toISOString().split('T')[0]}.json`;
                    a.click();
                    URL.revokeObjectURL(url);
                    
                    showNotification('📥 Logs exportés', 'success');
                },
                
                // Démarrer le rafraîchissement automatique
                startAutoRefresh() {
                    setInterval(() => {
                        this.updateSidebarStatus();
                    }, 30000); // Toutes les 30 secondes
                },
                
                // Notifier de la mise à jour des logs
                notifyLogUpdate() {
                    // Mettre à jour l'affichage si le modal est ouvert
                    const modal = document.getElementById('api-logs-modal');
                    if (modal && !modal.classList.contains('hidden')) {
                        this.showLogsModal();
                    }
                }
            };

            // === FIN SYSTÈME DE LOGGING API ===

            const themes = {
                professional: {
                    primaryColor: '#2563eb', secondaryColor: '#334155', bodyTextColor: '#334155',
                    fontH1: "'Montserrat', sans-serif", fontH2: "'Montserrat', sans-serif", fontBody: "'Lato', sans-serif"
                },
                creative: {
                    primaryColor: '#db2777', secondaryColor: '#4f46e5', bodyTextColor: '#44403c',
                    fontH1: "'Playfair Display', serif", fontH2: "'Oswald', sans-serif", fontBody: "'Nunito Sans', sans-serif"
                },
                modern: {
                    primaryColor: '#16a34a', secondaryColor: '#1f2937', bodyTextColor: '#374151',
                    fontH1: "'Oswald', sans-serif", fontH2: "'Source Sans Pro', sans-serif", fontBody: "'Source Sans Pro', sans-serif"
                }
            };
            
            // --- GLOBAL STATE VARIABLES ---
            let pageCounter = 1;
            let customSectionCounter = 0;
            const root = document.documentElement;
            let isAnonymized = false;
            let originalData = {};
            let isRestoringState = false; 
            let activeIconTarget = null;
            
            // --- UI UTILITIES ---
            function showLoader(text = "Chargement...") {
                controls.loaderText.textContent = text;
                controls.loader.classList.remove('hidden');
                controls.loader.classList.add('flex');
            }

            function hideLoader() {
                controls.loader.classList.add('hidden');
                controls.loader.classList.remove('flex');
            }

            function showNotification(message, type = 'success', duration = 3000) {
                const toast = document.createElement('div');
                const icon = type === 'error' ? 'fa-times-circle text-red-500' : 'fa-check-circle text-green-500';
                toast.className = 'toast';
                toast.innerHTML = `<i class="fas ${icon}"></i><span>${message}</span>`;
                document.getElementById('notification').appendChild(toast);
                setTimeout(() => toast.classList.add('show'), 10);
                setTimeout(() => {
                    toast.classList.remove('show');
                    toast.addEventListener('transitionend', () => toast.remove());
                }, duration);
            }
            
            // Alias pour compatibilité
            function showToast(message, type = 'success', duration = 3000) {
                console.log(`🍞 [TOAST] ${message}`, { type, duration });
                return showNotification(message, type, duration);
            }
            
            // === GEMINI API FUNCTIONS ===
            
            // Configuration API
            const GEMINI_CONFIG = {
                baseUrl: 'https://generativelanguage.googleapis.com/v1beta/models/',
                models: {
                    'gemini-1.5-flash': 'gemini-1.5-flash-latest',
                    'gemini-1.5-pro': 'gemini-1.5-pro-latest', 
                    'gemini-pro': 'gemini-pro'
                }
            };

            // 🚀 GESTIONNAIRE DE CLÉS MULTIPLES GEMINI (CONTOURNEMENT LIMITES)
            class GeminiKeysManager {
                constructor() {
                    this.keys = this.loadKeys();
                    this.currentKeyIndex = 0;
                    this.dailyLimits = {}; // Suivi des limites par clé
                    this.loadDailyLimits();
                }

                loadKeys() {
                    const keys = localStorage.getItem('gemini-multiple-keys');
                    return keys ? JSON.parse(keys) : [];
                }

                saveKeys() {
                    localStorage.setItem('gemini-multiple-keys', JSON.stringify(this.keys));
                    this.updateUI();
                }

                loadDailyLimits() {
                    const today = new Date().toDateString();
                    const stored = localStorage.getItem('gemini-daily-limits');
                    this.dailyLimits = stored ? JSON.parse(stored) : {};
                    
                    // Reset si c'est un nouveau jour
                    if (this.dailyLimits.date !== today) {
                        this.dailyLimits = { date: today };
                        this.saveDailyLimits();
                    }
                }

                saveDailyLimits() {
                    localStorage.setItem('gemini-daily-limits', JSON.stringify(this.dailyLimits));
                }

                addKey(key, name = '') {
                    if (!key || key.length < 10) {
                        showNotification('Clé API invalide', 'error');
                        return false;
                    }
                    
                    // Vérifier si la clé existe déjà
                    const exists = this.keys.find(k => k.key === key);
                    if (exists) {
                        showNotification('Cette clé existe déjà', 'warning');
                        return false;
                    }

                    this.keys.push({
                        id: Date.now(),
                        key: key,
                        name: name || `Clé ${this.keys.length + 1}`,
                        active: true,
                        requestsToday: 0,
                        lastUsed: null,
                        status: 'untested'
                    });
                    
                    this.saveKeys();
                    showNotification(`Clé "${name || 'Nouvelle clé'}" ajoutée avec succès`, 'success');
                    return true;
                }

                removeKey(id) {
                    this.keys = this.keys.filter(k => k.id !== id);
                    this.saveKeys();
                }

                async testKey(key) {
                    try {
                        const response = await fetch(`${GEMINI_CONFIG.baseUrl}gemini-1.5-flash:generateContent?key=${key}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                contents: [{ role: "user", parts: [{ text: "Test" }] }],
                                generationConfig: { maxOutputTokens: 5 }
                            })
                        });
                        
                        return response.ok;
                    } catch (error) {
                        return false;
                    }
                }

                async testAllKeys() {
                    showLoader('Test de toutes les clés Gemini...');
                    let testedCount = 0;
                    let activeCount = 0;

                    for (let keyObj of this.keys) {
                        const isValid = await this.testKey(keyObj.key);
                        keyObj.status = isValid ? 'active' : 'error';
                        keyObj.active = isValid;
                        if (isValid) activeCount++;
                        testedCount++;
                    }

                    this.saveKeys();
                    hideLoader();
                    
                    showNotification(`Test terminé: ${activeCount}/${testedCount} clés actives`, 
                                   activeCount > 0 ? 'success' : 'error');
                }

                getActiveKey() {
                    const activeKeys = this.keys.filter(k => k.active);
                    if (activeKeys.length === 0) {
                        // Fallback vers la clé principale
                        return localStorage.getItem('gemini-api-key');
                    }

                    // Rotation intelligente: éviter les clés qui ont atteint leur limite
                    for (let i = 0; i < activeKeys.length; i++) {
                        const keyIndex = (this.currentKeyIndex + i) % activeKeys.length;
                        const keyObj = activeKeys[keyIndex];
                        
                        const keyId = keyObj.id.toString();
                        const requestsToday = this.dailyLimits[keyId] || 0;
                        
                        if (requestsToday < 45) { // Marge de sécurité sous les 50
                            this.currentKeyIndex = keyIndex;
                            return keyObj.key;
                        }
                    }

                    // Si toutes les clés sont proches de la limite, utiliser celle avec le moins de requêtes
                    const bestKey = activeKeys.reduce((best, current) => {
                        const currentRequests = this.dailyLimits[current.id.toString()] || 0;
                        const bestRequests = this.dailyLimits[best.id.toString()] || 0;
                        return currentRequests < bestRequests ? current : best;
                    });

                    return bestKey.key;
                }

                trackRequest(apiKey) {
                    // Trouver la clé utilisée et incrémenter son compteur
                    const keyObj = this.keys.find(k => k.key === apiKey);
                    if (keyObj) {
                        const keyId = keyObj.id.toString();
                        this.dailyLimits[keyId] = (this.dailyLimits[keyId] || 0) + 1;
                        keyObj.requestsToday = this.dailyLimits[keyId];
                        keyObj.lastUsed = new Date().toISOString();
                        this.saveDailyLimits();
                        this.saveKeys();
                        this.updateUI();
                    }
                }

                getTotalRequests() {
                    return Object.values(this.dailyLimits).reduce((sum, count) => {
                        return typeof count === 'number' ? sum + count : sum;
                    }, 0);
                }

                updateUI() {
                    if (controls.activeGeminiKeysCount) {
                        const activeCount = this.keys.filter(k => k.active).length;
                        controls.activeGeminiKeysCount.textContent = activeCount + 1; // +1 pour la clé principale
                    }
                    
                    if (controls.totalGeminiRequests) {
                        controls.totalGeminiRequests.textContent = this.getTotalRequests();
                    }

                    // 🚀 Afficher la limite théorique totale
                    const theoreticalLimitElement = document.getElementById('theoretical-limit');
                    if (theoreticalLimitElement) {
                        const totalKeys = this.keys.filter(k => k.active).length + 1; // +1 pour clé principale
                        const theoreticalLimit = totalKeys * 50;
                        theoreticalLimitElement.textContent = theoreticalLimit;
                        theoreticalLimitElement.title = `${totalKeys} clés × 50 requêtes = ${theoreticalLimit} requêtes/jour`;
                    }

                    this.renderKeysUI();
                }

                renderKeysUI() {
                    if (!controls.geminiKeysContainer) return;
                    
                    controls.geminiKeysContainer.innerHTML = '';
                    
                    this.keys.forEach((keyObj, index) => {
                        const keyElement = document.createElement('div');
                        keyElement.className = 'bg-white border border-gray-200 rounded-lg p-3 mb-2';
                        
                        const statusIcon = keyObj.status === 'active' ? '🟢' : 
                                         keyObj.status === 'error' ? '🔴' : '⚪';
                        
                        keyElement.innerHTML = `
                            <div class="flex items-center justify-between">
                                <div class="flex-1">
                                    <div class="flex items-center gap-2">
                                        <span>${statusIcon}</span>
                                        <input type="text" value="${keyObj.name}" 
                                               onchange="geminiKeysManager.updateKeyName(${keyObj.id}, this.value)"
                                               class="font-medium text-sm bg-transparent border-none outline-none">
                                        <span class="text-xs text-gray-500">(${keyObj.requestsToday || 0}/50)</span>
                                    </div>
                                    <div class="text-xs text-gray-400 font-mono">
                                        ${keyObj.key.substring(0, 15)}...
                                    </div>
                                </div>
                                <div class="flex gap-1">
                                    <button onclick="geminiKeysManager.testSingleKey(${keyObj.id})" 
                                            class="text-blue-600 hover:text-blue-800 text-xs px-2 py-1 rounded">
                                        Test
                                    </button>
                                    <button onclick="geminiKeysManager.toggleKey(${keyObj.id})" 
                                            class="text-${keyObj.active ? 'green' : 'gray'}-600 hover:text-${keyObj.active ? 'green' : 'gray'}-800 text-xs px-2 py-1 rounded">
                                        ${keyObj.active ? 'ON' : 'OFF'}
                                    </button>
                                    <button onclick="geminiKeysManager.removeKey(${keyObj.id})" 
                                            class="text-red-600 hover:text-red-800 text-xs px-2 py-1 rounded">
                                        ✕
                                    </button>
                                </div>
                            </div>
                        `;
                        
                        controls.geminiKeysContainer.appendChild(keyElement);
                    });
                }

                updateKeyName(id, newName) {
                    const keyObj = this.keys.find(k => k.id === id);
                    if (keyObj) {
                        keyObj.name = newName;
                        this.saveKeys();
                    }
                }

                async testSingleKey(id) {
                    const keyObj = this.keys.find(k => k.id === id);
                    if (!keyObj) return;

                    const isValid = await this.testKey(keyObj.key);
                    keyObj.status = isValid ? 'active' : 'error';
                    keyObj.active = isValid;
                    this.saveKeys();
                    
                    showNotification(`Clé "${keyObj.name}": ${isValid ? 'Valide ✅' : 'Erreur ❌'}`, 
                                   isValid ? 'success' : 'error');
                }

                toggleKey(id) {
                    const keyObj = this.keys.find(k => k.id === id);
                    if (keyObj) {
                        keyObj.active = !keyObj.active;
                        this.saveKeys();
                    }
                }
            }

            // Instancier le gestionnaire
            const geminiKeysManager = new GeminiKeysManager();
            
            // Sauvegarder la clé API
            function saveGeminiApiKey() {
                const apiKey = controls.geminiApiKey?.value?.trim();
                if (!apiKey) {
                    showNotification('Veuillez saisir une clé API valide', 'error');
                    return;
                }
                
                if (!apiKey.startsWith('AIza')) {
                    showNotification('Format de clé API invalide. La clé doit commencer par "AIza"', 'error');
                    return;
                }
                
                try {
                    localStorage.setItem('gemini-api-key', apiKey);
                    showNotification('Clé API sauvegardée avec succès', 'success');
                    updateApiStatus('saved', 'Clé API sauvegardée');
                } catch (error) {
                    showNotification('Erreur lors de la sauvegarde', 'error');
                }
            }
            
            // Charger la clé API
            function loadGeminiApiKey() {
                const savedKey = localStorage.getItem('gemini-api-key');
                if (savedKey && controls.geminiApiKey) {
                    controls.geminiApiKey.value = savedKey;
                    updateApiStatus('loaded', 'Clé API chargée');
                }
            }

            // Fonctions utilitaires pour les générateurs de styles
            function applyLayoutSettings(layout) {
                if (layout.columns) {
                    document.querySelectorAll('.column-btn').forEach(btn => btn.classList.remove('active'));
                    const colBtn = document.querySelector(`[data-columns="${layout.columns}"]`);
                    if (colBtn) colBtn.classList.add('active');
                    controls.columns = layout.columns;
                }
                if (layout.columnGap) {
                    const slider = document.getElementById('column-gap');
                    if (slider) {
                        slider.value = layout.columnGap;
                        const valueDisplay = document.getElementById('column-gap-value');
                        if (valueDisplay) valueDisplay.textContent = layout.columnGap;
                    }
                }
                if (layout.sectionSpacing) {
                    const slider = document.getElementById('section-spacing');
                    if (slider) {
                        slider.value = layout.sectionSpacing;
                        const valueDisplay = document.getElementById('section-spacing-value');
                        if (valueDisplay) valueDisplay.textContent = layout.sectionSpacing;
                    }
                }
                
                // Appliquer les marges de page
                const pageMargins = [
                    { key: 'marginTop', id: 'page-margin-top' },
                    { key: 'marginBottom', id: 'page-margin-bottom' },
                    { key: 'marginLeft', id: 'page-margin-left' },
                    { key: 'marginRight', id: 'page-margin-right' }
                ];
                
                pageMargins.forEach(margin => {
                    if (layout[margin.key]) {
                        const slider = document.getElementById(margin.id);
                        if (slider) {
                            slider.value = layout[margin.key];
                            const valueDisplay = document.getElementById(`${margin.id}-value`);
                            if (valueDisplay) valueDisplay.textContent = layout[margin.key];
                        }
                    }
                });
                
                // Appliquer les tailles de police
                if (layout.fontSizeH1) {
                    const slider = document.getElementById('font-size-h1');
                    if (slider) {
                        slider.value = layout.fontSizeH1;
                        const valueDisplay = document.getElementById('font-size-h1-value');
                        if (valueDisplay) valueDisplay.textContent = layout.fontSizeH1;
                    }
                }
                
                if (layout.fontSizeH2) {
                    const slider = document.getElementById('font-size-h2');
                    if (slider) {
                        slider.value = layout.fontSizeH2;
                        const valueDisplay = document.getElementById('font-size-h2-value');
                        if (valueDisplay) valueDisplay.textContent = layout.fontSizeH2;
                    }
                }
                
                if (layout.fontSizeP) {
                    const slider = document.getElementById('font-size-p');
                    if (slider) {
                        slider.value = layout.fontSizeP;
                        const valueDisplay = document.getElementById('font-size-p-value');
                        if (valueDisplay) valueDisplay.textContent = layout.fontSizeP;
                    }
                }
                
                // Appliquer l'interligne
                if (layout.lineHeight) {
                    const slider = document.getElementById('line-height-body');
                    if (slider) {
                        slider.value = layout.lineHeight;
                        const valueDisplay = document.getElementById('line-height-body-value');
                        if (valueDisplay) valueDisplay.textContent = layout.lineHeight;
                    }
                }
                
                // Déclencher la mise à jour du preview
                updateLayoutInPreview();
            }

            function applyStyleSettings(style) {
                if (style.primaryColor) {
                    document.getElementById('primary-color-picker').value = style.primaryColor;
                }
                if (style.secondaryColor) {
                    document.getElementById('secondary-color-picker').value = style.secondaryColor;
                }
                if (style.accentColor) {
                    document.getElementById('accent-color-picker').value = style.accentColor;
                }
                if (style.neutralColor) {
                    document.getElementById('neutral-color-picker').value = style.neutralColor;
                }
                if (style.backgroundColor) {
                    document.getElementById('background-color-picker').value = style.backgroundColor;
                }
                if (style.textColor) {
                    document.getElementById('text-color-picker').value = style.textColor;
                }
                
                // Appliquer les polices
                ['H1', 'H2', 'H3', 'Body', 'Accent'].forEach(type => {
                    const key = `font${type}`;
                    if (style[key]) {
                        const select = document.getElementById(`font-family-${type.toLowerCase()}-select`);
                        if (select) select.value = style[key];
                    }
                });

                // Appliquer le style de titre
                if (style.titleStyle) {
                    document.querySelectorAll('.section-title-style-btn').forEach(btn => btn.classList.remove('active'));
                    const titleBtn = document.querySelector(`[data-title-style="${style.titleStyle}"]`);
                    if (titleBtn) titleBtn.classList.add('active');
                }

                // Appliquer les effets
                if (style.effects) {
                    Object.keys(style.effects).forEach(effect => {
                        const checkbox = document.getElementById(`global-${effect}`);
                        if (checkbox) checkbox.checked = style.effects[effect];
                    });
                }

                updateStylesInPreview();
            }

            function updateLayoutInPreview() {
                // Mise à jour du layout dans la prévisualisation
                const preview = document.getElementById('cv-preview');
                if (preview) {
                    // Appliquer les styles de layout
                    const root = document.documentElement;
                    const columnGap = document.getElementById('column-gap-slider')?.value || 20;
                    const sectionSpacing = document.getElementById('section-spacing-slider')?.value || 20;
                    
                    root.style.setProperty('--column-gap', `${columnGap}px`);
                    root.style.setProperty('--section-spacing', `${sectionSpacing}px`);
                    
                    ['top', 'bottom', 'left', 'right'].forEach(side => {
                        const value = document.getElementById(`margin-${side}-slider`)?.value || 20;
                        root.style.setProperty(`--margin-${side}`, `${value}px`);
                    });
                }
            }

            function updateStylesInPreview() {
                // Mise à jour des styles dans la prévisualisation
                const root = document.documentElement;
                
                // Appliquer les couleurs
                ['primary', 'secondary', 'accent', 'neutral', 'background', 'text'].forEach(color => {
                    const picker = document.getElementById(`${color}-color-picker`);
                    if (picker) {
                        root.style.setProperty(`--color-${color}`, picker.value);
                    }
                });

                // Appliquer les polices
                ['h1', 'h2', 'h3', 'body', 'accent'].forEach(type => {
                    const select = document.getElementById(`font-family-${type}-select`);
                    if (select && select.value) {
                        root.style.setProperty(`--font-${type}`, select.value);
                    }
                });
            }

            // Fonctions utilitaires supplémentaires pour les styles
            function applyPredefinedPalette(paletteName) {
                const palettes = {
                    ocean: {
                        primaryColor: '#0ea5e9',
                        secondaryColor: '#06b6d4',
                        accentColor: '#10b981',
                        neutralColor: '#64748b',
                        backgroundColor: '#f0f9ff',
                        textColor: '#0f172a'
                    },
                    sunset: {
                        primaryColor: '#f59e0b',
                        secondaryColor: '#ef4444',
                        accentColor: '#ec4899',
                        neutralColor: '#6b7280',
                        backgroundColor: '#fffbeb',
                        textColor: '#1c1917'
                    },
                    forest: {
                        primaryColor: '#16a34a',
                        secondaryColor: '#84cc16',
                        accentColor: '#65a30d',
                        neutralColor: '#78716c',
                        backgroundColor: '#f7fee7',
                        textColor: '#1c1917'
                    },
                    royal: {
                        primaryColor: '#7c3aed',
                        secondaryColor: '#a855f7',
                        accentColor: '#3b82f6',
                        neutralColor: '#64748b',
                        backgroundColor: '#faf5ff',
                        textColor: '#1e1b4b'
                    },
                    autumn: {
                        primaryColor: '#dc2626',
                        secondaryColor: '#ea580c',
                        accentColor: '#d97706',
                        neutralColor: '#78716c',
                        backgroundColor: '#fef2f2',
                        textColor: '#1c1917'
                    },
                    mono: {
                        primaryColor: '#374151',
                        secondaryColor: '#6b7280',
                        accentColor: '#9ca3af',
                        neutralColor: '#d1d5db',
                        backgroundColor: '#ffffff',
                        textColor: '#111827'
                    },
                    pastel: {
                        primaryColor: '#fbbf24',
                        secondaryColor: '#f472b6',
                        accentColor: '#a78bfa',
                        neutralColor: '#9ca3af',
                        backgroundColor: '#fefce8',
                        textColor: '#1f2937'
                    },
                    neon: {
                        primaryColor: '#06ffa5',
                        secondaryColor: '#00d4ff',
                        accentColor: '#ff006e',
                        neutralColor: '#64748b',
                        backgroundColor: '#0f0f23',
                        textColor: '#f1f5f9'
                    }
                };

                const palette = palettes[paletteName];
                if (palette) {
                    applyStyleSettings(palette);
                    showToast(`Palette ${paletteName} appliquée 🎨`, "success");
                }
            }

            function applyBackgroundPattern(patternName) {
                const root = document.documentElement;
                const patterns = {
                    none: 'none',
                    dots: 'radial-gradient(circle, var(--color-neutral) 1px, transparent 1px)',
                    lines: 'linear-gradient(90deg, var(--color-neutral) 1px, transparent 1px)',
                    grid: 'linear-gradient(var(--color-neutral) 1px, transparent 1px), linear-gradient(90deg, var(--color-neutral) 1px, transparent 1px)',
                    waves: 'repeating-linear-gradient(45deg, transparent, transparent 10px, var(--color-neutral) 10px, var(--color-neutral) 20px)',
                    geometric: 'repeating-conic-gradient(var(--color-neutral) 0% 25%, transparent 0% 50%)'
                };

                root.style.setProperty('--background-pattern', patterns[patternName] || 'none');
                showToast(`Motif ${patternName} appliqué`, "success");
            }

            async function generateHarmoniousColors() {
                const fallbackFunction = () => {
                    // Palettes harmonieuses pré-définies
                    const harmoniousPalettes = [
                        { primaryColor: '#2563eb', secondaryColor: '#1e40af', accentColor: '#3b82f6', neutralColor: '#64748b', backgroundColor: '#f8fafc', textColor: '#1e293b' },
                        { primaryColor: '#dc2626', secondaryColor: '#b91c1c', accentColor: '#ef4444', neutralColor: '#6b7280', backgroundColor: '#fef2f2', textColor: '#1f2937' },
                        { primaryColor: '#059669', secondaryColor: '#047857', accentColor: '#10b981', neutralColor: '#6b7280', backgroundColor: '#f0fdf4', textColor: '#1f2937' },
                        { primaryColor: '#7c3aed', secondaryColor: '#6d28d9', accentColor: '#8b5cf6', neutralColor: '#6b7280', backgroundColor: '#faf5ff', textColor: '#1f2937' }
                    ];
                    const randomPalette = harmoniousPalettes[Math.floor(Math.random() * harmoniousPalettes.length)];
                    applyStyleSettings(randomPalette);
                    return "Couleurs harmonieuses appliquées (mode fallback)";
                };

                try {
                    const prompt = "Génère une palette de 6 couleurs harmonieuses pour un CV professionnel. Réponds avec un objet JSON contenant: primaryColor, secondaryColor, accentColor, neutralColor, backgroundColor, textColor (toutes en hex).";
                    const response = await callAIWithFallback(prompt, fallbackFunction);
                    if (typeof response === 'string' && response.includes('fallback')) {
                        showToast(response, "success");
                    } else {
                        const colors = JSON.parse(response);
                        applyStyleSettings(colors);
                        showToast("Couleurs harmonieuses générées par IA 🎨", "success");
                    }
                } catch (error) {
                    console.error('Erreur génération couleurs:', error);
                    fallbackFunction();
                    showToast("Couleurs harmonieuses appliquées (fallback) 🎨", "success");
                }
            }

            async function generateContrastColors() {
                const fallbackFunction = () => {
                    // Palettes à fort contraste pré-définies
                    const contrastPalettes = [
                        { primaryColor: '#000000', secondaryColor: '#ffffff', accentColor: '#ff0000', neutralColor: '#808080', backgroundColor: '#ffffff', textColor: '#000000' },
                        { primaryColor: '#ffffff', secondaryColor: '#000000', accentColor: '#00ff00', neutralColor: '#808080', backgroundColor: '#000000', textColor: '#ffffff' },
                        { primaryColor: '#ffff00', secondaryColor: '#000080', accentColor: '#ff00ff', neutralColor: '#808080', backgroundColor: '#ffffff', textColor: '#000000' }
                    ];
                    const randomPalette = contrastPalettes[Math.floor(Math.random() * contrastPalettes.length)];
                    applyStyleSettings(randomPalette);
                    return "Couleurs contrastées appliquées (mode fallback)";
                };

                try {
                    const prompt = "Génère une palette de 6 couleurs à fort contraste pour un CV moderne et impactant. Réponds avec un objet JSON contenant: primaryColor, secondaryColor, accentColor, neutralColor, backgroundColor, textColor (toutes en hex).";
                    const response = await callAIWithFallback(prompt, fallbackFunction);
                    if (typeof response === 'string' && response.includes('fallback')) {
                        showToast(response, "success");
                    } else {
                        const colors = JSON.parse(response);
                        applyStyleSettings(colors);
                        showToast("Couleurs contrastées générées par IA ⚡", "success");
                    }
                } catch (error) {
                    console.error('Erreur génération couleurs:', error);
                    fallbackFunction();
                    showToast("Couleurs contrastées appliquées (fallback) ⚡", "success");
                }
            }

            function generateRandomPalette() {
                const colors = ['#ef4444', '#f97316', '#eab308', '#22c55e', '#06b6d4', '#3b82f6', '#8b5cf6', '#ec4899', '#f43f5e', '#10b981', '#f59e0b', '#84cc16', '#06b6d4', '#6366f1', '#8b5cf6', '#d946ef'];
                const randomColors = {
                    primaryColor: colors[Math.floor(Math.random() * colors.length)],
                    secondaryColor: colors[Math.floor(Math.random() * colors.length)],
                    accentColor: colors[Math.floor(Math.random() * colors.length)],
                    neutralColor: '#6b7280',
                    backgroundColor: '#ffffff',
                    textColor: '#1f2937'
                };
                applyStyleSettings(randomColors);
                showToast("Palette aléatoire appliquée 🎲", "success");
            }

            async function generateAIFontPairing() {
                const fallbackFunction = () => {
                    // Combinaisons de polices pré-définies harmonieuses
                    const fontPairings = [
                        { fontH1: 'Playfair Display', fontH2: 'Source Sans Pro', fontH3: 'Source Sans Pro', fontBody: 'Source Sans Pro', fontAccent: 'Playfair Display' },
                        { fontH1: 'Merriweather', fontH2: 'Open Sans', fontH3: 'Open Sans', fontBody: 'Open Sans', fontAccent: 'Merriweather' },
                        { fontH1: 'Cormorant Garamond', fontH2: 'Lato', fontH3: 'Lato', fontBody: 'Lato', fontAccent: 'Cormorant Garamond' },
                        { fontH1: 'Crimson Text', fontH2: 'Nunito', fontH3: 'Nunito', fontBody: 'Nunito', fontAccent: 'Crimson Text' }
                    ];
                    const randomPairing = fontPairings[Math.floor(Math.random() * fontPairings.length)];
                    applyStyleSettings(randomPairing);
                    return "Pairing de polices appliqué (mode fallback)";
                };

                try {
                    const fontList = fonts.map(f => f.name).join(', ');
                    const prompt = `Choisir une combinaison harmonieuse de 5 polices pour un CV professionnel parmi: ${fontList}. Réponds avec un objet JSON contenant: fontH1, fontH2, fontH3, fontBody, fontAccent.`;
                    const response = await callAIWithFallback(prompt, fallbackFunction);
                    if (typeof response === 'string' && response.includes('fallback')) {
                        showToast(response, "success");
                    } else {
                        const fontPairing = JSON.parse(response);
                        applyStyleSettings(fontPairing);
                        showToast("Pairing de polices généré par IA 🤖", "success");
                    }
                } catch (error) {
                    console.error('Erreur génération polices:', error);
                    fallbackFunction();
                    showToast("Pairing de polices appliqué (fallback) 🤖", "success");
                }
            }
            
            // Basculer la visibilité de la clé
            function toggleApiKeyVisibility() {
                if (!controls.geminiApiKey || !controls.toggleApiKeyVisibility) return;
                
                if (controls.geminiApiKey.type === 'password') {
                    controls.geminiApiKey.type = 'text';
                    controls.toggleApiKeyVisibility.innerHTML = '<i class="fa-solid fa-eye-slash"></i>';
                } else {
                    controls.geminiApiKey.type = 'password';
                    controls.toggleApiKeyVisibility.innerHTML = '<i class="fa-solid fa-eye"></i>';
                }
            }
            
            // Mettre à jour le statut de l'API
            function updateApiStatus(type, message) {
                if (!controls.apiStatus) return;
                
                controls.apiStatus.classList.remove('hidden');
                
                const statusConfig = {
                    'saved': { color: 'text-green-700 bg-green-100 border-green-200', icon: 'fa-check-circle text-green-600' },
                    'loaded': { color: 'text-blue-700 bg-blue-100 border-blue-200', icon: 'fa-info-circle text-blue-600' },
                    'testing': { color: 'text-yellow-700 bg-yellow-100 border-yellow-200', icon: 'fa-spinner fa-spin text-yellow-600' },
                    'success': { color: 'text-green-700 bg-green-100 border-green-200', icon: 'fa-check-circle text-green-600' },
                    'error': { color: 'text-red-700 bg-red-100 border-red-200', icon: 'fa-exclamation-circle text-red-600' }
                };
                
                const config = statusConfig[type] || statusConfig.error;
                controls.apiStatus.className = `p-3 rounded-md border ${config.color}`;
                controls.apiStatusIcon.className = `fas ${config.icon}`;
                controls.apiStatusText.textContent = message;
                
                // Mettre à jour le quota en même temps
                updateQuotaStatus();
            }

            // Mettre à jour le statut du quota
            function updateQuotaStatus() {
                const quotaStatusEl = document.getElementById('quota-status');
                const quotaDetailsEl = document.getElementById('quota-details');
                const quotaResetInfoEl = document.getElementById('quota-reset-info');
                const quotaResetTimeEl = document.getElementById('quota-reset-time');
                
                if (!quotaStatusEl) return;

                // Vérifier si le quota est marqué comme épuisé
                const quotaData = JSON.parse(localStorage.getItem('gemini-quota') || '{}');
                const today = new Date().toDateString();
                
                if (quotaData.exhausted && quotaData.date === today) {
                    quotaStatusEl.textContent = 'Épuisé (50/50)';
                    quotaStatusEl.className = 'text-xs px-2 py-1 rounded-full bg-red-100 text-red-700';
                    
                    if (quotaDetailsEl) quotaDetailsEl.classList.remove('hidden');
                    if (quotaResetInfoEl) {
                        quotaResetInfoEl.classList.remove('hidden');
                        if (quotaResetTimeEl) {
                            const tomorrow = new Date();
                            tomorrow.setDate(tomorrow.getDate() + 1);
                            tomorrow.setHours(0, 0, 0, 0);
                            quotaResetTimeEl.textContent = `Demain à 00:00 (${tomorrow.toLocaleDateString()})`;
                        }
                    }
                    return;
                }

                if (isQuotaExceeded()) {
                    const retryAfter = localStorage.getItem('gemini-retry-after');
                    if (retryAfter) {
                        const retryTime = new Date(parseInt(retryAfter));
                        const now = new Date();
                        const diffHours = Math.ceil((retryTime - now) / (1000 * 60 * 60));
                        
                        quotaStatusEl.textContent = 'Quota Dépassé';
                        quotaStatusEl.className = 'text-xs px-2 py-1 rounded-full bg-red-100 text-red-700';
                        
                        if (quotaDetailsEl) quotaDetailsEl.classList.remove('hidden');
                        if (quotaResetInfoEl) {
                            quotaResetInfoEl.classList.remove('hidden');
                            if (quotaResetTimeEl) {
                                quotaResetTimeEl.textContent = `${retryTime.toLocaleString()} (dans ${diffHours}h)`;
                            }
                        }
                    }
                } else {
                    // Afficher le compte actuel si disponible
                    const currentCount = quotaData.count || 0;
                    quotaStatusEl.textContent = `Disponible (${currentCount}/50)`;
                    quotaStatusEl.className = 'text-xs px-2 py-1 rounded-full bg-green-100 text-green-700';
                    
                    if (quotaDetailsEl) quotaDetailsEl.classList.remove('hidden');
                    if (quotaResetInfoEl) quotaResetInfoEl.classList.add('hidden');
                }
            }

            // Vérifier le statut du quota
            async function checkQuotaStatus() {
                const checkBtn = document.getElementById('check-quota-status');
                if (checkBtn) {
                    checkBtn.disabled = true;
                    checkBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Vérification...';
                }

                try {
                    // Vérifier d'abord si on sait déjà que le quota est épuisé
                    const quotaData = JSON.parse(localStorage.getItem('gemini-quota') || '{}');
                    const today = new Date().toDateString();
                    
                    if (quotaData.exhausted && quotaData.date === today) {
                        showNotification('🚫 Quota API épuisé (50/50 requêtes utilisées). Mode fallback actif jusqu\'à demain.', 'warning', 6000);
                        return;
                    }
                    
                    if (isQuotaExceeded()) {
                        showNotification('⚠️ Quota API encore dépassé. Mode fallback actif.', 'warning');
                    } else {
                        // Faire un test léger pour vérifier le quota
                        const testResult = await callGeminiAPI('Test quota', { maxTokens: 10 });
                        if (testResult !== null) {
                            showNotification('✅ Quota API disponible', 'success');
                        }
                    }
                } catch (error) {
                    if (error.message === 'QUOTA_EXCEEDED' || error.message.includes('QUOTA_EXCEEDED') || error.message.includes('429')) {
                        showNotification('❌ Quota API dépassé. Utilisation du mode fallback.', 'error');
                    } else {
                        showNotification(`❌ Erreur API: ${error.message}`, 'error');
                    }
                } finally {
                    updateQuotaStatus();
                    if (checkBtn) {
                        checkBtn.disabled = false;
                        checkBtn.innerHTML = '<i class="fas fa-chart-line"></i> Vérifier Quota';
                    }
                }
            }
            
            // Appel à l'API Gemini avec gestion avancée des erreurs
            async function callGeminiAPI(prompt, options = {}) {
                const startTime = Date.now();
                
                // 🚀 UTILISATION DES CLÉS MULTIPLES POUR CONTOURNER LES LIMITES
                const apiKey = geminiKeysManager.getActiveKey();
                
                // Log du début de la fonction
                console.log('🔵 [GEMINI] Début callGeminiAPI avec clés multiples', {
                    timestamp: new Date().toISOString(),
                    prompt_length: prompt?.length || 0,
                    options: options,
                    has_api_key: !!apiKey,
                    total_keys: geminiKeysManager.keys.length,
                    active_keys: geminiKeysManager.keys.filter(k => k.active).length,
                    total_requests_today: geminiKeysManager.getTotalRequests()
                });
                
                APILogger.log('info', 'gemini', 'call-start', {
                    prompt_length: prompt?.length || 0,
                    model: options.model || controls.aiModelSelect?.value || 'gemini-1.5-flash',
                    has_api_key: !!apiKey,
                    multi_keys_count: geminiKeysManager.keys.length,
                    requests_today: geminiKeysManager.getTotalRequests()
                });
                
                if (!apiKey) {
                    console.error('❌ [GEMINI] Aucune clé API disponible (principale + multiples)');
                    APILogger.log('error', 'gemini', 'call-error', { error: 'Aucune clé API configurée' });
                    throw new Error('Aucune clé API Gemini configurée. Ajoutez au moins une clé dans l\'onglet API.');
                }

                // Vérifier si le quota est encore dépassé pour TOUTES les clés
                if (isQuotaExceeded()) {
                    const retryAfter = localStorage.getItem('gemini-retry-after');
                    const retryTime = new Date(parseInt(retryAfter));
                    
                    // Vérifier si on a des clés alternatives avec du quota disponible
                    const totalRequests = geminiKeysManager.getTotalRequests();
                    const maxPossibleRequests = (geminiKeysManager.keys.length + 1) * 45; // +1 pour clé principale
                    
                    if (totalRequests < maxPossibleRequests) {
                        console.log('🔄 [GEMINI] Quota principal dépassé mais clés alternatives disponibles', {
                            total_requests: totalRequests,
                            max_possible: maxPossibleRequests
                        });
                    } else {
                        const errorMsg = `QUOTA_EXCEEDED: Toutes les clés Gemini ont atteint leur limite. Prochaine tentative possible à ${retryTime.toLocaleString()}`;
                        
                        console.warn('⚠️ [GEMINI] Toutes les clés ont atteint leur quota', { 
                            retryTime: retryTime.toISOString(),
                            total_requests: totalRequests,
                            max_possible: maxPossibleRequests
                        });
                        APILogger.log('warning', 'gemini', 'all-quotas-exceeded', { 
                            error: 'Toutes les clés ont atteint leur quota',
                            retry_time: retryTime.toISOString(),
                            total_requests: totalRequests
                        });
                        
                        throw new Error(errorMsg);
                    }
                }
                
                const model = options.model || controls.aiModelSelect?.value || 'gemini-1.5-flash';
                const temperature = options.temperature || parseFloat(controls.aiTemperature?.value || '0.7');
                const maxTokens = options.maxTokens || parseInt(controls.aiMaxTokens?.value || '1000');
                const retries = options.retries || 3;
                
                console.log('🔧 [GEMINI] Configuration', {
                    model: model,
                    temperature: temperature,
                    maxTokens: maxTokens,
                    retries: retries
                });
                
                const modelName = GEMINI_CONFIG.models[model] || model;
                const url = `${GEMINI_CONFIG.baseUrl}${modelName}:generateContent?key=${apiKey}`;
                
                const requestBody = {
                    contents: [{
                        parts: [{ text: prompt }]
                    }],
                    generationConfig: {
                        temperature: temperature,
                        maxOutputTokens: maxTokens,
                        topP: 0.95,
                        topK: 64,
                    },
                    safetySettings: [
                        {
                            category: "HARM_CATEGORY_HARASSMENT",
                            threshold: "BLOCK_MEDIUM_AND_ABOVE"
                        },
                        {
                            category: "HARM_CATEGORY_HATE_SPEECH",
                            threshold: "BLOCK_MEDIUM_AND_ABOVE"
                        },
                        {
                            category: "HARM_CATEGORY_SEXUALLY_EXPLICIT",
                            threshold: "BLOCK_MEDIUM_AND_ABOVE"
                        },
                        {
                            category: "HARM_CATEGORY_DANGEROUS_CONTENT",
                            threshold: "BLOCK_MEDIUM_AND_ABOVE"
                        }
                    ]
                };

                for (let attempt = 1; attempt <= retries; attempt++) {
                    console.log(`🔄 [GEMINI] Tentative ${attempt}/${retries}`, {
                        attempt: attempt,
                        url: url,
                        model: model
                    });
                    
                    APILogger.log('info', 'gemini', `attempt-${attempt}`, {
                        attempt: attempt,
                        total_retries: retries,
                        model: model
                    });
                    
                    try {
                        const fetchStart = Date.now();
                        const response = await fetch(url, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(requestBody)
                        });
                        
                        const fetchDuration = Date.now() - fetchStart;
                        console.log(`🌐 [GEMINI] Réponse HTTP reçue`, {
                            status: response.status,
                            ok: response.ok,
                            fetch_duration: fetchDuration,
                            attempt: attempt
                        });

                        if (!response.ok) {
                            const errorData = await response.text();
                            let errorObj;
                            try {
                                errorObj = JSON.parse(errorData);
                            } catch (e) {
                                errorObj = { error: { message: errorData } };
                            }
                            
                            console.error(`❌ [GEMINI] Erreur HTTP ${response.status}`, {
                                status: response.status,
                                attempt: attempt,
                                error_data: errorObj,
                                raw_error: errorData
                            });

                            // Gestion spécifique des erreurs de quota
                            if (response.status === 429) {
                                const retryAfter = extractRetryAfter(errorObj) || 86400000; // 24h par défaut
                                localStorage.setItem('gemini-quota-exceeded', Date.now().toString());
                                localStorage.setItem('gemini-retry-after', (Date.now() + retryAfter).toString());
                                
                                console.error('🚫 [GEMINI] Quota dépassé détecté', {
                                    retry_after_ms: retryAfter,
                                    retry_time: new Date(Date.now() + retryAfter).toISOString(),
                                    attempt: attempt
                                });
                                
                                APILogger.log('error', 'gemini', 'quota-exceeded', {
                                    error: 'Quota dépassé',
                                    retry_after: retryAfter,
                                    attempt: attempt,
                                    duration: Date.now() - startTime
                                });
                                
                                const quotaError = new Error('QUOTA_EXCEEDED');
                                quotaError.originalError = errorObj;
                                quotaError.retryAfter = retryAfter;
                                throw quotaError;
                            }

                            const errorMsg = `Erreur API: ${response.status} - ${errorObj.error?.message || errorData}`;
                            APILogger.log('error', 'gemini', 'http-error', {
                                error: errorMsg,
                                status: response.status,
                                attempt: attempt,
                                duration: Date.now() - startTime
                            });
                            
                            throw new Error(errorMsg);
                        }

                        const responseStart = Date.now();
                        const data = await response.json();
                        const responseParseTime = Date.now() - responseStart;
                        
                        console.log(`📥 [GEMINI] Réponse JSON parsée`, {
                            parse_duration: responseParseTime,
                            has_candidates: !!data.candidates,
                            candidates_count: data.candidates?.length || 0,
                            attempt: attempt
                        });
                        
                        if (!data.candidates || !data.candidates[0]?.content?.parts?.[0]?.text) {
                            console.error('❌ [GEMINI] Réponse invalide - structure manquante', {
                                data_structure: {
                                    has_candidates: !!data.candidates,
                                    candidates_length: data.candidates?.length,
                                    first_candidate: data.candidates?.[0],
                                    has_content: !!data.candidates?.[0]?.content,
                                    has_parts: !!data.candidates?.[0]?.content?.parts,
                                    parts_length: data.candidates?.[0]?.content?.parts?.length,
                                    has_text: !!data.candidates?.[0]?.content?.parts?.[0]?.text
                                },
                                attempt: attempt
                            });
                            
                            APILogger.log('error', 'gemini', 'invalid-response', {
                                error: 'Structure de réponse invalide',
                                data_preview: JSON.stringify(data).substring(0, 200),
                                attempt: attempt,
                                duration: Date.now() - startTime
                            });
                            
                            throw new Error('Réponse invalide de l\'API');
                        }

                        const content = data.candidates[0].content.parts[0].text;
                        const successDuration = Date.now() - startTime;
                        
                        console.log(`🎉 [GEMINI] Succès complet!`, {
                            content_length: content.length,
                            content_preview: content.substring(0, 100) + (content.length > 100 ? '...' : ''),
                            attempt: attempt,
                            total_duration: successDuration,
                            fetch_duration: fetchDuration,
                            parse_duration: responseParseTime
                        });
                        
                        APILogger.log('success', 'gemini', 'api-call-success', {
                            duration: successDuration,
                            attempt: attempt,
                            content_length: content.length,
                            model: model,
                            prompt_length: prompt.length
                        });

                        // 🚀 TRACKER LA REQUÊTE POUR LE SYSTÈME MULTI-CLÉS
                        geminiKeysManager.trackRequest(apiKey);
                        console.log(`📊 [GEMINI] Requête trackée`, {
                            requests_today: geminiKeysManager.getTotalRequests(),
                            key_used: apiKey.substring(0, 10) + '...'
                        });

                        return content;
                    } catch (error) {
                        console.error(`❌ [GEMINI] Tentative ${attempt}/${retries} échouée`, {
                            error_message: error.message,
                            error_type: error.constructor.name,
                            attempt: attempt,
                            duration_so_far: Date.now() - startTime,
                            stack: error.stack?.split('\n')[0]
                        });
                        
                        APILogger.log('error', 'gemini', 'attempt-failed', {
                            error: error.message,
                            attempt: attempt,
                            duration: Date.now() - startTime,
                            error_type: error.constructor.name
                        });
                        
                        // Si c'est une erreur de quota, ne pas retry
                        if (error.message === 'QUOTA_EXCEEDED') {
                            console.error('🚫 [GEMINI] Quota exceeded - abandon immédiat', {
                                error: error.originalError,
                                retry_after: error.retryAfter
                            });
                            throw error;
                        }
                        
                        if (attempt === retries) {
                            console.error('🔴 [GEMINI] Toutes les tentatives épuisées', {
                                total_attempts: retries,
                                final_error: error.message,
                                total_duration: Date.now() - startTime
                            });
                            
                            APILogger.log('error', 'gemini', 'all-attempts-failed', {
                                error: error.message,
                                total_attempts: retries,
                                duration: Date.now() - startTime
                            });
                            
                            throw error;
                        }
                        
                        // Attendre avant de réessayer (backoff exponentiel)
                        const delayMs = 1000 * Math.pow(2, attempt - 1);
                        console.log(`⏳ [GEMINI] Attente avant retry`, {
                            delay_ms: delayMs,
                            next_attempt: attempt + 1,
                            remaining_attempts: retries - attempt
                        });
                        
                        await new Promise(resolve => setTimeout(resolve, delayMs));
                    }
                }
            }

            // Fonction pour extraire le délai de retry des erreurs de quota
            function extractRetryAfter(errorObj) {
                if (errorObj?.error?.details) {
                    for (const detail of errorObj.error.details) {
                        if (detail['@type'] === 'type.googleapis.com/google.rpc.RetryInfo' && detail.retryDelay) {
                            const delay = detail.retryDelay;
                            if (delay.endsWith('s')) {
                                return parseInt(delay.slice(0, -1)) * 1000; // Convertir en millisecondes
                            }
                        }
                    }
                }
                return 86400000; // 24h par défaut
            }

            // Vérifier si le quota est encore dépassé
            function isQuotaExceeded() {
                const quotaExceeded = localStorage.getItem('gemini-quota-exceeded');
                const retryAfter = localStorage.getItem('gemini-retry-after');
                
                if (!quotaExceeded || !retryAfter) return false;
                
                const now = Date.now();
                const retryTime = parseInt(retryAfter);
                
                if (now >= retryTime) {
                    // Le délai est écoulé, nettoyer le localStorage
                    localStorage.removeItem('gemini-quota-exceeded');
                    localStorage.removeItem('gemini-retry-after');
                    return false;
                }
                
                return true;
            }

            // Fonction wrapper avec fallback automatique (utilise maintenant le système de priorité)
            async function callAIWithFallback(prompt, fallbackFunction = null, options = {}) {
                try {
                    return await callAIWithPriority(prompt, options);
                } catch (error) {
                    console.error('Erreur API:', error);
                    
                    if (error.message.includes('QUOTA_EXCEEDED') || error.message.includes('429')) {
                        showNotification(`⚠️ Quotas API dépassés. Mode fallback activé.`, 'warning');
                    } else {
                        showNotification(`❌ Erreur IA: ${error.message}. Mode fallback activé.`, 'error');
                    }
                    
                    // Exécuter la fonction fallback si fournie
                    if (fallbackFunction && typeof fallbackFunction === 'function') {
                        showToast("Mode fallback activé - génération alternative", "info");
                        return fallbackFunction();
                    }
                    
                    throw error;
                }
            }
            
            // Tester la connexion API
            async function testGeminiApi() {
                if (!controls.testGeminiApi) return;
                
                updateApiStatus('testing', 'Test de la connexion en cours...');
                const startTime = Date.now();
                
                try {
                    APILogger.log('info', 'gemini', 'test-start', { model: controls.aiModelSelect?.value });
                    
                    const testPrompt = "Réponds simplement 'Test réussi' si tu reçois ce message.";
                    const result = await callGeminiAPI(testPrompt);
                    
                    const duration = Date.now() - startTime;
                    APILogger.log('success', 'gemini', 'test', { 
                        model: controls.aiModelSelect?.value,
                        duration: duration,
                        tokens: testPrompt.length
                    });
                    
                    if (result && typeof result === 'string' && result.toLowerCase().includes('test')) {
                        updateApiStatus('success', 'Connexion API réussie !');
                        showNotification('API Gemini connectée avec succès', 'success');
                    } else if (result) {
                        updateApiStatus('success', 'API connectée (réponse inattendue)');
                        showNotification('API connectée mais réponse inattendue', 'warning');
                    } else {
                        updateApiStatus('error', 'Réponse vide de l\'API');
                        showNotification('API Gemini: réponse vide', 'error');
                    }
                } catch (error) {
                    const duration = Date.now() - startTime;
                    APILogger.log('error', 'gemini', 'test', { 
                        error: error.message,
                        duration: duration
                    });
                    
                    updateApiStatus('error', `Erreur: ${error.message}`);
                    showNotification(`Erreur de connexion: ${error.message}`, 'error');
                }
            }
            
            // Intégration avec les fonctions IA existantes
            async function generateAIContent(prompt, type = 'general') {
                try {
                    showLoader(`Génération ${type} en cours...`);
                    
                    const apiKey = localStorage.getItem('gemini-api-key');
                    if (!apiKey) {
                        throw new Error('Clé API non configurée');
                    }
                    
                    const model = controls.aiModelSelect?.value || 'gemini-1.5-flash';
                    const temperature = parseFloat(controls.aiTemperature?.value || '0.7');
                    const maxTokens = parseInt(controls.aiMaxTokens?.value || '1000');
                    
                    const modelName = GEMINI_CONFIG.models[model] || model;
                    const url = `${GEMINI_CONFIG.baseUrl}${modelName}:generateContent?key=${apiKey}`;
                    
                    const requestBody = {
                        contents: [{
                            parts: [{ text: prompt }]
                        }],
                        generationConfig: {
                            temperature: temperature,
                            maxOutputTokens: maxTokens
                        }
                    };
                    
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(requestBody)
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(errorData.error?.message || `Erreur API: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    
                    if (!data.candidates || !data.candidates[0]?.content?.parts?.[0]?.text) {
                        throw new Error('Réponse invalide de l\'API');
                    }
                    
                    const result = data.candidates[0].content.parts[0].text;
                    hideLoader();
                    return result;
                } catch (error) {
                    hideLoader();
                    showNotification(`Erreur lors de la génération: ${error.message}`, 'error');
                    throw error;
                }
            }
            
            function showConfirmModal(title, text) {
                return new Promise((resolve) => {
                    controls.confirmModal.title.textContent = title;
                    controls.confirmModal.text.innerHTML = text;
                    controls.confirmModal.overlay.classList.add('active');

                    const cleanup = (result) => {
                        controls.confirmModal.overlay.classList.remove('active');
                        controls.confirmModal.okBtn.onclick = null;
                        controls.confirmModal.cancelBtn.onclick = null;
                        resolve(result);
                    };

                    controls.confirmModal.okBtn.onclick = () => cleanup(true);
                    controls.confirmModal.cancelBtn.onclick = () => cleanup(false);
                });
            }

            // === FONCTIONS OPENAI ===
            
            // Configuration OpenAI
            const OPENAI_CONFIG = {
                baseUrl: 'https://api.openai.com/v1/chat/completions',
                models: {
                    'gpt-3.5-turbo': 'gpt-3.5-turbo',
                    'gpt-4': 'gpt-4',
                    'gpt-4-turbo': 'gpt-4-turbo-preview',
                    'gpt-4o': 'gpt-4o',
                    'gpt-4o-mini': 'gpt-4o-mini',
                    'gpt-5': 'gpt-5'
                }
            };

            // Appel à l'API OpenAI
            async function callOpenAIAPI(prompt, options = {}) {
                const startTime = Date.now();
                console.log('🟢 [OPENAI] Début callOpenAIAPI', {
                    timestamp: new Date().toISOString(),
                    prompt_length: prompt.length,
                    options: options,
                    start_time: startTime
                });
                
                APILogger.log('info', 'openai', 'api-call-start', {
                    prompt_length: prompt.length,
                    options: options
                });
                
                const apiKey = localStorage.getItem('openai-api-key');
                if (!apiKey) {
                    console.error('❌ [OPENAI] Clé API manquante');
                    APILogger.log('error', 'openai', 'no-api-key', {
                        error: 'Clé API OpenAI non configurée'
                    });
                    throw new Error('Clé API OpenAI non configurée');
                }
                
                console.log('🔑 [OPENAI] Clé API trouvée', {
                    key_length: apiKey.length,
                    key_preview: apiKey.substring(0, 8) + '...'
                });
                
                const model = options.model || controls.openaiModel?.value || 'gpt-4o';
                const temperature = options.temperature || parseFloat(controls.aiTemperature?.value || '0.7');
                const maxTokens = options.maxTokens || parseInt(controls.aiMaxTokens?.value || '1000');
                const retries = options.retries || 3;
                
                console.log('⚙️ [OPENAI] Configuration', {
                    model: model,
                    mapped_model: OPENAI_CONFIG.models[model] || model,
                    temperature: temperature,
                    max_tokens: maxTokens,
                    retries: retries
                });
                
                APILogger.log('info', 'openai', 'configuration', {
                    model: model,
                    temperature: temperature,
                    max_tokens: maxTokens,
                    retries: retries
                });
                
                const requestBody = {
                    model: OPENAI_CONFIG.models[model] || model,
                    messages: [{
                        role: 'user',
                        content: prompt
                    }],
                    temperature: temperature,
                    max_tokens: maxTokens,
                    top_p: 0.95
                };

                console.log('📦 [OPENAI] Corps de requête préparé', {
                    body_size: JSON.stringify(requestBody).length,
                    messages_count: requestBody.messages.length,
                    model: requestBody.model
                });

                for (let attempt = 1; attempt <= retries; attempt++) {
                    console.log(`🔄 [OPENAI] Tentative ${attempt}/${retries}`, {
                        attempt: attempt,
                        url: OPENAI_CONFIG.baseUrl,
                        model: requestBody.model
                    });
                    
                    APILogger.log('info', 'openai', `attempt-${attempt}`, {
                        attempt: attempt,
                        total_retries: retries,
                        model: requestBody.model
                    });
                    
                    try {
                        const fetchStart = Date.now();
                        const response = await fetch(OPENAI_CONFIG.baseUrl, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${apiKey}`
                            },
                            body: JSON.stringify(requestBody)
                        });
                        
                        const fetchDuration = Date.now() - fetchStart;
                        console.log(`🌐 [OPENAI] Réponse HTTP reçue`, {
                            status: response.status,
                            ok: response.ok,
                            fetch_duration: fetchDuration,
                            attempt: attempt
                        });

                        if (!response.ok) {
                            const errorData = await response.json().catch(() => ({}));
                            
                            console.error(`❌ [OPENAI] Erreur HTTP ${response.status}`, {
                                status: response.status,
                                attempt: attempt,
                                error_data: errorData
                            });
                            
                            if (response.status === 429) {
                                const retryAfter = response.headers.get('retry-after');
                                const waitTime = retryAfter ? parseInt(retryAfter) * 1000 : Math.pow(2, attempt) * 1000;
                                
                                console.error('🚫 [OPENAI] Quota dépassé détecté', {
                                    retry_after_header: retryAfter,
                                    wait_time_ms: waitTime,
                                    retry_time: new Date(Date.now() + waitTime).toISOString(),
                                    attempt: attempt
                                });
                                
                                APILogger.log('error', 'openai', 'quota-exceeded', {
                                    error: 'Quota dépassé',
                                    wait_time: waitTime,
                                    attempt: attempt,
                                    duration: Date.now() - startTime
                                });
                                
                                if (attempt < retries) {
                                    console.log(`⏳ [OPENAI] Attente quota ${waitTime/1000}s avant retry`, {
                                        wait_seconds: waitTime/1000,
                                        next_attempt: attempt + 1
                                    });
                                    await new Promise(resolve => setTimeout(resolve, waitTime));
                                    continue;
                                } else {
                                    const quotaError = new Error(`QUOTA_EXCEEDED: Quota OpenAI dépassé. ${errorData.error?.message || ''}`);
                                    quotaError.originalError = errorData;
                                    quotaError.retryAfter = waitTime;
                                    throw quotaError;
                                }
                            }
                            
                            const errorMsg = errorData.error?.message || `Erreur API OpenAI: ${response.status}`;
                            APILogger.log('error', 'openai', 'http-error', {
                                error: errorMsg,
                                status: response.status,
                                attempt: attempt,
                                duration: Date.now() - startTime
                            });
                            
                            throw new Error(errorMsg);
                        }

                        const responseStart = Date.now();
                        const data = await response.json();
                        const responseParseTime = Date.now() - responseStart;
                        
                        console.log(`📥 [OPENAI] Réponse JSON parsée`, {
                            parse_duration: responseParseTime,
                            has_choices: !!data.choices,
                            choices_count: data.choices?.length || 0,
                            attempt: attempt
                        });
                        
                        if (!data.choices || !data.choices[0]?.message?.content) {
                            console.error('❌ [OPENAI] Réponse invalide - structure manquante', {
                                data_structure: {
                                    has_choices: !!data.choices,
                                    choices_length: data.choices?.length,
                                    first_choice: data.choices?.[0],
                                    has_message: !!data.choices?.[0]?.message,
                                    has_content: !!data.choices?.[0]?.message?.content
                                },
                                attempt: attempt
                            });
                            
                            APILogger.log('error', 'openai', 'invalid-response', {
                                error: 'Structure de réponse invalide',
                                data_preview: JSON.stringify(data).substring(0, 200),
                                attempt: attempt,
                                duration: Date.now() - startTime
                            });
                            
                            throw new Error('Réponse invalide de l\'API OpenAI');
                        }

                        const content = data.choices[0].message.content.trim();
                        const successDuration = Date.now() - startTime;
                        
                        console.log(`🎉 [OPENAI] Succès complet!`, {
                            content_length: content.length,
                            content_preview: content.substring(0, 100) + (content.length > 100 ? '...' : ''),
                            attempt: attempt,
                            total_duration: successDuration,
                            fetch_duration: fetchDuration,
                            parse_duration: responseParseTime,
                            usage: data.usage
                        });
                        
                        APILogger.log('success', 'openai', 'api-call-success', {
                            duration: successDuration,
                            attempt: attempt,
                            content_length: content.length,
                            model: requestBody.model,
                            prompt_length: prompt.length,
                            usage: data.usage
                        });

                        return content;
                    } catch (error) {
                        console.error(`❌ [OPENAI] Tentative ${attempt}/${retries} échouée`, {
                            error_message: error.message,
                            error_type: error.constructor.name,
                            attempt: attempt,
                            duration_so_far: Date.now() - startTime,
                            stack: error.stack?.split('\n')[0]
                        });
                        
                        APILogger.log('error', 'openai', 'attempt-failed', {
                            error: error.message,
                            attempt: attempt,
                            duration: Date.now() - startTime,
                            error_type: error.constructor.name
                        });
                        
                        if (attempt === retries) {
                            console.error('🔴 [OPENAI] Toutes les tentatives épuisées', {
                                total_attempts: retries,
                                final_error: error.message,
                                total_duration: Date.now() - startTime
                            });
                            
                            APILogger.log('error', 'openai', 'all-attempts-failed', {
                                error: error.message,
                                total_attempts: retries,
                                duration: Date.now() - startTime
                            });
                            
                            throw error;
                        }
                        
                        if (!error.message.includes('QUOTA_EXCEEDED')) {
                            const waitTime = Math.pow(2, attempt) * 1000;
                            console.log(`⏳ [OPENAI] Attente avant retry`, {
                                delay_ms: waitTime,
                                delay_seconds: waitTime/1000,
                                next_attempt: attempt + 1,
                                remaining_attempts: retries - attempt
                            });
                            await new Promise(resolve => setTimeout(resolve, waitTime));
                        } else {
                            console.error('🚫 [OPENAI] Quota exceeded - abandon immédiat', {
                                error: error.originalError,
                                retry_after: error.retryAfter
                            });
                            throw error;
                        }
                    }
                }
            }

            // Système de priorité des APIs
            async function callAIWithPriority(prompt, options = {}) {
                const startTime = Date.now();
                const priority = localStorage.getItem('api-priority') || 'gemini-first';
                
                console.log('🎯 [PRIORITY] Début callAIWithPriority', {
                    timestamp: new Date().toISOString(),
                    priority: priority,
                    prompt_length: prompt.length,
                    options: options,
                    start_time: startTime
                });
                
                APILogger.log('info', 'priority', 'call-start', {
                    priority: priority,
                    prompt_length: prompt.length,
                    options: options
                });
                
                const tryGemini = async () => {
                    console.log('🔵 [PRIORITY] Tentative Gemini', {
                        priority: priority,
                        action: 'try-gemini'
                    });
                    
                    try {
                        updateCombinedApiStatus('active', 'Gemini actif', 'gemini');
                        const geminiStartTime = Date.now();
                        const result = await callGeminiAPI(prompt, options);
                        const geminiDuration = Date.now() - geminiStartTime;
                        
                        console.log('✅ [PRIORITY] Gemini réussi', {
                            duration: geminiDuration,
                            result_length: result?.length || 0
                        });
                        
                        APILogger.log('success', 'priority', 'gemini-success', {
                            duration: geminiDuration,
                            result_length: result?.length || 0
                        });
                        
                        return result;
                    } catch (error) {
                        console.error('❌ [PRIORITY] Gemini échoué', {
                            error_message: error.message,
                            error_type: error.constructor.name,
                            is_quota_exceeded: error.message.includes('QUOTA_EXCEEDED') || error.message.includes('429')
                        });
                        
                        APILogger.log('error', 'priority', 'gemini-failed', {
                            error: error.message,
                            error_type: error.constructor.name,
                            is_quota_exceeded: error.message.includes('QUOTA_EXCEEDED') || error.message.includes('429')
                        });
                        
                        if (error.message.includes('QUOTA_EXCEEDED') || error.message.includes('429')) {
                            console.log('🚫 [PRIORITY] Quota Gemini dépassé, fallback possible', {
                                error: error.message
                            });
                            return null;
                        }
                        throw error;
                    }
                };
                
                const tryOpenAI = async () => {
                    console.log('🟢 [PRIORITY] Tentative OpenAI', {
                        priority: priority,
                        action: 'try-openai'
                    });
                    
                    try {
                        const currentModel = controls.openaiModel?.value || 'gpt-4o';
                        const modelDisplay = currentModel === 'gpt-5' ? '🚀 GPT-5 actif' : `OpenAI ${currentModel.toUpperCase()} actif`;
                        updateCombinedApiStatus('active', modelDisplay, 'openai');
                        
                        const openaiStartTime = Date.now();
                        const result = await callOpenAIAPI(prompt, options);
                        const openaiDuration = Date.now() - openaiStartTime;
                        
                        console.log('✅ [PRIORITY] OpenAI réussi', {
                            model: currentModel,
                            duration: openaiDuration,
                            result_length: result?.length || 0
                        });
                        
                        APILogger.log('success', 'priority', 'openai-success', {
                            model: currentModel,
                            duration: openaiDuration,
                            result_length: result?.length || 0
                        });
                        
                        return result;
                    } catch (error) {
                        console.error('❌ [PRIORITY] OpenAI échoué', {
                            error_message: error.message,
                            error_type: error.constructor.name,
                            is_quota_exceeded: error.message.includes('QUOTA_EXCEEDED') || error.message.includes('429')
                        });
                        
                        APILogger.log('error', 'priority', 'openai-failed', {
                            error: error.message,
                            error_type: error.constructor.name,
                            is_quota_exceeded: error.message.includes('QUOTA_EXCEEDED') || error.message.includes('429')
                        });
                        
                        if (error.message.includes('QUOTA_EXCEEDED') || error.message.includes('429')) {
                            console.log('🚫 [PRIORITY] Quota OpenAI dépassé', {
                                error: error.message
                            });
                            return null;
                        }
                        throw error;
                    }
                };

                console.log('🎯 [PRIORITY] Stratégie sélectionnée', {
                    priority: priority,
                    strategy: `${priority} strategy`
                });

                switch (priority) {
                    case 'gemini-first':
                        console.log('🔵 [PRIORITY] Stratégie Gemini-First', { priority });
                        let geminiResult = await tryGemini();
                        if (geminiResult !== null) {
                            console.log('🎉 [PRIORITY] Succès avec Gemini (premier choix)', {
                                priority: priority,
                                total_duration: Date.now() - startTime
                            });
                            return geminiResult;
                        }
                        
                        // Fallback vers OpenAI
                        console.log('🔄 [PRIORITY] Fallback vers OpenAI', { priority });
                        const openaiKey = localStorage.getItem('openai-api-key');
                        if (openaiKey) {
                            const currentModel = controls.openaiModel?.value || 'gpt-4o';
                            const modelName = currentModel === 'gpt-5' ? '🚀 GPT-5' : currentModel.toUpperCase();
                            showToast(`Basculement vers ${modelName} (quota Gemini dépassé)`, 'info');
                            let openaiResult = await tryOpenAI();
                            if (openaiResult !== null) {
                                console.log('🎉 [PRIORITY] Succès avec OpenAI (fallback)', {
                                    priority: priority,
                                    model: currentModel,
                                    total_duration: Date.now() - startTime
                                });
                                return openaiResult;
                            }
                        } else {
                            console.log('🚫 [PRIORITY] Pas de clé OpenAI pour fallback', { priority });
                        }
                        break;
                        
                    case 'openai-first':
                        console.log('🟢 [PRIORITY] Stratégie OpenAI-First', { priority });
                        const openaiKey2 = localStorage.getItem('openai-api-key');
                        if (openaiKey2) {
                            let openaiResult = await tryOpenAI();
                            if (openaiResult !== null) {
                                console.log('🎉 [PRIORITY] Succès avec OpenAI (premier choix)', {
                                    priority: priority,
                                    total_duration: Date.now() - startTime
                                });
                                return openaiResult;
                            }
                        } else {
                            console.log('🚫 [PRIORITY] Pas de clé OpenAI configurée', { priority });
                        }
                        
                        // Fallback vers Gemini
                        console.log('🔄 [PRIORITY] Fallback vers Gemini', { priority });
                        const currentModel = controls.openaiModel?.value || 'gpt-4o';
                        const modelName = currentModel === 'gpt-5' ? 'GPT-5' : currentModel.toUpperCase();
                        showToast(`Basculement vers Gemini (quota ${modelName} dépassé)`, 'info');
                        let geminiResult2 = await tryGemini();
                        if (geminiResult2 !== null) {
                            console.log('🎉 [PRIORITY] Succès avec Gemini (fallback)', {
                                priority: priority,
                                total_duration: Date.now() - startTime
                            });
                            return geminiResult2;
                        }
                        break;
                        
                    case 'gemini-only':
                        console.log('🔵 [PRIORITY] Stratégie Gemini-Only', { priority });
                        const geminiOnlyResult = await tryGemini();
                        console.log('🎉 [PRIORITY] Résultat Gemini-Only', {
                            priority: priority,
                            success: geminiOnlyResult !== null,
                            total_duration: Date.now() - startTime
                        });
                        return geminiOnlyResult;
                        
                    case 'openai-only':
                        console.log('🟢 [PRIORITY] Stratégie OpenAI-Only', { priority });
                        const openaiOnlyResult = await tryOpenAI();
                        console.log('🎉 [PRIORITY] Résultat OpenAI-Only', {
                            priority: priority,
                            success: openaiOnlyResult !== null,
                            total_duration: Date.now() - startTime
                        });
                        return openaiOnlyResult;
                        
                    case 'french-first':
                        console.log('🇫🇷 [PRIORITY] Stratégie French-First', { priority });
                        
                        // Tenter les APIs françaises en premier
                        const tryFrenchFirst = async () => {
                            const frenchAPIs = [
                                { name: 'Mistral AI', fn: callMistralAPI, key: 'mistral-api-key', icon: '🇫🇷' },
                                { name: 'Hugging Face', fn: callHuggingFaceAPI, key: 'huggingface-token', icon: '🤗' },
                                { name: 'Groq', fn: callGroqAPI, key: 'groq-api-key', icon: '⚡' }
                            ];
                            
                            for (const api of frenchAPIs) {
                                const hasKey = localStorage.getItem(api.key);
                                if (hasKey) {
                                    try {
                                        console.log(`${api.icon} [PRIORITY] Tentative ${api.name} (priorité française)`, { priority });
                                        const result = await api.fn(prompt, options);
                                        if (result) {
                                            console.log(`🎉 [PRIORITY] Succès avec ${api.name} (priorité française)`, {
                                                priority: priority,
                                                api: api.name,
                                                total_duration: Date.now() - startTime
                                            });
                                            return result;
                                        }
                                    } catch (error) {
                                        console.log(`💥 [PRIORITY] ${api.name} a échoué (priorité française)`, {
                                            priority: priority,
                                            api: api.name,
                                            error: error.message
                                        });
                                    }
                                }
                            }
                            return null;
                        };
                        
                        const frenchFirstResult = await tryFrenchFirst();
                        if (frenchFirstResult !== null) {
                            return frenchFirstResult;
                        }
                        
                        // Fallback vers Gemini
                        console.log('🔄 [PRIORITY] Fallback vers Gemini (après APIs françaises)', { priority });
                        let geminiResultFrench = await tryGemini();
                        if (geminiResultFrench !== null) {
                            console.log('🎉 [PRIORITY] Succès avec Gemini (fallback après français)', {
                                priority: priority,
                                total_duration: Date.now() - startTime
                            });
                            return geminiResultFrench;
                        }
                        
                        // Fallback final vers OpenAI
                        console.log('🔄 [PRIORITY] Fallback final vers OpenAI (après français + Gemini)', { priority });
                        const openaiKeyFrench = localStorage.getItem('openai-api-key');
                        if (openaiKeyFrench) {
                            let openaiResultFrench = await tryOpenAI();
                            if (openaiResultFrench !== null) {
                                console.log('🎉 [PRIORITY] Succès avec OpenAI (fallback final français)', {
                                    priority: priority,
                                    total_duration: Date.now() - startTime
                                });
                                return openaiResultFrench;
                            }
                        }
                        break;
                }
                
                // 🇫🇷 FALLBACK FINAL: APIs Françaises Gratuites
                console.log('🇫🇷 [PRIORITY] Tentative fallback APIs françaises', { priority });
                
                // Fonction helper pour tester les APIs françaises
                const tryFrenchAPIs = async () => {
                    const frenchAPIs = [
                        { name: 'Hugging Face', fn: callHuggingFaceAPI, key: 'huggingface-token', icon: '🤗' },
                        { name: 'Mistral AI', fn: callMistralAPI, key: 'mistral-api-key', icon: '🇫🇷' },
                        { name: 'Groq', fn: callGroqAPI, key: 'groq-api-key', icon: '⚡' }
                    ];
                    
                    for (const api of frenchAPIs) {
                        const hasKey = localStorage.getItem(api.key);
                        if (hasKey) {
                            try {
                                console.log(`${api.icon} [PRIORITY] Tentative ${api.name}`, { priority });
                                showToast(`${api.icon} Tentative ${api.name} (APIs principales épuisées)`, 'info');
                                
                                const result = await api.fn(prompt, options);
                                if (result) {
                                    console.log(`🎉 [PRIORITY] Succès avec ${api.name} (fallback français)`, {
                                        priority: priority,
                                        api: api.name,
                                        total_duration: Date.now() - startTime
                                    });
                                    
                                    showToast(`${api.icon} ${api.name} a pris le relais avec succès!`, 'success');
                                    
                                    APILogger.log('success', 'priority', 'french-api-success', {
                                        api: api.name,
                                        priority: priority,
                                        duration: Date.now() - startTime
                                    });
                                    
                                    return result;
                                }
                            } catch (error) {
                                console.log(`💥 [PRIORITY] ${api.name} a échoué`, {
                                    priority: priority,
                                    api: api.name,
                                    error: error.message
                                });
                                
                                APILogger.log('error', 'priority', 'french-api-failed', {
                                    api: api.name,
                                    error: error.message,
                                    priority: priority
                                });
                                // Continue vers la prochaine API
                            }
                        } else {
                            console.log(`🚫 [PRIORITY] ${api.name} - pas de clé configurée`, { priority });
                        }
                    }
                    return null;
                };
                
                const frenchResult = await tryFrenchAPIs();
                if (frenchResult !== null) {
                    return frenchResult;
                }
                
                const finalDuration = Date.now() - startTime;
                console.error('💥 [PRIORITY] Toutes les APIs ont échoué (y compris françaises)', {
                    priority: priority,
                    total_duration: finalDuration
                });
                
                APILogger.log('error', 'priority', 'all-apis-failed', {
                    priority: priority,
                    duration: finalDuration,
                    error: 'Toutes les APIs indisponibles (principales + françaises)'
                });
                
                showToast('❌ Toutes les APIs sont indisponibles (quotas épuisés)', 'error');
                updateCombinedApiStatus('error', 'Toutes les APIs indisponibles', 'none');
                throw new Error('Toutes les APIs ont atteint leur quota ou sont indisponibles');
            }

            // ================================
            // 🇫🇷 APIS FRANÇAISES GRATUITES 
            // ================================

            // 1️⃣ Hugging Face API (Plateforme française, 1000+ modèles gratuits)
            async function callHuggingFaceAPI(prompt, options = {}) {
                const startTime = Date.now();
                const hfToken = localStorage.getItem('huggingface-token') || '';
                const hfModel = localStorage.getItem('huggingface-model') || 'microsoft/DialoGPT-medium';
                
                console.log('🤗 [HUGGINGFACE] Début appel API', {
                    model: hfModel,
                    prompt_length: prompt.length,
                    has_token: !!hfToken
                });
                
                if (!hfToken) {
                    throw new Error('Token Hugging Face requis');
                }
                
                try {
                    const response = await fetch(`https://api-inference.huggingface.co/models/${hfModel}`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${hfToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            inputs: prompt,
                            parameters: {
                                max_new_tokens: options.maxTokens || 500,
                                temperature: options.temperature || 0.7,
                                top_p: 0.9,
                                do_sample: true
                            }
                        })
                    });
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`Erreur ${response.status}: ${errorText}`);
                    }
                    
                    const data = await response.json();
                    let result = '';
                    
                    if (Array.isArray(data) && data[0]) {
                        result = data[0].generated_text || data[0].translation_text || JSON.stringify(data[0]);
                    } else if (data.generated_text) {
                        result = data.generated_text;
                    } else {
                        result = JSON.stringify(data);
                    }
                    
                    const duration = Date.now() - startTime;
                    console.log('🎉 [HUGGINGFACE] Succès', {
                        model: hfModel,
                        duration: duration,
                        response_length: result.length
                    });
                    
                    APILogger.log('success', 'huggingface', 'api-call', {
                        model: hfModel,
                        duration: duration,
                        tokens_used: result.length
                    });
                    
                    return result;
                    
                } catch (error) {
                    const duration = Date.now() - startTime;
                    console.error('💥 [HUGGINGFACE] Erreur', {
                        model: hfModel,
                        error: error.message,
                        duration: duration
                    });
                    
                    APILogger.log('error', 'huggingface', 'api-error', {
                        model: hfModel,
                        error: error.message,
                        duration: duration
                    });
                    
                    throw error;
                }
            }

            // 2️⃣ Mistral AI API (Entreprise française, quota généreux)
            async function callMistralAPI(prompt, options = {}) {
                const startTime = Date.now();
                const mistralKey = localStorage.getItem('mistral-api-key') || '';
                const mistralModel = localStorage.getItem('mistral-model') || 'mistral-tiny';
                
                console.log('🇫🇷 [MISTRAL] Début appel API', {
                    model: mistralModel,
                    prompt_length: prompt.length,
                    has_key: !!mistralKey
                });
                
                if (!mistralKey) {
                    throw new Error('Clé API Mistral requise');
                }
                
                try {
                    const response = await fetch('https://api.mistral.ai/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${mistralKey}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            model: mistralModel,
                            messages: [
                                {
                                    role: 'user',
                                    content: prompt
                                }
                            ],
                            max_tokens: options.maxTokens || 500,
                            temperature: options.temperature || 0.7
                        })
                    });
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`Erreur ${response.status}: ${errorText}`);
                    }
                    
                    const data = await response.json();
                    const result = data.choices[0].message.content;
                    
                    const duration = Date.now() - startTime;
                    console.log('🎉 [MISTRAL] Succès', {
                        model: mistralModel,
                        duration: duration,
                        response_length: result.length,
                        tokens_used: data.usage?.total_tokens || 'N/A'
                    });
                    
                    APILogger.log('success', 'mistral', 'api-call', {
                        model: mistralModel,
                        duration: duration,
                        tokens_used: data.usage?.total_tokens || 0
                    });
                    
                    return result;
                    
                } catch (error) {
                    const duration = Date.now() - startTime;
                    console.error('💥 [MISTRAL] Erreur', {
                        model: mistralModel,
                        error: error.message,
                        duration: duration
                    });
                    
                    APILogger.log('error', 'mistral', 'api-error', {
                        model: mistralModel,
                        error: error.message,
                        duration: duration
                    });
                    
                    throw error;
                }
            }

            // 3️⃣ Groq API (Inférence ultra-rapide, quota gratuit généreux)
            async function callGroqAPI(prompt, options = {}) {
                const startTime = Date.now();
                const groqKey = localStorage.getItem('groq-api-key') || '';
                const groqModel = localStorage.getItem('groq-model') || 'llama2-70b-4096';
                
                console.log('⚡ [GROQ] Début appel API', {
                    model: groqModel,
                    prompt_length: prompt.length,
                    has_key: !!groqKey
                });
                
                if (!groqKey) {
                    throw new Error('Clé API Groq requise');
                }
                
                try {
                    const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${groqKey}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            model: groqModel,
                            messages: [
                                {
                                    role: 'user',
                                    content: prompt
                                }
                            ],
                            max_tokens: options.maxTokens || 500,
                            temperature: options.temperature || 0.7
                        })
                    });
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`Erreur ${response.status}: ${errorText}`);
                    }
                    
                    const data = await response.json();
                    const result = data.choices[0].message.content;
                    
                    const duration = Date.now() - startTime;
                    console.log('🎉 [GROQ] Succès', {
                        model: groqModel,
                        duration: duration,
                        response_length: result.length,
                        tokens_used: data.usage?.total_tokens || 'N/A'
                    });
                    
                    APILogger.log('success', 'groq', 'api-call', {
                        model: groqModel,
                        duration: duration,
                        tokens_used: data.usage?.total_tokens || 0
                    });
                    
                    return result;
                    
                } catch (error) {
                    const duration = Date.now() - startTime;
                    console.error('💥 [GROQ] Erreur', {
                        model: groqModel,
                        error: error.message,
                        duration: duration
                    });
                    
                    APILogger.log('error', 'groq', 'api-error', {
                        model: groqModel,
                        error: error.message,
                        duration: duration
                    });
                    
                    throw error;
                }
            }

            // Tester la connexion OpenAI
            async function testOpenAIConnection() {
                if (!controls.testOpenaiConnection) return;
                
                const button = controls.testOpenaiConnection;
                const originalText = button.innerHTML;
                button.disabled = true;
                button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Test...';
                
                updateCombinedApiStatus('testing', 'Test OpenAI en cours...', 'openai');
                
                try {
                    const currentModel = controls.openaiModel?.value || 'gpt-4o';
                    const testPrompt = "Réponds simplement 'Test OpenAI réussi' si tu reçois ce message.";
                    const result = await callOpenAIAPI(testPrompt, { maxTokens: 20 });
                    
                    // Message spécial pour GPT-5
                    if (currentModel === 'gpt-5') {
                        updateCombinedApiStatus('success', '🚀 GPT-5 opérationnel (Nouvelle Génération)', 'openai');
                        showNotification('🚀 Test GPT-5 réussi: ' + result + ' (Nouvelle génération activée!)', 'success');
                    } else {
                        updateCombinedApiStatus('success', `OpenAI ${currentModel.toUpperCase()} opérationnel`, 'openai');
                        showNotification(`✅ Test ${currentModel.toUpperCase()} réussi: ` + result, 'success');
                    }
                } catch (error) {
                    updateCombinedApiStatus('error', `Erreur OpenAI: ${error.message}`, 'openai');
                    showNotification(`❌ Erreur OpenAI: ${error.message}`, 'error');
                } finally {
                    button.disabled = false;
                    button.innerHTML = originalText;
                }
            }

            // ================================
            // 🇫🇷 TESTS APIS FRANÇAISES
            // ================================

            // Test Hugging Face API
            async function testHuggingFaceAPI() {
                const button = document.getElementById('test-huggingface');
                if (!button) return;
                
                const originalText = button.innerHTML;
                button.disabled = true;
                button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Test...';
                
                try {
                    const testPrompt = "Bonjour, réponds simplement 'Test Hugging Face réussi' si tu reçois ce message.";
                    const result = await callHuggingFaceAPI(testPrompt, { maxTokens: 50 });
                    
                    document.getElementById('huggingface-status').innerHTML = 
                        '<i class="fas fa-check-circle text-green-600"></i> <span class="text-green-700">🤗 Hugging Face opérationnel</span>';
                    showNotification('✅ Test Hugging Face réussi: ' + (result.substring(0, 100) + '...'), 'success');
                    
                } catch (error) {
                    document.getElementById('huggingface-status').innerHTML = 
                        '<i class="fas fa-exclamation-circle text-red-600"></i> <span class="text-red-700">Erreur: ' + error.message + '</span>';
                    showNotification('❌ Erreur Hugging Face: ' + error.message, 'error');
                } finally {
                    button.disabled = false;
                    button.innerHTML = originalText;
                }
            }

            // Test Mistral AI API
            async function testMistralAPI() {
                const button = document.getElementById('test-mistral');
                if (!button) return;
                
                const originalText = button.innerHTML;
                button.disabled = true;
                button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Test...';
                
                try {
                    const testPrompt = "Bonjour, réponds simplement 'Test Mistral AI réussi' si tu reçois ce message.";
                    const result = await callMistralAPI(testPrompt, { maxTokens: 50 });
                    
                    document.getElementById('mistral-status').innerHTML = 
                        '<i class="fas fa-check-circle text-green-600"></i> <span class="text-green-700">🇫🇷 Mistral AI opérationnel</span>';
                    showNotification('✅ Test Mistral AI réussi: ' + result.substring(0, 100), 'success');
                    
                } catch (error) {
                    document.getElementById('mistral-status').innerHTML = 
                        '<i class="fas fa-exclamation-circle text-red-600"></i> <span class="text-red-700">Erreur: ' + error.message + '</span>';
                    showNotification('❌ Erreur Mistral AI: ' + error.message, 'error');
                } finally {
                    button.disabled = false;
                    button.innerHTML = originalText;
                }
            }

            // Test Groq API
            async function testGroqAPI() {
                const button = document.getElementById('test-groq');
                if (!button) return;
                
                const originalText = button.innerHTML;
                button.disabled = true;
                button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Test...';
                
                try {
                    const testPrompt = "Hello, just respond 'Test Groq successful' if you receive this message.";
                    const result = await callGroqAPI(testPrompt, { maxTokens: 50 });
                    
                    document.getElementById('groq-status').innerHTML = 
                        '<i class="fas fa-check-circle text-green-600"></i> <span class="text-green-700">⚡ Groq opérationnel</span>';
                    showNotification('✅ Test Groq réussi: ' + result.substring(0, 100), 'success');
                    
                } catch (error) {
                    document.getElementById('groq-status').innerHTML = 
                        '<i class="fas fa-exclamation-circle text-red-600"></i> <span class="text-red-700">Erreur: ' + error.message + '</span>';
                    showNotification('❌ Erreur Groq: ' + error.message, 'error');
                } finally {
                    button.disabled = false;
                    button.innerHTML = originalText;
                }
            }

            // Fonction pour sauvegarder les configs APIs françaises
            function saveFrenchAPIsConfig() {
                // Hugging Face
                const hfToken = document.getElementById('huggingface-token')?.value?.trim();
                const hfModel = document.getElementById('huggingface-model')?.value;
                if (hfToken) localStorage.setItem('huggingface-token', hfToken);
                if (hfModel) localStorage.setItem('huggingface-model', hfModel);
                
                // Mistral AI
                const mistralKey = document.getElementById('mistral-api-key')?.value?.trim();
                const mistralModel = document.getElementById('mistral-model')?.value;
                if (mistralKey) localStorage.setItem('mistral-api-key', mistralKey);
                if (mistralModel) localStorage.setItem('mistral-model', mistralModel);
                
                // Groq
                const groqKey = document.getElementById('groq-api-key')?.value?.trim();
                const groqModel = document.getElementById('groq-model')?.value;
                if (groqKey) localStorage.setItem('groq-api-key', groqKey);
                if (groqModel) localStorage.setItem('groq-model', groqModel);
                
                showNotification('🇫🇷 Configuration APIs françaises sauvegardée', 'success');
            }

            // Charger les configs APIs françaises au démarrage
            function loadFrenchAPIsConfig() {
                // Hugging Face
                const hfToken = localStorage.getItem('huggingface-token');
                const hfModel = localStorage.getItem('huggingface-model');
                if (hfToken && document.getElementById('huggingface-token')) {
                    document.getElementById('huggingface-token').value = hfToken;
                }
                if (hfModel && document.getElementById('huggingface-model')) {
                    document.getElementById('huggingface-model').value = hfModel;
                }
                
                // Mistral AI
                const mistralKey = localStorage.getItem('mistral-api-key');
                const mistralModel = localStorage.getItem('mistral-model');
                if (mistralKey && document.getElementById('mistral-api-key')) {
                    document.getElementById('mistral-api-key').value = mistralKey;
                }
                if (mistralModel && document.getElementById('mistral-model')) {
                    document.getElementById('mistral-model').value = mistralModel;
                }
                
                // Groq
                const groqKey = localStorage.getItem('groq-api-key');
                const groqModel = localStorage.getItem('groq-model');
                if (groqKey && document.getElementById('groq-api-key')) {
                    document.getElementById('groq-api-key').value = groqKey;
                }
                if (groqModel && document.getElementById('groq-model')) {
                    document.getElementById('groq-model').value = groqModel;
                }
            }

            // Mettre à jour le statut combiné des APIs
            function updateCombinedApiStatus(status, message, activeApi = '') {
                if (!controls.combinedApiStatus) return;
                
                const statusElement = controls.combinedApiStatus;
                const iconElement = controls.combinedStatusIcon;
                const textElement = controls.combinedStatusText;
                const activeApiElement = controls.activeApiIndicator;
                
                // Réinitialiser les classes
                statusElement.className = 'p-2 rounded border';
                iconElement.className = '';
                
                switch (status) {
                    case 'testing':
                        statusElement.classList.add('bg-blue-50', 'border-blue-200');
                        iconElement.className = 'fas fa-spinner fa-spin text-blue-600';
                        break;
                    case 'success':
                        statusElement.classList.add('bg-green-50', 'border-green-200');
                        iconElement.className = 'fas fa-check-circle text-green-600';
                        break;
                    case 'active':
                        statusElement.classList.add('bg-green-50', 'border-green-200');
                        iconElement.className = 'fas fa-circle text-green-500';
                        break;
                    case 'error':
                        statusElement.classList.add('bg-red-50', 'border-red-200');
                        iconElement.className = 'fas fa-exclamation-circle text-red-600';
                        break;
                    case 'warning':
                        statusElement.classList.add('bg-yellow-50', 'border-yellow-200');
                        iconElement.className = 'fas fa-exclamation-triangle text-yellow-600';
                        break;
                }
                
                if (textElement) textElement.textContent = message;
                
                if (activeApiElement) {
                    switch (activeApi) {
                        case 'gemini':
                            activeApiElement.textContent = '🤖 Gemini';
                            break;
                        case 'openai':
                            activeApiElement.textContent = '🤖 OpenAI';
                            break;
                        case 'none':
                            activeApiElement.textContent = '❌ Aucune API';
                            break;
                        default:
                            activeApiElement.textContent = '';
                    }
                }
                
                statusElement.classList.remove('hidden');
            }

            // Sauvegarder les configurations OpenAI
            function saveOpenAIConfig() {
                const apiKey = controls.openaiApiKey?.value?.trim();
                const model = controls.openaiModel?.value;
                const priority = controls.apiPriority?.value;
                
                if (apiKey) {
                    localStorage.setItem('openai-api-key', apiKey);
                    showNotification('Clé API OpenAI sauvegardée', 'success');
                }
                
                if (model) {
                    localStorage.setItem('openai-model', model);
                }
                
                if (priority) {
                    localStorage.setItem('api-priority', priority);
                }
                
                updateCombinedApiStatus('success', 'Configuration OpenAI sauvegardée', 'openai');
            }

            // Charger les configurations OpenAI
            function loadOpenAIConfig() {
                const apiKey = localStorage.getItem('openai-api-key');
                const model = localStorage.getItem('openai-model') || 'gpt-4o';
                const priority = localStorage.getItem('api-priority') || 'gemini-first';
                
                if (controls.openaiApiKey && apiKey) {
                    controls.openaiApiKey.value = apiKey;
                }
                
                if (controls.openaiModel) {
                    controls.openaiModel.value = model;
                }
                
                if (controls.apiPriority) {
                    controls.apiPriority.value = priority;
                }
            }

            // ================================
            // 🎯 NOUVEAU SYSTÈME DE SÉLECTION D'API UNIFIÉ
            // ================================

            // Fonction pour mettre à jour le statut des APIs dans l'interface
            function updateAPIStatus() {
                // Mettre à jour les compteurs de clés Gemini
                const geminiKeys = GeminiKeysManager.getAllKeys();
                const geminiKeysCountElement = document.getElementById('gemini-keys-count');
                if (geminiKeysCountElement) {
                    geminiKeysCountElement.textContent = `${geminiKeys.length} clé${geminiKeys.length > 1 ? 's' : ''}`;
                }
                
                // Mettre à jour le modèle OpenAI
                const openaiModel = localStorage.getItem('openai-model') || 'gpt-4o';
                const openaiModelDisplay = document.getElementById('openai-model-display');
                if (openaiModelDisplay) {
                    openaiModelDisplay.textContent = openaiModel.toUpperCase();
                }
                
                // Mettre à jour les modèles des APIs françaises
                const hfModel = localStorage.getItem('huggingface-model') || 'DialoGPT-medium';
                const hfModelDisplay = document.getElementById('hf-model-display');
                if (hfModelDisplay) {
                    hfModelDisplay.textContent = hfModel.split('/').pop() || hfModel;
                }
                
                const mistralModel = localStorage.getItem('mistral-model') || 'mistral-tiny';
                const mistralModelDisplay = document.getElementById('mistral-model-display');
                if (mistralModelDisplay) {
                    mistralModelDisplay.textContent = mistralModel;
                }
                
                const groqModel = localStorage.getItem('groq-model') || 'llama2-70b-4096';
                const groqModelDisplay = document.getElementById('groq-model-display');
                if (groqModelDisplay) {
                    groqModelDisplay.textContent = groqModel.split('-')[0];
                }
                
                // Mettre à jour les statuts de connexion
                updateAPIConnectionStatus();
            }

            // Fonction pour mettre à jour les statuts de connexion (points colorés)
            function updateAPIConnectionStatus() {
                // Gemini
                const geminiKeys = GeminiKeysManager.getAllKeys();
                const geminiDot = document.querySelector('#select-gemini-multi + .api-card .api-status-dot');
                if (geminiDot) {
                    if (geminiKeys.length > 0) {
                        geminiDot.classList.remove('bg-gray-400');
                        geminiDot.classList.add('online');
                    } else {
                        geminiDot.classList.remove('online');
                        geminiDot.classList.add('bg-gray-400');
                    }
                }
                
                // OpenAI
                const openaiKey = localStorage.getItem('openai-api-key');
                const openaiDot = document.querySelector('#select-openai + .api-card .api-status-dot');
                if (openaiDot) {
                    if (openaiKey) {
                        openaiDot.classList.remove('bg-gray-400');
                        openaiDot.classList.add('online');
                    } else {
                        openaiDot.classList.remove('online');
                        openaiDot.classList.add('bg-gray-400');
                    }
                }
                
                // APIs françaises
                const hfToken = localStorage.getItem('huggingface-token');
                const hfDot = document.querySelector('#select-huggingface + .api-card .api-status-dot');
                if (hfDot) {
                    if (hfToken) {
                        hfDot.classList.remove('bg-gray-400');
                        hfDot.classList.add('online');
                    } else {
                        hfDot.classList.remove('online');
                        hfDot.classList.add('bg-gray-400');
                    }
                }
                
                const mistralKey = localStorage.getItem('mistral-api-key');
                const mistralDot = document.querySelector('#select-mistral + .api-card .api-status-dot');
                if (mistralDot) {
                    if (mistralKey) {
                        mistralDot.classList.remove('bg-gray-400');
                        mistralDot.classList.add('online');
                    } else {
                        mistralDot.classList.remove('online');
                        mistralDot.classList.add('bg-gray-400');
                    }
                }
                
                const groqKey = localStorage.getItem('groq-api-key');
                const groqDot = document.querySelector('#select-groq + .api-card .api-status-dot');
                if (groqDot) {
                    if (groqKey) {
                        groqDot.classList.remove('bg-gray-400');
                        groqDot.classList.add('online');
                    } else {
                        groqDot.classList.remove('online');
                        groqDot.classList.add('bg-gray-400');
                    }
                }
            }

            // Fonction pour changer d'API principale
            function switchPrimaryAPI(apiType) {
                localStorage.setItem('primary-api', apiType);
                
                // Mettre à jour l'affichage du statut API dans la sidebar
                updateSidebarAPIStatus(apiType);
                
                // Afficher/masquer les paramètres de fallback
                const fallbackSettings = document.getElementById('fallback-settings');
                if (fallbackSettings) {
                    if (apiType === 'auto-fallback') {
                        fallbackSettings.classList.remove('hidden');
                    } else {
                        fallbackSettings.classList.add('hidden');
                    }
                }
                
                // Message de confirmation
                const apiNames = {
                    'gemini-multi': '🤖 Gemini Multi-Clés',
                    'openai': '🟢 OpenAI',
                    'huggingface': '🤗 Hugging Face',
                    'mistral': '🇫🇷 Mistral AI',
                    'groq': '⚡ Groq',
                    'auto-fallback': '🎯 Auto-Fallback'
                };
                
                showToast(`API principale changée vers: ${apiNames[apiType]}`, 'success');
                console.log('🔄 [API-SWITCH] API principale changée', { apiType });
            }

            // Fonction pour mettre à jour le statut API dans la sidebar
            function updateSidebarAPIStatus(apiType) {
                const activeDot = document.getElementById('active-api-dot');
                const activeName = document.getElementById('active-api-name');
                const activeBadge = document.getElementById('active-api-badge');
                
                if (!activeDot || !activeName || !activeBadge) return;
                
                // Réinitialiser les couleurs
                activeDot.className = 'w-3 h-3 rounded-full transition-colors';
                
                switch (apiType) {
                    case 'gemini-multi':
                        activeDot.classList.add('bg-blue-500');
                        activeName.textContent = '🤖 Gemini Multi-Clés';
                        activeBadge.textContent = 'UNLIMITED';
                        activeBadge.className = 'px-2 py-1 bg-blue-100 text-blue-600 text-xs rounded-full font-mono';
                        break;
                    case 'openai':
                        activeDot.classList.add('bg-green-500');
                        activeName.textContent = '🟢 OpenAI';
                        const model = localStorage.getItem('openai-model') || 'GPT-4o';
                        activeBadge.textContent = model.toUpperCase();
                        activeBadge.className = 'px-2 py-1 bg-green-100 text-green-600 text-xs rounded-full font-mono';
                        break;
                    case 'huggingface':
                        activeDot.classList.add('bg-yellow-500');
                        activeName.textContent = '🤗 Hugging Face';
                        activeBadge.textContent = 'FREE';
                        activeBadge.className = 'px-2 py-1 bg-yellow-100 text-yellow-600 text-xs rounded-full font-mono';
                        break;
                    case 'mistral':
                        activeDot.classList.add('bg-red-500');
                        activeName.textContent = '🇫🇷 Mistral AI';
                        activeBadge.textContent = 'FRANÇAIS';
                        activeBadge.className = 'px-2 py-1 bg-red-100 text-red-600 text-xs rounded-full font-mono';
                        break;
                    case 'groq':
                        activeDot.classList.add('bg-purple-500');
                        activeName.textContent = '⚡ Groq';
                        activeBadge.textContent = 'FAST';
                        activeBadge.className = 'px-2 py-1 bg-purple-100 text-purple-600 text-xs rounded-full font-mono';
                        break;
                    case 'auto-fallback':
                    default:
                        activeDot.classList.add('bg-green-500');
                        activeName.textContent = '🎯 Auto-Fallback';
                        activeBadge.textContent = 'SMART';
                        activeBadge.className = 'px-2 py-1 bg-green-100 text-green-600 text-xs rounded-full font-mono';
                        break;
                }
            }

            // Fonction pour tester l'API sélectionnée
            async function testSelectedAPI() {
                const selectedRadio = document.querySelector('input[name="primary-api"]:checked');
                if (!selectedRadio) return;
                
                const apiType = selectedRadio.value;
                const testButton = document.getElementById('test-selected-api');
                const resultDiv = document.getElementById('selected-api-test-result');
                
                if (!testButton || !resultDiv) return;
                
                const originalText = testButton.innerHTML;
                testButton.disabled = true;
                testButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Test en cours...';
                resultDiv.classList.remove('hidden');
                resultDiv.innerHTML = '<div class="text-blue-600"><i class="fas fa-spinner fa-spin"></i> Test en cours...</div>';
                
                try {
                    const testPrompt = "Réponds simplement 'Test réussi' si tu reçois ce message.";
                    let result = null;
                    
                    switch (apiType) {
                        case 'gemini-multi':
                            result = await callGeminiAPI(testPrompt, {});
                            break;
                        case 'openai':
                            result = await callOpenAIAPI(testPrompt, { maxTokens: 20 });
                            break;
                        case 'huggingface':
                            result = await callHuggingFaceAPI(testPrompt, { maxTokens: 20 });
                            break;
                        case 'mistral':
                            result = await callMistralAPI(testPrompt, { maxTokens: 20 });
                            break;
                        case 'groq':
                            result = await callGroqAPI(testPrompt, { maxTokens: 20 });
                            break;
                        case 'auto-fallback':
                            result = await callAIWithPriority(testPrompt, { maxTokens: 20 });
                            break;
                    }
                    
                    if (result) {
                        resultDiv.innerHTML = `<div class="text-green-600"><i class="fas fa-check-circle"></i> ✅ Test réussi: ${result.substring(0, 50)}...</div>`;
                        updateAPIConnectionStatus();
                    } else {
                        resultDiv.innerHTML = '<div class="text-red-600"><i class="fas fa-exclamation-circle"></i> ❌ Test échoué: aucune réponse</div>';
                    }
                    
                } catch (error) {
                    resultDiv.innerHTML = `<div class="text-red-600"><i class="fas fa-exclamation-circle"></i> ❌ Erreur: ${error.message}</div>`;
                } finally {
                    testButton.disabled = false;
                    testButton.innerHTML = originalText;
                }
            }

            // Sauvegarder l'ancienne fonction et rediriger vers la nouvelle logique
            const originalCallAIWithPriority = callAIWithPriority;
            
            // Remplacer la fonction globale
            async function callAIWithPriorityUpdated(prompt, options = {}) {
                const primaryAPI = localStorage.getItem('primary-api') || 'auto-fallback';
                
                // Si une API spécifique est sélectionnée, l'utiliser directement
                if (primaryAPI !== 'auto-fallback') {
                    try {
                        switch (primaryAPI) {
                            case 'gemini-multi':
                                return await callGeminiAPI(prompt, options);
                            case 'openai':
                                return await callOpenAIAPI(prompt, options);
                            case 'huggingface':
                                return await callHuggingFaceAPI(prompt, options);
                            case 'mistral':
                                return await callMistralAPI(prompt, options);
                            case 'groq':
                                return await callGroqAPI(prompt, options);
                        }
                    } catch (error) {
                        console.log(`💥 [API-SELECT] ${primaryAPI} a échoué, pas de fallback`, { error: error.message });
                        throw error;
                    }
                }
                
                // Mode auto-fallback: utiliser la logique existante
                return await originalCallAIWithPriority(prompt, options);
            }
            
            // Rediriger toutes les références
            callAIWithPriority = callAIWithPriorityUpdated;


            // --- HISTORY (UNDO/REDO) SYSTEM ---
            // History is not saved, so this is a simple implementation
            function undo() { showNotification("Fonctionnalité non disponible en mode hors ligne.", "error"); }
            function redo() { showNotification("Fonctionnalité non disponible en mode hors ligne.", "error"); }
            
            // --- DRAG & DROP & RESIZE ---
            let activeResizer = null;
            let activeContainer = null;
            let activeCol1 = null;
            let initialX = 0;
            let initialCol1Width = 0;

            function initResize(e) {
                e.preventDefault();
                activeResizer = e.target;
                activeContainer = activeResizer.parentElement;
                const columns = activeContainer.querySelectorAll('.cv-column');
                activeCol1 = columns[0];
                initialX = e.clientX;
                initialCol1Width = activeCol1.offsetWidth;

                document.addEventListener('mousemove', doResize);
                document.addEventListener('mouseup', stopResize);
                document.body.classList.add('is-resizing');
            }

            function doResize(e) {
                if (!activeResizer) return;
                const dx = e.clientX - initialX;
                const newCol1Width = initialCol1Width + dx;
                const containerWidth = activeContainer.offsetWidth;
                
                if (newCol1Width < 50 || newCol1Width > containerWidth - 50) return;

                const newCol1Percent = (newCol1Width / containerWidth) * 100;
                const newCol2Percent = 100 - newCol1Percent;

                activeContainer.classList.remove('layout-2-col-33-67', 'layout-2-col-50-50', 'layout-2-col-67-33');
                activeContainer.style.gridTemplateColumns = `${newCol1Percent}% ${newCol2Percent}%`;
                activeResizer.style.left = `${newCol1Percent}%`;
            }

            function stopResize() {
                document.removeEventListener('mousemove', doResize);
                document.removeEventListener('mouseup', stopResize);
                document.body.classList.remove('is-resizing');
                activeResizer = null;
                activeContainer = null;
                activeCol1 = null;
            }

            function setupAllResizers() {
                document.querySelectorAll('.a4-page').forEach(page => {
                    const container = page.querySelector('.cv-body-container');
                    const oldResizer = container.querySelector('.column-resizer');
                    if (oldResizer) oldResizer.remove();

                    const columns = container.querySelectorAll('.cv-column');
                    if (columns.length === 2 && getComputedStyle(container).gridTemplateColumns.split(' ').length === 2) {
                        const resizer = document.createElement('div');
                        resizer.className = 'column-resizer';
                        container.appendChild(resizer);
                        const col1 = columns[0];
                        const col1WidthPercent = parseFloat(getComputedStyle(col1).width) / parseFloat(getComputedStyle(container).width) * 100;
                        resizer.style.left = col1WidthPercent + '%';
                        resizer.addEventListener('mousedown', initResize);
                    }
                });
            }

            function initializeSortableForPage(pageId) {
                const col1 = document.getElementById(`cv-col-${pageId}-1`);
                const col2 = document.getElementById(`cv-col-${pageId}-2`);
                const onEnd = () => { checkAllPagesOverflow(); };
                if (col1) new Sortable(col1, { group: 'cv-modules', animation: 150, handle: '.drag-handle', ghostClass: 'sortable-ghost', onEnd });
                if (col2) new Sortable(col2, { group: 'cv-modules', animation: 150, handle: '.drag-handle', ghostClass: 'sortable-ghost', onEnd });
            }

            function initializeSkillSorting() {
                const skillLists = document.querySelectorAll('#cv-competences-preview ul');
                skillLists.forEach(list => {
                    new Sortable(list, {
                        group: 'skills', animation: 150, ghostClass: 'skills-ghost',
                        onEnd: function () {
                            syncFormFromPreview(document.getElementById('cv-competences-preview'));
                        }
                    });
                });
            }

            // --- PAGE & OVERFLOW MANAGEMENT ---
            function checkPageOverflow(page) {
                requestAnimationFrame(() => {
                    // Using a 1px tolerance for floating point inaccuracies
                    const isOverflowing = page.scrollHeight > page.clientHeight + 1;
                    page.classList.toggle('is-overflowing', isOverflowing);
                });
            }

            function checkAllPagesOverflow() {
                document.querySelectorAll('.a4-page').forEach(checkPageOverflow);
            }

            function setupOverflowObserver(pageElement) {
                const observer = new ResizeObserver(() => {
                    checkPageOverflow(pageElement);
                });
                // Observe the page element itself and its direct content container
                observer.observe(pageElement);
                const bodyContainer = pageElement.querySelector('.cv-body-container');
                if (bodyContainer) {
                    observer.observe(bodyContainer);
                }
            }
            
            function addNewPage() {
                pageCounter++;
                const newPageContainer = document.createElement('div');
                newPageContainer.className = 'a4-page-container';
                const layoutClass = document.querySelector('.layout-btn.active')?.dataset.layout || 'layout-1-col';
                
                newPageContainer.innerHTML = `
                    <div id="page-${pageCounter}" class="a4-page">
                        <div class="cv-body-container ${layoutClass}">
                            <div id="cv-col-${pageCounter}-1" class="cv-column"></div>
                            <div id="cv-col-${pageCounter}-2" class="cv-column"></div>
                        </div>
                    </div>
                    <button class="remove-page-btn no-print"><i class="fas fa-trash-can"></i></button>
                `;
                
                const addBtnWrapper = document.getElementById('add-page-btn-wrapper');
                preview.previewWrapper.insertBefore(newPageContainer, addBtnWrapper);
                
                const newPageElement = document.getElementById(`page-${pageCounter}`);
                setupOverflowObserver(newPageElement);

                initializeSortableForPage(pageCounter);
                setupAllResizers();
                checkAllPagesOverflow();
            }


            // --- DYNAMIC CONTENT ---
            function createDynamicItem(container, fields, data = {}, index = -1) {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'p-2 border rounded-md bg-white relative';
                
                fields.forEach(field => {
                    const isTextarea = field.type === 'textarea';
                    const input = document.createElement(isTextarea ? 'textarea' : 'input');
                    
                    if (!isTextarea) input.type = 'text';
                    
                    input.placeholder = field.placeholder;
                    input.className = `cv-input w-full p-1 border rounded-sm mb-1 data-${field.key}`;
                    if(isTextarea) input.rows = 3;
                    input.value = data[field.key] || '';
                    itemDiv.appendChild(input);
                });

                const removeBtn = document.createElement('button');
                removeBtn.innerHTML = '<i class="fas fa-times-circle text-red-400 hover:text-red-600"></i>';
                removeBtn.className = 'absolute top-1 right-1 remove-dynamic-item-btn';
                itemDiv.appendChild(removeBtn);
                
                if (index !== -1 && index < container.children.length) {
                    container.insertBefore(itemDiv, container.children[index]);
                } else {
                    container.appendChild(itemDiv);
                }
                
                updatePreview('form');
                const firstInput = itemDiv.querySelector('input, textarea');
                if (firstInput) firstInput.focus();
            }

            function getDynamicData(container) {
                return Array.from(container.children).map(itemDiv => ({
                    title: itemDiv.querySelector('.data-title')?.value || '',
                    meta: itemDiv.querySelector('.data-meta')?.value || '',
                    desc: itemDiv.querySelector('.data-desc')?.value || '',
                }));
            }
            
            // --- SKILLS RENDERING ---
            function renderSkillsAsTags(text) {
                let html = '';
                const sections = text.split('\n').filter(Boolean);
                sections.forEach(section => {
                    const parts = section.split(':');
                    if (parts.length === 2 && parts[0].trim() !== '') {
                        html += `<h3 class="skill-category" contenteditable="true">${parts[0].trim()}</h3>`;
                        html += `<ul>${parts[1].split(',').map(item => item.trim().replace(/\s*\(.*\)/, '')).filter(Boolean).map(item => `<li class="skill-item" contenteditable="false">${item}<span class="delete-skill-btn">&times;</span></li>`).join('')}</ul>`;
                    } else {
                        html += `<ul>${section.split(',').map(item => item.trim().replace(/\s*\(.*\)/, '')).filter(Boolean).map(item => `<li class="skill-item" contenteditable="false">${item}<span class="delete-skill-btn">&times;</span></li>`).join('')}</ul>`;
                    }
                });
                return html;
            }

            function renderSkillsAsLevels() {
                let html = '';
                const gaugeStyle = document.querySelector('.gauge-style-btn.active')?.dataset.gaugeStyle || 'bar';
                const skillItems = controls.skillsLevelList.querySelectorAll('.skill-level-item');

                skillItems.forEach(item => {
                    const name = item.querySelector('.skill-name-input').value;
                    const level = item.querySelector('.skill-level-input').value;
                    if (!name) return;

                    html += `<div class="skill-level">
                                        <div class="skill-level-label" contenteditable="true">${name}</div>
                                        <div class="gauge-container">${renderGauge(level, gaugeStyle)}</div>
                                    </div>`;
                });
                return html;
            }
            
            function renderGauge(level, style) {
                const max = 5;
                let gaugeHtml = '';
                switch (style) {
                    case 'dots':
                        gaugeHtml = `<div class="gauge-dots">`;
                        for (let i = 1; i <= max; i++) gaugeHtml += `<span class="${i <= level ? 'filled' : ''}">●</span>`;
                        gaugeHtml += `</div>`;
                        break;
                    case 'stars':
                        gaugeHtml = `<div class="gauge-stars">`;
                        for (let i = 1; i <= max; i++) gaugeHtml += `<i class="${i <= level ? 'fas' : 'far'} fa-star ${i <= level ? 'filled' : ''}"></i>`;
                        gaugeHtml += `</div>`;
                        break;
                    case 'squares':
                         gaugeHtml = `<div class="gauge-squares">`;
                        for (let i = 1; i <= max; i++) gaugeHtml += `<span class="${i <= level ? 'filled' : ''}">■</span>`;
                        gaugeHtml += `</div>`;
                        break;
                    case 'number':
                        gaugeHtml = `<div class="gauge-number">${level}/${max}</div>`;
                        break;
                    case 'bar':
                    default:
                        const width = (level / max) * 100;
                        gaugeHtml = `<div class="gauge-bar-bg"><div class="gauge-bar-fill" style="width: ${width}%;"></div></div>`;
                        break;
                }
                return gaugeHtml;
            }

            function renderSkillsAsSimple(text) {
                let html = '<ul>';
                const skills = text.split(/,|\n/).map(s => s.trim().replace(/\s*\(.*\)/, '')).filter(Boolean);
                skills.forEach(skill => {
                    html += `<li>${skill}</li>`;
                });
                html += '</ul>';
                return html;
            }

            function createSkillLevelItem(name = '', level = 3) {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'skill-level-item flex items-center gap-2';
                itemDiv.innerHTML = `
                    <input type="text" placeholder="Compétence" value="${name}" class="skill-name-input cv-input flex-grow p-1 border rounded-sm">
                    <input type="range" value="${level}" min="1" max="5" class="skill-level-input w-24">
                    <span class="skill-level-value text-sm font-mono">${level}/5</span>
                    <button class="remove-skill-level-btn text-red-400 hover:text-red-600"><i class="fas fa-times-circle"></i></button>
                `;
                controls.skillsLevelList.appendChild(itemDiv);
                updatePreview('form');
            }

            // --- UPDATES & FORMATTING ---
            function updateBannerBackground() {
                const opacity = controls.bannerBgOpacity.value;
                const blur = controls.bannerBgBlur.value;
                const grayscale = controls.bannerBgGrayscale.checked;

                controls.bannerBgOpacityValue.textContent = opacity;
                controls.bannerBgBlurValue.textContent = blur;

                preview.bannerBgImg.style.opacity = opacity;
                preview.bannerBgImg.style.filter = `blur(${blur}px) grayscale(${grayscale ? 1 : 0})`;
            }

            function updatePreview(source = 'form') {
                if (source === 'form' || source === 'banner-style' || source === 'theme' || source === 'state') {
                    preview.cvNomPrenom.textContent = `${controls.prenom.value} ${controls.nom.value}`.trim() || 'Prénom NOM';
                    preview.cvPoste.textContent = controls.poste.value || 'Poste Recherché';
                    preview.cvDescription.innerHTML = `<div class="editable-wrapper"><p contenteditable="true">${controls.description.value.replace(/\n/g, '<br>') || '&nbsp;'}</p><span class="delete-line-btn"><i class="fas fa-times"></i></span></div>`;
                    
                    const renderDynamicList = (previewContainer, controlContainer, type) => {
                        previewContainer.innerHTML = '';
                        const data = getDynamicData(controlContainer);

                        const createInsertButton = (type, index) => {
                            const wrapper = document.createElement('div');
                            wrapper.className = 'insert-line-wrapper';
                            wrapper.innerHTML = `<button class="add-line-preview-btn" data-type="${type}" data-index="${index}" title="Insérer un nouveau bloc ici"><i class="fas fa-plus"></i></button>`;
                            return wrapper;
                        };

                        const createItemContainer = (item, i) => {
                            const itemContainer = document.createElement('div');
                            itemContainer.className = 'dynamic-item-container';
                            itemContainer.dataset.index = i;
                            itemContainer.dataset.type = type;

                            const itemContent = document.createElement('div');
                            itemContent.className = "dynamic-preview-item";
                            itemContent.innerHTML = `<button class="delete-block-btn" title="Supprimer le bloc"><i class="fas fa-trash-alt"></i></button>`;

                            if (type === 'experience') {
                                const titleHTML = `<div class="editable-wrapper"><p class="item-title" contenteditable="true">${item.title || '&nbsp;'}</p><span class="delete-line-btn"><i class="fas fa-times"></i></span></div>`;
                                const metaHTML = `<div class="editable-wrapper"><p class="item-meta" contenteditable="true">${item.meta || '&nbsp;'}</p><span class="delete-line-btn"><i class="fas fa-times"></i></span></div>`;
                                const descHTML = `<div class="editable-wrapper"><p class="mt-1" contenteditable="true">${item.desc.replace(/\n/g, '<br>') || '&nbsp;'}</p><span class="delete-line-btn"><i class="fas fa-times"></i></span></div>`;
                                const addButtonHTML = `<button class="add-desc-line-btn"><i class="fas fa-plus mr-1"></i> Ajouter une mission</button>`;
                                itemContent.innerHTML += `${titleHTML}${metaHTML}${descHTML}${addButtonHTML}`;
                            } else { // formation
                                const titleHTML = `<div class="editable-wrapper"><p class="item-title" contenteditable="true">${item.title || '&nbsp;'}</p><span class="delete-line-btn"><i class="fas fa-times"></i></span></div>`;
                                const metaHTML = `<div class="editable-wrapper"><p class="item-meta" contenteditable="true">${item.meta || '&nbsp;'}</p><span class="delete-line-btn"><i class="fas fa-times"></i></span></div>`;
                                itemContent.innerHTML += `${titleHTML}${metaHTML}`;
                            }
                            
                            itemContainer.appendChild(createInsertButton(type, i));
                            itemContainer.appendChild(itemContent);
                            return itemContainer;
                        };
                        
                        data.forEach((item, i) => {
                            previewContainer.appendChild(createItemContainer(item, i));
                        });
                        const finalButtonWrapper = document.createElement('div');
                        finalButtonWrapper.className = 'dynamic-item-container';
                        finalButtonWrapper.appendChild(createInsertButton(type, data.length));
                        previewContainer.appendChild(finalButtonWrapper);
                    };

                    renderDynamicList(preview.cvExperience, controls.experienceList, 'experience');
                    renderDynamicList(preview.cvFormation, controls.formationList, 'formation');

                    const skillStyle = document.querySelector('.skill-style-btn.active')?.dataset.skillStyle || 'tags';
                    preview.cvCompetences.dataset.style = skillStyle;
                    
                    if (skillStyle === 'tags') {
                        preview.cvCompetences.innerHTML = renderSkillsAsTags(controls.competences.value);
                        initializeSkillSorting(); 
                    } else if (skillStyle === 'levels') {
                        preview.cvCompetences.innerHTML = renderSkillsAsLevels();
                    } else { // simple
                        preview.cvCompetences.innerHTML = renderSkillsAsSimple(controls.competences.value);
                    }

                    document.querySelectorAll('.custom-module-preview').forEach(m => m.remove());
                    Array.from(controls.customSectionsList.children).forEach(div => {
                        const sectionId = div.dataset.sectionId;
                        const title = div.querySelector('input').value;
                        const content = div.querySelector('textarea').value;
                        const iconClass = div.dataset.icon || 'fas fa-puzzle-piece';
                        
                        const moduleDiv = document.createElement('div');
                        moduleDiv.id = sectionId;
                        moduleDiv.className = 'cv-module custom-module-preview'; 
                        moduleDiv.innerHTML = `
                            <div class="drag-handle"><i class="fas fa-grip-vertical"></i></div>
                            <h2 class="section-title" data-section-id="${sectionId}"><i class="${iconClass} section-icon"></i><span contenteditable="true">${title}</span><div class="section-ai-actions"><button class="ai-action-btn toggle-visibility-btn" title="Masquer/Afficher la section"><i class="fas fa-eye"></i></button></div></h2>
                            <div class="dynamic-preview-item">
                                <button class="delete-block-btn" title="Supprimer la section"><i class="fas fa-trash-alt"></i></button>
                                <div class="editable-wrapper">
                                    <div class="custom-content" contenteditable="true">${content.replace(/\n/g, '<br>') || '&nbsp;'}</div>
                                    <span class="delete-line-btn"><i class="fas fa-times"></i></span>
                                </div>
                            </div>
                        `;
                        const lastModule = document.querySelector('#competences-module');
                        if(lastModule && lastModule.parentElement) {
                            lastModule.parentElement.insertBefore(moduleDiv, lastModule.nextSibling);
                        }
                    });
                    
                    preview.bannerNom.textContent = controls.bannerNom.value || "Nom Prénom Recruteur";
                    preview.bannerPoste.textContent = controls.bannerPoste.value || "Poste du Recruteur";
                    preview.bannerEmail.textContent = controls.bannerEmail.value || "email@recruteur.com";
                    preview.bannerTel.textContent = controls.bannerTel.value || "01 23 45 67 89";
                }

                preview.bannerNom.style.fontFamily = controls.bannerNomFont.value;
                preview.bannerNom.style.fontSize = controls.bannerNomSize.value + 'pt';
                preview.bannerNom.style.color = controls.bannerNomColor.value;
                preview.bannerNom.style.fontWeight = controls.bannerNomBold.classList.contains('active') ? 'bold' : 'normal';
                preview.bannerNom.style.fontStyle = controls.bannerNomItalic.classList.contains('active') ? 'italic' : 'normal';
                
                preview.bannerPoste.style.fontSize = controls.bannerPosteSize.value + 'pt';
                preview.bannerPoste.style.color = controls.bannerPosteColor.value;
                preview.bannerPoste.style.fontWeight = controls.bannerPosteBold.classList.contains('active') ? 'bold' : 'normal';
                preview.bannerPoste.style.fontStyle = controls.bannerPosteItalic.classList.contains('active') ? 'italic' : 'normal';

                preview.bannerContact.style.fontSize = controls.bannerContactSize.value + 'pt';
                preview.bannerContact.style.color = controls.bannerContactColor.value;
                preview.bannerContact.style.fontWeight = controls.bannerContactBold.classList.contains('active') ? 'bold' : 'normal';
                preview.bannerContact.style.fontStyle = controls.bannerContactItalic.classList.contains('active') ? 'italic' : 'normal';
                
                const dispo = controls.qualificationDispo.value;
                const salaire = controls.qualificationSalaire.value;
                const loc = controls.qualificationLoc.value;
                let qualHTML = '';
                if (dispo) qualHTML += `<div><i class="fas fa-calendar-check mr-1 text-gray-400"></i> ${dispo}</div>`;
                if (salaire) qualHTML += `<div><i class="fas fa-euro-sign mr-1 text-gray-400"></i> ${salaire}</div>`;
                if (loc) qualHTML += `<div><i class="fas fa-map-marker-alt mr-1 text-gray-400"></i> ${loc}</div>`;
                preview.qualificationPreview.innerHTML = qualHTML;
                preview.qualificationModule.style.display = (dispo || salaire || loc) ? '' : 'none';

                const isBannerEnabled = controls.toggleBanner.checked;
                const isBannerInTop = preview.fixedBannerTop.contains(preview.banner);
                const isBannerInBottom = preview.fixedBannerBottom.contains(preview.banner);
                const isBannerInModule = preview.bannerModule.contains(preview.banner);
                
                preview.bannerModule.classList.toggle('hidden', !isBannerEnabled || !isBannerInModule);
                preview.fixedBannerTop.style.display = (isBannerEnabled && isBannerInTop) ? 'block' : 'none';
                preview.fixedBannerBottom.style.display = (isBannerEnabled && isBannerInBottom) ? 'block' : 'none';

                checkAllPagesOverflow();
            }
            
            function syncFormFromPreview(element) {
                if (!element) return;
                const id = element.id;

                if (id === 'cv-competences-preview') {
                    const style = preview.cvCompetences.dataset.style;
                    if (style === 'levels') {
                        const skillLabels = preview.cvCompetences.querySelectorAll('.skill-level-label');
                        const controlInputs = controls.skillsLevelList.querySelectorAll('.skill-name-input');
                        skillLabels.forEach((label, index) => {
                            if (controlInputs[index]) {
                                controlInputs[index].value = label.textContent;
                            }
                        });
                    } else { 
                        let result = [];
                        const nodes = Array.from(element.childNodes);
                        for (let i = 0; i < nodes.length; i++) {
                            const node = nodes[i];
                            if (node.nodeName === 'H3' && node.classList.contains('skill-category')) {
                                const categoryName = node.textContent.trim();
                                const nextNode = nodes[i + 1];
                                if (nextNode && nextNode.nodeName === 'UL') {
                                    const skills = Array.from(nextNode.querySelectorAll('li.skill-item')).map(li => li.textContent.replace('×', '').trim()).filter(Boolean).join(', ');
                                    if (categoryName && skills) {
                                        result.push(`${categoryName}: ${skills}`);
                                    }
                                    i++; 
                                }
                            } else if (node.nodeName === 'UL') {
                                const skills = Array.from(node.querySelectorAll('li')).map(li => li.textContent.replace('×', '').trim()).filter(Boolean).join(', ');
                                if (skills) {
                                    result.push(skills);
                                }
                            }
                        }
                        controls.competences.value = result.join('\n');
                    }
                    return;
                }
                
                let text = element.innerHTML.replace(/<br\s*\/?>/gi, '\n').trim();
                text = new DOMParser().parseFromString(text, "text/html").documentElement.textContent;

                if (id) {
                    switch (id) {
                        case 'cv-nom-prenom-preview': const nameParts = text.trim().split(' '); controls.prenom.value = nameParts.shift() || ''; controls.nom.value = nameParts.join(' ') || ''; break;
                        case 'cv-poste-preview': controls.poste.value = text; break;
                        case 'cv-description-preview': controls.description.value = text; break;
                        case 'banner-nom-preview': controls.bannerNom.value = text; break;
                        case 'banner-poste-preview': controls.bannerPoste.value = text; break;
                        case 'banner-email-preview': controls.bannerEmail.value = text; break;
                        case 'banner-tel-preview': controls.bannerTel.value = text; break;
                    }
                } else {
                    const itemContainer = element.closest('.dynamic-item-container');
                    if (itemContainer) {
                        const index = parseInt(itemContainer.dataset.index, 10);
                        const type = itemContainer.dataset.type;
                        const formList = type === 'experience' ? controls.experienceList : controls.formationList;
                        const formItem = formList.children[index];
                        if (!formItem) return;

                        const title = itemContainer.querySelector('.item-title')?.textContent || '';
                        const meta = itemContainer.querySelector('.item-meta')?.textContent || '';
                        const descEl = itemContainer.querySelector('.mt-1');
                        const desc = descEl ? new DOMParser().parseFromString(descEl.innerHTML.replace(/<br\s*\/?>/gi, '\n'), "text/html").documentElement.textContent : '';

                        if (formItem.querySelector('.data-title')) formItem.querySelector('.data-title').value = title;
                        if (formItem.querySelector('.data-meta')) formItem.querySelector('.data-meta').value = meta;
                        if (formItem.querySelector('.data-desc')) formItem.querySelector('.data-desc').value = desc;

                    } else {
                        const customModule = element.closest('.custom-module-preview');
                        if (customModule) {
                            const sectionId = customModule.id;
                            const controlTitleInput = document.getElementById(`custom-section-title-${sectionId}`);
                            const controlContentTextarea = document.getElementById(`custom-section-content-${sectionId}`);
                            
                            if (element.matches('[contenteditable].section-title span')) {
                               if (controlTitleInput) controlTitleInput.value = element.textContent;
                            }
                            if (element.matches('[contenteditable].custom-content')) {
                               if (controlContentTextarea) controlContentTextarea.value = text;
                            }
                        }
                    }
                }
            }

            function moveBannerTo(destination) {
                const recruiterBanner = preview.banner;
                if (destination === 'top') {
                    preview.fixedBannerTop.appendChild(recruiterBanner);
                } else if (destination === 'bottom') {
                    preview.fixedBannerBottom.appendChild(recruiterBanner);
                } else { // 'modular'
                    preview.bannerModule.querySelector('.drag-handle').insertAdjacentElement('afterend', recruiterBanner);
                }
                const isModular = (destination === 'modular');
                document.getElementById('banner-fix-controls').classList.toggle('hidden', !isModular);
                controls.modularBannerBtn.classList.toggle('hidden', isModular);
                updatePreview('banner-move');
            }

            function addCustomSection(title = 'Nouvelle Section', content = '', id = null, icon = 'fas fa-puzzle-piece') {
                customSectionCounter++;
                const sectionId = id || `custom-module-${Date.now()}-${customSectionCounter}`;
                
                const controlDiv = document.createElement('div');
                controlDiv.className = 'p-2 border rounded-md bg-white relative';
                controlDiv.dataset.sectionId = sectionId;
                controlDiv.dataset.icon = icon;
                controlDiv.innerHTML = `
                    <input type="text" value="${title}" class="w-full p-1 border rounded-sm mb-1 font-semibold custom-section-input" id="custom-section-title-${sectionId}">
                    <textarea rows="4" class="w-full p-1 border rounded-sm mb-1 custom-section-input" id="custom-section-content-${sectionId}" placeholder="Contenu...">${content}</textarea>
                    <button class="absolute top-1 right-1 text-red-400 hover:text-red-600 remove-section-btn"><i class="fas fa-times-circle"></i></button>
                `;
                controls.customSectionsList.appendChild(controlDiv);
                
                updatePreview('form');
                updateAllStyles();
            }

            // === PARSER JSON ROBUSTE ===
            
            function forceParseJson(rawText) {
                console.log("🔥 Parser JSON robuste activé...");
                
                try {
                    // D'abord essayer le parsing standard
                    return JSON.parse(rawText);
                } catch {
                    console.log("🔧 Parsing standard échoué, extraction manuelle...");
                }
                
                // Extraire manuellement chaque champ nécessaire
                const result = {
                    nom: extractFieldValue(rawText, 'nom'),
                    prenom: extractFieldValue(rawText, 'prenom'),
                    poste: extractFieldValue(rawText, 'poste'),
                    description: extractFieldValue(rawText, 'description'),
                    experiences: extractExperiencesRobust(rawText),
                    formations: extractFormationsRobust(rawText),
                    competences: extractFieldValue(rawText, 'competences')
                };
                
                console.log("🔥 Données extraites manuellement:", result);
                return result;
            }
            
            function extractFieldValue(text, fieldName) {
                // Plusieurs patterns pour capturer les valeurs
                const patterns = [
                    new RegExp(`"${fieldName}"\\s*:\\s*"([^"]*)"`, 'i'),
                    new RegExp(`${fieldName}\\s*:\\s*"([^"]*)"`, 'i'),
                    new RegExp(`"${fieldName}"\\s*:\\s*'([^']*)'`, 'i'),
                    new RegExp(`${fieldName}\\s*:\\s*'([^']*)'`, 'i')
                ];
                
                for (const pattern of patterns) {
                    const match = text.match(pattern);
                    if (match) {
                        return match[1].trim();
                    }
                }
                
                return '';
            }
            
            function extractExperiencesRobust(text) {
                const experiences = [];
                
                // Chercher le début de l'array experiences
                const expMatch = text.match(/"experiences"\s*:\s*\[(.*?)(?:\]|$)/is);
                if (!expMatch) return experiences;
                
                const expContent = expMatch[1];
                
                // Diviser par les accolades fermantes suivies d'accolades ouvrantes ou fin
                const expItems = expContent.split(/}\s*(?:{|,\s*{|$)/);
                
                for (let item of expItems) {
                    if (item.trim() && item.includes('title')) {
                        const exp = {
                            title: extractFieldValue(item + '}', 'title'),
                            meta: extractFieldValue(item + '}', 'meta'),
                            desc: extractFieldValue(item + '}', 'desc')
                        };
                        
                        if (exp.title || exp.meta || exp.desc) {
                            experiences.push(exp);
                        }
                    }
                }
                
                console.log(`🔥 Expériences extraites: ${experiences.length}`);
                return experiences;
            }
            
            function extractFormationsRobust(text) {
                const formations = [];
                
                // Chercher le début de l'array formations
                const formMatch = text.match(/"formations"\s*:\s*\[(.*?)(?:\]|$)/is);
                if (!formMatch) return formations;
                
                const formContent = formMatch[1];
                
                // Diviser par les accolades fermantes suivies d'accolades ouvrantes ou fin
                const formItems = formContent.split(/}\s*(?:{|,\s*{|$)/);
                
                for (let item of formItems) {
                    if (item.trim() && item.includes('title')) {
                        const form = {
                            title: extractFieldValue(item + '}', 'title'),
                            meta: extractFieldValue(item + '}', 'meta')
                        };
                        
                        if (form.title || form.meta) {
                            formations.push(form);
                        }
                    }
                }
                
                console.log(`🔥 Formations extraites: ${formations.length}`);
                return formations;
            }

            // === FONCTIONS DE NETTOYAGE JSON ===
            
            function cleanJsonResponse(text) {
                if (!text || typeof text !== 'string') return '{}';
                
                // Supprimer les balises markdown si présentes
                let cleaned = text.replace(/```json\s*/gi, '').replace(/```\s*/g, '');
                
                // Supprimer les caractères de contrôle problématiques (sauf \n, \r, \t)
                cleaned = cleaned.replace(/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]/g, '');
                
                // Chercher le premier { et le dernier } pour extraire le JSON
                const firstBrace = cleaned.indexOf('{');
                const lastBrace = cleaned.lastIndexOf('}');
                
                if (firstBrace !== -1 && lastBrace !== -1 && lastBrace > firstBrace) {
                    cleaned = cleaned.substring(firstBrace, lastBrace + 1);
                } else {
                    // Si pas de structure JSON trouvée, retourner un objet vide
                    console.warn("⚠️ Pas de structure JSON valide trouvée");
                    return '{}';
                }
                
                // Nettoyer les retours à la ligne dans les valeurs JSON
                cleaned = cleaned.replace(/"\s*\n\s*"/g, '" "');
                
                return cleaned.trim();
            }
            
            function repairJsonResponse(text) {
                let repaired = cleanJsonResponse(text);
                
                if (repaired === '{}') return repaired;
                
                try {
                    // Test si le JSON est déjà valide
                    JSON.parse(repaired);
                    return repaired;
                } catch {
                    // Continuer avec les réparations
                }
                
                console.log("🔧 Début de réparation JSON...");
                
                // 1. Réparer les propriétés sans guillemets
                repaired = repaired.replace(/([{,]\s*)([a-zA-Z_][a-zA-Z0-9_]*)\s*:/g, '$1"$2":');
                
                // 2. Fermer les chaînes non terminées
                repaired = repaired.replace(/: "([^"]*?)(\s*[,}\]])$/gm, ': "$1"$2');
                repaired = repaired.replace(/: "([^"]*?)$/gm, ': "$1"');
                
                // 3. Réparation spéciale pour les arrays mal formatés
                console.log("🔧 Réparation des arrays...");
                
                // Ajouter des virgules entre objets consécutifs dans les arrays
                repaired = repaired.replace(/}\s*{/g, '}, {');
                repaired = repaired.replace(/]\s*\[/g, '], [');
                
                // Réparer spécifiquement les patterns problématiques d'arrays
                repaired = repaired.replace(/}(\s*){"/g, '}, {$1"');  // }{"prop" → }, {"prop"
                repaired = repaired.replace(/"(\s*){"/g, '", {$1"');  // "text"{"prop" → "text", {"prop"
                repaired = repaired.replace(/}(\s*)"/g, '}, $1"');    // }"text" → }, "text"
                
                // Cas spécifiques pour les arrays d'objets
                repaired = repaired.replace(/}(\s+){"title"/g, '}, $1{"title"');
                repaired = repaired.replace(/}(\s+){"meta"/g, '}, $1{"meta"');
                repaired = repaired.replace(/}(\s+){"desc"/g, '}, $1{"desc"');
                
                // Nettoyer les doubles virgules
                repaired = repaired.replace(/,(\s*,)+/g, ',');
                
                // 4. Réparer les objets dans les arrays - patterns plus génériques
                repaired = repaired.replace(/}(\s*){"[^"]+"/g, '}, {$1"');
                
                // 5. Gérer les guillemets non échappés dans les valeurs
                repaired = repaired.replace(/: "([^"]*)"([^",}\]]*)"([^",}\]]*)/g, (match, p1, p2, p3) => {
                    if (p2 && p3) {
                        const escapedValue = (p1 + p2 + p3).replace(/"/g, '\\"');
                        return `: "${escapedValue}"`;
                    }
                    return match;
                });
                
                // 6. Supprimer les retours à la ligne dans les valeurs JSON
                repaired = repaired.replace(/: "([^"]*)\n([^"]*)"(\s*[,}])/g, ': "$1 $2"$3');
                
                // 7. Réparer les virgules manquantes entre propriétés
                repaired = repaired.replace(/}(\s*)"([^"]+)":/g, '},$1"$2":');
                repaired = repaired.replace(/](\s*)"([^"]+)":/g, '],$1"$2":');
                repaired = repaired.replace(/"(\s+)"([^"]+)":/g, '",$1"$2":');
                
                // 8. Supprimer les virgules en trop
                repaired = repaired.replace(/,(\s*[}\]])/g, '$1');
                repaired = repaired.replace(/,(\s*,)/g, ',');
                
                // 9. Ajouter des guillemets manquants aux valeurs
                repaired = repaired.replace(/:\s*([^",{\[\]}\s][^,}\]]*?)(\s*[,}])/g, ': "$1"$2');
                
                // 10. Réparation spécialisée pour les arrays problématiques
                repaired = fixArraySyntax(repaired);
                
                // Test intermédiaire
                try {
                    JSON.parse(repaired);
                    console.log("✅ JSON réparé avec succès");
                    return repaired;
                } catch (e) {
                    console.log("🔧 Réparation avancée nécessaire...", e.message);
                }
                
                // 11. Réparation drastique - reconstruction manuelle
                try {
                    return reconstructJson(repaired);
                } catch {
                    console.warn("⚠️ Impossible de réparer le JSON - retour à un objet vide");
                    return '{}';
                }
            }
            
            function fixArraySyntax(jsonStr) {
                console.log("🔧 Réparation spécialisée des arrays...");
                
                // Trouver tous les arrays et les réparer individuellement
                return jsonStr.replace(/"(experiences|formations)"\s*:\s*\[([^\]]*(?:\][^\]]*)*?)\]/g, (match, arrayName, arrayContent) => {
                    console.log(`🔧 Réparation de l'array "${arrayName}"`);
                    
                    // Nettoyer le contenu de l'array
                    let cleaned = arrayContent;
                    
                    // Réparer les objets consécutifs sans virgules
                    cleaned = cleaned.replace(/}\s*{/g, '}, {');
                    
                    // Ajouter des virgules entre chaînes et objets
                    cleaned = cleaned.replace(/"(\s*){/g, '", {');
                    cleaned = cleaned.replace(/}(\s*)"/g, '}, "');
                    
                    // Nettoyer les virgules multiples
                    cleaned = cleaned.replace(/,(\s*,)+/g, ',');
                    
                    // Supprimer les virgules avant la fermeture
                    cleaned = cleaned.replace(/,(\s*)$/g, '');
                    
                    return `"${arrayName}": [${cleaned}]`;
                });
            }
            
            function reconstructJson(brokenJson) {
                console.log("🏗️ Reconstruction manuelle du JSON...");
                
                // Extraire les principales données même si le JSON est cassé
                const data = {
                    nom: extractValue(brokenJson, 'nom'),
                    prenom: extractValue(brokenJson, 'prenom'),
                    poste: extractValue(brokenJson, 'poste'),
                    description: extractValue(brokenJson, 'description'),
                    experiences: extractArray(brokenJson, 'experiences'),
                    formations: extractArray(brokenJson, 'formations'),
                    competences: extractValue(brokenJson, 'competences')
                };
                
                return JSON.stringify(data);
            }
            
            function extractValue(text, key) {
                const regex = new RegExp(`"${key}"\\s*:\\s*"([^"]*)"`, 'i');
                const match = text.match(regex);
                return match ? match[1] : '';
            }
            
            function extractArray(text, key) {
                const regex = new RegExp(`"${key}"\\s*:\\s*\\[([^\\]]*(?:\\][^\\]]*)*?)\\]`, 'i');
                const match = text.match(regex);
                if (!match) return [];
                
                const arrayContent = match[1];
                const items = [];
                
                // Extraction simple d'objets dans l'array
                const objectRegex = /{[^{}]*}/g;
                let objectMatch;
                
                while ((objectMatch = objectRegex.exec(arrayContent)) !== null) {
                    try {
                        const cleaned = objectMatch[0]
                            .replace(/([{,]\s*)([a-zA-Z_][a-zA-Z0-9_]*)\s*:/g, '$1"$2":')
                            .replace(/,(\s*[}])/g, '$1');
                        
                        const parsed = JSON.parse(cleaned);
                        items.push(parsed);
                    } catch {
                        // Si impossible de parser, extraire les valeurs manuellement
                        const obj = {};
                        obj.title = extractValue(objectMatch[0], 'title');
                        obj.meta = extractValue(objectMatch[0], 'meta');
                        obj.desc = extractValue(objectMatch[0], 'desc');
                        if (obj.title || obj.meta || obj.desc) {
                            items.push(obj);
                        }
                    }
                }
                
                return items;
            }
            
            // Fonction fallback sans schema JSON
            async function callGeminiFallback(originalPrompt) {
                const apiKey = localStorage.getItem('gemini-api-key');
                if (!apiKey) return null;
                
                const simplePrompt = `${originalPrompt}

RÉPONDRE EN JSON SIMPLE ET VALIDE UNIQUEMENT. Format exact attendu :
{
  "nom": "nom de famille",
  "prenom": "prénom",
  "poste": "titre du poste",
  "description": "description professionnelle courte",
  "experiences": [
    {"title": "poste", "meta": "entreprise - dates", "desc": "description courte"}
  ],
  "formations": [
    {"title": "diplôme", "meta": "école - année"}
  ],
  "competences": "competence1, competence2, competence3"
}`;

                const model = controls.aiModelSelect?.value || 'gemini-1.5-flash';
                const modelName = GEMINI_CONFIG.models[model] || model;
                const url = `${GEMINI_CONFIG.baseUrl}${modelName}:generateContent?key=${apiKey}`;
                
                const payload = {
                    contents: [{ parts: [{ text: simplePrompt }] }],
                    generationConfig: {
                        temperature: 0.3, // Plus déterministe pour le JSON
                        maxOutputTokens: parseInt(controls.aiMaxTokens?.value || '1000')
                    }
                };

                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) return null;

                const data = await response.json();
                
                if (data.candidates && data.candidates.length > 0 && 
                    data.candidates[0].content && data.candidates[0].content.parts) {
                    const text = data.candidates[0].content.parts[0].text;
                    const cleaned = cleanJsonResponse(text);
                    return JSON.parse(cleaned);
                }
                
                return null;
            }

            // Fonction legacy mise à jour pour utiliser la nouvelle API
            async function callGeminiAPI(prompt, schema) {
                try {
                    showLoader("L'IA réfléchit...");
                    
                    // Vérifier si le quota est encore dépassé
                    if (isQuotaExceeded()) {
                        const retryAfter = localStorage.getItem('gemini-retry-after');
                        const retryTime = new Date(parseInt(retryAfter));
                        throw new Error(`QUOTA_EXCEEDED: Quota dépassé. Prochaine tentative possible à ${retryTime.toLocaleString()}`);
                    }
                    
                    let result;
                    if (schema) {
                        // Pour les schémas JSON, utiliser l'API avec responseSchema
                        const apiKey = localStorage.getItem('gemini-api-key');
                        if (!apiKey) {
                            throw new Error('Clé API non configurée');
                        }
                        
                        const model = controls.aiModelSelect?.value || 'gemini-1.5-flash';
                        const modelName = GEMINI_CONFIG.models[model] || model;
                        const url = `${GEMINI_CONFIG.baseUrl}${modelName}:generateContent?key=${apiKey}`;
                        
                        const payload = {
                            contents: [{ role: "user", parts: [{ text: prompt }] }],
                            generationConfig: { 
                                responseMimeType: "application/json", 
                                responseSchema: schema,
                                temperature: parseFloat(controls.aiTemperature?.value || '0.7'),
                                maxOutputTokens: parseInt(controls.aiMaxTokens?.value || '1000')
                            }
                        };

                        const response = await fetch(url, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (!response.ok) {
                            const errorData = await response.text();
                            let errorObj;
                            try {
                                errorObj = JSON.parse(errorData);
                            } catch (e) {
                                errorObj = { error: { message: errorData } };
                            }

                            // Gestion spécifique des erreurs de quota
                            if (response.status === 429) {
                                const retryAfter = extractRetryAfter(errorObj) || 86400000; // 24h par défaut
                                localStorage.setItem('gemini-quota-exceeded', Date.now().toString());
                                localStorage.setItem('gemini-retry-after', (Date.now() + retryAfter).toString());
                                
                                const quotaError = new Error('QUOTA_EXCEEDED');
                                quotaError.originalError = errorObj;
                                quotaError.retryAfter = retryAfter;
                                throw quotaError;
                            }

                            throw new Error(`Erreur API: ${response.status} ${response.statusText} - ${errorData}`);
                        }

                        const data = await response.json();
                        
                        if (data.candidates && data.candidates.length > 0) {
                            if (data.candidates[0].finishReason !== "STOP" && data.candidates[0].finishReason !== "MAX_TOKENS") {
                                throw new Error(`L'IA a été bloquée (raison: ${data.candidates[0].finishReason}). Veuillez reformuler votre demande.`);
                            }
                            if (data.candidates[0].content && data.candidates[0].content.parts && data.candidates[0].content.parts.length > 0) {
                                const rawText = data.candidates[0].content.parts[0].text;
                                console.log("🔍 Réponse brute de l'IA:", rawText);
                                
                                // Nettoyer et valider le JSON
                                try {
                                    const cleanedJson = cleanJsonResponse(rawText);
                                    console.log("🧹 JSON nettoyé:", cleanedJson);
                                    result = JSON.parse(cleanedJson);
                                    console.log("✅ JSON parsé avec succès:", result);
                                } catch (parseError) {
                                    console.error("❌ Erreur de parsing JSON:", parseError);
                                    console.log("� Activation du parser robuste...");
                                    
                                    // Utiliser le parser robuste en premier
                                    try {
                                        result = forceParseJson(rawText);
                                        console.log("🔥✅ Parser robuste réussi:", result);
                                    } catch (robustError) {
                                        console.error("❌ Parser robuste échoué:", robustError);
                                        console.log("� Activation mode fallback direct...");
                                        
                                        // Mode fallback direct sans tentatives de réparation
                                        try {
                                            const fallbackResult = await callGeminiFallback(prompt);
                                            if (fallbackResult) {
                                                result = fallbackResult;
                                                console.log("🔄✅ Mode fallback réussi:", result);
                                            } else {
                                                throw new Error(`Échec total : ${parseError.message}`);
                                            }
                                        } catch (fallbackError) {
                                            throw new Error(`Échec complet de l'analyse: ${fallbackError.message}`);
                                        }
                                    }
                                }
                            }
                        }
                    } else {
                        // Pour les prompts simples, utiliser directement notre fonction API
                        const apiKey = localStorage.getItem('gemini-api-key');
                        if (!apiKey) {
                            throw new Error('Clé API non configurée');
                        }
                        
                        const model = controls.aiModelSelect?.value || 'gemini-1.5-flash';
                        const temperature = parseFloat(controls.aiTemperature?.value || '0.7');
                        const maxTokens = parseInt(controls.aiMaxTokens?.value || '1000');
                        
                        const modelName = GEMINI_CONFIG.models[model] || model;
                        const url = `${GEMINI_CONFIG.baseUrl}${modelName}:generateContent?key=${apiKey}`;
                        
                        const requestBody = {
                            contents: [{
                                parts: [{ text: prompt }]
                            }],
                            generationConfig: {
                                temperature: temperature,
                                maxOutputTokens: maxTokens
                            }
                        };
                        
                        const response = await fetch(url, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(requestBody)
                        });
                        
                        if (!response.ok) {
                            const errorData = await response.json().catch(() => ({}));
                            throw new Error(errorData.error?.message || `Erreur API: ${response.status}`);
                        }
                        
                        const data = await response.json();
                        
                        if (!data.candidates || !data.candidates[0]?.content?.parts?.[0]?.text) {
                            throw new Error('Réponse invalide de l\'API');
                        }
                        
                        result = data.candidates[0].content.parts[0].text;
                    }
                    
                    hideLoader();
                    return result;
                    
                } catch (error) {
                    hideLoader();
                    console.error("Erreur détaillée de l'IA:", error);
                    
                    // Gestion spéciale pour les erreurs de quota
                    if (error.message.includes('429') || error.message.includes('quota') || error.message.includes('RESOURCE_EXHAUSTED')) {
                        console.warn("🚫 Quota API épuisé, activation du mode fallback");
                        
                        // Marquer le quota comme épuisé
                        const today = new Date().toDateString();
                        const quotaData = {
                            date: today,
                            count: 50, // Limite atteinte
                            exhausted: true
                        };
                        localStorage.setItem('gemini-quota', JSON.stringify(quotaData));
                        
                        // Afficher une notification explicative
                        showNotification(
                            '⚠️ Quota API Gemini épuisé (50 requêtes/jour). Les générateurs utilisent maintenant les fallbacks prédéfinis. Le quota se réinitialise demain.',
                            'warning',
                            8000
                        );
                        
                        // Retourner un texte de fallback au lieu de null
                        return generateFallbackContent(prompt);
                    }
                    
                    // Autres erreurs
                    showNotification(`Erreur de l'IA : ${error.message}`, 'error', 5000);
                    return null;
                }
            }
            
            // Générateur de contenu de fallback quand le quota est épuisé
            function generateFallbackContent(prompt) {
                console.log("🔄 Génération de contenu fallback pour:", prompt.substring(0, 100));
                
                // Fallbacks basés sur des mots-clés dans le prompt
                if (prompt.toLowerCase().includes('couleur') || prompt.toLowerCase().includes('color')) {
                    return {
                        primary: '#2563eb',
                        secondary: '#64748b',
                        accent: '#3b82f6'
                    };
                }
                
                if (prompt.toLowerCase().includes('formation') || prompt.toLowerCase().includes('education')) {
                    return {
                        diplome: "Diplôme universitaire",
                        etablissement: "Université/École",
                        annee: new Date().getFullYear() - 2,
                        lieu: "Ville, Pays"
                    };
                }
                
                if (prompt.toLowerCase().includes('expérience') || prompt.toLowerCase().includes('experience')) {
                    return {
                        poste: "Poste professionnel",
                        entreprise: "Nom de l'entreprise",
                        debut: new Date().getFullYear() - 3,
                        fin: new Date().getFullYear() - 1,
                        description: "Description de l'expérience professionnelle et des responsabilités principales."
                    };
                }
                
                if (prompt.toLowerCase().includes('compétence') || prompt.toLowerCase().includes('skill')) {
                    return {
                        competences: [
                            "Compétence technique 1",
                            "Compétence technique 2", 
                            "Compétence professionnelle 1",
                            "Compétence professionnelle 2"
                        ]
                    };
                }
                
                if (prompt.toLowerCase().includes('layout') || prompt.toLowerCase().includes('mise en page')) {
                    return {
                        colonnes: 2,
                        espacement: "normal",
                        style: "professionnel"
                    };
                }
                
                // Fallback générique pour analyse de texte
                return {
                    message: "Contenu généré automatiquement",
                    suggestion: "Quota API épuisé - Contenu par défaut utilisé",
                    conseil: "Le quota se réinitialise chaque jour"
                };
            }
            
            function updateAllStyles() {
                // Vérifications de null pour éviter les erreurs TypeError
                try {
                    if (controls.primaryColorPicker && controls.primaryColorPicker.value) {
                        root.style.setProperty('--primary-color', controls.primaryColorPicker.value);
                    }
                    if (controls.secondaryColorPicker && controls.secondaryColorPicker.value) {
                        root.style.setProperty('--secondary-color', controls.secondaryColorPicker.value);
                    }
                    if (controls.bodyTextColorPicker && controls.bodyTextColorPicker.value) {
                        root.style.setProperty('--body-text-color', controls.bodyTextColorPicker.value);
                    }
                    if (controls.fontFamilyH1Select && controls.fontFamilyH1Select.value) {
                        root.style.setProperty('--font-family-h1', controls.fontFamilyH1Select.value);
                    }
                    if (controls.fontFamilyH2Select && controls.fontFamilyH2Select.value) {
                        root.style.setProperty('--font-family-h2', controls.fontFamilyH2Select.value);
                    }
                    if (controls.fontFamilyBodySelect && controls.fontFamilyBodySelect.value) {
                        root.style.setProperty('--font-family-body', controls.fontFamilyBodySelect.value);
                    }

                    const activeStyle = document.querySelector('.section-title-style-btn.active')?.dataset.titleStyle || 'style-underline';
                    document.querySelectorAll('.section-title').forEach(title => {
                        title.classList.remove('style-underline', 'style-side-line', 'style-background', 'style-boxed');
                        title.classList.add(activeStyle);
                    });
                } catch (error) {
                    console.warn('Erreur dans updateAllStyles:', error);
                }
                
                const banner = preview.banner;
                const newBannerStyle = controls.bannerStyleSelect.value;
                const newAlign = document.querySelector('.banner-align-btn.active')?.dataset.bannerAlign || 'left';
                const isInverted = controls.bannerInvertBtn.classList.contains('active');

                const classesToRemove = Array.from(banner.classList).filter(c => c.startsWith('banner-style-'));
                if (classesToRemove.length > 0) banner.classList.remove(...classesToRemove);

                if (newBannerStyle) banner.classList.add(newBannerStyle);
                
                const contentWrapper = banner.querySelector('.banner-content-wrapper');
                contentWrapper.className = 'banner-content-wrapper'; // Reset classes
                contentWrapper.classList.add(`banner-align-${newAlign}`);
                if (isInverted) contentWrapper.classList.add('banner-layout-inverted');
                
                checkAllPagesOverflow();
            }

            function populateFontSelectors() {
                const fonts = [
                    { name: 'Lato', value: "'Lato', sans-serif" },
                    { name: 'Montserrat', value: "'Montserrat', sans-serif" },
                    { name: 'Roboto Mono', value: "'Roboto Mono', monospace" },
                    { name: 'Playfair Display', value: "'Playfair Display', serif" },
                    { name: 'Merriweather', value: "'Merriweather', serif" },
                    { name: 'Oswald', value: "'Oswald', sans-serif" },
                    { name: 'Open Sans', value: "'Open Sans', sans-serif" },
                    { name: 'Source Sans Pro', value: "'Source Sans Pro', sans-serif" },
                    { name: 'Nunito Sans', value: "'Nunito Sans', sans-serif" },
                    { name: 'Cormorant Garamond', value: "'Cormorant Garamond', serif" },
                ];
                const selects = [controls.fontFamilyH1Select, controls.fontFamilyH2Select, controls.fontFamilyBodySelect, controls.bannerNomFont];
                selects.forEach(select => {
                    if (!select) return;
                    select.innerHTML = '';
                    fonts.forEach(font => {
                        const option = document.createElement('option');
                        option.value = font.value;
                        option.textContent = font.name;
                        select.appendChild(option);
                    });
                });
            }
            
            function populateIconPicker() {
                const icons = ["fa-user-circle", "fa-briefcase", "fa-graduation-cap", "fa-star", "fa-puzzle-piece", "fa-globe", "fa-paint-brush", "fa-certificate", "fa-lightbulb", "fa-heart", "fa-cogs", "fa-code", "fa-chart-line", "fa-comments", "fa-bullhorn", "fa-trophy", "fa-book", "fa-wrench", "fa-users", "fa-award", "fa-phone", "fa-envelope", "fa-map-marker-alt", "fa-linkedin", "fa-github"];
                controls.iconPickerGrid.innerHTML = '';
                icons.forEach(iconClass => {
                    const iconEl = document.createElement('i');
                    iconEl.className = `fas ${iconClass}`;
                    iconEl.dataset.icon = `fas ${iconClass}`;
                    controls.iconPickerGrid.appendChild(iconEl);
                });
            }

            function resetCVToDefault() {
                document.querySelectorAll('.cv-input, .banner-input, .custom-section-input').forEach(input => {
                    if(input.type === 'checkbox') input.checked = false;
                    else if (input.type !== 'range' && input.type !== 'color') input.value = '';
                });
                
                controls.experienceList.innerHTML = '';
                controls.formationList.innerHTML = '';
                controls.customSectionsList.innerHTML = '';
                controls.skillsLevelList.innerHTML = '';
                
                document.querySelectorAll('.custom-module-preview').forEach(m => m.remove());
                
                setDefaultRecruiterInfo();
                
                // S'assurer que les contrôles de thème sont disponibles avant d'appliquer le thème
                if (controls.primaryColorPicker && controls.secondaryColorPicker && controls.bodyTextColorPicker) {
                    applyTheme('professional');
                } else {
                    console.warn('Contrôles de thème non disponibles, applyTheme reporté');
                }
                
                document.querySelector('.layout-btn[data-layout="layout-1-col"]')?.click();
                document.querySelector('.skill-style-btn[data-skill-style="tags"]')?.click();
                
                Object.values(sliders).forEach(config => {
                    if (config.el && config.valueEl) {
                        const defaultValue = config.el.defaultValue;
                        config.el.value = defaultValue;
                        config.valueEl.textContent = defaultValue;
                        root.style.setProperty(config.property, `${defaultValue}${config.unit}`);
                    } else {
                        console.warn('Slider element not found in resetCVToDefault:', config);
                    }
                });
                
                moveBannerTo('modular');
                removeBannerBackground();

                document.querySelectorAll('.completion-checkbox').forEach(cb => {
                    cb.checked = false;
                    cb.closest('details').open = true;
                });
                updateProgressBar();
                
                updatePreview('form');
                updateAllStyles();
                showNotification("Le CV a été réinitialisé.", "success");
            }

            function applyTheme(themeName) {
                const theme = themes[themeName];
                if (!theme) return;

                // Vérifications de null pour éviter les erreurs TypeError
                if (controls.primaryColorPicker) controls.primaryColorPicker.value = theme.primaryColor;
                if (controls.secondaryColorPicker) controls.secondaryColorPicker.value = theme.secondaryColor;
                if (controls.bodyTextColorPicker) controls.bodyTextColorPicker.value = theme.bodyTextColor;
                if (controls.fontFamilyH1Select) controls.fontFamilyH1Select.value = theme.fontH1;
                if (controls.fontFamilyH2Select) controls.fontFamilyH2Select.value = theme.fontH2;
                if (controls.fontFamilyBodySelect) controls.fontFamilyBodySelect.value = theme.fontBody;

                document.querySelectorAll('.theme-btn').forEach(b => b.classList.remove('active'));
                document.querySelector(`.theme-btn[data-theme="${themeName}"]`)?.classList.add('active');

                updateAllStyles();
                updatePreview('theme');
            }
            
            async function handleAIAction(action, moduleElement) {
                let prompt = '';
                let targetControl = null;

                switch (action) {
                    case 'rewrite-profile':
                        console.log('🎯 [AI-BUTTON] Début réécriture profil', {
                            action: 'rewrite-profile',
                            timestamp: new Date().toISOString()
                        });
                        
                        APILogger.log('info', 'ai-button', 'rewrite-profile-start', {
                            action: 'rewrite-profile'
                        });
                        
                        const profileText = controls.description.value;
                        if (!profileText) { 
                            console.log('❌ [AI-BUTTON] Profil vide', { action: 'rewrite-profile' });
                            APILogger.log('error', 'ai-button', 'empty-profile', { error: 'Profil vide' });
                            showNotification("Le profil est vide.", "error"); 
                            return; 
                        }
                        
                        console.log('📝 [AI-BUTTON] Profil trouvé', {
                            action: 'rewrite-profile',
                            profile_length: profileText.length,
                            profile_preview: profileText.substring(0, 50) + '...'
                        });
                        
                        prompt = `En tant qu'expert en recrutement, réécris ce profil de CV pour qu'il soit plus percutant et professionnel, en utilisant des verbes d'action forts. Garde une longueur similaire et un ton professionnel. Ne retourne que le paragraphe final réécrit, sans aucun commentaire. Le profil actuel est : "${profileText}"`;
                        targetControl = controls.description;
                        
                        console.log('🚀 [AI-BUTTON] Appel API pour réécriture profil', {
                            prompt_length: prompt.length,
                            target_control: 'description'
                        });
                        
                        try {
                            const profileStartTime = Date.now();
                            const newProfile = await callAIWithPriority(prompt);
                            const profileDuration = Date.now() - profileStartTime;
                            
                            if (newProfile && targetControl) {
                                console.log('✅ [AI-BUTTON] Profil réécrit avec succès', {
                                    action: 'rewrite-profile',
                                    old_length: profileText.length,
                                    new_length: newProfile.length,
                                    duration: profileDuration,
                                    new_preview: newProfile.substring(0, 50) + '...'
                                });
                                
                                APILogger.log('success', 'ai-button', 'rewrite-profile-success', {
                                    old_length: profileText.length,
                                    new_length: newProfile.length,
                                    duration: profileDuration
                                });
                                
                                targetControl.value = newProfile;
                                showNotification("Profil amélioré par l'IA.", "success");
                            } else {
                                console.error('❌ [AI-BUTTON] Réponse vide ou contrôle manquant', {
                                    action: 'rewrite-profile',
                                    has_new_profile: !!newProfile,
                                    has_target_control: !!targetControl
                                });
                                
                                APILogger.log('error', 'ai-button', 'empty-response', {
                                    error: 'Réponse vide ou contrôle manquant'
                                });
                            }
                        } catch (error) {
                            console.error("❌ [AI-BUTTON] Erreur lors de la réécriture du profil:", {
                                action: 'rewrite-profile',
                                error_message: error.message,
                                error_type: error.constructor.name,
                                stack: error.stack?.split('\n')[0]
                            });
                            
                            APILogger.log('error', 'ai-button', 'rewrite-profile-error', {
                                error: error.message,
                                error_type: error.constructor.name
                            });
                            
                            if (error.message.includes('QUOTA_EXCEEDED') || error.message.includes('429')) {
                                console.log('⚠️ [AI-BUTTON] Quota dépassé détecté', {
                                    action: 'rewrite-profile',
                                    error: error.message
                                });
                                showNotification("⚠️ Quota dépassé. Configurez OpenAI dans l'onglet API pour continuer.", "warning");
                            } else {
                                showNotification(`❌ Erreur: ${error.message}`, "error");
                            }
                        }
                        break;
                    case 'summarize-experience':
                        console.log('🎯 [AI-BUTTON] Début synthèse expériences', {
                            action: 'summarize-experience',
                            timestamp: new Date().toISOString()
                        });
                        
                        APILogger.log('info', 'ai-button', 'summarize-experience-start', {
                            action: 'summarize-experience'
                        });
                        
                        await summarizeAllExperiencesAI();
                        break;
                    case 'rewrite-formation':
                        const formations = getDynamicData(controls.formationList);
                        if (formations.length === 0) { showNotification("Aucune formation à améliorer.", "error"); return; }
                        const formationSchema = { type: "ARRAY", items: { type: "OBJECT", properties: { title: { type: "STRING" }, meta: { type: "STRING" } } } };
                        const formationPrompt = `En tant qu'expert RH, améliore la formulation de ces entrées de formation pour un CV. Rends les titres plus percutants et les descriptions plus claires si nécessaire. Ne retourne que le résultat final sous forme de tableau JSON \`[{"title": "...", "meta": "..."}]\` sans aucun commentaire ou texte additionnel. Voici les données actuelles : ${JSON.stringify(formations.map(f => ({ title: f.title, meta: f.meta })))}`;
                        try {
                            const newFormations = await callGeminiAPI(formationPrompt, formationSchema);
                            if (newFormations && Array.isArray(newFormations)) {
                                controls.formationList.innerHTML = '';
                                newFormations.forEach(form => createDynamicItem(controls.formationList, [{ key: 'title', placeholder: 'Nom du diplôme' }, { key: 'meta', placeholder: 'Établissement & Année' }], form));
                                showNotification("Formations améliorées par l'IA.", "success");
                            }
                        } catch (error) {
                            console.error("❌ Erreur lors de l'amélioration des formations:", error);
                            if (error.message.includes('QUOTA_EXCEEDED') || error.message.includes('429')) {
                                showNotification("⚠️ Quota Gemini dépassé. Tentative avec OpenAI...", "warning");
                                try {
                                    const newFormations = await callOpenAI(formationPrompt, formationSchema);
                                    if (newFormations && Array.isArray(newFormations)) {
                                        controls.formationList.innerHTML = '';
                                        newFormations.forEach(form => createDynamicItem(controls.formationList, [{ key: 'title', placeholder: 'Nom du diplôme' }, { key: 'meta', placeholder: 'Établissement & Année' }], form));
                                        showNotification("Formations améliorées par OpenAI.", "success");
                                    }
                                } catch (openaiError) {
                                    showNotification(`❌ Toutes les APIs sont indisponibles: ${openaiError.message}`, "error");
                                }
                            } else {
                                showNotification(`❌ Erreur: ${error.message}`, "error");
                            }
                        }
                        break;
                    case 'rewrite-skills':
                        console.log('🎯 [AI-BUTTON] Début amélioration compétences', {
                            action: 'rewrite-skills',
                            timestamp: new Date().toISOString()
                        });
                        
                        APILogger.log('info', 'ai-button', 'rewrite-skills-start', {
                            action: 'rewrite-skills'
                        });
                        
                        await synthesizeSkillsWithAI();
                        break;
                    default:
                        return;
                }
                updatePreview('form');
            }
            
            function setDefaultRecruiterInfo() {
                controls.bannerNom.value = "Lyes AMARA";
                controls.bannerPoste.value = "Responsable d’activité recrutement – BTP – France";
                controls.bannerEmail.value = "l.amara@ltd-international.com";
                controls.bannerTel.value = "01 56 02 12 25 / 06 34 25 32 96";
            }

            function anonymizeCV() {
                if (isAnonymized) {
                    controls.nom.value = originalData.nom;
                    controls.prenom.value = originalData.prenom;
                    
                    controls.anonymizeBtn.innerHTML = '<i class="fa-solid fa-user-secret"></i> Anonymiser le CV';
                    isAnonymized = false;
                    showNotification("CV désanonymisé.", "success");
                } else {
                    originalData = {
                        nom: controls.nom.value,
                        prenom: controls.prenom.value,
                    };
                    
                    const firstLetter = originalData.nom ? originalData.nom.charAt(0) + '.' : '';
                    controls.nom.value = firstLetter;
                    controls.prenom.value = originalData.prenom;
                    
                    controls.anonymizeBtn.innerHTML = '<i class="fa-solid fa-user-check"></i> Désanonymiser le CV';
                    isAnonymized = true;
                    showNotification("CV anonymisé.", "success");
                }
                updatePreview('form');
            }

            async function summarizeAllExperiencesAI() {
                console.log('🎯 [AI-FUNCTION] Début summarizeAllExperiencesAI', {
                    function: 'summarizeAllExperiencesAI',
                    timestamp: new Date().toISOString()
                });
                
                APILogger.log('info', 'ai-function', 'summarize-experiences-start', {
                    function: 'summarizeAllExperiencesAI'
                });
                
                const experienceItems = controls.experienceList.querySelectorAll('.data-desc');
                console.log('📋 [AI-FUNCTION] Expériences trouvées', {
                    count: experienceItems.length,
                    function: 'summarizeAllExperiencesAI'
                });
                
                if (experienceItems.length === 0) {
                    console.log('❌ [AI-FUNCTION] Aucune expérience trouvée', {
                        function: 'summarizeAllExperiencesAI'
                    });
                    APILogger.log('error', 'ai-function', 'no-experiences', {
                        error: 'Aucune expérience à résumer'
                    });
                    showNotification("Aucune expérience à résumer.", "error");
                    return;
                }

                showLoader("Synthèse des expériences...");
                const startTime = Date.now();
                
                try {
                    for (let i = 0; i < experienceItems.length; i++) {
                        console.log(`🔄 [AI-FUNCTION] Traitement expérience ${i+1}/${experienceItems.length}`, {
                            index: i + 1,
                            total: experienceItems.length,
                            function: 'summarizeAllExperiencesAI'
                        });
                        
                        const textarea = experienceItems[i];
                        const originalText = textarea.value;
                        
                        if (originalText) {
                            console.log(`📝 [AI-FUNCTION] Texte original trouvé`, {
                                experience_index: i + 1,
                                original_length: originalText.length,
                                original_preview: originalText.substring(0, 100) + '...'
                            });
                            
                            const prompt = `Résume la description de cette mission professionnelle en 5 lignes maximum. Utilise des verbes d'action et un format de liste à puces (chaque point commençant par '• '). Ne retourne que le texte final formaté en liste à puces, sans aucune phrase d'introduction, de conclusion ou de commentaire. Voici la description : "${originalText}"`;
                            
                            try {
                                const expStartTime = Date.now();
                                const summary = await callAIWithPriority(prompt);
                                const expDuration = Date.now() - expStartTime;
                                
                                if (summary) {
                                    console.log(`✅ [AI-FUNCTION] Expérience ${i+1} résumée`, {
                                        experience_index: i + 1,
                                        original_length: originalText.length,
                                        summary_length: summary.length,
                                        duration: expDuration,
                                        summary_preview: summary.substring(0, 100) + '...'
                                    });
                                    
                                    APILogger.log('success', 'ai-function', 'experience-summarized', {
                                        experience_index: i + 1,
                                        original_length: originalText.length,
                                        summary_length: summary.length,
                                        duration: expDuration
                                    });
                                    
                                    textarea.value = summary;
                                } else {
                                    console.log(`⚠️ [AI-FUNCTION] Résumé vide pour expérience ${i+1}`, {
                                        experience_index: i + 1
                                    });
                                    APILogger.log('warning', 'ai-function', 'empty-summary', {
                                        experience_index: i + 1
                                    });
                                }
                            } catch (error) {
                                console.error(`❌ [AI-FUNCTION] Erreur expérience ${i+1}:`, {
                                    experience_index: i + 1,
                                    error_message: error.message,
                                    error_type: error.constructor.name,
                                    stack: error.stack?.split('\n')[0]
                                });
                                
                                APILogger.log('error', 'ai-function', 'experience-error', {
                                    experience_index: i + 1,
                                    error: error.message,
                                    error_type: error.constructor.name
                                });
                                
                                if (error.message.includes('QUOTA_EXCEEDED') || error.message.includes('429')) {
                                    console.log(`🚫 [AI-FUNCTION] Quota dépassé à l'expérience ${i+1}`, {
                                        experience_index: i + 1,
                                        total_processed: i + 1,
                                        remaining: experienceItems.length - (i + 1)
                                    });
                                    showNotification(`⚠️ Quota dépassé à l'expérience ${i+1}. Configurez OpenAI pour continuer.`, "warning");
                                    break; // Arrêter le traitement des autres expériences
                                }
                            }
                        } else {
                            console.log(`⚠️ [AI-FUNCTION] Expérience ${i+1} vide`, {
                                experience_index: i + 1
                            });
                        }
                    }
                } catch (globalError) {
                    console.error("❌ [AI-FUNCTION] Erreur globale dans summarizeAllExperiencesAI:", {
                        error_message: globalError.message,
                        error_type: globalError.constructor.name,
                        duration: Date.now() - startTime,
                        stack: globalError.stack?.split('\n')[0]
                    });
                    
                    APILogger.log('error', 'ai-function', 'global-error', {
                        error: globalError.message,
                        duration: Date.now() - startTime,
                        error_type: globalError.constructor.name
                    });
                    
                    showNotification(`❌ Erreur: ${globalError.message}`, "error");
                } finally {
                    const totalDuration = Date.now() - startTime;
                    console.log('🏁 [AI-FUNCTION] Fin summarizeAllExperiencesAI', {
                        total_duration: totalDuration,
                        experiences_count: experienceItems.length
                    });
                    
                    APILogger.log('info', 'ai-function', 'summarize-experiences-end', {
                        duration: totalDuration,
                        experiences_count: experienceItems.length
                    });
                    
                    hideLoader();
                    updatePreview('form');
                }
                showNotification("Synthèse des expériences terminée.", "success");
            }

            async function synthesizeSkillsWithAI() {
                console.log('🎯 [AI-FUNCTION] Début synthesizeSkillsWithAI', {
                    function: 'synthesizeSkillsWithAI',
                    timestamp: new Date().toISOString()
                });
                
                APILogger.log('info', 'ai-function', 'synthesize-skills-start', {
                    function: 'synthesizeSkillsWithAI'
                });
                
                const currentSkills = controls.competences.value;
                if (!currentSkills) {
                    console.log('❌ [AI-FUNCTION] Compétences vides', {
                        function: 'synthesizeSkillsWithAI'
                    });
                    APILogger.log('error', 'ai-function', 'empty-skills', {
                        error: 'Liste de compétences vide'
                    });
                    showNotification("La liste de compétences est vide.", "error");
                    return;
                }
                
                console.log('📝 [AI-FUNCTION] Compétences trouvées', {
                    skills_length: currentSkills.length,
                    skills_preview: currentSkills.substring(0, 100) + '...',
                    function: 'synthesizeSkillsWithAI'
                });
                
                const prompt = `Analyse cette liste de compétences de CV: "${currentSkills}". Regroupe-les par catégories pertinentes (ex: Langages, Frameworks, Outils, Logiciels, Langues, etc.). Retourne le résultat sous la forme "Catégorie 1: compétence A, compétence B\nCatégorie 2: compétence C, compétence D". Ne retourne que le texte final formaté, sans aucune phrase d'introduction, de conclusion ou de commentaire.`;

                console.log('🚀 [AI-FUNCTION] Appel API pour organisation compétences', {
                    prompt_length: prompt.length,
                    function: 'synthesizeSkillsWithAI'
                });

                try {
                    const startTime = Date.now();
                    const organizedSkills = await callAIWithPriority(prompt);
                    const duration = Date.now() - startTime;
                    
                    if (organizedSkills) {
                        console.log('✅ [AI-FUNCTION] Compétences organisées', {
                            original_length: currentSkills.length,
                            organized_length: organizedSkills.length,
                            duration: duration,
                            organized_preview: organizedSkills.substring(0, 100) + '...',
                            function: 'synthesizeSkillsWithAI'
                        });
                        
                        APILogger.log('success', 'ai-function', 'skills-organized', {
                            original_length: currentSkills.length,
                            organized_length: organizedSkills.length,
                            duration: duration
                        });
                        
                        controls.competences.value = organizedSkills;
                        updatePreview('form');
                        showNotification("Compétences organisées par l'IA.", "success");
                    } else {
                        console.log('⚠️ [AI-FUNCTION] Réponse vide pour organisation compétences', {
                            function: 'synthesizeSkillsWithAI'
                        });
                        APILogger.log('warning', 'ai-function', 'empty-organized-skills', {
                            warning: 'Réponse vide pour organisation'
                        });
                    }
                } catch (error) {
                    console.error("❌ [AI-FUNCTION] Erreur organisation compétences:", {
                        error_message: error.message,
                        error_type: error.constructor.name,
                        function: 'synthesizeSkillsWithAI',
                        stack: error.stack?.split('\n')[0]
                    });
                    
                    APILogger.log('error', 'ai-function', 'synthesize-skills-error', {
                        error: error.message,
                        error_type: error.constructor.name
                    });
                    
                    if (error.message.includes('QUOTA_EXCEEDED') || error.message.includes('429')) {
                        console.log('🚫 [AI-FUNCTION] Quota dépassé pour organisation compétences', {
                            function: 'synthesizeSkillsWithAI',
                            error: error.message
                        });
                        showNotification("⚠️ Quota dépassé. Configurez OpenAI dans l'onglet API pour continuer.", "warning");
                    } else {
                        showNotification(`❌ Erreur: ${error.message}`, "error");
                    }
                }
            }

            async function limitSkillsWithAI() {
                const currentSkills = controls.competences.value;
                const jobTitle = controls.poste.value;
                if (!currentSkills) {
                    showNotification("La liste de compétences est vide.", "error");
                    return;
                }
                if (!jobTitle) {
                    showNotification("Veuillez renseigner le 'Poste recherché' pour de meilleurs résultats.", "error");
                    return;
                }
                const prompt = `À partir de cette liste de compétences: "${currentSkills}", sélectionne les 10 compétences les plus importantes et pertinentes pour un poste de "${jobTitle}". Retourne uniquement la liste des 10 compétences, séparées par des virgules, sans aucune phrase d'introduction, de conclusion ou de commentaire.`;

                try {
                    const limitedSkills = await callAIWithPriority(prompt);
                    if (limitedSkills) {
                        controls.competences.value = limitedSkills;
                        updatePreview('form');
                        showNotification("Compétences limitées à 10 par l'IA.", "success");
                    }
                } catch (error) {
                    console.error("❌ Erreur lors de la limitation des compétences:", error);
                    if (error.message.includes('QUOTA_EXCEEDED') || error.message.includes('429')) {
                        showNotification("⚠️ Quota dépassé. Configurez OpenAI dans l'onglet API pour continuer.", "warning");
                    } else {
                        showNotification(`❌ Erreur: ${error.message}`, "error");
                    }
                }
            }
            
            function removeBannerBackground() {
                preview.bannerBgImg.src = '';
                controls.bannerBgImage.value = ''; // Reset file input
                controls.bannerBgOpacity.value = 1;
                controls.bannerBgBlur.value = 0;
                controls.bannerBgGrayscale.checked = false;
                updateBannerBackground();
            }

            // NEW: Progress Bar Update Function
            function updateProgressBar() {
                const checkboxes = document.querySelectorAll('.completion-checkbox');
                const total = checkboxes.length;
                const completed = document.querySelectorAll('.completion-checkbox:checked').length;
                const percentage = total > 0 ? (completed / total) * 100 : 0;

                const progressBar = document.getElementById('progress-bar');
                const progressText = document.getElementById('progress-text');

                if(progressBar) progressBar.style.width = `${percentage}%`;
                if(progressText) progressText.textContent = `${completed}/${total} sections complétées`;
            }

            function populateLevelsFromText() {
                const text = controls.competences.value;
                const skills = text
                    .replace(/.*:/g, '') // Remove category labels like "Langages:"
                    .split(/,|\n/)
                    .map(s => s.trim())
                    .filter(Boolean);

                controls.skillsLevelList.innerHTML = '';
                skills.forEach(skill => createSkillLevelItem(skill, 3));
            }

            // --- INITIALIZATION FUNCTION ---
            function initializeAll() {
                console.log("Initializing UI components and event listeners...");
                
                reinitializePreviewSelectors();
                initializeSortableForPage(1);
                
                populateFontSelectors();
                populateIconPicker();

                // --- EVENT LISTENERS ---

                const tabNavigation = document.getElementById('tab-navigation');
                const tabPanels = document.querySelectorAll('.tab-panel');
                const tabButtons = document.querySelectorAll('.tab-btn');
                
                tabNavigation.addEventListener('click', (e) => {
                    const tabBtn = e.target.closest('.tab-btn');
                    if (!tabBtn) return;
                    tabPanels.forEach(panel => panel.classList.add('hidden'));
                    tabButtons.forEach(btn => {
                        btn.classList.remove('border-blue-600', 'text-blue-600');
                        btn.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
                    });
                    const targetPanelId = tabBtn.dataset.target;
                    document.querySelector(targetPanelId).classList.remove('hidden');
                    tabBtn.classList.add('border-blue-600', 'text-blue-600');
                    tabBtn.classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
                });
                tabButtons[0].click();

                controls.undoBtn.addEventListener('click', undo);
                controls.redoBtn.addEventListener('click', redo);
                document.addEventListener('keydown', (e) => {
                    if (e.ctrlKey && e.key === 'z') { e.preventDefault(); undo(); }
                    if (e.ctrlKey && e.key === 'y') { e.preventDefault(); redo(); }
                });

                controls.addExperienceBtn.addEventListener('click', () => createDynamicItem(controls.experienceList, [{ key: 'title', placeholder: 'Titre du poste' }, { key: 'meta', placeholder: 'Entreprise & Dates' }, { key: 'desc', placeholder: 'Description des missions', type: 'textarea' }]));
                controls.addFormationBtn.addEventListener('click', () => createDynamicItem(controls.formationList, [{ key: 'title', placeholder: 'Nom du diplôme' }, { key: 'meta', placeholder: 'Établissement & Année' }]));
                
                const controlsPanel = document.getElementById('controls');
                controlsPanel.addEventListener('input', (e) => {
                    if (e.target.matches('.cv-input, .banner-input, .custom-section-input, #banner-bg-opacity, #banner-bg-blur, #banner-bg-grayscale')) {
                        if (e.target.matches('#banner-bg-opacity, #banner-bg-blur, #banner-bg-grayscale')) {
                             updateBannerBackground();
                        } else {
                             updatePreview('form');
                             updateAllStyles();
                        }
                    }
                    if(e.target.matches('.completion-checkbox')) {
                        updateProgressBar();
                    }
                     if(e.target.matches('.skill-level-input')) {
                         e.target.nextElementSibling.textContent = `${e.target.value}/5`;
                         updatePreview('form');
                     }
                });
                 controlsPanel.addEventListener('change', (e) => {
                    if (e.target.matches('.cv-input, .banner-input, .custom-section-input')) {
                        updatePreview('form');
                        updateAllStyles();
                    }
                });

                controls.bannerImage.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (event) => { preview.bannerImg.src = event.target.result; };
                        reader.readAsDataURL(file);
                    }
                });
                
                controls.bannerBgImage.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (event) => {
                            preview.bannerBgImg.src = event.target.result;
                            updateBannerBackground();
                        };
                        reader.readAsDataURL(file);
                    }
                });

                preview.previewWrapper.addEventListener('input', (e) => {
                    if (e.target.hasAttribute('contenteditable')) {
                        syncFormFromPreview(e.target);
                    }
                });

                preview.previewWrapper.addEventListener('click', (e) => {
                    const target = e.target;
                    
                    const visibilityBtn = target.closest('.toggle-visibility-btn');
                    if (visibilityBtn) {
                        const moduleElement = visibilityBtn.closest('.cv-module');
                        const icon = visibilityBtn.querySelector('i');
                        if (moduleElement) {
                            moduleElement.classList.toggle('section-hidden');
                            const isHidden = moduleElement.classList.contains('section-hidden');
                            if (icon) {
                                icon.className = `fas ${isHidden ? 'fa-eye-slash' : 'fa-eye'}`;
                            }
                        }
                        return;
                    }

                    const aiBtn = target.closest('.ai-action-btn');
                    if (aiBtn) {
                        const action = aiBtn.dataset.action;
                        if (action) {
                            handleAIAction(action);
                        }
                        return;
                    }

                    const deleteBlockBtn = target.closest('.delete-block-btn');
                    if (deleteBlockBtn) {
                        const itemContainer = deleteBlockBtn.closest('.dynamic-item-container');
                        if (itemContainer) {
                            const index = parseInt(itemContainer.dataset.index, 10);
                            const type = itemContainer.dataset.type;
                            const formList = type === 'experience' ? controls.experienceList : controls.formationList;
                            if (formList.children[index]) {
                                formList.children[index].remove();
                                updatePreview('form');
                            }
                        } else {
                            const customModule = deleteBlockBtn.closest('.custom-module-preview');
                            if(customModule) {
                                const controlItem = controls.customSectionsList.querySelector(`[data-section-id="${customModule.id}"]`);
                                if(controlItem) controlItem.remove();
                                customModule.remove();
                            }
                        }
                        return;
                    }

                    const addLineBtn = target.closest('.add-line-preview-btn');
                    if (addLineBtn) {
                        const index = parseInt(addLineBtn.dataset.index, 10);
                        const type = addLineBtn.dataset.type;
                        if (type === 'experience') createDynamicItem(controls.experienceList, [{ key: 'title', placeholder: 'Titre du poste' }, { key: 'meta', placeholder: 'Entreprise & Dates' }, { key: 'desc', placeholder: 'Description des missions', type: 'textarea' }], {}, index);
                        else if (type === 'formation') createDynamicItem(controls.formationList, [{ key: 'title', placeholder: 'Nom du diplôme' }, { key: 'meta', placeholder: 'Établissement & Année' }], {}, index);
                        return;
                    }

                    const deleteLineBtn = target.closest('.delete-line-btn');
                    if (deleteLineBtn) {
                        const wrapper = deleteLineBtn.closest('.editable-wrapper');
                        if (wrapper) {
                            wrapper.remove();
                            syncFormFromPreview(wrapper.closest('.dynamic-preview-item') || document.getElementById('cv-description-preview'));
                        }
                        return;
                    }
                    
                    const removePageBtn = target.closest('.remove-page-btn');
                    if (removePageBtn) {
                        const pageContainer = removePageBtn.closest('.a4-page-container');
                        if (pageContainer) {
                            pageContainer.remove();
                            checkAllPagesOverflow();
                        }
                        return;
                    }
                });

                controlsPanel.addEventListener('click', (e) => {
                    const target = e.target;
                    
                    const removeBtn = target.closest('.remove-dynamic-item-btn, .remove-skill-level-btn');
                    if (removeBtn) {
                        removeBtn.parentElement.remove();
                        updatePreview('form');
                        return;
                    }
                    const removeSectionBtn = target.closest('.remove-section-btn');
                    if (removeSectionBtn) {
                        const sectionDiv = removeSectionBtn.closest('[data-section-id]');
                        const sectionId = sectionDiv.dataset.sectionId;
                        sectionDiv.remove();
                        const previewModule = document.getElementById(sectionId);
                        if(previewModule) previewModule.remove();
                        return;
                    }
                    
                    const layoutBtn = target.closest('.layout-btn');
                    if (layoutBtn) {
                        const layout = layoutBtn.dataset.layout;
                        document.querySelectorAll('.layout-btn').forEach(b => b.classList.remove('active'));
                        layoutBtn.classList.add('active');
                        document.querySelectorAll('.cv-body-container').forEach(container => {
                           container.className = `cv-body-container ${layout}`;
                           if (layout === 'layout-1-col') {
                               const col2 = container.querySelector('.cv-column:nth-child(2)');
                               const col1 = container.querySelector('.cv-column:nth-child(1)');
                               if (col2 && col1) Array.from(col2.children).forEach(module => col1.appendChild(module));
                           }
                           container.style.gridTemplateColumns = '';
                        });
                        setupAllResizers();
                        checkAllPagesOverflow();
                        return;
                    }

                    const titleStyleBtn = target.closest('.section-title-style-btn');
                    if (titleStyleBtn) {
                        document.querySelectorAll('.section-title-style-btn').forEach(b => b.classList.remove('active'));
                        titleStyleBtn.classList.add('active');
                        updateAllStyles();
                        return;
                    }
                    
                    const themeBtn = target.closest('.theme-btn');
                    if (themeBtn) {
                        applyTheme(themeBtn.dataset.theme);
                        return;
                    }

                    const logoSizeBtn = target.closest('.logo-size-btn');
                    if (logoSizeBtn) {
                        document.querySelectorAll('.logo-size-btn').forEach(b => b.classList.remove('active'));
                        logoSizeBtn.classList.add('active');
                        preview.bannerImg.className = `logo-${logoSizeBtn.dataset.logoSize}`;
                        return;
                    }

                    const skillStyleBtn = target.closest('.skill-style-btn');
                    if (skillStyleBtn) {
                        document.querySelectorAll('.skill-style-btn').forEach(b => b.classList.remove('active'));
                        skillStyleBtn.classList.add('active');
                        const style = skillStyleBtn.dataset.skillStyle;
                        controls.skillsTextControls.classList.toggle('hidden', style === 'levels');
                        controls.skillsLevelControls.classList.toggle('hidden', style !== 'levels');
                        if (style === 'levels') {
                            populateLevelsFromText();
                        }
                        updatePreview('form');
                        return;
                    }
                    
                    const gaugeStyleBtn = target.closest('.gauge-style-btn');
                    if (gaugeStyleBtn) {
                        document.querySelectorAll('.gauge-style-btn').forEach(b => b.classList.remove('active'));
                        gaugeStyleBtn.classList.add('active');
                        updatePreview('form');
                        return;
                    }

                    const styleToggleBtn = target.closest('.style-toggle-btn');
                    if (styleToggleBtn) {
                        styleToggleBtn.classList.toggle('active');
                        updatePreview('form');
                        return;
                    }
                });

                // Fonction de nettoyage du texte d'entrée
                function cleanInputText(rawText) {
                    let cleaned = rawText;
                    
                    // Nettoyer les caractères d'échappement
                    cleaned = cleaned.replace(/\\r\\n/g, ' ');
                    cleaned = cleaned.replace(/\\n/g, ' ');
                    cleaned = cleaned.replace(/\\r/g, ' ');
                    cleaned = cleaned.replace(/\r\n/g, ' ');
                    cleaned = cleaned.replace(/\n/g, ' ');
                    cleaned = cleaned.replace(/\r/g, ' ');
                    
                    // Nettoyer les espaces multiples
                    cleaned = cleaned.replace(/\s+/g, ' ');
                    
                    // Nettoyer les caractères spéciaux problématiques
                    cleaned = cleaned.replace(/[""]/g, '"');
                    cleaned = cleaned.replace(/['']/g, "'");
                    
                    // Ajouter des points pour séparer les phrases qui se suivent
                    cleaned = cleaned.replace(/([a-z])([A-Z])/g, '$1. $2');
                    
                    return cleaned.trim();
                }

                Object.values(sliders).forEach(config => {
                    if (config.el && config.valueEl) {
                        config.el.addEventListener('input', () => {
                            config.valueEl.textContent = config.el.value;
                            root.style.setProperty(config.property, `${config.el.value}${config.unit}`);
                            checkAllPagesOverflow();
                        });
                    } else {
                        console.warn('Slider element not found:', config);
                    }
                });
                
                // Fonction de post-traitement des données extraites
                function postProcessExtractedData(data) {
                    const cleaned = { ...data };
                    
                    // Nettoyer les champs texte
                    if (cleaned.nom) cleaned.nom = cleanTextValue(cleaned.nom);
                    if (cleaned.prenom) cleaned.prenom = cleanTextValue(cleaned.prenom);
                    if (cleaned.poste) cleaned.poste = cleanTextValue(cleaned.poste);
                    if (cleaned.description) cleaned.description = cleanTextValue(cleaned.description);
                    if (cleaned.competences) cleaned.competences = cleanTextValue(cleaned.competences);
                    
                    // Nettoyer les expériences
                    if (cleaned.experiences && Array.isArray(cleaned.experiences)) {
                        cleaned.experiences = cleaned.experiences.map(exp => ({
                            title: cleanTextValue(exp.title || ''),
                            meta: cleanTextValue(exp.meta || ''),
                            desc: cleanTextValue(exp.desc || '')
                        })).filter(exp => exp.title || exp.meta || exp.desc);
                    }
                    
                    // Nettoyer les formations
                    if (cleaned.formations && Array.isArray(cleaned.formations)) {
                        cleaned.formations = cleaned.formations.map(form => ({
                            title: cleanTextValue(form.title || ''),
                            meta: cleanTextValue(form.meta || '')
                        })).filter(form => form.title || form.meta);
                    }
                    
                    // Si pas de nom/prénom mais du contenu, suggérer un placeholder
                    if (!cleaned.nom && !cleaned.prenom && (cleaned.experiences?.length > 0 || cleaned.description)) {
                        console.log("💡 Suggestion: Ajoutez manuellement nom et prénom");
                        showNotification("✅ CV analysé ! N'oubliez pas d'ajouter votre nom et prénom.", "info");
                    }
                    
                    return cleaned;
                }
                
                function cleanTextValue(text) {
                    if (!text) return '';
                    
                    let cleaned = text.toString();
                    
                    // Supprimer les caractères d'échappement restants
                    cleaned = cleaned.replace(/\\r\\n/g, ' ');
                    cleaned = cleaned.replace(/\\n/g, ' ');
                    cleaned = cleaned.replace(/\\"/g, '"');
                    
                    // Nettoyer les espaces multiples
                    cleaned = cleaned.replace(/\s+/g, ' ');
                    
                    // Première lettre en majuscule pour les noms
                    cleaned = cleaned.charAt(0).toUpperCase() + cleaned.slice(1);
                    
                    return cleaned.trim();
                }
                
                controls.analyzeBtn.addEventListener('click', async () => {
                    try {
                        let text = controls.aiInput.value;
                        if (!text) { showNotification("Veuillez coller du texte à analyser.", "error"); return; }
                        
                        // Nettoyage préalable du texte
                        text = cleanInputText(text);
                        console.log("🧹 Texte nettoyé:", text);
                        
                        // Vérification de la clé API (pour Gemini prioritaire)
                        const apiKey = localStorage.getItem('gemini-api-key');
                        const openaiKey = localStorage.getItem('openai-api-key');
                        const priority = localStorage.getItem('api-priority') || 'gemini-first';
                        
                        // Vérifier qu'au moins une API est configurée
                        if (!apiKey && !openaiKey) {
                            showNotification("⚠️ Aucune clé API configurée ! Allez dans l'onglet API pour configurer Gemini ou OpenAI.", "error");
                            return;
                        }
                        
                        // Si priorité Gemini mais pas de clé Gemini, vérifier OpenAI
                        if (priority.includes('gemini') && !apiKey && !openaiKey) {
                            showNotification("⚠️ Clé API Gemini non configurée ! Configurez une clé Gemini ou OpenAI dans l'onglet API.", "error");
                            return;
                        }
                    
                    const schema = {
                        type: "OBJECT",
                        properties: {
                            nom: { type: "STRING" }, 
                            prenom: { type: "STRING" }, 
                            poste: { type: "STRING" }, 
                            description: { type: "STRING" },
                            experiences: { 
                                type: "ARRAY", 
                                items: { 
                                    type: "OBJECT", 
                                    properties: { 
                                        title: { type: "STRING" }, 
                                        meta: { type: "STRING" }, 
                                        desc: { type: "STRING" } 
                                    } 
                                } 
                            },
                            formations: { 
                                type: "ARRAY", 
                                items: { 
                                    type: "OBJECT", 
                                    properties: { 
                                        title: { type: "STRING" }, 
                                        meta: { type: "STRING" } 
                                    } 
                                } 
                            },
                            competences: { type: "STRING" }
                        }
                    };
                    
                    const prompt = `Tu es un expert en analyse de CV et de textes professionnels. Analyse le texte suivant et extrais INTELLIGEMMENT toutes les informations disponibles :

RÈGLES D'EXTRACTION :

1. INFORMATIONS PERSONNELLES :
   - nom : nom de famille (si absent, laisse vide)
   - prenom : prénom (si absent, laisse vide)  
   - poste : déduis le poste principal à partir du contexte professionnel (ex: "Directeur Régional", "Manager", "Responsable")

2. DESCRIPTION PROFESSIONNELLE :
   - description : résume en 2-3 phrases le profil professionnel basé sur les expériences décrites

3. EXPERIENCES PROFESSIONNELLES :
   ANALYSE INTELLIGENTE du texte pour identifier et structurer les expériences :
   - Divise le texte en blocs logiques d'expériences professionnelles
   - Pour chaque expérience identifiée :
     * title : titre du poste ou fonction principale
     * meta : entreprise + période (si trouvée) ou "Période non précisée"
     * desc : missions et responsabilités (nettoie et structure le texte)

4. FORMATIONS : 
   - Cherche toute mention de diplômes, formations, études
   - Si aucune formation explicite, laisse le tableau vide

5. COMPETENCES :
   - Extrais TOUTES les compétences mentionnées : techniques, managériales, sectorielles
   - Déduis les compétences implicites à partir des missions décrites

TRAITEMENT DU TEXTE :
- Nettoie les caractères d'échappement (\\r\\n, \\n)
- Structure les phrases qui se suivent
- Identifie les activités principales même si mal formatées
- Groupe les activités similaires

GESTION DES CAS PARTICULIERS :
- Si nom/prénom absents : laisse vides mais remplis le reste
- Si le texte est une liste d'activités : structure en expériences logiques
- Si entreprises multiples : crée une expérience par entreprise
- Si période continue : groupe les activités sous une même expérience

FORMAT DE SORTIE :
JSON STRICT sans texte supplémentaire. Nettoie tous les \\r\\n et caractères spéciaux.

Texte à analyser :
"""${text}"""`;
                    
                    console.log("🤖 Prompt envoyé à l'IA:", prompt);
                    
                    const startTime = Date.now();
                    APILogger.log('info', 'mixed', 'analyze-start', { prompt_length: prompt.length });
                    
                    // Utiliser le système de priorité avec fallback
                    let extractedData;
                    try {
                        // Tenter d'abord avec le système de priorité pour les appels standards
                        extractedData = await callAIWithPriority(prompt);
                        
                        const duration = Date.now() - startTime;
                        APILogger.log('success', 'mixed', 'analyze', { 
                            duration: duration,
                            prompt_length: prompt.length,
                            response_type: typeof extractedData
                        });
                        
                        // Si réussi, parser le JSON manuellement car callAIWithPriority retourne du texte
                        if (typeof extractedData === 'string') {
                            try {
                                extractedData = JSON.parse(extractedData);
                            } catch (e) {
                                // Si le parsing échoue, utiliser la fonction legacy avec schema
                                extractedData = await callGeminiAPI(prompt, schema);
                            }
                        }
                    } catch (error) {
                        console.warn("🔄 Erreur avec le système de priorité, tentative avec schema:", error.message);
                        
                        const duration = Date.now() - startTime;
                        APILogger.log('warning', 'mixed', 'analyze-fallback', { 
                            error: error.message,
                            duration: duration
                        });
                        
                        // Si c'est une erreur de quota, ne pas essayer le fallback Gemini
                        if (error.message.includes('QUOTA_EXCEEDED') || error.message.includes('429')) {
                            console.log("⚠️ Quota Gemini dépassé, tentative avec OpenAI...");
                            try {
                                extractedData = await callOpenAI(prompt, schema);
                                APILogger.log('success', 'openai', 'analyze-fallback', { 
                                    duration: Date.now() - startTime
                                });
                            } catch (openaiError) {
                                console.error("❌ Erreur OpenAI également:", openaiError.message);
                                APILogger.log('error', 'openai', 'analyze-final-error', { 
                                    error: openaiError.message,
                                    duration: Date.now() - startTime
                                });
                                throw new Error(`Toutes les APIs sont indisponibles. Gemini: ${error.message}, OpenAI: ${openaiError.message}`);
                            }
                        } else {
                            // Pour les autres erreurs, tenter le fallback vers callGeminiAPI avec schema
                            try {
                                extractedData = await callGeminiAPI(prompt, schema);
                                APILogger.log('success', 'gemini', 'analyze-fallback-schema', { 
                                    duration: Date.now() - startTime
                                });
                            } catch (geminiError) {
                                // Si même le fallback Gemini échoue, essayer OpenAI
                                if (geminiError.message.includes('QUOTA_EXCEEDED')) {
                                    console.log("⚠️ Quota Gemini dépassé lors du fallback, tentative avec OpenAI...");
                                    extractedData = await callOpenAI(prompt, schema);
                                    APILogger.log('success', 'openai', 'analyze-final-fallback', { 
                                        duration: Date.now() - startTime
                                    });
                                } else {
                                    APILogger.log('error', 'gemini', 'analyze-error', { 
                                        error: geminiError.message,
                                        duration: Date.now() - startTime
                                    });
                                    throw geminiError;
                                }
                            }
                        }
                    }
                    
                    console.log("📥 Données extraites par l'IA:", extractedData);
                    
                    if (extractedData) {
                        // Post-traitement des données extraites
                        const cleanedData = postProcessExtractedData(extractedData);
                        
                        controls.nom.value = cleanedData.nom || '';
                        controls.prenom.value = cleanedData.prenom || '';
                        controls.poste.value = cleanedData.poste || '';
                        controls.description.value = cleanedData.description || '';
                        controls.competences.value = cleanedData.competences || '';
                        
                        // Nettoyer et remplir les expériences
                        controls.experienceList.innerHTML = '';
                        if (cleanedData.experiences && cleanedData.experiences.length > 0) {
                            console.log("📋 Ajout de", cleanedData.experiences.length, "expériences");
                            cleanedData.experiences.forEach(exp => {
                                createDynamicItem(controls.experienceList, [
                                    { key: 'title', placeholder: 'Titre du poste' }, 
                                    { key: 'meta', placeholder: 'Entreprise & Dates' }, 
                                    { key: 'desc', placeholder: 'Description', type: 'textarea' }
                                ], exp);
                            });
                        } else {
                            console.log("⚠️ Aucune expérience extraite");
                        }
                        
                        // Nettoyer et remplir les formations
                        controls.formationList.innerHTML = '';
                        if (cleanedData.formations && cleanedData.formations.length > 0) {
                            console.log("🎓 Ajout de", cleanedData.formations.length, "formations");
                            cleanedData.formations.forEach(form => {
                                createDynamicItem(controls.formationList, [
                                    { key: 'title', placeholder: 'Nom du diplôme' }, 
                                    { key: 'meta', placeholder: 'Établissement & Année' }
                                ], form);
                            });
                        } else {
                            console.log("⚠️ Aucune formation extraite");
                        }

                        updatePreview('form');
                        showNotification("CV rempli par l'IA !", "success");
                    } else {
                        showNotification("Erreur : L'IA n'a pas pu extraire les données", "error");
                    }
                } catch (error) {
                    console.error("❌ Erreur lors de l'analyse IA:", error);
                    hideLoader();
                    
                    // Gestion spécifique des erreurs de quota
                    if (error.message.includes('QUOTA_EXCEEDED') || error.message.includes('429')) {
                        const currentModel = controls.openaiModel?.value || 'gpt-4o';
                        if (error.message.includes('gemini') || error.message.includes('Gemini')) {
                            showNotification(`⚠️ Quota Gemini dépassé ! Basculement automatique vers ${currentModel.toUpperCase()} disponible dans l'onglet API.`, "warning");
                        } else {
                            showNotification(`⚠️ Quota ${currentModel.toUpperCase()} dépassé ! Configurez une autre API dans l'onglet API.`, "warning");
                        }
                    } else if (error.message.includes('API non configurée') || error.message.includes('clé API')) {
                        showNotification("⚠️ " + error.message, "error");
                    } else {
                        showNotification(`❌ Erreur de l'IA: ${error.message}. Vérifiez votre connexion et réessayez.`, "error");
                    }
                }
                });
                
                // === GESTIONNAIRES D'ÉVÉNEMENTS API ===
                
                // === NOUVEAUX SÉLECTEURS D'API ===
                
                // Sélecteur d'API principal
                const apiSelectors = document.querySelectorAll('.api-selector');
                const selectGeminiBtn = document.getElementById('select-gemini-api');
                const selectOpenaiBtn = document.getElementById('select-openai-api');
                const globalStatusIcon = document.getElementById('global-status-icon');
                const globalStatusText = document.getElementById('global-status-text');
                const activeModelBadge = document.getElementById('active-model-badge');
                const geminiConfig = document.getElementById('gemini-config');
                const openaiConfig = document.getElementById('openai-config');

                function updateAPISelector(selectedApi) {
                    // Mettre à jour l'apparence des boutons
                    apiSelectors.forEach(selector => {
                        const isSelected = selector.dataset.api === selectedApi;
                        const statusIndicator = selector.querySelector('.status-indicator');
                        const selectionIndicator = selector.querySelector('.selection-indicator');
                        
                        if (isSelected) {
                            selector.classList.add('active');
                            selector.classList.remove('border-gray-300');
                            if (selectedApi === 'gemini') {
                                selector.classList.add('border-blue-500', 'bg-blue-50');
                                statusIndicator.className = 'status-indicator mt-2 px-2 py-1 rounded text-xs font-medium bg-blue-100 text-blue-700';
                                statusIndicator.innerHTML = '<i class="fas fa-circle text-blue-500"></i> API Sélectionnée';
                                selectionIndicator.className = 'selection-indicator fas fa-check-circle text-blue-500 text-xl';
                            } else {
                                selector.classList.add('border-green-500', 'bg-green-50');
                                statusIndicator.className = 'status-indicator mt-2 px-2 py-1 rounded text-xs font-medium bg-green-100 text-green-700';
                                statusIndicator.innerHTML = '<i class="fas fa-circle text-green-500"></i> API Sélectionnée';
                                selectionIndicator.className = 'selection-indicator fas fa-check-circle text-green-500 text-xl';
                            }
                        } else {
                            selector.classList.remove('active', 'border-blue-500', 'border-green-500', 'bg-blue-50', 'bg-green-50');
                            selector.classList.add('border-gray-300');
                            statusIndicator.className = 'status-indicator mt-2 px-2 py-1 rounded text-xs font-medium bg-gray-100 text-gray-500';
                            statusIndicator.innerHTML = '<i class="fas fa-circle text-gray-400"></i> Non sélectionnée';
                            selectionIndicator.className = 'selection-indicator fas fa-circle text-gray-300 text-xl';
                        }
                    });

                    // Mettre à jour le statut global
                    if (selectedApi === 'gemini') {
                        globalStatusIcon.className = 'fas fa-circle text-blue-500';
                        globalStatusText.textContent = 'Google Gemini activé';
                        globalStatusText.className = 'font-medium text-blue-700';
                        activeModelBadge.textContent = controls.aiModelSelect?.value || 'gemini-1.5-flash';
                        activeModelBadge.className = 'px-2 py-1 bg-blue-100 text-blue-700 text-xs rounded-full';
                        
                        // Ouvrir la config Gemini et fermer OpenAI
                        if (geminiConfig) geminiConfig.setAttribute('open', '');
                        if (openaiConfig) openaiConfig.removeAttribute('open');
                    } else {
                        globalStatusIcon.className = 'fas fa-circle text-green-500';
                        globalStatusText.textContent = 'OpenAI ChatGPT activé';
                        globalStatusText.className = 'font-medium text-green-700';
                        activeModelBadge.textContent = controls.openaiModel?.value || 'gpt-4o';
                        activeModelBadge.className = 'px-2 py-1 bg-green-100 text-green-700 text-xs rounded-full';
                        
                        // Ouvrir la config OpenAI et fermer Gemini
                        if (openaiConfig) openaiConfig.setAttribute('open', '');
                        if (geminiConfig) geminiConfig.removeAttribute('open');
                    }

                    // Sauvegarder la préférence
                    localStorage.setItem('preferred-api', selectedApi);
                    
                    // Mettre à jour la priorité API
                    if (controls.apiPriority) {
                        if (selectedApi === 'gemini') {
                            controls.apiPriority.value = 'gemini-first';
                        } else {
                            controls.apiPriority.value = 'openai-first';
                        }
                    }
                }

                // Event listeners pour les sélecteurs
                if (selectGeminiBtn) {
                    selectGeminiBtn.addEventListener('click', () => {
                        updateAPISelector('gemini');
                        showNotification('🤖 Google Gemini sélectionné comme API principale', 'success');
                    });
                }

                if (selectOpenaiBtn) {
                    selectOpenaiBtn.addEventListener('click', () => {
                        updateAPISelector('openai');
                        showNotification('🧠 OpenAI ChatGPT sélectionné comme API principale', 'success');
                    });
                }

                // Charger la préférence sauvegardée au démarrage
                const preferredApi = localStorage.getItem('preferred-api') || 'gemini';
                updateAPISelector(preferredApi);

                // Mise à jour du badge quand on change de modèle
                if (controls.aiModelSelect) {
                    controls.aiModelSelect.addEventListener('change', () => {
                        if (preferredApi === 'gemini') {
                            activeModelBadge.textContent = controls.aiModelSelect.value;
                        }
                    });
                }

                if (controls.openaiModel) {
                    controls.openaiModel.addEventListener('change', () => {
                        if (preferredApi === 'openai') {
                            activeModelBadge.textContent = controls.openaiModel.value;
                        }
                    });
                }

                // Bouton de sauvegarde OpenAI
                const saveOpenaiKeyBtn = document.getElementById('save-openai-api-key');
                if (saveOpenaiKeyBtn) {
                    saveOpenaiKeyBtn.addEventListener('click', () => {
                        const apiKey = controls.openaiApiKey?.value?.trim();
                        if (apiKey) {
                            localStorage.setItem('openai-api-key', apiKey);
                            showNotification('🔑 Clé API OpenAI sauvegardée', 'success');
                            // Mettre à jour le statut OpenAI
                            const openaiStatus = document.getElementById('openai-quota-status');
                            if (openaiStatus) {
                                openaiStatus.textContent = '✅ Configuré';
                                openaiStatus.className = 'px-2 py-1 rounded-full bg-green-100 text-green-700 text-xs';
                            }
                        } else {
                            showNotification('❌ Veuillez entrer une clé API valide', 'error');
                        }
                    });
                }

                // Charger les clés API sauvegardées
                const savedGeminiKey = localStorage.getItem('gemini-api-key');
                const savedOpenaiKey = localStorage.getItem('openai-api-key');
                
                if (savedGeminiKey && controls.geminiApiKey) {
                    controls.geminiApiKey.value = savedGeminiKey;
                }
                
                if (savedOpenaiKey && controls.openaiApiKey) {
                    controls.openaiApiKey.value = savedOpenaiKey;
                    // Mettre à jour le statut OpenAI
                    const openaiStatus = document.getElementById('openai-quota-status');
                    if (openaiStatus) {
                        openaiStatus.textContent = '✅ Configuré';
                        openaiStatus.className = 'px-2 py-1 rounded-full bg-green-100 text-green-700 text-xs';
                    }
                }

                // === FIN NOUVEAUX SÉLECTEURS D'API ===
                
                // Sauvegarde clé API
                if (controls.saveGeminiApiKey) {
                    controls.saveGeminiApiKey.addEventListener('click', saveGeminiApiKey);
                }
                
                // 🚀 EVENT LISTENERS POUR CLÉS MULTIPLES GEMINI
                if (controls.addGeminiKey) {
                    controls.addGeminiKey.addEventListener('click', () => {
                        const key = prompt('Entrez votre clé API Gemini supplémentaire:');
                        if (key && key.trim()) {
                            const name = prompt('Nom pour cette clé (optionnel):') || `Clé ${geminiKeysManager.keys.length + 1}`;
                            geminiKeysManager.addKey(key.trim(), name);
                        }
                    });
                }
                
                if (controls.testAllGeminiKeys) {
                    controls.testAllGeminiKeys.addEventListener('click', () => {
                        geminiKeysManager.testAllKeys();
                    });
                }
                
                // Mettre à jour l'UI au chargement
                geminiKeysManager.updateUI();
                
                // Basculer visibilité clé
                if (controls.toggleApiKeyVisibility) {
                    controls.toggleApiKeyVisibility.addEventListener('click', toggleApiKeyVisibility);
                }
                
                // Test de l'API
                if (controls.testGeminiApi) {
                    controls.testGeminiApi.addEventListener('click', testGeminiApi);
                }
                
                // === GESTIONNAIRES D'ÉVÉNEMENTS OPENAI ===
                
                // Basculer visibilité clé OpenAI
                if (controls.toggleOpenaiKey) {
                    controls.toggleOpenaiKey.addEventListener('click', () => {
                        const input = controls.openaiApiKey;
                        const icon = controls.toggleOpenaiKey.querySelector('i');
                        
                        if (input.type === 'password') {
                            input.type = 'text';
                            icon.className = 'fas fa-eye-slash';
                        } else {
                            input.type = 'password';
                            icon.className = 'fas fa-eye';
                        }
                    });
                }
                
                // Sauvegarder configuration OpenAI
                if (controls.openaiApiKey) {
                    controls.openaiApiKey.addEventListener('blur', saveOpenAIConfig);
                }
                
                if (controls.openaiModel) {
                    controls.openaiModel.addEventListener('change', saveOpenAIConfig);
                }
                
                if (controls.apiPriority) {
                    controls.apiPriority.addEventListener('change', saveOpenAIConfig);
                }
                
                // Test de connexion OpenAI
                if (controls.testOpenaiConnection) {
                    controls.testOpenaiConnection.addEventListener('click', testOpenAIConnection);
                }
                
                // Event listeners pour les APIs françaises
                const testHuggingFaceBtn = document.getElementById('test-huggingface');
                if (testHuggingFaceBtn) {
                    testHuggingFaceBtn.addEventListener('click', testHuggingFaceAPI);
                }
                
                const testMistralBtn = document.getElementById('test-mistral');
                if (testMistralBtn) {
                    testMistralBtn.addEventListener('click', testMistralAPI);
                }
                
                const testGroqBtn = document.getElementById('test-groq');
                if (testGroqBtn) {
                    testGroqBtn.addEventListener('click', testGroqAPI);
                }
                
                // Event listeners pour sauvegarder les configs APIs françaises
                const frenchApiInputs = [
                    'huggingface-token', 'huggingface-model',
                    'mistral-api-key', 'mistral-model',
                    'groq-api-key', 'groq-model'
                ];
                
                frenchApiInputs.forEach(id => {
                    const input = document.getElementById(id);
                    if (input) {
                        input.addEventListener('change', saveFrenchAPIsConfig);
                        input.addEventListener('blur', saveFrenchAPIsConfig);
                    }
                });
                
                // Charger les clés API au démarrage
                loadGeminiApiKey();
                loadFrenchAPIsConfig();  // 🇫🇷 Charger les configs des APIs françaises
                
                // 🎯 NOUVEAUX EVENT LISTENERS POUR LE SÉLECTEUR D'API UNIFIÉ
                
                // Event listeners pour les radio buttons de sélection d'API
                const apiRadios = document.querySelectorAll('input[name="primary-api"]');
                apiRadios.forEach(radio => {
                    radio.addEventListener('change', function() {
                        if (this.checked) {
                            switchPrimaryAPI(this.value);
                        }
                    });
                });
                
                // Event listener pour le bouton de test de l'API sélectionnée
                const testSelectedApiBtn = document.getElementById('test-selected-api');
                if (testSelectedApiBtn) {
                    testSelectedApiBtn.addEventListener('click', testSelectedAPI);
                }
                
                // Charger la sélection d'API au démarrage
                const savedPrimaryAPI = localStorage.getItem('primary-api') || 'auto-fallback';
                const savedRadio = document.getElementById(`select-${savedPrimaryAPI}`);
                if (savedRadio) {
                    savedRadio.checked = true;
                    switchPrimaryAPI(savedPrimaryAPI);
                }
                
                // Mettre à jour le statut des APIs au démarrage
                updateAPIStatus();
                
                // Event listener pour détecter les changements de config et mettre à jour le statut
                const configInputs = [
                    'openai-api-key', 'openai-model',
                    'huggingface-token', 'huggingface-model',
                    'mistral-api-key', 'mistral-model',
                    'groq-api-key', 'groq-model'
                ];
                
                configInputs.forEach(id => {
                    const input = document.getElementById(id);
                    if (input) {
                        input.addEventListener('change', () => {
                            setTimeout(updateAPIStatus, 100); // Délai pour que le localStorage soit mis à jour
                        });
                    }
                });
                
                // Mettre à jour le statut du quota au démarrage
                updateQuotaStatus();
                
                controls.generateMailBtn.addEventListener('click', async () => {
                    const nomCandidat = `${controls.prenom.value} ${controls.nom.value}`.trim();
                    const posteCandidat = controls.poste.value;
                    const dispoCandidat = controls.qualificationDispo.value;
                    const salaireCandidat = controls.qualificationSalaire.value;
                    const profilCandidat = controls.description.value;
                    const nomRecruteur = controls.bannerNom.value || "votre consultant";
                    const posteRecruteur = controls.bannerPoste.value || "cabinet de recrutement";

                    if (!nomCandidat || !posteCandidat) {
                        showNotification("Veuillez renseigner au moins le nom, prénom et poste du candidat.", "error");
                        return;
                    }

                    const prompt = `En tant que consultant en recrutement pour un cabinet, rédige un e-mail de vente percutant destiné à un client pour lui présenter un excellent candidat.
                    
                    **Ton Persona:** Tu es ${nomRecruteur}, ${posteRecruteur}. Tu es proactif, professionnel et tu connais bien ton marché.
                    **Objectif:** Convaincre le client de l'adéquation du profil avec ses besoins potentiels et l'inciter à en savoir plus.
                    
                    **Informations sur le candidat à intégrer:**
                    - Nom du candidat: ${nomCandidat}
                    - Poste ciblé: ${posteCandidat}
                    - Disponibilité: ${dispoCandidat || 'à discuter'}
                    - Prétentions salariales: ${salaireCandidat || 'à discuter'}
                    - Résumé du profil: "${profilCandidat}"

                    **Structure de l'e-mail:**
                    1.  **Objet accrocheur:** Ex: "Profil - [Poste du candidat]" ou "Opportunité: Un [Poste du candidat] pour vos équipes".
                    2.  **Introduction:** Commence par une formule de politesse professionnelle (ex: "Bonjour,"). Mentionne que tu le contactes pour lui présenter un profil qui pourrait l'intéresser.
                    3.  **Présentation du profil:** Met en avant les points forts du candidat en te basant sur son résumé. Sois concis et impactant. Mentionne le poste, et éventuellement une ou deux compétences clés si elles sont évidentes.
                    4.  **Informations pratiques:** Indique sa disponibilité et ses prétentions salariales de manière professionnelle.
                    5.  **Call to action:** Propose d'envoyer le CV complet et/ou de planifier un bref appel pour discuter plus en détail du profil.
                    6.  **Conclusion:** Termine par une formule de politesse et ta signature (${nomRecruteur}).

                    **Important:** Ne retourne QUE le texte de l'e-mail (objet inclus, sous la forme "Objet: ..."), sans aucune phrase d'introduction ou de conclusion de ta part. Le ton doit être celui d'un partenaire commercial, pas celui du candidat.`;

                    try {
                        const mailContent = await callAIWithPriority(prompt);
                        if (mailContent) {
                            controls.recruiterMailContent.value = mailContent;
                            showNotification("E-mail de présentation client généré.", "success");
                        }
                    } catch (error) {
                        console.error("❌ Erreur lors de la génération de l'e-mail:", error);
                        if (error.message.includes('QUOTA_EXCEEDED') || error.message.includes('429')) {
                            showNotification("⚠️ Quota dépassé. Configurez OpenAI dans l'onglet API pour continuer.", "warning");
                        } else {
                            showNotification(`❌ Erreur: ${error.message}`, "error");
                        }
                    }
                });

                // Function to generate PDF with selectable text using jsPDF - Single Page Version
                function generateSelectablePDF() {
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF();
                    
                    const margin = 15;
                    const pageWidth = pdf.internal.pageSize.getWidth();
                    const pageHeight = pdf.internal.pageSize.getHeight();
                    const contentWidth = pageWidth - (margin * 2);
                    const maxContentHeight = pageHeight - (margin * 2);
                    
                    // Collect all content first to calculate total height needed
                    const contentSections = [];
                    
                    // Helper function to prepare content sections
                    function addContentSection(text, fontSize, isBold = false, color = [0, 0, 0], spacing = 5) {
                        if (!text || !text.trim()) return;
                        
                        contentSections.push({
                            text: text.trim(),
                            fontSize,
                            isBold,
                            color,
                            spacing
                        });
                    }
                    
                    // Collect all content with safety checks
                    const nom = (controls.prenom?.value || '') + ' ' + (controls.nom?.value || '');
                    const poste = controls.poste?.value || '';
                    
                    // Header
                    if (nom.trim()) addContentSection(nom.trim(), 18, true, [0, 0, 139], 3);
                    if (poste.trim()) addContentSection(poste, 12, false, [100, 100, 100], 8);
                    
                    // Contact info
                    let contactInfo = [];
                    if (controls.bannerEmail?.value) contactInfo.push(controls.bannerEmail.value);
                    if (controls.bannerTel?.value) contactInfo.push(controls.bannerTel.value);
                    if (contactInfo.length > 0) {
                        addContentSection(contactInfo.join(' | '), 9, false, [100, 100, 100], 8);
                    }
                    
                    // Profile/Description
                    if (controls.description?.value) {
                        addContentSection('PROFIL', 12, true, [0, 0, 0], 3);
                        addContentSection(controls.description.value, 9, false, [0, 0, 0], 8);
                    }
                    
                    // Experiences
                    const experiences = document.querySelectorAll('#cv-experience-preview .experience-item');
                    if (experiences.length > 0) {
                        addContentSection('EXPÉRIENCE PROFESSIONNELLE', 12, true, [0, 0, 0], 3);
                        experiences.forEach((exp, index) => {
                            const periode = exp.querySelector('.experience-period')?.textContent || '';
                            const posteExp = exp.querySelector('.experience-poste')?.textContent || '';
                            const entreprise = exp.querySelector('.experience-entreprise')?.textContent || '';
                            const description = exp.querySelector('.experience-description')?.textContent || '';
                            
                            if (periode) addContentSection(periode, 8, false, [100, 100, 100], 2);
                            if (posteExp) addContentSection(posteExp, 10, true, [0, 0, 0], 1);
                            if (entreprise) addContentSection(entreprise, 9, false, [0, 0, 139], 1);
                            if (description) addContentSection(description, 8, false, [0, 0, 0], index < experiences.length - 1 ? 5 : 3);
                        });
                    }
                    
                    // Formation
                    const formations = document.querySelectorAll('#cv-formation-preview .formation-item');
                    if (formations.length > 0) {
                        addContentSection('FORMATION', 12, true, [0, 0, 0], 3);
                        formations.forEach((form, index) => {
                            const periode = form.querySelector('.formation-period')?.textContent || '';
                            const diplome = form.querySelector('.formation-diplome')?.textContent || '';
                            const etablissement = form.querySelector('.formation-etablissement')?.textContent || '';
                            
                            if (periode) addContentSection(periode, 8, false, [100, 100, 100], 2);
                            if (diplome) addContentSection(diplome, 10, true, [0, 0, 0], 1);
                            if (etablissement) addContentSection(etablissement, 9, false, [0, 0, 139], index < formations.length - 1 ? 4 : 3);
                        });
                    }
                    
                    // Competences
                    const competences = document.querySelector('#cv-competences-preview')?.textContent;
                    if (competences && competences.trim()) {
                        addContentSection('COMPÉTENCES', 12, true, [0, 0, 0], 3);
                        addContentSection(competences.trim(), 9, false, [0, 0, 0], 3);
                    }
                    
                    // Custom sections
                    const customSections = document.querySelectorAll('.custom-section-preview');
                    customSections.forEach((section, index) => {
                        const title = section.querySelector('.section-title')?.textContent || '';
                        const content = section.querySelector('.section-content')?.textContent || '';
                        
                        if (title) addContentSection(title.toUpperCase(), 12, true, [0, 0, 0], 3);
                        if (content) addContentSection(content, 9, false, [0, 0, 0], index < customSections.length - 1 ? 8 : 3);
                    });
                    
                    // Calculate total height needed and scale factor
                    let totalHeight = 0;
                    contentSections.forEach(section => {
                        const tempPdf = new jsPDF(); // Temporary PDF for calculations
                        tempPdf.setFontSize(section.fontSize);
                        const lines = tempPdf.splitTextToSize(section.text, contentWidth);
                        totalHeight += lines.length * section.fontSize * 0.4 + section.spacing;
                    });
                    
                    // Calculate scale factor to fit everything on one page
                    const scaleFactor = totalHeight > maxContentHeight ? maxContentHeight / totalHeight : 1;
                    
                    // Apply content with scaling
                    let yPosition = margin;
                    
                    contentSections.forEach(section => {
                        const adjustedFontSize = Math.max(6, section.fontSize * scaleFactor); // Minimum font size of 6
                        const adjustedSpacing = section.spacing * scaleFactor;
                        
                        pdf.setFontSize(adjustedFontSize);
                        pdf.setFont("helvetica", section.isBold ? "bold" : "normal");
                        pdf.setTextColor(...section.color);
                        
                        const lines = pdf.splitTextToSize(section.text, contentWidth);
                        pdf.text(lines, margin, yPosition);
                        yPosition += lines.length * adjustedFontSize * 0.4 + adjustedSpacing;
                    });
                    
                    // Ensure we only have one page by deleting any additional pages
                    const totalPages = pdf.getNumberOfPages();
                    for (let i = totalPages; i > 1; i--) {
                        pdf.deletePage(i);
                    }
                    
                    // Save the PDF
                    const prenomValue = controls.prenom?.value || 'Prenom';
                    const nomValue = controls.nom?.value || 'Nom';
                    const filename = `CV_${prenomValue}_${nomValue}.pdf`.replace(/ /g, '_');
                    pdf.save(filename);
                }

                controls.downloadPdfBtn.addEventListener('click', async () => {
                    // Use the new selectable text PDF generator
                    generateSelectablePDF();
                    showNotification("PDF avec texte sélectionnable généré !", "success");
                });

                controls.resetCvBtn.addEventListener('click', async () => {
                    const confirmed = await showConfirmModal("Nouveau CV", "Êtes-vous sûr de vouloir réinitialiser complètement le CV ?");
                    if (confirmed) resetCVToDefault();
                });
                
                controls.togglePresentationModeBtn.addEventListener('click', () => {
                    document.body.classList.toggle('presentation-mode');
                    const isActive = document.body.classList.contains('presentation-mode');
                    controls.togglePresentationModeBtn.innerHTML = `<i class="fa-solid ${isActive ? 'fa-eye-slash' : 'fa-eye'}"></i> ${isActive ? 'Quitter Présentation' : 'Mode Présentation'}`;
                });
                
                controls.toggleOverflowBtn.addEventListener('click', (e) => {
                    document.body.classList.toggle('overflow-check-active');
                    e.currentTarget.classList.toggle('active');
                    checkAllPagesOverflow();
                });

                // Collapse all details/expand functionality
                controls.collapseAllBtn.addEventListener('click', () => {
                    // Sélectionner tous les détails dans tous les onglets, même cachés
                    const allDetails = document.querySelectorAll('details.control-group');
                    const collapseIcon = document.getElementById('collapse-icon');
                    const collapseText = document.getElementById('collapse-text');
                    
                    console.log(`🔍 Trouvé ${allDetails.length} éléments details.control-group`);
                    
                    // Log each detail found
                    allDetails.forEach((detail, index) => {
                        const panel = detail.closest('.tab-panel');
                        const panelId = panel ? panel.id : 'no-panel';
                        const isHidden = panel ? panel.classList.contains('hidden') : false;
                        console.log(`  ${index + 1}. Panel: ${panelId}, Hidden: ${isHidden}, Open: ${detail.open}`);
                    });
                    
                    // Check current state - only consider visible details for state detection
                    const visibleDetails = Array.from(allDetails).filter(detail => {
                        const panel = detail.closest('.tab-panel');
                        return !panel || !panel.classList.contains('hidden');
                    });
                    
                    console.log(`👁️ Détails visibles: ${visibleDetails.length}`);
                    const hasOpenDetails = visibleDetails.some(detail => detail.open);
                    console.log(`📂 A des détails ouverts: ${hasOpenDetails}`);
                    
                    if (hasOpenDetails) {
                        // Collapse all (including hidden ones)
                        console.log('🔽 Fermeture de tous les volets...');
                        allDetails.forEach(detail => {
                            detail.open = false;
                        });
                        collapseIcon.className = 'fa-solid fa-expand';
                        collapseText.textContent = 'Déplier tous les volets';
                        controls.collapseAllBtn.classList.remove('bg-gray-100', 'hover:bg-gray-200');
                        controls.collapseAllBtn.classList.add('bg-blue-100', 'hover:bg-blue-200', 'text-blue-700');
                        console.log('✅ Tous les volets repliés');
                    } else {
                        // Expand all (including hidden ones)
                        console.log('🔼 Ouverture de tous les volets...');
                        allDetails.forEach(detail => {
                            detail.open = true;
                        });
                        collapseIcon.className = 'fa-solid fa-compress';
                        collapseText.textContent = 'Replier tous les volets';
                        controls.collapseAllBtn.classList.remove('bg-blue-100', 'hover:bg-blue-200', 'text-blue-700');
                        controls.collapseAllBtn.classList.add('bg-gray-100', 'hover:bg-gray-200');
                        console.log('✅ Tous les volets dépliés');
                    }
                });

                // Gestionnaires d'événements avec vérification d'existence
                if (controls.aiSummarizeBtn) {
                    controls.aiSummarizeBtn.addEventListener('click', summarizeAllExperiencesAI);
                }
                if (controls.aiSynthesizeSkillsBtn) {
                    controls.aiSynthesizeSkillsBtn.addEventListener('click', synthesizeSkillsWithAI);
                }
                if (controls.aiLimitSkillsBtn) {
                    controls.aiLimitSkillsBtn.addEventListener('click', limitSkillsWithAI);
                }
                if (controls.anonymizeBtn) {
                    controls.anonymizeBtn.addEventListener('click', anonymizeCV);
                }
                if (controls.resetRecruiterBtn) {
                    controls.resetRecruiterBtn.addEventListener('click', () => { setDefaultRecruiterInfo(); updatePreview('form'); });
                }
                if (controls.addPageBtn) {
                    controls.addPageBtn.addEventListener('click', () => addNewPage());
                }
                if (controls.removeBannerBgBtn) {
                    controls.removeBannerBgBtn.addEventListener('click', () => removeBannerBackground());
                }
                if (controls.addSectionBtn && controls.newSectionTitleInput) {
                    controls.addSectionBtn.addEventListener('click', () => {
                        const title = controls.newSectionTitleInput.value.trim();
                        if(title) {
                            addCustomSection(title);
                            controls.newSectionTitleInput.value = '';
                        } else {
                            showNotification("Veuillez entrer un titre pour la nouvelle section.", "error");
                        }
                    });
                }
                if (controls.sectionSuggestionSelect && controls.newSectionTitleInput) {
                    controls.sectionSuggestionSelect.addEventListener('change', (e) => {
                        if(e.target.value) controls.newSectionTitleInput.value = e.target.value;
                    });
                }
                if (controls.fixBannerTopBtn) {
                    controls.fixBannerTopBtn.addEventListener('click', () => moveBannerTo('top'));
                }
                if (controls.fixBannerBottomBtn) {
                    controls.fixBannerBottomBtn.addEventListener('click', () => moveBannerTo('bottom'));
                }
                if (controls.modularBannerBtn) {
                    controls.modularBannerBtn.addEventListener('click', () => moveBannerTo('modular'));
                }
                if (controls.addSkillLevelBtn) {
                    controls.addSkillLevelBtn.addEventListener('click', () => createSkillLevelItem());
                }

                document.querySelectorAll('.a4-page').forEach(setupOverflowObserver);
                
                // === INITIALISATION API ===
                initializeApiTab();
            }
            
            // Fonction d'initialisation complète de l'onglet API
            function initializeApiTab() {
                // Charger la clé API sauvegardée
                loadGeminiApiKey();
                
                // Charger la configuration OpenAI
                loadOpenAIConfig();
                
                // Afficher un message d'information si aucune clé n'est configurée
                const savedKey = localStorage.getItem('gemini-api-key');
                if (!savedKey) {
                    updateApiStatus('error', 'Aucune clé API configurée. Veuillez saisir votre clé Gemini.');
                } else {
                    updateApiStatus('loaded', 'Clé API chargée depuis le stockage local');
                }
                
                // Initialiser les valeurs des curseurs
                if (controls.aiTemperature && controls.temperatureValue) {
                    controls.temperatureValue.textContent = controls.aiTemperature.value;
                }
                if (controls.aiMaxTokens && controls.maxTokensValue) {
                    controls.maxTokensValue.textContent = controls.aiMaxTokens.value;
                }
                
                // Masquer les résultats de test au démarrage
                if (controls.testResults) {
                    controls.testResults.classList.add('hidden');
                }
                
                // Message d'accueil dans l'onglet API
                console.log('🤖 Onglet API Gemini initialisé avec succès');
                console.log('📋 Fonctionnalités disponibles:');
                console.log('   - Gestion des clés API avec sauvegarde locale');
                console.log('   - Test de connexion et validation');
                console.log('   - Configuration avancée (modèle, température, tokens)');
                console.log('   - Interface de test personnalisé');
                console.log('   - Intégration complète avec toutes les fonctions IA');
            }

            // ==============================================
            // AI GENERATORS EVENT LISTENERS
            // ==============================================

            // AI Layout Generators
            const aiLayoutProfessional = document.getElementById('ai-layout-professional');
            if (aiLayoutProfessional) {
                aiLayoutProfessional.addEventListener('click', () => {
                    const professionalLayout = {
                        columns: 2,
                        columnGap: 2.0,
                        sectionSpacing: 1.5,
                        marginTop: 2.0,
                        marginBottom: 2.0,
                        marginLeft: 2.0,
                        marginRight: 2.0,
                        fontSizeH1: 28,
                        fontSizeH2: 18,
                        fontSizeP: 10,
                        lineHeight: 1.4
                    };
                    applyLayoutSettings(professionalLayout);
                    showToast("Layout professionnel appliqué par IA 🤖", "success");
                });
            }

            const aiLayoutCreative = document.getElementById('ai-layout-creative');
            if (aiLayoutCreative) {
                aiLayoutCreative.addEventListener('click', () => {
                    const creativeLayout = {
                        columns: 1,
                        columnGap: 3.0,
                        sectionSpacing: 2.0,
                        marginTop: 1.5,
                        marginBottom: 1.5,
                        marginLeft: 2.5,
                        marginRight: 2.5,
                        fontSizeH1: 36,
                        fontSizeH2: 22,
                        fontSizeP: 11,
                        lineHeight: 1.6
                    };
                    applyLayoutSettings(creativeLayout);
                    showToast("Layout créatif appliqué par IA 🎨", "success");
                });
            }

            const aiLayoutModern = document.getElementById('ai-layout-modern');
            if (aiLayoutModern) {
                aiLayoutModern.addEventListener('click', () => {
                    const modernLayout = {
                        columns: 3,
                        columnGap: 1.5,
                        sectionSpacing: 1.8,
                        marginTop: 1.0,
                        marginBottom: 1.0,
                        marginLeft: 1.5,
                        marginRight: 1.5,
                        fontSizeH1: 24,
                        fontSizeH2: 16,
                        fontSizeP: 9,
                        lineHeight: 1.2
                    };
                    applyLayoutSettings(modernLayout);
                    showToast("Layout moderne appliqué par IA 🚀", "success");
                });
            }

            const aiLayoutRandom = document.getElementById('ai-layout-random');
            if (aiLayoutRandom) {
                aiLayoutRandom.addEventListener('click', async () => {
                    const fallbackFunction = () => {
                        // Fallback: layout aléatoire sans IA
                        const randomLayout = {
                            columns: Math.floor(Math.random() * 3) + 1, // 1-3 colonnes
                            columnGap: (Math.random() * 3 + 1).toFixed(1), // 1.0-4.0 rem
                            sectionSpacing: (Math.random() * 2 + 1).toFixed(1), // 1.0-3.0 rem
                            marginTop: (Math.random() * 3 + 1).toFixed(1), // 1.0-4.0 cm
                            marginBottom: (Math.random() * 3 + 1).toFixed(1),
                            marginLeft: (Math.random() * 3 + 1).toFixed(1),
                            marginRight: (Math.random() * 3 + 1).toFixed(1),
                            fontSizeH1: Math.floor(Math.random() * 20) + 20, // 20-40pt
                            fontSizeH2: Math.floor(Math.random() * 12) + 14, // 14-26pt
                            fontSizeP: Math.floor(Math.random() * 4) + 8, // 8-12pt
                            lineHeight: (Math.random() * 1 + 1.2).toFixed(1) // 1.2-2.2
                        };
                        applyLayoutSettings(randomLayout);
                        return "Layout aléatoire appliqué (mode fallback)";
                    };

                    try {
                        const prompt = `Génère un layout de CV unique et créatif avec ces paramètres:
                        - Nombre de colonnes (1-4)
                        - Espacement entre colonnes (10-50px)
                        - Espacement entre sections (15-40px) 
                        - Marges (10-40px)
                        - Taille de police (small/medium/large/xlarge)
                        - Hauteur de ligne (tight/normal/relaxed/loose)
                        - Alignement (left/center/right/justify)
                        - Indentation (0-20px)
                        
                        Réponds uniquement avec un objet JSON valide.`;
                        
                        const response = await callAIWithFallback(prompt, fallbackFunction);
                        if (typeof response === 'string' && response.includes('fallback')) {
                            showToast(response, "success");
                        } else {
                            const layout = JSON.parse(response);
                            applyLayoutSettings(layout);
                            showToast("Layout aléatoire généré par IA ✨", "success");
                        }
                    } catch (error) {
                        console.error('Erreur génération layout IA:', error);
                        fallbackFunction();
                        showToast("Layout aléatoire appliqué (fallback) ✨", "success");
                    }
                });
            }

            // AI Style Generators
            const aiStyleProfessional = document.getElementById('ai-style-professional');
            if (aiStyleProfessional) {
                aiStyleProfessional.addEventListener('click', () => {
                    const professionalStyle = {
                        primaryColor: '#1e40af',
                        secondaryColor: '#374151',
                        accentColor: '#3b82f6',
                        neutralColor: '#6b7280',
                        backgroundColor: '#ffffff',
                        textColor: '#1f2937',
                        fontH1: 'Merriweather',
                        fontH2: 'Source Sans Pro',
                        fontH3: 'Source Sans Pro',
                        fontBody: 'Source Sans Pro',
                        fontAccent: 'Merriweather',
                        titleStyle: 'style-underline',
                        effects: { shadows: true, gradients: false, borders: true, rounded: false }
                    };
                    applyStyleSettings(professionalStyle);
                    showToast("Style professionnel appliqué par IA 💼", "success");
                });
            }

            const aiStyleCreative = document.getElementById('ai-style-creative');
            if (aiStyleCreative) {
                aiStyleCreative.addEventListener('click', () => {
                    const creativeStyle = {
                        primaryColor: '#8b5cf6',
                        secondaryColor: '#ec4899',
                        accentColor: '#f59e0b',
                        neutralColor: '#6b7280',
                        backgroundColor: '#fefbff',
                        textColor: '#1e293b',
                        fontH1: 'Playfair Display',
                        fontH2: 'Nunito',
                        fontH3: 'Nunito',
                        fontBody: 'Nunito',
                        fontAccent: 'Dancing Script',
                        titleStyle: 'style-gradient',
                        effects: { shadows: true, gradients: true, borders: false, rounded: true }
                    };
                    applyStyleSettings(creativeStyle);
                    showToast("Style créatif appliqué par IA 🎨", "success");
                });
            }

            const aiStyleMinimalist = document.getElementById('ai-style-minimalist');
            if (aiStyleMinimalist) {
                aiStyleMinimalist.addEventListener('click', () => {
                    const minimalistStyle = {
                        primaryColor: '#374151',
                        secondaryColor: '#6b7280',
                        accentColor: '#9ca3af',
                        neutralColor: '#d1d5db',
                        backgroundColor: '#ffffff',
                        textColor: '#111827',
                        fontH1: 'Inter',
                        fontH2: 'Inter',
                        fontH3: 'Inter',
                        fontBody: 'Inter',
                        fontAccent: 'Inter',
                        titleStyle: 'style-side-line',
                        effects: { shadows: false, gradients: false, borders: false, rounded: false }
                    };
                    applyStyleSettings(minimalistStyle);
                    showToast("Style minimaliste appliqué par IA ⚪", "success");
                });
            }

            const aiStyleLuxury = document.getElementById('ai-style-luxury');
            if (aiStyleLuxury) {
                aiStyleLuxury.addEventListener('click', () => {
                    const luxuryStyle = {
                        primaryColor: '#d97706',
                        secondaryColor: '#92400e',
                        accentColor: '#fbbf24',
                        neutralColor: '#78716c',
                        backgroundColor: '#fffbeb',
                        textColor: '#1c1917',
                        fontH1: 'Cormorant Garamond',
                        fontH2: 'Lora',
                        fontH3: 'Lora',
                        fontBody: 'Crimson Text',
                        fontAccent: 'Italianno',
                        titleStyle: 'style-3d',
                        effects: { shadows: true, gradients: true, borders: true, rounded: false }
                    };
                    applyStyleSettings(luxuryStyle);
                    showToast("Style luxe appliqué par IA 👑", "success");
                });
            }

            const aiStyleRandom = document.getElementById('ai-style-random');
            if (aiStyleRandom) {
                aiStyleRandom.addEventListener('click', async () => {
                    const fallbackFunction = () => {
                        // Fallback: style aléatoire sans IA
                        const colors = ['#ef4444', '#f97316', '#eab308', '#22c55e', '#06b6d4', '#3b82f6', '#8b5cf6', '#ec4899', '#f43f5e', '#10b981', '#f59e0b', '#84cc16'];
                        const randomStyle = {
                            primaryColor: colors[Math.floor(Math.random() * colors.length)],
                            secondaryColor: colors[Math.floor(Math.random() * colors.length)],
                            accentColor: colors[Math.floor(Math.random() * colors.length)],
                            neutralColor: '#6b7280',
                            backgroundColor: '#ffffff',
                            textColor: '#1f2937',
                            fontH1: fonts[Math.floor(Math.random() * fonts.length)].name,
                            fontH2: fonts[Math.floor(Math.random() * fonts.length)].name,
                            fontH3: fonts[Math.floor(Math.random() * fonts.length)].name,
                            fontBody: fonts[Math.floor(Math.random() * fonts.length)].name,
                            fontAccent: fonts[Math.floor(Math.random() * fonts.length)].name,
                            titleStyle: ['style-underline', 'style-side-line', 'style-background', 'style-boxed', 'style-gradient', 'style-shadow', 'style-3d', 'style-neon'][Math.floor(Math.random() * 8)],
                            effects: {
                                shadows: Math.random() > 0.5,
                                gradients: Math.random() > 0.5,
                                borders: Math.random() > 0.5,
                                rounded: Math.random() > 0.5
                            }
                        };
                        applyStyleSettings(randomStyle);
                        return "Style surprise appliqué (mode fallback)";
                    };

                    try {
                        const fontList = fonts.map(f => f.name).join(', ');
                        const prompt = `Génère un style de CV unique et harmonieux avec:
                        - Palette de couleurs cohérente (6 couleurs en hex: primaryColor, secondaryColor, accentColor, neutralColor, backgroundColor, textColor)
                        - Combinaison de polices professionnelles (fontH1, fontH2, fontH3, fontBody, fontAccent parmi: ${fontList})
                        - Style de titre (titleStyle: style-underline/style-side-line/style-background/style-boxed/style-gradient/style-shadow/style-3d/style-neon)
                        - Effets visuels (effects: {shadows: boolean, gradients: boolean, borders: boolean, rounded: boolean})
                        
                        Réponds avec un objet JSON valide uniquement.`;
                        
                        const response = await callAIWithFallback(prompt, fallbackFunction);
                        if (typeof response === 'string' && response.includes('fallback')) {
                            showToast(response, "success");
                        } else {
                            const style = JSON.parse(response);
                            applyStyleSettings(style);
                            showToast("Style surprise généré par IA ✨", "success");
                        }
                    } catch (error) {
                        console.error('Erreur génération style IA:', error);
                        fallbackFunction();
                        showToast("Style surprise appliqué (fallback) ✨", "success");
                    }
                });
            }

            // Additional Style Controls Event Listeners
            const paletteButtons = document.querySelectorAll('.palette-btn');
            paletteButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    const palette = btn.dataset.palette;
                    applyPredefinedPalette(palette);
                });
            });

            // Pattern controls
            const patternButtons = document.querySelectorAll('.pattern-btn');
            patternButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    const pattern = btn.dataset.pattern;
                    applyBackgroundPattern(pattern);
                });
            });

            // Additional AI color generators
            const aiHarmoniousColors = document.getElementById('ai-harmonious-colors');
            if (aiHarmoniousColors) {
                aiHarmoniousColors.addEventListener('click', generateHarmoniousColors);
            }

            const aiContrastColors = document.getElementById('ai-contrast-colors');
            if (aiContrastColors) {
                aiContrastColors.addEventListener('click', generateContrastColors);
            }

            const randomPalette = document.getElementById('random-palette');
            if (randomPalette) {
                randomPalette.addEventListener('click', generateRandomPalette);
            }

            // Font pairing AI
            const aiFontPairing = document.getElementById('ai-font-pairing');
            if (aiFontPairing) {
                aiFontPairing.addEventListener('click', generateAIFontPairing);
            }

            // Quota status checker
            const checkQuotaBtn = document.getElementById('check-quota-status');
            if (checkQuotaBtn) {
                checkQuotaBtn.addEventListener('click', checkQuotaStatus);
            }

            // ==============================================
            // ZOOM ET REDIMENSIONNEMENT
            // ==============================================
            
            // Variables pour le zoom
            let currentZoom = 100;
            const zoomLevels = [50, 75, 100, 125, 150, 200];
            
            // Contrôles de zoom
            const zoomInBtn = document.getElementById('zoom-in');
            const zoomOutBtn = document.getElementById('zoom-out');
            const zoomResetBtn = document.getElementById('zoom-reset');
            const zoomLevelDisplay = document.getElementById('zoom-level');
            const cvPreviewWrapper = document.getElementById('cv-preview-wrapper');
            
            function updateZoom(newZoom) {
                currentZoom = Math.max(50, Math.min(200, newZoom));
                zoomLevelDisplay.textContent = currentZoom + '%';
                
                // Enlever toutes les classes de zoom
                cvPreviewWrapper.className = cvPreviewWrapper.className.replace(/zoom-\d+/g, '');
                // Ajouter la nouvelle classe de zoom
                cvPreviewWrapper.classList.add(`zoom-${currentZoom}`);
                
                console.log(`🔍 Zoom: ${currentZoom}%`);
            }
            
            if (zoomInBtn) {
                zoomInBtn.addEventListener('click', () => {
                    const currentIndex = zoomLevels.indexOf(currentZoom);
                    if (currentIndex < zoomLevels.length - 1) {
                        updateZoom(zoomLevels[currentIndex + 1]);
                    }
                });
            }
            
            if (zoomOutBtn) {
                zoomOutBtn.addEventListener('click', () => {
                    const currentIndex = zoomLevels.indexOf(currentZoom);
                    if (currentIndex > 0) {
                        updateZoom(zoomLevels[currentIndex - 1]);
                    }
                });
            }
            
            if (zoomResetBtn) {
                zoomResetBtn.addEventListener('click', () => {
                    updateZoom(100);
                });
            }
            
            // Redimensionnement du panneau de contrôles
            const controlsPanel = document.getElementById('controls');
            const resizeHandle = document.getElementById('resize-handle');
            let isResizing = false;
            
            if (resizeHandle) {
                resizeHandle.addEventListener('mousedown', (e) => {
                    isResizing = true;
                    document.body.style.cursor = 'ew-resize';
                    e.preventDefault();
                });
                
                document.addEventListener('mousemove', (e) => {
                    if (!isResizing) return;
                    
                    const newWidth = e.clientX;
                    if (newWidth >= 300 && newWidth <= 800) {
                        controlsPanel.style.width = newWidth + 'px';
                        console.log(`📐 Largeur panneau: ${newWidth}px`);
                    }
                });
                
                document.addEventListener('mouseup', () => {
                    if (isResizing) {
                        isResizing = false;
                        document.body.style.cursor = 'default';
                        console.log('✅ Redimensionnement terminé');
                    }
                });
            }

            // ==============================================
            // RESET AUTOMATIQUE DU QUOTA
            // ==============================================
            
            function resetQuotaIfNewDay() {
                const quotaData = JSON.parse(localStorage.getItem('gemini-quota') || '{}');
                const today = new Date().toDateString();
                
                // Si on a changé de jour, reset le quota
                if (quotaData.date && quotaData.date !== today) {
                    console.log("🔄 Nouveau jour détecté, reset du quota");
                    localStorage.setItem('gemini-quota', JSON.stringify({
                        date: today,
                        count: 0,
                        exhausted: false
                    }));
                    
                    // Supprimer aussi l'ancien retry-after
                    localStorage.removeItem('gemini-retry-after');
                    
                    showNotification('🎉 Nouveau jour ! Quota API réinitialisé (0/50)', 'success', 3000);
                    updateQuotaStatus();
                }
            }

            // ==============================================
            // END AI GENERATORS EVENT LISTENERS
            // ==============================================
            
            // --- START THE APP ---
            resetQuotaIfNewDay(); // Vérifier et reset le quota si nouveau jour
            initializeAll();
            
            // S'assurer que tous les éléments de contrôle sont disponibles avant de réinitialiser
            setTimeout(() => {
                resetCVToDefault(); // Start with a clean slate
                
                // S'assurer que la bannière est bien désactivée par défaut
                const bannerCheckbox = document.getElementById('toggle-banner-checkbox');
                if (bannerCheckbox) {
                    bannerCheckbox.checked = false;
                    updatePreview('form'); // Mettre à jour la prévisualisation
                }
            }, 100);
        });

    </script>
</body>
</html>
