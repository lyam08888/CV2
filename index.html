<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cr√©ateur de CV IA - Pro Recruteur</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&family=Montserrat:wght@400;500;700;800&family=Playfair+Display:ital,wght@0,400..900;1,400..900&family=Roboto+Mono:wght@400;700&family=Merriweather:wght@400;700&family=Oswald:wght@400;700&family=Cormorant+Garamond:wght@400;700&family=Open+Sans:wght@400;700&family=Source+Sans+Pro:wght@400;700&family=Nunito+Sans:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    
    <style>
        :root {
            --page-margin: 2cm;
            --primary-color: #2563eb;
            --secondary-color: #334155;
            --body-text-color: #334155;
            --font-family-h1: 'Montserrat', sans-serif;
            --font-family-h2: 'Montserrat', sans-serif;
            --font-family-body: 'Lato', sans-serif;
            --font-size-h1: 40pt;
            --font-size-h2: 21pt;
            --font-size-p: 10pt;
            --font-size-banner: 9pt;
            --line-height: 1.6;
            --paragraph-spacing: 0.5rem;
            --module-spacing: 1.5rem;
            --item-spacing: 0.5rem;
            --banner-element-spacing: 1rem;
        }

        #cv-preview-wrapper { width: 100%; display: flex; flex-direction: column; align-items: center; gap: 20px; }
        .a4-page-container { position: relative; }
        /* CORRECTIF : Remplacement de min-height par height pour une d√©tection de d√©passement fiable */
        .a4-page { width: 21cm; height: 29.7cm; box-shadow: 0 10px 30px rgba(0,0,0,0.15); background-color: white; overflow: hidden; display: flex; flex-direction: column; transition: all 0.3s ease; font-family: var(--font-family-body); color: var(--body-text-color); position: relative; outline: 2px solid transparent; outline-offset: -2px; padding: var(--page-margin); box-sizing: border-box; }
        body.overflow-check-active .is-overflowing { outline: 3px solid #ef4444 !important; box-shadow: 0 0 20px 8px rgba(239, 68, 68, 0.3) !important; }
        
        .remove-page-btn { position: absolute; top: -10px; right: -10px; width: 30px; height: 30px; background-color: #ef4444; color: white; border: none; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; opacity: 0.5; transition: opacity 0.2s, transform 0.2s; z-index: 10; }
        .remove-page-btn:hover { opacity: 1; transform: scale(1.1); }
        .a4-page-container:first-child .remove-page-btn { display: none; }

        #add-page-btn-wrapper { width: 21cm; text-align: center; padding: 10px 0; }
        #add-page-btn { width: 50px; height: 50px; background-color: #3b82f6; color: white; border-radius: 50%; border: none; cursor: pointer; font-size: 24px; transition: transform 0.2s; }
        #add-page-btn:hover { transform: scale(1.1); }

        .cv-body-container { display: grid; gap: 1rem; height: 100%; flex-grow: 1; position: relative; }
        .layout-1-col { grid-template-columns: 1fr; }
        .layout-2-col-33-67 { grid-template-columns: 1fr 2fr; }
        .layout-2-col-50-50 { grid-template-columns: 1fr 1fr; }
        .layout-2-col-67-33 { grid-template-columns: 2fr 1fr; }

        .cv-column { min-height: 150px; height: 100%; border: 1px dotted #ccc; padding: 5px; }
        .cv-module { position: relative; margin-bottom: var(--module-spacing); }
        .cv-module .drag-handle { position: absolute; top: 10px; left: -25px; cursor: grab; color: #d1d5db; opacity: 0; transition: opacity 0.2s; font-size: 1.2rem; }
        .cv-module:hover .drag-handle { opacity: 1; }
        .sortable-ghost { opacity: 0.4; background: #cce7ff; border: 1px dashed var(--primary-color); }

        [contenteditable="true"]:hover { outline: 1px dashed #3b82f6; background-color: #eff6ff; }
        [contenteditable="true"]:focus { outline: 2px solid #3b82f6; background-color: #dbeafe; }

        .cv-header h1 { font-family: var(--font-family-h1); font-weight: 800; font-size: var(--font-size-h1); color: var(--primary-color); margin-bottom: 0.25rem; }
        .cv-header p { font-family: var(--font-family-body); font-size: 1.2rem; color: var(--secondary-color); }
        .section-title { font-family: var(--font-family-h2); font-weight: 700; font-size: var(--font-size-h2); margin-bottom: 0.8rem; padding-bottom: 0.4rem; color: var(--primary-color); display: flex; align-items: center; gap: 0.5rem; transition: opacity 0.3s; }
        .section-title.style-underline { border-bottom: 2px solid var(--primary-color); }
        .section-title.style-side-line { border-left: 4px solid var(--primary-color); border-bottom: none; padding-left: 0.5rem; }
        .section-title.style-background { background-color: var(--primary-color); color: white; padding: 0.3rem 0.6rem; margin-bottom: 1rem; border-radius: 0.25rem; }
        .section-title.style-background .section-icon { color: white !important; }
        .section-title.style-boxed { border: 2px solid var(--primary-color); padding: 0.3rem 0.6rem; }

        .section-title .section-icon { cursor: pointer; transition: transform 0.2s; }
        .section-title .section-icon:hover { transform: scale(1.1); }
        .a4-page p, .a4-page li, #cv-description-preview, #cv-experience-preview, #cv-formation-preview { font-size: var(--font-size-p); line-height: var(--line-height); }
        .a4-page p { margin-bottom: var(--paragraph-spacing); }
        .a4-page ul { list-style: none; padding-left: 0;}
        #cv-competences-preview[data-style="simple"] ul li,
        .a4-page ul li { padding-left: 1.4em; position: relative; margin-bottom: 0.25rem; }
        #cv-competences-preview[data-style="simple"] ul li::before,
        .a4-page ul li::before { content: '‚Ä∫'; font-weight: bold; position: absolute; left: 0; color: var(--primary-color); font-size: 1.2em; top: -0.1em; }
        
        .item-title { font-weight: 700; color: var(--secondary-color); }
        .item-meta { font-size: calc(var(--font-size-p) * 0.9); font-style: italic; }

        #recruiter-banner { display: flex; align-items: center; padding: 0.5rem; box-sizing: border-box; width: 100%; font-size: var(--font-size-banner); position: relative; overflow: hidden; }
        .banner-content-wrapper { position: relative; z-index: 1; display: flex; align-items: center; width: 100%; height: 100%; gap: var(--banner-element-spacing); }
        #banner-bg-img-preview { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: 0; transition: opacity 0.3s, filter 0.3s; }
        #fixed-banner-top { margin-bottom: var(--module-spacing); display: none; }
        #fixed-banner-bottom { margin-top: auto; padding-top: var(--module-spacing); display: none; }
        #banner-img-preview { border-radius: 50%; object-fit: cover; flex-shrink: 0; transition: width 0.3s, height 0.3s; background-color: rgba(255,255,255,0.5); }
        #banner-img-preview.logo-sm { width: 40px; height: 40px; }
        #banner-img-preview.logo-md { width: 60px; height: 60px; }
        #banner-img-preview.logo-lg { width: 80px; height: 80px; }
        #banner-img-preview.logo-xl { width: 100px; height: 100px; }
        #banner-img-preview.logo-xxl { width: 120px; height: 120px; }
        #banner-nom-preview { font-weight: 700; }
        .banner-align-left { justify-content: flex-start; text-align: left; }
        .banner-align-center { justify-content: center; text-align: center; }
        .banner-align-right { justify-content: flex-end; text-align: right; }
        .banner-layout-inverted { flex-direction: row-reverse; }
        .banner-style-elegant { border-top: 2px solid var(--primary-color); border-bottom: 2px solid var(--primary-color); background: transparent; }
        .banner-style-modern { background-color: var(--primary-color); color: white; border-radius: 0.5rem; }
        .banner-style-modern p, .banner-style-modern span { color: white !important; }
        .banner-style-discret { border-left: 4px solid #d1d5db; background: transparent; }
        .banner-style-carte { box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); border-radius: 0.5rem; background: #f9fafb; }
        .banner-style-degrade { background: linear-gradient(to right, var(--primary-color), #a5b4fc); color: white; border-radius: 0.5rem; }
        .banner-style-degrade p, .banner-style-degrade span { color: white !important; }
        .banner-style-premium { background-color: #1e293b; color: #fde68a; border: 1px solid #fde68a; border-radius: 0.25rem; }
        .banner-style-premium p, .banner-style-premium span { color: #f1f5f9 !important; }
        .banner-style-minimal { border-bottom: 2px solid var(--primary-color); }
        .banner-style-encadre { border: 2px solid var(--primary-color); border-radius: 0.5rem; }
        .banner-style-ligne-haute { border-top: 4px solid var(--primary-color); padding-top: 0.8rem !important; }

        #notification { position: fixed; top: 20px; right: 20px; z-index: 10000; }
        .toast { background-color: white; color: #111827; padding: 1rem 1.5rem; border-radius: 0.5rem; box-shadow: 0 5px 15px rgba(0,0,0,0.1); display: flex; align-items: center; gap: 0.75rem; transition: all 0.3s ease; transform: translateX(120%); }
        .toast.show { transform: translateX(0); }

        /* Styles for collapsible control panel sections */
        details.control-group {
            background-color: #f9fafb;
            border: 1px solid #f3f4f6;
            border-radius: 0.5rem;
            transition: background-color 0.2s;
        }
        details.control-group[open] {
            background-color: white;
            border-color: #e5e7eb;
        }
        details.control-group summary {
            list-style: none;
            cursor: pointer;
            padding: 1rem;
            font-weight: 600;
            color: #374151;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        details.control-group summary::-webkit-details-marker {
            display: none;
        }
        details.control-group .control-group-content {
            padding: 0 1rem 1rem 1rem;
            border-top: 1px solid #f3f4f6;
            margin-top: -0.5rem;
            padding-top: 1rem;
        }
        .completion-label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.75rem;
            font-weight: 400;
            color: #6b7280;
            cursor: pointer;
        }
        .completion-checkbox {
            height: 1rem;
            width: 1rem;
            border-radius: 0.25rem;
            border-color: #d1d5db;
            color: #4f46e5;
            cursor: pointer;
        }
        .completion-checkbox:focus {
            outline: 2px solid #4f46e5;
            outline-offset: 2px;
        }
        
        #ai-summarize-btn { position: fixed; bottom: 30px; right: 30px; width: 60px; height: 60px; background-color: #2563eb; color: white; border-radius: 50%; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(0,0,0,0.2); font-size: 24px; z-index: 999; transition: transform 0.2s ease-in-out; }
        #ai-summarize-btn:hover { transform: scale(1.1); }

        /* --- Specific styles for skills section --- */
        #cv-competences-preview h3.skill-category { font-family: var(--font-family-h2); font-weight: 700; color: var(--secondary-color); margin-top: 0.8rem; margin-bottom: 0.4rem; padding-bottom: 0.2rem; border-bottom: 1px solid #e5e7eb; font-size: calc(var(--font-size-p) * 1.05); text-transform: uppercase; letter-spacing: 0.5px; }
        #cv-competences-preview .skill-category:hover { background-color: #f3f4f6; }
        #cv-competences-preview[data-style="tags"] ul { padding-left: 0; list-style: none; margin-top: 0.25rem; margin-bottom: 0.5rem; line-height: 1.5; }
        #cv-competences-preview[data-style="tags"] ul li.skill-item { display: inline-block; margin: 0 8px 6px 0; padding: 3px 20px 3px 10px; border-radius: 12px; background-color: #f3f4f6; font-size: calc(var(--font-size-p) * 0.95); position: relative; cursor: grab; }
        #cv-competences-preview[data-style="tags"] ul li.skill-item:hover { background-color: #e5e7eb; }
        #cv-competences-preview[data-style="tags"] ul li::before { content: none; }
        .skills-ghost { opacity: 0.4; background: #cce7ff; border-radius: 12px; }
        .skill-item .delete-skill-btn { display: none; position: absolute; top: 50%; right: 5px; transform: translateY(-50%); cursor: pointer; font-size: 14px; line-height: 1; color: #9ca3af; padding: 2px; }
        .skill-item:hover .delete-skill-btn { display: inline-block; }
        .skill-item .delete-skill-btn:hover { color: #ef4444; }
        .style-toggle-btn.active, .skill-style-btn.active, .section-title-style-btn.active, .layout-btn.active, .banner-align-btn.active, .logo-size-btn.active, .theme-btn.active, #banner-invert-btn.active, .gauge-style-btn.active, #toggle-overflow-btn.active { background-color: #3b82f6; color: white; }
        .skill-level { display: flex; align-items: center; margin-bottom: 6px; gap: 8px; }
        .skill-level-label { width: 120px; flex-shrink: 0; font-size: var(--font-size-p); }
        
        /* Gauge Styles */
        .gauge-container { flex-grow: 1; }
        .gauge-bar-bg { background-color: #e5e7eb; border-radius: 4px; height: 8px; overflow: hidden;}
        .gauge-bar-fill { background-color: var(--primary-color); height: 100%; border-radius: 4px; transition: width 0.3s ease; }
        .gauge-dots, .gauge-stars, .gauge-squares { display: flex; gap: 4px; font-size: 1.2em; color: #d1d5db; }
        .gauge-dots .filled, .gauge-stars .filled, .gauge-squares .filled { color: var(--primary-color); }
        .gauge-number { font-weight: bold; color: var(--secondary-color); }

        .editable-wrapper { position: relative; }
        .editable-wrapper .delete-line-btn { display: none; position: absolute; top: 50%; right: 2px; transform: translateY(-50%); cursor: pointer; color: #ef4444; background-color: white; border-radius: 50%; width: 18px; height: 18px; text-align: center; line-height: 18px; font-size: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); z-index: 5; }
        .editable-wrapper:hover .delete-line-btn { display: flex; align-items: center; justify-content: center; }
        .history-btn:disabled { opacity: 0.4; cursor: not-allowed; }
        .insert-line-wrapper { position: relative; height: 0.5rem; opacity: 0; transition: opacity 0.2s; margin: 0; display: flex; justify-content: center; align-items: center; }
        .dynamic-item-container:hover .insert-line-wrapper { opacity: 1; }
        .add-line-preview-btn { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: #eef2ff; color: #4f46e5; border: 1px dashed #a5b4fc; width: 24px; height: 24px; border-radius: 50%; cursor: pointer; z-index: 5; display: flex; align-items: center; justify-content: center; font-size: 12px; transition: all 0.2s; }
        .add-line-preview-btn:hover { background: #c7d2fe; border-style: solid; transform: translate(-50%, -50%) scale(1.1); }
        
        .add-desc-line-btn { display: none; font-size: 0.8rem; color: #4f46e5; cursor: pointer; margin-top: 0.25rem; padding: 2px 4px; border-radius: 4px; background: transparent; border: none; }
        .add-desc-line-btn:hover { background-color: #eef2ff; }
        .dynamic-preview-item:hover .add-desc-line-btn { display: inline-block; }

        .dynamic-preview-item { position: relative; border: 1px solid transparent; border-radius: 0.375rem; padding: 0.5rem; margin-bottom: var(--item-spacing); transition: border-color 0.2s, background-color 0.2s, opacity 0.3s; }
        .dynamic-preview-item:hover { background-color: #fafafa; border-color: #e5e7eb; }

        .delete-block-btn { display: none; position: absolute; top: 4px; right: 4px; width: 24px; height: 24px; background-color: #fee2e2; color: #b91c1c; border: none; border-radius: 50%; cursor: pointer; align-items: center; justify-content: center; z-index: 6; }
        .dynamic-preview-item:hover .delete-block-btn { display: flex; }
        .delete-block-btn:hover { background-color: #fecaca; color: #991b1b; }
        .new-badge { background-color: #ef4444; color: white; font-size: 0.6rem; font-weight: bold; padding: 2px 5px; border-radius: 4px; margin-left: 6px; vertical-align: middle; }
        
        /* Modal Styles */
        .modal-overlay { position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.5); display: flex; align-items: center; justify-content: center; z-index: 5000; opacity: 0; transition: opacity 0.2s; pointer-events: none; }
        .modal-overlay.active { opacity: 1; pointer-events: auto; }
        .modal-content { background: white; padding: 2rem; border-radius: 0.5rem; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 90%; max-width: 500px; transform: scale(0.95); transition: transform 0.2s; }
        .modal-overlay.active .modal-content { transform: scale(1); }
        
        /* Icon Picker Modal */
        #icon-picker-modal .modal-content { max-width: 700px; }
        #icon-picker-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(50px, 1fr)); gap: 0.5rem; max-height: 60vh; overflow-y: auto; }
        #icon-picker-grid i { font-size: 1.5rem; padding: 0.75rem; border-radius: 0.25rem; cursor: pointer; text-align: center; transition: background-color 0.2s, color 0.2s; }
        #icon-picker-grid i:hover { background-color: #eef2ff; color: #4f46e5; }
        
        /* In-Preview AI Buttons */
        .section-ai-actions { margin-left: auto; display: flex; gap: 0.5rem; opacity: 0; transition: opacity 0.2s; }
        .cv-module:hover .section-ai-actions { opacity: 1; }
        .ai-action-btn { background: #e0e7ff; color: #4338ca; border: none; border-radius: 50%; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 0.8rem; }
        .ai-action-btn:hover { background: #c7d2fe; }

        /* Styles for hiding sections */
        .cv-module.section-hidden > *:not(h2) {
            display: none;
        }
        .cv-module.section-hidden > h2 {
            opacity: 0.5;
        }

        /* For column resizing */
        .column-resizer {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 10px; /* Wider grab area */
            cursor: col-resize;
            transform: translateX(-50%);
            z-index: 20; /* High z-index */
        }
        .column-resizer::after {
            content: '';
            position: absolute;
            top: 0;
            bottom: 0;
            left: 4px; /* Centered 2px line in a 10px div */
            width: 2px;
            background-color: #d1d5db;
            transition: background-color 0.2s ease;
        }
        .column-resizer:hover::after,
        body.is-resizing .column-resizer::after {
            background-color: #3b82f6;
        }
        body.is-resizing {
            cursor: col-resize;
            user-select: none;
        }

        /* Presentation Mode & Print Styles */
        body.presentation-mode .cv-column {
            border-color: transparent;
        }
        body.presentation-mode .column-resizer,
        body.presentation-mode .drag-handle,
        body.presentation-mode #ai-summarize-btn,
        body.presentation-mode .remove-page-btn,
        body.presentation-mode #add-page-btn-wrapper,
        body.presentation-mode .section-ai-actions,
        body.presentation-mode .delete-block-btn,
        body.presentation-mode .delete-line-btn,
        body.presentation-mode .insert-line-wrapper {
            display: none !important;
        }
        /* NEW: Completely hide the module in presentation mode if hidden */
        body.presentation-mode .cv-module.section-hidden {
            display: none !important;
        }

        @media print {
            body {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            .column-resizer,
            .drag-handle {
                display: none !important;
            }
            .cv-column {
                border-color: transparent !important;
            }
            .no-print {
                display: none !important;
            }
            .cv-module.section-hidden {
                display: none !important;
            }
            .a4-page {
                box-shadow: none !important;
                margin: 0;
                overflow: visible;
                height: auto;
                break-inside: avoid-page;
            }
            #cv-preview-wrapper {
                gap: 0;
            }
        }

    </style>
</head>
<body class="bg-gray-200 font-sans">

    <!-- OVERLAYS AND MODALS -->
    <div id="loader-overlay" class="hidden fixed inset-0 bg-white bg-opacity-75 flex-col items-center justify-center z-[9999]">
        <div class="h-16 w-16 rounded-full border-4 border-gray-200 border-t-blue-600 animate-spin"></div>
        <p id="loader-text" class="mt-4 text-gray-600 font-medium">Chargement...</p>
    </div>

    <div id="notification"></div>

    <div class="flex flex-col lg:flex-row min-h-screen">
        <!-- CONTROLS PANEL -->
        <div id="controls" class="w-full lg:w-1/3 xl:w-1/4 p-6 bg-white shadow-2xl overflow-y-auto flex flex-col no-print">
            <div class="flex justify-between items-center mb-4 flex-shrink-0">
                <div class="flex items-center gap-3"><i class="fas fa-magic-wand-sparkles text-3xl text-blue-600"></i><h1 class="text-2xl font-bold text-gray-800">Cr√©ateur de CV</h1></div>
                <div class="flex items-center gap-2">
                    <!-- Save status removed -->
                    <button id="undo-btn" class="history-btn text-xl text-gray-600 hover:text-gray-900 disabled:text-gray-300" title="Annuler (Ctrl+Z)"><i class="fas fa-undo"></i></button>
                    <button id="redo-btn" class="history-btn text-xl text-gray-600 hover:text-gray-900 disabled:text-gray-300" title="R√©tablir (Ctrl+Y)"><i class="fas fa-redo"></i></button>
                </div>
            </div>
            
            <!-- NEW: Progress Bar -->
            <div class="mb-4 flex-shrink-0">
                <label class="text-sm font-medium text-gray-600">Progression</label>
                <div id="progress-bar-container" class="w-full bg-gray-200 rounded-full h-2.5 mt-1">
                    <div id="progress-bar" class="bg-green-500 h-2.5 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
                <p id="progress-text" class="text-xs text-right text-gray-500 mt-1">0/X sections compl√©t√©es</p>
            </div>


            <!-- TABS -->
            <div id="tab-navigation" class="flex flex-wrap -mb-px border-b border-gray-200">
                <button class="tab-btn -mb-px py-3 px-4 text-sm font-medium border-b-2 whitespace-nowrap" data-target="#panel-ia"><i class="fa-solid fa-robot mr-1"></i> IA</button>
                <button class="tab-btn -mb-px py-3 px-4 text-sm font-medium border-b-2 whitespace-nowrap" data-target="#panel-api"><i class="fa-solid fa-key mr-1"></i> API</button>
                <button class="tab-btn -mb-px py-3 px-4 text-sm font-medium border-b-2 whitespace-nowrap" data-target="#panel-content"><i class="fa-solid fa-file-lines mr-1"></i> Contenu</button>
                <button class="tab-btn -mb-px py-3 px-4 text-sm font-medium border-b-2 whitespace-nowrap" data-target="#panel-layout"><i class="fa-solid fa-columns mr-1"></i> Mise en Page</button>
                <button class="tab-btn -mb-px py-3 px-4 text-sm font-medium border-b-2 whitespace-nowrap" data-target="#panel-styles"><i class="fa-solid fa-palette mr-1"></i> Styles</button>
                <button class="tab-btn -mb-px py-3 px-4 text-sm font-medium border-b-2 whitespace-nowrap" data-target="#panel-recrutement"><i class="fa-solid fa-briefcase mr-1"></i> Recrutement</button>
                <button class="tab-btn -mb-px py-3 px-4 text-sm font-medium border-b-2 whitespace-nowrap" data-target="#panel-settings"><i class="fa-solid fa-cog mr-1"></i> Param√®tres</button>
            </div>

            <!-- COLLAPSE ALL BUTTON -->
            <div class="px-4 py-2 border-b border-gray-100">
                <button id="collapse-all-btn" class="w-full bg-gray-100 hover:bg-gray-200 text-gray-700 py-2 px-3 rounded-md text-sm font-medium flex items-center justify-center gap-2 transition-colors">
                    <i class="fa-solid fa-compress" id="collapse-icon"></i>
                    <span id="collapse-text">Replier tous les volets</span>
                </button>
            </div>

            <div id="tab-content" class="py-4 flex-grow overflow-y-auto">
                <!-- TAB: IA -->
                <div id="panel-ia" class="tab-panel space-y-4">
                    <details class="control-group" open>
                        <summary><span>Analyse IA</span><label class="completion-label"><input type="checkbox" id="completion-ia-analyse" class="completion-checkbox"><span>Fait ‚úÖ</span></label></summary>
                        <div class="control-group-content space-y-2">
                            <textarea id="ai-input" rows="6" class="w-full p-2 border rounded-md" placeholder="Collez ici une description de poste, un CV brut..."></textarea>
                            <button id="analyze-btn" class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 flex items-center justify-center gap-2"><i class="fa-solid fa-wand-magic-sparkles"></i> Analyser & Remplir</button>
                        </div>
                    </details>
                    <details class="control-group" open>
                        <summary><span>Actions IA</span><label class="completion-label"><input type="checkbox" id="completion-ia-actions" class="completion-checkbox"><span>Fait ‚úÖ</span></label></summary>
                        <div class="control-group-content space-y-2">
                            <button id="ai-synthesize-skills-btn" class="w-full bg-teal-600 text-white py-2 px-4 rounded-md hover:bg-teal-700 flex items-center justify-center gap-2"><i class="fas fa-magic-wand-sparkles"></i> Synth√©tiser les comp√©tences</button>
                            <button id="ai-limit-skills-btn" class="w-full bg-orange-600 text-white py-2 px-4 rounded-md hover:bg-orange-700 flex items-center justify-center gap-2"><i class="fas fa-filter"></i> Limiter les comp√©tences</button>
                            <button id="floating-ai-btn" class="w-full bg-gradient-to-r from-indigo-500 to-purple-600 text-white py-2 px-4 rounded-md hover:from-indigo-600 hover:to-purple-700 flex items-center justify-center gap-2"><i class="fas fa-magic-wand-sparkles"></i> Synth√©tise IA</button>
                        </div>
                    </details>
                </div>

                <!-- TAB: API -->
                <div id="panel-api" class="tab-panel hidden space-y-4">
                    <details class="control-group" open>
                        <summary><span>Configuration API Gemini</span><label class="completion-label"><input type="checkbox" id="completion-api-config" class="completion-checkbox"><span>Fait ‚úÖ</span></label></summary>
                        <div class="control-group-content space-y-4">
                            <div class="bg-blue-50 border border-blue-200 rounded-md p-3">
                                <div class="flex items-start gap-2">
                                    <i class="fas fa-info-circle text-blue-600 mt-1"></i>
                                    <div class="text-sm text-blue-800">
                                        <p class="font-medium">Configuration de l'API Gemini</p>
                                        <p>Obtenez votre cl√© API sur <a href="https://makersuite.google.com/app/apikey" target="_blank" class="underline hover:text-blue-900">Google AI Studio</a></p>
                                    </div>
                                </div>
                            </div>
                            
                            <div>
                                <label for="gemini-api-key" class="block text-sm font-medium text-gray-700 mb-2">Cl√© API Gemini</label>
                                <div class="flex gap-2">
                                    <input type="password" id="gemini-api-key" placeholder="AIza..." class="flex-1 p-2 border rounded-md text-sm font-mono" />
                                    <button id="toggle-api-key-visibility" class="bg-gray-500 text-white px-3 py-2 rounded-md hover:bg-gray-600 text-sm">
                                        <i class="fa-solid fa-eye"></i>
                                    </button>
                                    <button id="save-gemini-api-key" class="bg-green-600 text-white px-3 py-2 rounded-md hover:bg-green-700 text-sm">
                                        <i class="fa-solid fa-save"></i>
                                    </button>
                                </div>
                                <p class="text-xs text-gray-500 mt-1">La cl√© sera sauvegard√©e de mani√®re s√©curis√©e dans votre navigateur</p>
                            </div>
                            
                            <div id="api-status" class="hidden p-3 rounded-md">
                                <div class="flex items-center gap-2">
                                    <i id="api-status-icon" class=""></i>
                                    <span id="api-status-text" class="text-sm font-medium"></span>
                                </div>
                            </div>

                            <!-- Indicateur de Quota -->
                            <div class="bg-gray-50 p-3 rounded-md border">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-sm font-medium text-gray-700">Statut Quota API:</span>
                                    <span id="quota-status" class="text-xs px-2 py-1 rounded-full bg-green-100 text-green-700">Disponible</span>
                                </div>
                                <div id="quota-details" class="text-xs text-gray-500 hidden">
                                    <div>Limite: 50 requ√™tes/jour (gratuit)</div>
                                    <div id="quota-reset-info" class="mt-1 hidden">
                                        R√©initialisation: <span id="quota-reset-time"></span>
                                    </div>
                                </div>
                                <button id="check-quota-status" class="mt-2 text-xs bg-purple-100 text-purple-700 px-2 py-1 rounded hover:bg-purple-200">
                                    <i class="fas fa-chart-line"></i> V√©rifier Quota
                                </button>
                            </div>
                        </div>
                    </details>
                    
                    <details class="control-group" open>
                        <summary><span>Test & Validation</span><label class="completion-label"><input type="checkbox" id="completion-api-test" class="completion-checkbox"><span>Fait ‚úÖ</span></label></summary>
                        <div class="control-group-content space-y-3">
                            <button id="test-gemini-api" class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 flex items-center justify-center gap-2">
                                <i class="fa-solid fa-flask"></i> Tester la connexion API
                            </button>
                            
                            <div>
                                <label for="test-prompt" class="block text-sm font-medium text-gray-700 mb-2">Test personnalis√© (optionnel)</label>
                                <textarea id="test-prompt" rows="3" class="w-full p-2 border rounded-md text-sm" placeholder="√âcrivez un test personnalis√© pour v√©rifier l'API..."></textarea>
                                <button id="run-custom-test" class="mt-2 w-full bg-purple-600 text-white py-2 px-4 rounded-md hover:bg-purple-700 flex items-center justify-center gap-2">
                                    <i class="fa-solid fa-play"></i> Ex√©cuter le test
                                </button>
                            </div>
                            
                            <div id="test-results" class="hidden mt-3 p-3 border rounded-md bg-gray-50">
                                <h4 class="text-sm font-medium text-gray-700 mb-2">R√©sultat du test :</h4>
                                <div id="test-output" class="text-sm text-gray-600 whitespace-pre-wrap"></div>
                            </div>
                        </div>
                    </details>
                    
                    <details class="control-group" open>
                        <summary><span>Param√®tres IA</span><label class="completion-label"><input type="checkbox" id="completion-api-settings" class="completion-checkbox"><span>Fait ‚úÖ</span></label></summary>
                        <div class="control-group-content space-y-4">
                            <div>
                                <label for="ai-model-select" class="block text-sm font-medium text-gray-700 mb-2">Mod√®le Gemini</label>
                                <select id="ai-model-select" class="w-full p-2 border rounded-md text-sm">
                                    <option value="gemini-1.5-flash">Gemini 1.5 Flash (Rapide)</option>
                                    <option value="gemini-1.5-pro">Gemini 1.5 Pro (Pr√©cis)</option>
                                    <option value="gemini-pro">Gemini Pro (Standard)</option>
                                </select>
                            </div>
                            
                            <div>
                                <label for="ai-temperature" class="block text-sm font-medium text-gray-700 mb-2">Cr√©ativit√©: <span id="temperature-value">0.7</span></label>
                                <input type="range" id="ai-temperature" min="0" max="1" step="0.1" value="0.7" class="w-full h-2 bg-gray-200 rounded-lg cursor-pointer">
                                <div class="flex justify-between text-xs text-gray-500 mt-1">
                                    <span>Pr√©cis</span>
                                    <span>Cr√©atif</span>
                                </div>
                            </div>
                            
                            <div>
                                <label for="ai-max-tokens" class="block text-sm font-medium text-gray-700 mb-2">Longueur max: <span id="max-tokens-value">1000</span> tokens</label>
                                <input type="range" id="ai-max-tokens" min="100" max="2000" step="100" value="1000" class="w-full h-2 bg-gray-200 rounded-lg cursor-pointer">
                            </div>
                            
                            <div class="pt-3 border-t">
                                <button id="reset-api-settings" class="w-full bg-gray-500 text-white py-2 px-4 rounded-md hover:bg-gray-600 flex items-center justify-center gap-2">
                                    <i class="fa-solid fa-undo"></i> R√©initialiser les param√®tres
                                </button>
                            </div>
                        </div>
                    </details>
                </div>

                <!-- TAB: Contenu -->
                <div id="panel-content" class="tab-panel hidden space-y-4">
                    <details class="control-group" open>
                        <summary><span>Informations Principales</span><label class="completion-label"><input type="checkbox" id="completion-content-infos" class="completion-checkbox"><span>Fait ‚úÖ</span></label></summary>
                        <div class="control-group-content space-y-3">
                            <input type="text" id="nom" placeholder="Nom" class="cv-input w-full p-2 border rounded-md">
                            <input type="text" id="prenom" placeholder="Pr√©nom" class="cv-input w-full p-2 border rounded-md">
                            <input type="text" id="poste" placeholder="Poste recherch√©" class="cv-input w-full p-2 border rounded-md">
                            <textarea id="description" placeholder="Description du profil" rows="4" class="cv-input w-full p-2 border rounded-md"></textarea>
                        </div>
                    </details>
                     <details class="control-group" open>
                        <summary><span>Exp√©riences</span><label class="completion-label"><input type="checkbox" id="completion-content-exp" class="completion-checkbox"><span>Fait ‚úÖ</span></label></summary>
                        <div class="control-group-content space-y-2">
                            <div class="flex justify-end mb-2"><button id="add-experience" class="text-sm text-blue-600 hover:text-blue-800 font-medium"><i class="fas fa-circle-plus"></i> Ajouter un bloc</button></div>
                            <div id="experience-list" class="space-y-2"></div>
                        </div>
                    </details>
                     <details class="control-group" open>
                        <summary><span>Formations</span><label class="completion-label"><input type="checkbox" id="completion-content-form" class="completion-checkbox"><span>Fait ‚úÖ</span></label></summary>
                        <div class="control-group-content space-y-2">
                            <div class="flex justify-end mb-2"><button id="add-formation" class="text-sm text-blue-600 hover:text-blue-800 font-medium"><i class="fas fa-circle-plus"></i> Ajouter un bloc</button></div>
                            <div id="formation-list" class="space-y-2"></div>
                        </div>
                    </details>
                    
                    <!-- Comp√©tences (fusionn√©) -->
                     <details class="control-group" open>
                        <summary><span>Comp√©tences</span><label class="completion-label"><input type="checkbox" id="completion-skills" class="completion-checkbox"><span>Fait ‚úÖ</span></label></summary>
                        <div class="control-group-content space-y-3">
                            <p class="text-sm font-medium">Style de Pr√©sentation</p>
                            <div class="flex gap-2">
                                <button data-skill-style="tags" class="skill-style-btn flex-1 bg-gray-200 p-2 rounded-md text-sm active">Tags</button>
                                <button data-skill-style="levels" class="skill-style-btn flex-1 bg-gray-200 p-2 rounded-md text-sm">Niveaux</button>
                                <button data-skill-style="simple" class="skill-style-btn flex-1 bg-gray-200 p-2 rounded-md text-sm">Simple</button>
                            </div>
                            
                            <div id="skills-text-controls">
                                <div class="flex justify-between items-center"><label for="competences" class="font-medium">Liste des comp√©tences</label><div class="flex gap-2"><button id="ai-limit-skills-btn" class="text-blue-600 hover:text-blue-800" title="Limiter √† 10 comp√©tences par l'IA"><i class="fas fa-filter"></i> 10</button><button id="ai-synthesize-skills-btn" class="text-blue-600 hover:text-blue-800" title="Synth√©tiser et ranger les comp√©tences par l'IA"><i class="fas fa-brain"></i></button></div></div>
                                <textarea id="competences" placeholder="Comp√©tences (s√©par√©es par des virgules)..." rows="4" class="cv-input w-full p-2 border rounded-md"></textarea>
                            </div>

                            <div id="skills-level-controls" class="hidden space-y-3">
                                <p class="text-sm font-medium">Style de Jauge</p>
                                <div class="grid grid-cols-5 gap-2 text-center">
                                    <button data-gauge-style="bar" class="gauge-style-btn bg-gray-200 p-2 rounded-md text-sm active" title="Barre"><i class="fas fa-bars"></i></button>
                                    <button data-gauge-style="dots" class="gauge-style-btn bg-gray-200 p-2 rounded-md text-sm" title="Points"><i class="fas fa-circle"></i></button>
                                    <button data-gauge-style="stars" class="gauge-style-btn bg-gray-200 p-2 rounded-md text-sm" title="√âtoiles"><i class="fas fa-star"></i></button>
                                    <button data-gauge-style="squares" class="gauge-style-btn bg-gray-200 p-2 rounded-md text-sm" title="Carr√©s"><i class="fas fa-square"></i></button>
                                    <button data-gauge-style="number" class="gauge-style-btn bg-gray-200 p-2 rounded-md text-sm font-bold" title="Chiffres">‚Öó</button>
                                </div>
                                <div id="skills-level-list" class="space-y-2 border-t pt-3"></div>
                                <button id="add-skill-level-btn" class="w-full bg-blue-100 text-blue-800 py-2 px-4 rounded-md hover:bg-blue-200 flex items-center justify-center gap-2 text-sm"><i class="fas fa-plus-circle"></i> Ajouter une comp√©tence</button>
                            </div>
                        </div>
                    </details>
                    
                    <!-- Sections Personnalis√©es (fusionn√©) -->
                    <details class="control-group" open>
                        <summary><span>Sections Personnalis√©es</span><label class="completion-label"><input type="checkbox" id="completion-custom" class="completion-checkbox"><span>Fait ‚úÖ</span></label></summary>
                        <div class="control-group-content space-y-3">
                            <div class="space-y-2">
                                <label class="text-sm font-medium">Ajouter une nouvelle section</label>
                                <select id="section-suggestion-select" class="w-full p-2 border rounded-md text-sm">
                                    <option value="">-- Choisir une suggestion --</option>
                                    <option value="Langues üåê">Langues üåê</option>
                                    <option value="Centres d'int√©r√™t üé®">Centres d'int√©r√™t üé®</option>
                                    <option value="Certifications üìú">Certifications üìú</option>
                                    <option value="Projets Personnels üí°">Projets Personnels üí°</option>
                                    <option value="B√©n√©volat ‚ù§Ô∏è">B√©n√©volat ‚ù§Ô∏è</option>
                                </select>
                                <div class="flex gap-2">
                                    <input type="text" id="new-section-title-input" class="flex-grow p-2 border rounded-md text-sm" placeholder="Ou tapez un titre personnalis√©...">
                                    <button id="add-section-btn" class="bg-indigo-500 text-white py-2 px-4 rounded-md hover:bg-indigo-600"><i class="fas fa-plus"></i></button>
                                </div>
                            </div>
                            <div id="custom-sections-list" class="space-y-2 mt-2 border-t pt-2"></div>
                        </div>
                    </details>
                </div>
                
                <!-- TAB: Comp√©tences -->
                
                <!-- TAB: Mise en Page -->
                <div id="panel-layout" class="tab-panel hidden space-y-4">
                    <!-- IA LAYOUT GENERATOR -->
                    <details class="control-group" open>
                        <summary><span>ü§ñ G√©n√©rateur IA de Mise en Page</span><label class="completion-label"><input type="checkbox" id="completion-layout-ai" class="completion-checkbox"><span>Fait ‚úÖ</span></label></summary>
                        <div class="control-group-content space-y-3">
                            <button id="ai-layout-professional" class="w-full bg-gradient-to-r from-blue-600 to-indigo-600 text-white py-3 px-4 rounded-md hover:from-blue-700 hover:to-indigo-700 flex items-center justify-center gap-2">
                                <i class="fas fa-magic-wand-sparkles"></i> Mise en Page Professionnelle IA
                            </button>
                            <button id="ai-layout-creative" class="w-full bg-gradient-to-r from-purple-600 to-pink-600 text-white py-3 px-4 rounded-md hover:from-purple-700 hover:to-pink-700 flex items-center justify-center gap-2">
                                <i class="fas fa-palette"></i> Mise en Page Cr√©ative IA
                            </button>
                            <button id="ai-layout-modern" class="w-full bg-gradient-to-r from-teal-600 to-cyan-600 text-white py-3 px-4 rounded-md hover:from-teal-700 hover:to-cyan-700 flex items-center justify-center gap-2">
                                <i class="fas fa-rocket"></i> Mise en Page Moderne IA
                            </button>
                            <button id="ai-layout-random" class="w-full bg-gradient-to-r from-orange-600 to-red-600 text-white py-3 px-4 rounded-md hover:from-orange-700 hover:to-red-700 flex items-center justify-center gap-2">
                                <i class="fas fa-dice"></i> Mise en Page Al√©atoire Intelligente
                            </button>
                        </div>
                    </details>

                    <!-- LAYOUT STRUCTURE -->
                    <details class="control-group" open>
                        <summary><span>Structure & Colonnes</span><label class="completion-label"><input type="checkbox" id="completion-layout-structure" class="completion-checkbox"><span>Fait ‚úÖ</span></label></summary>
                        <div class="control-group-content space-y-4">
                            <div>
                                <label class="text-sm font-medium text-gray-700 mb-2 block">Disposition g√©n√©rale</label>
                                <div class="grid grid-cols-2 gap-2">
                                    <button data-layout="layout-1-col" class="layout-btn bg-gray-200 p-3 rounded-md text-sm">üìÑ 1 Colonne</button>
                                    <button data-layout="layout-2-col-33-67" class="layout-btn bg-gray-200 p-3 rounded-md text-sm">üìä 33/67</button>
                                    <button data-layout="layout-2-col-50-50" class="layout-btn bg-gray-200 p-3 rounded-md text-sm">‚öñÔ∏è 50/50</button>
                                    <button data-layout="layout-2-col-67-33" class="layout-btn bg-gray-200 p-3 rounded-md text-sm">üìà 67/33</button>
                                    <button data-layout="layout-3-col" class="layout-btn bg-gray-200 p-3 rounded-md text-sm">üèõÔ∏è 3 Colonnes</button>
                                    <button data-layout="layout-zigzag" class="layout-btn bg-gray-200 p-3 rounded-md text-sm">‚ö° Zigzag</button>
                                </div>
                            </div>
                            <div>
                                <label class="text-sm font-medium text-gray-700 mb-2 block">Ordre des sections</label>
                                <div class="grid grid-cols-1 gap-2">
                                    <button id="shuffle-sections" class="bg-indigo-500 text-white py-2 px-4 rounded-md hover:bg-indigo-600">üîÄ R√©organiser al√©atoirement</button>
                                    <button id="optimize-sections" class="bg-green-500 text-white py-2 px-4 rounded-md hover:bg-green-600">üéØ Optimiser l'ordre IA</button>
                                </div>
                            </div>
                        </div>
                    </details>

                    <!-- ADVANCED SPACING -->
                    <details class="control-group" open>
                        <summary><span>Espacements Avanc√©s</span><label class="completion-label"><input type="checkbox" id="completion-layout-spacing" class="completion-checkbox"><span>Fait ‚úÖ</span></label></summary>
                        <div class="control-group-content space-y-4">
                            <div class="grid grid-cols-2 gap-4">
                                <div><label for="page-margin-top" class="block text-sm font-medium text-gray-700">Marge Haut: <span id="page-margin-top-value">2</span>cm</label><input type="range" id="page-margin-top" min="0" max="5" step="0.1" value="2" class="cv-input w-full h-2 bg-gray-200 rounded-lg cursor-pointer"></div>
                                <div><label for="page-margin-bottom" class="block text-sm font-medium text-gray-700">Marge Bas: <span id="page-margin-bottom-value">2</span>cm</label><input type="range" id="page-margin-bottom" min="0" max="5" step="0.1" value="2" class="cv-input w-full h-2 bg-gray-200 rounded-lg cursor-pointer"></div>
                                <div><label for="page-margin-left" class="block text-sm font-medium text-gray-700">Marge Gauche: <span id="page-margin-left-value">2</span>cm</label><input type="range" id="page-margin-left" min="0" max="5" step="0.1" value="2" class="cv-input w-full h-2 bg-gray-200 rounded-lg cursor-pointer"></div>
                                <div><label for="page-margin-right" class="block text-sm font-medium text-gray-700">Marge Droite: <span id="page-margin-right-value">2</span>cm</label><input type="range" id="page-margin-right" min="0" max="5" step="0.1" value="2" class="cv-input w-full h-2 bg-gray-200 rounded-lg cursor-pointer"></div>
                            </div>
                            <div><label for="column-gap" class="block text-sm font-medium text-gray-700">Espace entre Colonnes: <span id="column-gap-value">2</span>rem</label><input type="range" id="column-gap" min="0.5" max="5" step="0.1" value="2" class="cv-input w-full h-2 bg-gray-200 rounded-lg cursor-pointer"></div>
                            <div><label for="section-spacing" class="block text-sm font-medium text-gray-700">Espace Sections: <span id="section-spacing-value">1.5</span>rem</label><input type="range" id="section-spacing" min="0" max="6" step="0.1" value="1.5" class="cv-input w-full h-2 bg-gray-200 rounded-lg cursor-pointer"></div>
                            <div><label for="subsection-spacing" class="block text-sm font-medium text-gray-700">Espace Sous-sections: <span id="subsection-spacing-value">1</span>rem</label><input type="range" id="subsection-spacing" min="0" max="4" step="0.1" value="1" class="cv-input w-full h-2 bg-gray-200 rounded-lg cursor-pointer"></div>
                            <div><label for="item-spacing" class="block text-sm font-medium text-gray-700">Espace √âl√©ments: <span id="item-spacing-value">0.5</span>rem</label><input type="range" id="item-spacing" min="0" max="3" step="0.1" value="0.5" class="cv-input w-full h-2 bg-gray-200 rounded-lg cursor-pointer"></div>
                        </div>
                    </details>

                    <!-- TYPOGRAPHY ADVANCED -->
                    <details class="control-group" open>
                        <summary><span>Typographie Avanc√©e</span><label class="completion-label"><input type="checkbox" id="completion-layout-typography" class="completion-checkbox"><span>Fait ‚úÖ</span></label></summary>
                        <div class="control-group-content space-y-4">
                            <div class="grid grid-cols-2 gap-4">
                                <div><label for="font-size-h1" class="block text-sm font-medium text-gray-700">Titre Principal: <span id="font-size-h1-value">40</span>pt</label><input type="range" id="font-size-h1" min="16" max="60" step="0.5" value="40" class="cv-input w-full h-2 bg-gray-200 rounded-lg cursor-pointer"></div>
                                <div><label for="font-size-h2" class="block text-sm font-medium text-gray-700">Titres Section: <span id="font-size-h2-value">21</span>pt</label><input type="range" id="font-size-h2" min="12" max="36" step="0.5" value="21" class="cv-input w-full h-2 bg-gray-200 rounded-lg cursor-pointer"></div>
                                <div><label for="font-size-h3" class="block text-sm font-medium text-gray-700">Sous-titres: <span id="font-size-h3-value">16</span>pt</label><input type="range" id="font-size-h3" min="10" max="24" step="0.5" value="16" class="cv-input w-full h-2 bg-gray-200 rounded-lg cursor-pointer"></div>
                                <div><label for="font-size-p" class="block text-sm font-medium text-gray-700">Paragraphe: <span id="font-size-p-value">10</span>pt</label><input type="range" id="font-size-p" min="8" max="16" step="0.25" value="10" class="cv-input w-full h-2 bg-gray-200 rounded-lg cursor-pointer"></div>
                                <div><label for="font-size-small" class="block text-sm font-medium text-gray-700">Texte petit: <span id="font-size-small-value">8</span>pt</label><input type="range" id="font-size-small" min="6" max="12" step="0.25" value="8" class="cv-input w-full h-2 bg-gray-200 rounded-lg cursor-pointer"></div>
                                <div><label for="font-size-caption" class="block text-sm font-medium text-gray-700">L√©gendes: <span id="font-size-caption-value">7</span>pt</label><input type="range" id="font-size-caption" min="5" max="10" step="0.25" value="7" class="cv-input w-full h-2 bg-gray-200 rounded-lg cursor-pointer"></div>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div><label for="line-height-headings" class="block text-sm font-medium text-gray-700">Interligne Titres: <span id="line-height-headings-value">1.2</span></label><input type="range" id="line-height-headings" min="0.8" max="2" step="0.05" value="1.2" class="cv-input w-full h-2 bg-gray-200 rounded-lg cursor-pointer"></div>
                                <div><label for="line-height-body" class="block text-sm font-medium text-gray-700">Interligne Corps: <span id="line-height-body-value">1.6</span></label><input type="range" id="line-height-body" min="1" max="3" step="0.05" value="1.6" class="cv-input w-full h-2 bg-gray-200 rounded-lg cursor-pointer"></div>
                                <div><label for="letter-spacing" class="block text-sm font-medium text-gray-700">Espacement Lettres: <span id="letter-spacing-value">0</span>px</label><input type="range" id="letter-spacing" min="-2" max="5" step="0.1" value="0" class="cv-input w-full h-2 bg-gray-200 rounded-lg cursor-pointer"></div>
                                <div><label for="word-spacing" class="block text-sm font-medium text-gray-700">Espacement Mots: <span id="word-spacing-value">0</span>px</label><input type="range" id="word-spacing" min="-5" max="10" step="0.5" value="0" class="cv-input w-full h-2 bg-gray-200 rounded-lg cursor-pointer"></div>
                            </div>
                        </div>
                    </details>

                    <!-- ADVANCED LAYOUT OPTIONS -->
                    <details class="control-group" open>
                        <summary><span>Options Avanc√©es</span><label class="completion-label"><input type="checkbox" id="completion-layout-advanced" class="completion-checkbox"><span>Fait ‚úÖ</span></label></summary>
                        <div class="control-group-content space-y-4">
                            <div>
                                <label class="text-sm font-medium text-gray-700 mb-2 block">Alignements</label>
                                <div class="grid grid-cols-3 gap-2">
                                    <button data-text-align="left" class="text-align-btn bg-gray-200 p-2 rounded-md text-sm">‚¨ÖÔ∏è Gauche</button>
                                    <button data-text-align="center" class="text-align-btn bg-gray-200 p-2 rounded-md text-sm">‚¨å Centr√©</button>
                                    <button data-text-align="right" class="text-align-btn bg-gray-200 p-2 rounded-md text-sm">‚û°Ô∏è Droite</button>
                                    <button data-text-align="justify" class="text-align-btn bg-gray-200 p-2 rounded-md text-sm">‚¨å Justifi√©</button>
                                    <button data-text-align="mixed" class="text-align-btn bg-gray-200 p-2 rounded-md text-sm">üé® Mixte</button>
                                    <button data-text-align="dynamic" class="text-align-btn bg-gray-200 p-2 rounded-md text-sm">ü§ñ IA</button>
                                </div>
                            </div>
                            <div>
                                <label class="text-sm font-medium text-gray-700 mb-2 block">Indentations</label>
                                <div class="grid grid-cols-2 gap-4">
                                    <div><label for="paragraph-indent" class="block text-xs text-gray-600">Retrait Paragraphe: <span id="paragraph-indent-value">0</span>rem</label><input type="range" id="paragraph-indent" min="0" max="3" step="0.1" value="0" class="cv-input w-full h-2 bg-gray-200 rounded-lg cursor-pointer"></div>
                                    <div><label for="list-indent" class="block text-xs text-gray-600">Retrait Listes: <span id="list-indent-value">1</span>rem</label><input type="range" id="list-indent" min="0.5" max="4" step="0.1" value="1" class="cv-input w-full h-2 bg-gray-200 rounded-lg cursor-pointer"></div>
                                </div>
                            </div>
                            <div>
                                <label class="text-sm font-medium text-gray-700 mb-2 block">Effets visuels</label>
                                <div class="grid grid-cols-2 gap-2">
                                    <label class="flex items-center gap-2 text-sm"><input type="checkbox" id="drop-shadows" class="cv-input">Ombres port√©es</label>
                                    <label class="flex items-center gap-2 text-sm"><input type="checkbox" id="rounded-corners" class="cv-input">Coins arrondis</label>
                                    <label class="flex items-center gap-2 text-sm"><input type="checkbox" id="section-borders" class="cv-input">Bordures sections</label>
                                    <label class="flex items-center gap-2 text-sm"><input type="checkbox" id="alternating-bg" class="cv-input">Fond altern√©</label>
                                </div>
                            </div>
                        </div>
                    </details>
                </div>
                    </details>
                </div>
                
                <!-- TAB: Styles Globaux -->
                <div id="panel-styles" class="tab-panel hidden space-y-4">
                    <!-- IA STYLE GENERATOR -->
                    <details class="control-group" open>
                        <summary><span>üé® G√©n√©rateur IA de Styles</span><label class="completion-label"><input type="checkbox" id="completion-styles-ai" class="completion-checkbox"><span>Fait ‚úÖ</span></label></summary>
                        <div class="control-group-content space-y-3">
                            <button id="ai-style-professional" class="w-full bg-gradient-to-r from-gray-700 to-blue-800 text-white py-3 px-4 rounded-md hover:from-gray-800 hover:to-blue-900 flex items-center justify-center gap-2">
                                <i class="fas fa-briefcase"></i> Style Professionnel IA
                            </button>
                            <button id="ai-style-creative" class="w-full bg-gradient-to-r from-purple-600 to-pink-600 text-white py-3 px-4 rounded-md hover:from-purple-700 hover:to-pink-700 flex items-center justify-center gap-2">
                                <i class="fas fa-paint-brush"></i> Style Cr√©atif IA
                            </button>
                            <button id="ai-style-minimalist" class="w-full bg-gradient-to-r from-gray-400 to-gray-600 text-white py-3 px-4 rounded-md hover:from-gray-500 hover:to-gray-700 flex items-center justify-center gap-2">
                                <i class="fas fa-minus"></i> Style Minimaliste IA
                            </button>
                            <button id="ai-style-luxury" class="w-full bg-gradient-to-r from-yellow-600 to-yellow-800 text-white py-3 px-4 rounded-md hover:from-yellow-700 hover:to-yellow-900 flex items-center justify-center gap-2">
                                <i class="fas fa-crown"></i> Style Luxe IA
                            </button>
                            <button id="ai-style-random" class="w-full bg-gradient-to-r from-green-600 to-teal-600 text-white py-3 px-4 rounded-md hover:from-green-700 hover:to-teal-700 flex items-center justify-center gap-2">
                                <i class="fas fa-magic-wand-sparkles"></i> Style Surprise IA
                            </button>
                        </div>
                    </details>

                    <!-- ADVANCED THEMES -->
                    <details class="control-group" open>
                        <summary><span>Th√®mes Avanc√©s</span><label class="completion-label"><input type="checkbox" id="completion-styles-themes" class="completion-checkbox"><span>Fait ‚úÖ</span></label></summary>
                        <div class="control-group-content space-y-4">
                            <div id="theme-buttons" class="grid grid-cols-3 gap-2">
                                <button data-theme="professional" class="theme-btn bg-gray-200 p-3 rounded-md text-sm">üíº Pro</button>
                                <button data-theme="creative" class="theme-btn bg-gray-200 p-3 rounded-md text-sm">üé® Cr√©atif</button>
                                <button data-theme="modern" class="theme-btn bg-gray-200 p-3 rounded-md text-sm">üöÄ Moderne</button>
                                <button data-theme="elegant" class="theme-btn bg-gray-200 p-3 rounded-md text-sm">‚ú® √âl√©gant</button>
                                <button data-theme="tech" class="theme-btn bg-gray-200 p-3 rounded-md text-sm">üíª Tech</button>
                                <button data-theme="artistic" class="theme-btn bg-gray-200 p-3 rounded-md text-sm">üé≠ Artistique</button>
                                <button data-theme="minimalist" class="theme-btn bg-gray-200 p-3 rounded-md text-sm">‚ö™ Minimal</button>
                                <button data-theme="luxury" class="theme-btn bg-gray-200 p-3 rounded-md text-sm">üëë Luxe</button>
                                <button data-theme="vintage" class="theme-btn bg-gray-200 p-3 rounded-md text-sm">üìú Vintage</button>
                            </div>
                            <button id="random-theme" class="w-full bg-purple-500 text-white py-2 px-4 rounded-md hover:bg-purple-600 mt-3">üé≤ Th√®me Al√©atoire</button>
                        </div>
                    </details>

                    <!-- ADVANCED COLORS -->
                    <details class="control-group" open>
                        <summary><span>Palette de Couleurs Avanc√©e</span><label class="completion-label"><input type="checkbox" id="completion-styles-colors" class="completion-checkbox"><span>Fait ‚úÖ</span></label></summary>
                        <div class="control-group-content space-y-4">
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label for="primary-color-picker" class="block text-sm font-medium text-gray-700">Couleur Principale</label>
                                    <input type="color" id="primary-color-picker" value="#2563eb" class="cv-input w-full h-12 p-1 border rounded-md">
                                </div>
                                <div>
                                    <label for="secondary-color-picker" class="block text-sm font-medium text-gray-700">Couleur Secondaire</label>
                                    <input type="color" id="secondary-color-picker" value="#334155" class="cv-input w-full h-12 p-1 border rounded-md">
                                </div>
                                <div>
                                    <label for="accent-color-picker" class="block text-sm font-medium text-gray-700">Couleur d'Accent</label>
                                    <input type="color" id="accent-color-picker" value="#f59e0b" class="cv-input w-full h-12 p-1 border rounded-md">
                                </div>
                                <div>
                                    <label for="neutral-color-picker" class="block text-sm font-medium text-gray-700">Couleur Neutre</label>
                                    <input type="color" id="neutral-color-picker" value="#6b7280" class="cv-input w-full h-12 p-1 border rounded-md">
                                </div>
                                <div>
                                    <label for="background-color-picker" class="block text-sm font-medium text-gray-700">Arri√®re-plan</label>
                                    <input type="color" id="background-color-picker" value="#ffffff" class="cv-input w-full h-12 p-1 border rounded-md">
                                </div>
                                <div>
                                    <label for="text-color-picker" class="block text-sm font-medium text-gray-700">Texte Principal</label>
                                    <input type="color" id="text-color-picker" value="#1f2937" class="cv-input w-full h-12 p-1 border rounded-md">
                                </div>
                            </div>
                            <div class="grid grid-cols-3 gap-2 mt-4">
                                <button id="ai-harmonious-colors" class="bg-blue-500 text-white py-2 px-3 rounded-md hover:bg-blue-600 text-sm">üé® Harmonie IA</button>
                                <button id="ai-contrast-colors" class="bg-purple-500 text-white py-2 px-3 rounded-md hover:bg-purple-600 text-sm">‚ö° Contraste IA</button>
                                <button id="random-palette" class="bg-orange-500 text-white py-2 px-3 rounded-md hover:bg-orange-600 text-sm">üé≤ Palette Al√©atoire</button>
                            </div>
                            <!-- Palettes pr√©-d√©finies -->
                            <div>
                                <label class="text-sm font-medium text-gray-700 mb-2 block">Palettes Pr√©-d√©finies</label>
                                <div class="grid grid-cols-4 gap-2">
                                    <button data-palette="ocean" class="palette-btn h-8 rounded-md" style="background: linear-gradient(90deg, #0ea5e9, #06b6d4, #10b981);"></button>
                                    <button data-palette="sunset" class="palette-btn h-8 rounded-md" style="background: linear-gradient(90deg, #f59e0b, #ef4444, #ec4899);"></button>
                                    <button data-palette="forest" class="palette-btn h-8 rounded-md" style="background: linear-gradient(90deg, #16a34a, #84cc16, #65a30d);"></button>
                                    <button data-palette="royal" class="palette-btn h-8 rounded-md" style="background: linear-gradient(90deg, #7c3aed, #a855f7, #3b82f6);"></button>
                                    <button data-palette="autumn" class="palette-btn h-8 rounded-md" style="background: linear-gradient(90deg, #dc2626, #ea580c, #d97706);"></button>
                                    <button data-palette="mono" class="palette-btn h-8 rounded-md" style="background: linear-gradient(90deg, #374151, #6b7280, #9ca3af);"></button>
                                    <button data-palette="pastel" class="palette-btn h-8 rounded-md" style="background: linear-gradient(90deg, #fbbf24, #f472b6, #a78bfa);"></button>
                                    <button data-palette="neon" class="palette-btn h-8 rounded-md" style="background: linear-gradient(90deg, #06ffa5, #00d4ff, #ff006e);"></button>
                                </div>
                            </div>
                        </div>
                    </details>

                    <!-- ADVANCED FONTS -->
                    <details class="control-group" open>
                        <summary><span>Typographie Professionnelle</span><label class="completion-label"><input type="checkbox" id="completion-styles-fonts" class="completion-checkbox"><span>Fait ‚úÖ</span></label></summary>
                        <div class="control-group-content space-y-4">
                            <div class="grid grid-cols-1 gap-4">
                                <div>
                                    <label for="font-family-h1-select" class="block text-sm font-medium text-gray-700">Titre Principal (H1)</label>
                                    <select id="font-family-h1-select" class="cv-input w-full p-2 border rounded-md"></select>
                                </div>
                                <div>
                                    <label for="font-family-h2-select" class="block text-sm font-medium text-gray-700">Titres de Section (H2)</label>
                                    <select id="font-family-h2-select" class="cv-input w-full p-2 border rounded-md"></select>
                                </div>
                                <div>
                                    <label for="font-family-h3-select" class="block text-sm font-medium text-gray-700">Sous-titres (H3)</label>
                                    <select id="font-family-h3-select" class="cv-input w-full p-2 border rounded-md"></select>
                                </div>
                                <div>
                                    <label for="font-family-body-select" class="block text-sm font-medium text-gray-700">Corps de Texte</label>
                                    <select id="font-family-body-select" class="cv-input w-full p-2 border rounded-md"></select>
                                </div>
                                <div>
                                    <label for="font-family-accent-select" class="block text-sm font-medium text-gray-700">Texte d'Accent</label>
                                    <select id="font-family-accent-select" class="cv-input w-full p-2 border rounded-md"></select>
                                </div>
                            </div>
                            <div class="grid grid-cols-3 gap-2">
                                <button id="ai-font-pairing" class="bg-indigo-500 text-white py-2 px-3 rounded-md hover:bg-indigo-600 text-sm">ü§ñ Pairing IA</button>
                                <button id="random-fonts" class="bg-purple-500 text-white py-2 px-3 rounded-md hover:bg-purple-600 text-sm">üé≤ Polices Al√©atoires</button>
                                <button id="reset-fonts" class="bg-gray-500 text-white py-2 px-3 rounded-md hover:bg-gray-600 text-sm">‚Ü∫ Reset</button>
                            </div>
                        </div>
                    </details>

                    <!-- VISUAL EFFECTS -->
                    <details class="control-group" open>
                        <summary><span>Effets Visuels</span><label class="completion-label"><input type="checkbox" id="completion-styles-effects" class="completion-checkbox"><span>Fait ‚úÖ</span></label></summary>
                        <div class="control-group-content space-y-4">
                            <div>
                                <label class="text-sm font-medium text-gray-700 mb-2 block">Style des Titres de Section</label>
                                <div class="grid grid-cols-2 gap-2">
                                    <button data-title-style="style-underline" class="section-title-style-btn bg-gray-200 p-3 rounded-md text-sm">üìù Soulign√©</button>
                                    <button data-title-style="style-side-line" class="section-title-style-btn bg-gray-200 p-3 rounded-md text-sm">üìè Ligne C√¥t√©</button>
                                    <button data-title-style="style-background" class="section-title-style-btn bg-gray-200 p-3 rounded-md text-sm">üé® Fond Color√©</button>
                                    <button data-title-style="style-boxed" class="section-title-style-btn bg-gray-200 p-3 rounded-md text-sm">üì¶ Encadr√©</button>
                                    <button data-title-style="style-gradient" class="section-title-style-btn bg-gray-200 p-3 rounded-md text-sm">üåà D√©grad√©</button>
                                    <button data-title-style="style-shadow" class="section-title-style-btn bg-gray-200 p-3 rounded-md text-sm">üë§ Ombre</button>
                                    <button data-title-style="style-3d" class="section-title-style-btn bg-gray-200 p-3 rounded-md text-sm">üîÆ 3D</button>
                                    <button data-title-style="style-neon" class="section-title-style-btn bg-gray-200 p-3 rounded-md text-sm">üí° N√©on</button>
                                </div>
                            </div>
                            <div>
                                <label class="text-sm font-medium text-gray-700 mb-2 block">Effets Globaux</label>
                                <div class="grid grid-cols-2 gap-2">
                                    <label class="flex items-center gap-2 text-sm"><input type="checkbox" id="global-shadows" class="cv-input">üåë Ombres globales</label>
                                    <label class="flex items-center gap-2 text-sm"><input type="checkbox" id="global-gradients" class="cv-input">üåà D√©grad√©s</label>
                                    <label class="flex items-center gap-2 text-sm"><input type="checkbox" id="global-borders" class="cv-input">üî≤ Bordures</label>
                                    <label class="flex items-center gap-2 text-sm"><input type="checkbox" id="global-rounded" class="cv-input">üîò Coins arrondis</label>
                                    <label class="flex items-center gap-2 text-sm"><input type="checkbox" id="global-animation" class="cv-input">‚ö° Animations</label>
                                    <label class="flex items-center gap-2 text-sm"><input type="checkbox" id="global-texture" class="cv-input">üé® Textures</label>
                                </div>
                            </div>
                            <div>
                                <label class="text-sm font-medium text-gray-700 mb-2 block">Opacit√© et Transparence</label>
                                <div class="grid grid-cols-2 gap-4">
                                    <div><label for="section-opacity" class="block text-xs text-gray-600">Opacit√© Sections: <span id="section-opacity-value">1</span></label><input type="range" id="section-opacity" min="0.1" max="1" step="0.05" value="1" class="cv-input w-full h-2 bg-gray-200 rounded-lg cursor-pointer"></div>
                                    <div><label for="background-opacity" class="block text-xs text-gray-600">Opacit√© Fond: <span id="background-opacity-value">1</span></label><input type="range" id="background-opacity" min="0.1" max="1" step="0.05" value="1" class="cv-input w-full h-2 bg-gray-200 rounded-lg cursor-pointer"></div>
                                </div>
                            </div>
                        </div>
                    </details>

                    <!-- PATTERN & TEXTURE -->
                    <details class="control-group" open>
                        <summary><span>Motifs & Textures</span><label class="completion-label"><input type="checkbox" id="completion-styles-patterns" class="completion-checkbox"><span>Fait ‚úÖ</span></label></summary>
                        <div class="control-group-content space-y-4">
                            <div>
                                <label class="text-sm font-medium text-gray-700 mb-2 block">Motifs de Fond</label>
                                <div class="grid grid-cols-3 gap-2">
                                    <button data-pattern="none" class="pattern-btn bg-gray-200 p-3 rounded-md text-sm">üö´ Aucun</button>
                                    <button data-pattern="dots" class="pattern-btn bg-gray-200 p-3 rounded-md text-sm">‚ö´ Points</button>
                                    <button data-pattern="lines" class="pattern-btn bg-gray-200 p-3 rounded-md text-sm">üìè Lignes</button>
                                    <button data-pattern="grid" class="pattern-btn bg-gray-200 p-3 rounded-md text-sm">‚öè Grille</button>
                                    <button data-pattern="waves" class="pattern-btn bg-gray-200 p-3 rounded-md text-sm">üåä Vagues</button>
                                    <button data-pattern="geometric" class="pattern-btn bg-gray-200 p-3 rounded-md text-sm">üî∑ G√©om√©trique</button>
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div><label for="pattern-opacity" class="block text-xs text-gray-600">Opacit√© Motif: <span id="pattern-opacity-value">0.1</span></label><input type="range" id="pattern-opacity" min="0" max="0.5" step="0.01" value="0.1" class="cv-input w-full h-2 bg-gray-200 rounded-lg cursor-pointer"></div>
                                <div><label for="pattern-scale" class="block text-xs text-gray-600">√âchelle Motif: <span id="pattern-scale-value">1</span></label><input type="range" id="pattern-scale" min="0.5" max="3" step="0.1" value="1" class="cv-input w-full h-2 bg-gray-200 rounded-lg cursor-pointer"></div>
                            </div>
                        </div>
                    </details>
                </div>
                
                <!-- TAB: Recrutement -->
                <div id="panel-recrutement" class="tab-panel hidden space-y-4">
                    <details class="control-group" open>
                        <summary><span>Pr√©sentation Recruteur</span><label class="completion-label"><input type="checkbox" id="completion-ia-presentation" class="completion-checkbox"><span>Fait ‚úÖ</span></label></summary>
                        <div class="control-group-content space-y-3">
                            <input type="text" id="qualification-dispo" placeholder="Disponibilit√©" class="cv-input w-full p-2 border rounded-md">
                            <input type="text" id="qualification-salaire" placeholder="Pr√©tentions salariales" class="cv-input w-full p-2 border rounded-md">
                            <input type="text" id="qualification-loc" placeholder="Localisation" class="cv-input w-full p-2 border rounded-md">
                            <button id="generate-mail-btn" class="mt-2 w-full bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700 flex items-center justify-center gap-2"><i class="fas fa-wand-magic-sparkles"></i> G√©n√©rer le mail</button>
                            <textarea id="recruiter-mail-content" rows="8" class="cv-input w-full p-2 border rounded-md mt-2" placeholder="Le mail de pr√©sentation appara√Ætra ici..."></textarea>
                        </div>
                    </details>
                    <details class="control-group" open>
                        <summary><span>Banni√®re Recruteur</span><label class="completion-label"><input type="checkbox" id="completion-banner-main" class="completion-checkbox"><span>Fait ‚úÖ</span></label></summary>
                        <div class="control-group-content space-y-3">
                            <div class="flex justify-between items-center">
                                <h3 class="font-semibold text-gray-700">Banni√®re Recruteur</h3>
                                <button id="reset-recruiter-btn" class="text-sm text-gray-500 hover:text-red-600" title="R√©initialiser les informations recruteur"><i class="fas fa-undo"></i></button>
                            </div>
                            <div id="banner-fix-controls"><button id="fix-banner-top-btn" class="w-full bg-teal-600 text-white py-2 px-4 rounded-md hover:bg-teal-700 flex items-center justify-center gap-2"><i class="fas fa-arrow-up"></i>Fixer en haut</button><button id="fix-banner-bottom-btn" class="w-full bg-teal-600 text-white py-2 px-4 rounded-md hover:bg-teal-700 flex items-center justify-center gap-2 mt-2"><i class="fas fa-arrow-down"></i>Fixer en bas</button></div><button id="modular-banner-btn" class="cv-input w-full bg-orange-500 text-white py-2 px-4 rounded-md hover:bg-orange-600 flex items-center justify-center gap-2 hidden"><i class="fas fa-arrows-up-down-left-right"></i>Rendre modulaire</button><label class="flex items-center gap-2 text-sm"><input type="checkbox" id="toggle-banner-checkbox" class="cv-input">Afficher la banni√®re</label><label for="banner-style-select" class="text-sm font-medium">Style de Banni√®re</label><select id="banner-style-select" class="cv-input w-full p-2 border rounded-md"><option value="banner-style-modern">Moderne</option><option value="banner-style-elegant">√âl√©gant</option><option value="banner-style-discret">Discret</option><option value="banner-style-carte">Carte</option><option value="banner-style-degrade">D√©grad√©</option><option value="banner-style-premium">Premium</option><option value="banner-style-minimal">Minimal</option><option value="banner-style-encadre">Encadr√©</option><option value="banner-style-ligne-haute">Ligne Haute</option></select><p class="text-sm font-medium">Alignement</p><div class="flex gap-2"><button data-banner-align="left" class="banner-align-btn flex-1 bg-gray-200 p-2 rounded-md text-sm"><i class="fas fa-align-left"></i></button><button data-banner-align="center" class="banner-align-btn flex-1 bg-gray-200 p-2 rounded-md text-sm"><i class="fas fa-align-center"></i></button><button data-banner-align="right" class="banner-align-btn flex-1 bg-gray-200 p-2 rounded-md text-sm"><i class="fas fa-align-right"></i></button><button id="banner-invert-btn" class="p-2 bg-gray-200 rounded-md text-sm" title="Inverser Logo/Texte"><i class="fas fa-right-left"></i></button></div><p class="text-sm font-medium">Taille Logo</p><div class="flex gap-2"><button data-logo-size="sm" class="logo-size-btn flex-1 bg-gray-200 p-2 rounded-md text-sm">P</button><button data-logo-size="md" class="logo-size-btn flex-1 bg-gray-200 p-2 rounded-md text-sm">M</button><button data-logo-size="lg" class="logo-size-btn flex-1 bg-gray-200 p-2 rounded-md text-sm">G</button><button data-logo-size="xl" class="logo-size-btn flex-1 bg-gray-200 p-2 rounded-md text-sm">XL</button><button data-logo-size="xxl" class="logo-size-btn flex-1 bg-gray-200 p-2 rounded-md text-sm">XXL</button></div><div><label for="banner-element-spacing" class="block text-sm font-medium text-gray-700">Espace Banni√®re: <span id="banner-element-spacing-value">1</span>rem</label><input type="range" id="banner-element-spacing" min="0.5" max="4" step="0.1" value="1" class="cv-input w-full h-2 bg-gray-200 rounded-lg cursor-pointer"></div><input type="text" id="banner-nom" placeholder="Votre Nom & Pr√©nom" class="banner-input w-full p-2 border rounded-md"><input type="text" id="banner-poste" placeholder="Votre Poste" class="banner-input w-full p-2 border rounded-md"><input type="email" id="banner-email" placeholder="Email" class="banner-input w-full p-2 border rounded-md"><input type="tel" id="banner-tel" placeholder="T√©l√©phone" class="banner-input w-full p-2 border rounded-md"><div><label for="banner-image" class="block text-sm font-medium text-gray-700">Photo/Logo</label><input type="file" id="banner-image" accept="image/*" class="banner-input mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"></div>
                        </div>
                    </details>
                    <details class="control-group" open>
                        <summary><span>Image de Fond Banni√®re</span><label class="completion-label"><input type="checkbox" id="completion-banner-bg" class="completion-checkbox"><span>Fait ‚úÖ</span></label></summary>
                        <div class="control-group-content space-y-4">
                            <div>
                                <label for="banner-bg-image" class="block text-sm font-medium text-gray-700">T√©l√©charger une image</label>
                                <input type="file" id="banner-bg-image" accept="image/*" class="banner-input mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                            </div>
                            <div>
                                <label for="banner-bg-opacity" class="block text-sm font-medium text-gray-700">Opacit√©: <span id="banner-bg-opacity-value">1</span></label>
                                <input type="range" id="banner-bg-opacity" min="0" max="1" step="0.05" value="1" class="cv-input w-full h-2 bg-gray-200 rounded-lg cursor-pointer">
                            </div>
                            <div>
                                <label for="banner-bg-blur" class="block text-sm font-medium text-gray-700">Flou: <span id="banner-bg-blur-value">0</span>px</label>
                                <input type="range" id="banner-bg-blur" min="0" max="20" step="1" value="0" class="cv-input w-full h-2 bg-gray-200 rounded-lg cursor-pointer">
                            </div>
                            <label class="flex items-center gap-2 text-sm"><input type="checkbox" id="banner-bg-grayscale" class="cv-input">Image en noir et blanc</label>
                            <button id="remove-banner-bg-btn" class="w-full bg-red-500 text-white py-2 px-4 rounded-md hover:bg-red-600 flex items-center justify-center gap-2"><i class="fas fa-trash"></i> Supprimer l'image de fond</button>
                        </div>
                    </details>
                    <details class="control-group" open>
                        <summary><span>Style du Texte Banni√®re</span><label class="completion-label"><input type="checkbox" id="completion-banner-text" class="completion-checkbox"><span>Fait ‚úÖ</span></label></summary>
                        <div class="control-group-content space-y-4">
                            <button id="randomize-banner-style-btn" class="w-full bg-indigo-500 text-white py-2 px-4 rounded-md hover:bg-indigo-600 flex items-center justify-center gap-2"><i class="fas fa-dice"></i> Style Al√©atoire</button><div class="border-t pt-4 mt-4"><h4 class="font-semibold text-sm mb-2">Nom & Pr√©nom</h4><label class="text-xs">Police</label><select id="banner-nom-font" class="cv-input w-full p-1 border text-sm rounded-md"><option value="'Montserrat', sans-serif">Montserrat</option><option value="'Playfair Display', serif">Playfair Display</option><option value="'Oswald', sans-serif">Oswald</option><option value="'Cormorant Garamond', serif">Cormorant Garamond</option><option value="'Merriweather', serif">Merriweather</option><option value="'Lato', sans-serif">Lato</option></select><label class="text-xs mt-2 block">Taille: <span id="banner-nom-size-value">24</span>pt</label><input type="range" id="banner-nom-size" min="14" max="40" step="1" value="24" class="cv-input w-full h-2 bg-gray-200 rounded-lg cursor-pointer"><div class="flex items-center gap-2 mt-2"><label class="text-xs">Couleur:</label><input type="color" id="banner-nom-color" value="#334155" class="cv-input w-full h-8 p-1 border rounded-md"><button id="banner-nom-bold" class="style-toggle-btn p-1 px-2 rounded-md bg-gray-200 text-sm"><i class="fas fa-bold"></i></button><button id="banner-nom-italic" class="style-toggle-btn p-1 px-2 rounded-md bg-gray-200 text-sm"><i class="fas fa-italic"></i></button></div></div><div class="border-t pt-4 mt-4"><h4 class="font-semibold text-sm mb-2">Poste</h4><label class="text-xs mt-2 block">Taille: <span id="banner-poste-size-value">12</span>pt</label><input type="range" id="banner-poste-size" min="8" max="20" step="0.5" value="12" class="cv-input w-full h-2 bg-gray-200 rounded-lg cursor-pointer"><div class="flex items-center gap-2 mt-2"><label class="text-xs">Couleur:</label><input type="color" id="banner-poste-color" value="#334155" class="cv-input w-full h-8 p-1 border rounded-md"><button id="banner-poste-bold" class="style-toggle-btn p-1 px-2 rounded-md bg-gray-200 text-sm"><i class="fas fa-bold"></i></button><button id="banner-poste-italic" class="style-toggle-btn p-1 px-2 rounded-md bg-gray-200 text-sm"><i class="fas fa-italic"></i></button></div></div><div class="border-t pt-4 mt-4"><h4 class="font-semibold text-sm mb-2">Coordonn√©es</h4><label class="text-xs mt-2 block">Taille: <span id="banner-contact-size-value">9</span>pt</label><input type="range" id="banner-contact-size" min="7" max="14" step="0.5" value="9" class="cv-input w-full h-2 bg-gray-200 rounded-lg cursor-pointer"><div class="flex items-center gap-2 mt-2"><label class="text-xs">Couleur:</label><input type="color" id="banner-contact-color" value="#334155" class="cv-input w-full h-8 p-1 border rounded-md"><button id="banner-contact-bold" class="style-toggle-btn p-1 px-2 rounded-md bg-gray-200 text-sm"><i class="fas fa-bold"></i></button><button id="banner-contact-italic" class="style-toggle-btn p-1 px-2 rounded-md bg-gray-200 text-sm"><i class="fas fa-italic"></i></button></div></div>
                        </div>
                    </details>
                </div>
                
                <!-- TAB: Param√®tres -->
                <div id="panel-settings" class="tab-panel hidden space-y-4">
                    <details class="control-group" open>
                        <summary><span>Actions CV</span><label class="completion-label"><input type="checkbox" id="completion-actions" class="completion-checkbox"><span>Fait ‚úÖ</span></label></summary>
                        <div class="control-group-content space-y-3">
                            <div class="grid grid-cols-2 gap-2">
                                <button id="download-pdf-btn" class="w-full bg-gray-800 text-white py-2 px-4 rounded-md hover:bg-gray-900 flex items-center justify-center gap-2"><i class="fa-solid fa-download"></i> PDF</button>
                                <button id="share-btn" class="w-full bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700 flex items-center justify-center gap-2"><i class="fa-solid fa-share-alt"></i> Partager</button>
                            </div>
                            <button id="anonymize-btn" class="w-full bg-slate-500 text-white py-2 px-4 rounded-md hover:bg-slate-600 flex items-center justify-center gap-2"><i class="fa-solid fa-user-secret"></i> Anonymiser le CV</button>
                            <button id="reset-cv-btn" class="w-full bg-red-600 text-white py-2 px-4 rounded-md hover:bg-red-700 flex items-center justify-center gap-2"><i class="fa-solid fa-file-circle-plus"></i> Nouveau CV</button>
                        </div>
                    </details>
                    
                    <details class="control-group" open>
                        <summary><span>Outils</span><label class="completion-label"><input type="checkbox" id="completion-tools" class="completion-checkbox"><span>Fait ‚úÖ</span></label></summary>
                        <div class="control-group-content space-y-3">
                            <button id="toggle-overflow-btn" class="w-full bg-yellow-500 text-white py-2 px-4 rounded-md hover:bg-yellow-600 flex items-center justify-center gap-2"><i class="fa-solid fa-ruler-combined"></i> D√©tection D√©passement</button>
                            <button id="toggle-presentation-mode-btn" class="w-full bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 flex items-center justify-center gap-2"><i class="fa-solid fa-eye"></i> Mode Pr√©sentation</button>
                        </div>
                    </details>
                </div>
            </div>

        </div>

        <!-- PREVIEW PANEL -->
        <div class="w-full lg:w-2/3 xl:w-3/4 p-8 bg-gray-200 flex justify-center items-start overflow-auto" id="preview-area">
            <div id="cv-preview-wrapper">
                <div class="a4-page-container">
                    <div id="page-1" class="a4-page">
                        <div id="fixed-banner-top"></div>
                        <div class="cv-body-container layout-1-col">
                            <div id="cv-col-1-1" class="cv-column">
                                <div id="banner-module" class="cv-module">
                                    <div class="drag-handle"><i class="fas fa-grip-vertical"></i></div>
                                    <div id="recruiter-banner" class="banner-align-left">
                                        <img id="banner-bg-img-preview" src="" alt="Banner background" class="absolute top-0 left-0 w-full h-full object-cover z-0 transition-all duration-300">
                                        <div class="banner-content-wrapper">
                                            <img id="banner-img-preview" class="logo-md" src="https://placehold.co/100x100/EFEFEF/AAAAAA&text=Photo" alt="Photo recruteur" onerror="this.onerror=null; this.src='https://placehold.co/100x100/EFEFEF/AAAAAA&text=Photo';">
                                            <div class="banner-content">
                                                <p id="banner-nom-preview" class="item-title" contenteditable="true"></p>
                                                <p id="banner-poste-preview" contenteditable="true"></p>
                                                <p id="banner-contact-preview"><span id="banner-email-preview" contenteditable="true"></span> | <span id="banner-tel-preview" contenteditable="true"></span></p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div id="header-module" class="cv-module"><div class="drag-handle"><i class="fas fa-grip-vertical"></i></div><div class="cv-header text-center"><div class="editable-wrapper"><h1 id="cv-nom-prenom-preview" contenteditable="true">Pr√©nom NOM</h1><span class="delete-line-btn"><i class="fas fa-times"></i></span></div><div class="editable-wrapper"><p id="cv-poste-preview" contenteditable="true">Poste Recherch√©</p><span class="delete-line-btn"><i class="fas fa-times"></i></span></div></div></div>
                                <div id="qualification-module" class="cv-module"><div class="drag-handle"><i class="fas fa-grip-vertical"></i></div><div id="qualification-preview" class="flex justify-center gap-4 text-center text-sm p-2 bg-slate-50 rounded-md"></div></div>
                                <div id="description-module" class="cv-module"><div class="drag-handle"><i class="fas fa-grip-vertical"></i></div><h2 class="section-title style-underline" data-section-id="description"><i class="fas fa-user-circle section-icon"></i><span contenteditable="true">Profil</span><div class="section-ai-actions"><button class="ai-action-btn toggle-visibility-btn" title="Masquer/Afficher la section"><i class="fas fa-eye"></i></button><button class="ai-action-btn" data-action="rewrite-profile" title="R√©√©crire le profil avec l'IA"><i class="fas fa-magic-wand-sparkles"></i></button></div></h2><div id="cv-description-preview"></div></div>
                                <div id="experience-module" class="cv-module"><div class="drag-handle"><i class="fas fa-grip-vertical"></i></div><h2 class="section-title style-underline" data-section-id="experience"><i class="fas fa-briefcase section-icon"></i><span contenteditable="true">Exp√©rience</span><div class="section-ai-actions"><button class="ai-action-btn toggle-visibility-btn" title="Masquer/Afficher la section"><i class="fas fa-eye"></i></button><button class="ai-action-btn" data-action="summarize-experience" title="Synth√©tiser les exp√©riences avec l'IA (5 lignes max)"><i class="fas fa-magic-wand-sparkles"></i></button></div></h2><div id="cv-experience-preview"></div></div>
                                <div id="formation-module" class="cv-module"><div class="drag-handle"><i class="fas fa-grip-vertical"></i></div><h2 class="section-title style-underline" data-section-id="formation"><i class="fas fa-graduation-cap section-icon"></i><span contenteditable="true">Formation</span><div class="section-ai-actions"><button class="ai-action-btn toggle-visibility-btn" title="Masquer/Afficher la section"><i class="fas fa-eye"></i></button><button class="ai-action-btn" data-action="rewrite-formation" title="Am√©liorer les formations avec l'IA"><i class="fas fa-magic-wand-sparkles"></i></button></div></h2><div id="cv-formation-preview"></div></div>
                                <div id="competences-module" class="cv-module"><div class="drag-handle"><i class="fas fa-grip-vertical"></i></div><h2 class="section-title style-underline" data-section-id="competences"><i class="fas fa-star section-icon"></i><span contenteditable="true">Comp√©tences</span><div class="section-ai-actions"><button class="ai-action-btn toggle-visibility-btn" title="Masquer/Afficher la section"><i class="fas fa-eye"></i></button><button class="ai-action-btn" data-action="rewrite-skills" title="Am√©liorer les comp√©tences avec l'IA"><i class="fas fa-magic-wand-sparkles"></i></button></div></h2><div id="cv-competences-preview" data-style="tags"></div></div>
                            </div>
                            <div id="cv-col-1-2" class="cv-column"></div>
                        </div>
                        <div id="fixed-banner-bottom"></div>
                    </div>
                     <button class="remove-page-btn no-print"><i class="fas fa-trash-can"></i></button>
                </div>
                 <div id="add-page-btn-wrapper" class="no-print">
                     <button id="add-page-btn" title="Ajouter une page"><i class="fas fa-plus"></i></button>
                 </div>
            </div>
        </div>
    </div>
    
    <!-- MODALS -->
    <div id="share-modal" class="modal-overlay">
        <div class="modal-content">
            <h2 class="text-xl font-bold mb-4">Partager le CV</h2>
            <p class="text-sm text-gray-600 mb-2">Copiez ce lien unique pour partager une version en lecture seule de ce CV.</p>
            <div class="flex items-center border rounded-md p-2 bg-gray-50">
                <input type="text" id="share-link-input" readonly class="flex-grow bg-transparent outline-none text-sm">
                <button id="copy-share-link-btn" class="ml-2 px-3 py-1 bg-blue-500 text-white text-sm rounded-md hover:bg-blue-600">Copier</button>
            </div>
            <div class="text-right mt-4">
                 <button id="close-share-modal" class="px-4 py-2 bg-gray-200 text-sm rounded-md hover:bg-gray-300">Fermer</button>
            </div>
        </div>
    </div>
    
    <div id="icon-picker-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">Choisir une ic√¥ne</h2>
                <button id="close-icon-picker-modal" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
            </div>
            <div class="mb-4">
                <input type="text" id="icon-search-input" placeholder="Rechercher une ic√¥ne..." class="w-full p-2 border rounded-md">
            </div>
            <div id="icon-picker-grid"></div>
        </div>
    </div>

    <div id="confirm-modal" class="modal-overlay">
        <div class="modal-content">
            <h2 id="confirm-modal-title" class="text-xl font-bold mb-4">Confirmation</h2>
            <p id="confirm-modal-text" class="text-gray-600 mb-6">√ätes-vous s√ªr ?</p>
            <div class="flex justify-end gap-4">
                <button id="confirm-modal-cancel-btn" class="px-4 py-2 bg-gray-200 text-sm rounded-md hover:bg-gray-300">Annuler</button>
                <button id="confirm-modal-ok-btn" class="px-4 py-2 bg-red-600 text-white text-sm rounded-md hover:bg-red-700">Confirmer</button>
            </div>
        </div>
    </div>

    <script type="module">
        // This script is now self-contained and does not use Firebase for saving.
        
        document.addEventListener('DOMContentLoaded', function() {
            // --- GLOBAL SELECTORS (STATIC) ---
            const controls = {
                aiInput: document.getElementById('ai-input'), analyzeBtn: document.getElementById('analyze-btn'), loader: document.getElementById('loader-overlay'), loaderText: document.getElementById('loader-text'),
                nom: document.getElementById('nom'), prenom: document.getElementById('prenom'), poste: document.getElementById('poste'),
                description: document.getElementById('description'), competences: document.getElementById('competences'), aiSynthesizeSkillsBtn: document.getElementById('ai-synthesize-skills-btn'),
                experienceList: document.getElementById('experience-list'), addExperienceBtn: document.getElementById('add-experience'),
                formationList: document.getElementById('formation-list'), addFormationBtn: document.getElementById('add-formation'),
                toggleBanner: document.getElementById('toggle-banner-checkbox'), bannerNom: document.getElementById('banner-nom'), bannerPoste: document.getElementById('banner-poste'), bannerEmail: document.getElementById('banner-email'), bannerTel: document.getElementById('banner-tel'), bannerImage: document.getElementById('banner-image'),
                bannerStyleSelect: document.getElementById('banner-style-select'), bannerInvertBtn: document.getElementById('banner-invert-btn'),
                fixBannerTopBtn: document.getElementById('fix-banner-top-btn'), fixBannerBottomBtn: document.getElementById('fix-banner-bottom-btn'), modularBannerBtn: document.getElementById('modular-banner-btn'),
                qualificationDispo: document.getElementById('qualification-dispo'), qualificationSalaire: document.getElementById('qualification-salaire'), qualificationLoc: document.getElementById('qualification-loc'),
                generateMailBtn: document.getElementById('generate-mail-btn'), recruiterMailContent: document.getElementById('recruiter-mail-content'),
                anonymizeBtn: document.getElementById('anonymize-btn'), downloadPdfBtn: document.getElementById('download-pdf-btn'),
                resetCvBtn: document.getElementById('reset-cv-btn'),
                togglePresentationModeBtn: document.getElementById('toggle-presentation-mode-btn'),
                toggleOverflowBtn: document.getElementById('toggle-overflow-btn'),
                collapseAllBtn: document.getElementById('collapse-all-btn'),
                // API Controls
                geminiApiKey: document.getElementById('gemini-api-key'),
                toggleApiKeyVisibility: document.getElementById('toggle-api-key-visibility'),
                saveGeminiApiKey: document.getElementById('save-gemini-api-key'),
                testGeminiApi: document.getElementById('test-gemini-api'),
                testPrompt: document.getElementById('test-prompt'),
                runCustomTest: document.getElementById('run-custom-test'),
                testResults: document.getElementById('test-results'),
                testOutput: document.getElementById('test-output'),
                apiStatus: document.getElementById('api-status'),
                apiStatusIcon: document.getElementById('api-status-icon'),
                apiStatusText: document.getElementById('api-status-text'),
                aiModelSelect: document.getElementById('ai-model-select'),
                aiTemperature: document.getElementById('ai-temperature'),
                temperatureValue: document.getElementById('temperature-value'),
                aiMaxTokens: document.getElementById('ai-max-tokens'),
                maxTokensValue: document.getElementById('max-tokens-value'),
                resetApiSettings: document.getElementById('reset-api-settings'),
                aiSummarizeBtn: document.getElementById('ai-summarize-btn'),
                resetRecruiterBtn: document.getElementById('reset-recruiter-btn'),
                aiLimitSkillsBtn: document.getElementById('ai-limit-skills-btn'),
                pageMargin: document.getElementById('page-margin'), pageMarginValue: document.getElementById('page-margin-value'),
                moduleSpacing: document.getElementById('module-spacing'), moduleSpacingValue: document.getElementById('module-spacing-value'),
                itemSpacing: document.getElementById('item-spacing'), itemSpacingValue: document.getElementById('item-spacing-value'),
                fontSizeH1: document.getElementById('font-size-h1'), fontSizeH1Value: document.getElementById('font-size-h1-value'),
                fontSizeH2: document.getElementById('font-size-h2'), fontSizeH2Value: document.getElementById('font-size-h2-value'),
                fontSizeP: document.getElementById('font-size-p'), fontSizePValue: document.getElementById('font-size-p-value'),
                fontSizeBanner: document.getElementById('font-size-banner'), fontSizeBannerValue: document.getElementById('font-size-banner-value'),
                bannerElementSpacing: document.getElementById('banner-element-spacing'), bannerElementSpacingValue: document.getElementById('banner-element-spacing-value'),
                lineHeight: document.getElementById('line-height'), lineHeightValue: document.getElementById('line-height-value'),
                paragraphSpacing: document.getElementById('paragraph-spacing'), paragraphSpacingValue: document.getElementById('paragraph-spacing-value'),
                randomizeBannerStyleBtn: document.getElementById('randomize-banner-style-btn'),
                bannerNomFont: document.getElementById('banner-nom-font'), bannerNomSize: document.getElementById('banner-nom-size'), bannerNomSizeValue: document.getElementById('banner-nom-size-value'), bannerNomColor: document.getElementById('banner-nom-color'), bannerNomBold: document.getElementById('banner-nom-bold'), bannerNomItalic: document.getElementById('banner-nom-italic'),
                bannerPosteSize: document.getElementById('banner-poste-size'), bannerPosteSizeValue: document.getElementById('banner-poste-size-value'), bannerPosteColor: document.getElementById('banner-poste-color'), bannerPosteBold: document.getElementById('banner-poste-bold'), bannerPosteItalic: document.getElementById('banner-poste-italic'),
                bannerContactSize: document.getElementById('banner-contact-size'), bannerContactSizeValue: document.getElementById('banner-contact-size-value'), bannerContactColor: document.getElementById('banner-contact-color'), bannerContactBold: document.getElementById('banner-contact-bold'), bannerContactItalic: document.getElementById('banner-contact-italic'),
                undoBtn: document.getElementById('undo-btn'), redoBtn: document.getElementById('redo-btn'),
                addSectionBtn: document.getElementById('add-section-btn'), customSectionsList: document.getElementById('custom-sections-list'), sectionSuggestionSelect: document.getElementById('section-suggestion-select'), newSectionTitleInput: document.getElementById('new-section-title-input'),
                primaryColorPicker: document.getElementById('primary-color-picker'),
                secondaryColorPicker: document.getElementById('secondary-color-picker'),
                aiColorBtn: document.getElementById('ai-color-btn'),
                bodyTextColorPicker: document.getElementById('body-text-color-picker'),
                fontFamilyH1Select: document.getElementById('font-family-h1-select'),
                fontFamilyH2Select: document.getElementById('font-family-h2-select'),
                fontFamilyBodySelect: document.getElementById('font-family-body-select'),
                shareBtn: document.getElementById('share-btn'), shareModal: document.getElementById('share-modal'), closeShareModal: document.getElementById('close-share-modal'), shareLinkInput: document.getElementById('share-link-input'), copyShareLinkBtn: document.getElementById('copy-share-link-btn'),
                iconPickerModal: document.getElementById('icon-picker-modal'), closeIconPickerModal: document.getElementById('close-icon-picker-modal'), iconPickerGrid: document.getElementById('icon-picker-grid'), iconSearchInput: document.getElementById('icon-search-input'),
                addPageBtn: document.getElementById('add-page-btn'),
                bannerBgImage: document.getElementById('banner-bg-image'),
                bannerBgOpacity: document.getElementById('banner-bg-opacity'),
                bannerBgOpacityValue: document.getElementById('banner-bg-opacity-value'),
                bannerBgBlur: document.getElementById('banner-bg-blur'),
                bannerBgBlurValue: document.getElementById('banner-bg-blur-value'),
                bannerBgGrayscale: document.getElementById('banner-bg-grayscale'),
                removeBannerBgBtn: document.getElementById('remove-banner-bg-btn'),
                skillsTextControls: document.getElementById('skills-text-controls'),
                skillsLevelControls: document.getElementById('skills-level-controls'),
                skillsLevelList: document.getElementById('skills-level-list'),
                addSkillLevelBtn: document.getElementById('add-skill-level-btn'),
                confirmModal: {
                    overlay: document.getElementById('confirm-modal'),
                    title: document.getElementById('confirm-modal-title'),
                    text: document.getElementById('confirm-modal-text'),
                    okBtn: document.getElementById('confirm-modal-ok-btn'),
                    cancelBtn: document.getElementById('confirm-modal-cancel-btn'),
                }
            };

            // --- DYNAMIC SELECTORS ---
            let preview = {};
            function reinitializePreviewSelectors() {
                preview.previewWrapper = document.getElementById('cv-preview-wrapper');
                preview.cvNomPrenom = document.getElementById('cv-nom-prenom-preview');
                preview.cvPoste = document.getElementById('cv-poste-preview');
                preview.cvDescription = document.getElementById('cv-description-preview');
                preview.cvFormation = document.getElementById('cv-formation-preview');
                preview.cvCompetences = document.getElementById('cv-competences-preview');
                preview.cvExperience = document.getElementById('cv-experience-preview');
                preview.bannerModule = document.getElementById('banner-module');
                preview.banner = document.getElementById('recruiter-banner');
                preview.bannerImg = document.getElementById('banner-img-preview');
                preview.bannerNom = document.getElementById('banner-nom-preview');
                preview.bannerPoste = document.getElementById('banner-poste-preview');
                preview.bannerContact = document.getElementById('banner-contact-preview');
                preview.bannerEmail = document.getElementById('banner-email-preview');
                preview.bannerTel = document.getElementById('banner-tel-preview');
                preview.qualificationModule = document.getElementById('qualification-module');
                preview.qualificationPreview = document.getElementById('qualification-preview');
                preview.fixedBannerTop = document.getElementById('fixed-banner-top');
                preview.fixedBannerBottom = document.getElementById('fixed-banner-bottom');
                preview.bannerBgImg = document.getElementById('banner-bg-img-preview');
            }
            
            // --- CONFIGURATION OBJECTS ---
            const sliders = {
                bannerElementSpacing: { el: controls.bannerElementSpacing, valueEl: controls.bannerElementSpacingValue, property: '--banner-element-spacing', unit: 'rem' },
                // Comment√© temporairement les sliders qui n'existent plus dans l'interface actuelle
                // pageMargin: { el: controls.pageMargin, valueEl: controls.pageMarginValue, property: '--page-margin', unit: 'cm' },
                // moduleSpacing: { el: controls.moduleSpacing, valueEl: controls.moduleSpacingValue, property: '--module-spacing', unit: 'rem' },
                // itemSpacing: { el: controls.itemSpacing, valueEl: controls.itemSpacingValue, property: '--item-spacing', unit: 'rem' },
                // fontSizeH1: { el: controls.fontSizeH1, valueEl: controls.fontSizeH1Value, property: '--font-size-h1', unit: 'pt' },
                // fontSizeH2: { el: controls.fontSizeH2, valueEl: controls.fontSizeH2Value, property: '--font-size-h2', unit: 'pt' },
                // fontSizeP: { el: controls.fontSizeP, valueEl: controls.fontSizePValue, property: '--font-size-p', unit: 'pt' },
                // fontSizeBanner: { el: controls.fontSizeBanner, valueEl: controls.fontSizeBannerValue, property: '--font-size-banner', unit: 'pt' },
                // lineHeight: { el: controls.lineHeight, valueEl: controls.lineHeightValue, property: '--line-height', unit: '' },
                // paragraphSpacing: { el: controls.paragraphSpacing, valueEl: controls.paragraphSpacingValue, property: '--paragraph-spacing', unit: 'rem' },
            };

            const bannerStyleControls = {
                nomFont: { el: controls.bannerNomFont, event: 'change', stateKey: 'nomFont' },
                nomSize: { el: controls.bannerNomSize, event: 'input', valueEl: controls.bannerNomSizeValue, stateKey: 'nomSize' },
                nomColor: { el: controls.bannerNomColor, event: 'input', stateKey: 'nomColor' },
                nomBold: { el: controls.bannerNomBold, event: 'click', toggle: true, stateKey: 'nomBold' },
                nomItalic: { el: controls.bannerNomItalic, event: 'click', toggle: true, stateKey: 'nomItalic' },
                posteSize: { el: controls.bannerPosteSize, event: 'input', valueEl: controls.bannerPosteSizeValue, stateKey: 'posteSize' },
                posteColor: { el: controls.bannerPosteColor, event: 'input', stateKey: 'posteColor' },
                posteBold: { el: controls.bannerPosteBold, event: 'click', toggle: true, stateKey: 'posteBold' },
                posteItalic: { el: controls.bannerPosteItalic, event: 'click', toggle: true, stateKey: 'posteItalic' },
                contactSize: { el: controls.bannerContactSize, event: 'input', valueEl: controls.bannerContactSizeValue, stateKey: 'contactSize' },
                contactColor: { el: controls.bannerContactColor, event: 'input', stateKey: 'contactColor' },
                contactBold: { el: controls.bannerContactBold, event: 'click', toggle: true, stateKey: 'contactBold' },
                contactItalic: { el: controls.bannerContactItalic, event: 'click', toggle: true, stateKey: 'contactItalic' },
            };

            const themes = {
                professional: {
                    primaryColor: '#2563eb', secondaryColor: '#334155', bodyTextColor: '#334155',
                    fontH1: "'Montserrat', sans-serif", fontH2: "'Montserrat', sans-serif", fontBody: "'Lato', sans-serif"
                },
                creative: {
                    primaryColor: '#db2777', secondaryColor: '#4f46e5', bodyTextColor: '#44403c',
                    fontH1: "'Playfair Display', serif", fontH2: "'Oswald', sans-serif", fontBody: "'Nunito Sans', sans-serif"
                },
                modern: {
                    primaryColor: '#16a34a', secondaryColor: '#1f2937', bodyTextColor: '#374151',
                    fontH1: "'Oswald', sans-serif", fontH2: "'Source Sans Pro', sans-serif", fontBody: "'Source Sans Pro', sans-serif"
                }
            };
            
            // --- GLOBAL STATE VARIABLES ---
            let pageCounter = 1;
            let customSectionCounter = 0;
            const root = document.documentElement;
            let isAnonymized = false;
            let originalData = {};
            let isRestoringState = false; 
            let activeIconTarget = null;
            
            // --- UI UTILITIES ---
            function showLoader(text = "Chargement...") {
                controls.loaderText.textContent = text;
                controls.loader.classList.remove('hidden');
                controls.loader.classList.add('flex');
            }

            function hideLoader() {
                controls.loader.classList.add('hidden');
                controls.loader.classList.remove('flex');
            }

            function showNotification(message, type = 'success', duration = 3000) {
                const toast = document.createElement('div');
                const icon = type === 'error' ? 'fa-times-circle text-red-500' : 'fa-check-circle text-green-500';
                toast.className = 'toast';
                toast.innerHTML = `<i class="fas ${icon}"></i><span>${message}</span>`;
                document.getElementById('notification').appendChild(toast);
                setTimeout(() => toast.classList.add('show'), 10);
                setTimeout(() => {
                    toast.classList.remove('show');
                    toast.addEventListener('transitionend', () => toast.remove());
                }, duration);
            }
            
            // === GEMINI API FUNCTIONS ===
            
            // Configuration API
            const GEMINI_CONFIG = {
                baseUrl: 'https://generativelanguage.googleapis.com/v1beta/models/',
                models: {
                    'gemini-1.5-flash': 'gemini-1.5-flash-latest',
                    'gemini-1.5-pro': 'gemini-1.5-pro-latest', 
                    'gemini-pro': 'gemini-pro'
                }
            };
            
            // Sauvegarder la cl√© API
            function saveGeminiApiKey() {
                const apiKey = controls.geminiApiKey?.value?.trim();
                if (!apiKey) {
                    showNotification('Veuillez saisir une cl√© API valide', 'error');
                    return;
                }
                
                if (!apiKey.startsWith('AIza')) {
                    showNotification('Format de cl√© API invalide. La cl√© doit commencer par "AIza"', 'error');
                    return;
                }
                
                try {
                    localStorage.setItem('gemini-api-key', apiKey);
                    showNotification('Cl√© API sauvegard√©e avec succ√®s', 'success');
                    updateApiStatus('saved', 'Cl√© API sauvegard√©e');
                } catch (error) {
                    showNotification('Erreur lors de la sauvegarde', 'error');
                }
            }
            
            // Charger la cl√© API
            function loadGeminiApiKey() {
                const savedKey = localStorage.getItem('gemini-api-key');
                if (savedKey && controls.geminiApiKey) {
                    controls.geminiApiKey.value = savedKey;
                    updateApiStatus('loaded', 'Cl√© API charg√©e');
                }
            }

            // Fonctions utilitaires pour les g√©n√©rateurs de styles
            function applyLayoutSettings(layout) {
                if (layout.columns) {
                    document.querySelectorAll('.column-btn').forEach(btn => btn.classList.remove('active'));
                    const colBtn = document.querySelector(`[data-columns="${layout.columns}"]`);
                    if (colBtn) colBtn.classList.add('active');
                    controls.columns = layout.columns;
                }
                if (layout.columnGap) {
                    const slider = document.getElementById('column-gap-slider');
                    if (slider) {
                        slider.value = layout.columnGap;
                        document.getElementById('column-gap-value').textContent = layout.columnGap;
                    }
                }
                if (layout.sectionSpacing) {
                    const slider = document.getElementById('section-spacing-slider');
                    if (slider) {
                        slider.value = layout.sectionSpacing;
                        document.getElementById('section-spacing-value').textContent = layout.sectionSpacing;
                    }
                }
                ['marginTop', 'marginBottom', 'marginLeft', 'marginRight'].forEach(margin => {
                    if (layout[margin]) {
                        const slider = document.getElementById(`${margin.toLowerCase().replace('margin', 'margin-')}-slider`);
                        if (slider) {
                            slider.value = layout[margin];
                            document.getElementById(`${margin.toLowerCase().replace('margin', 'margin-')}-value`).textContent = layout[margin];
                        }
                    }
                });
                if (layout.fontSize) {
                    document.querySelectorAll('.font-size-btn').forEach(btn => btn.classList.remove('active'));
                    const sizeBtn = document.querySelector(`[data-font-size="${layout.fontSize}"]`);
                    if (sizeBtn) sizeBtn.classList.add('active');
                }
                if (layout.lineHeight) {
                    document.querySelectorAll('.line-height-btn').forEach(btn => btn.classList.remove('active'));
                    const heightBtn = document.querySelector(`[data-line-height="${layout.lineHeight}"]`);
                    if (heightBtn) heightBtn.classList.add('active');
                }
                if (layout.alignment) {
                    document.querySelectorAll('.alignment-btn').forEach(btn => btn.classList.remove('active'));
                    const alignBtn = document.querySelector(`[data-alignment="${layout.alignment}"]`);
                    if (alignBtn) alignBtn.classList.add('active');
                }
                updateLayoutInPreview();
            }

            function applyStyleSettings(style) {
                if (style.primaryColor) {
                    document.getElementById('primary-color-picker').value = style.primaryColor;
                }
                if (style.secondaryColor) {
                    document.getElementById('secondary-color-picker').value = style.secondaryColor;
                }
                if (style.accentColor) {
                    document.getElementById('accent-color-picker').value = style.accentColor;
                }
                if (style.neutralColor) {
                    document.getElementById('neutral-color-picker').value = style.neutralColor;
                }
                if (style.backgroundColor) {
                    document.getElementById('background-color-picker').value = style.backgroundColor;
                }
                if (style.textColor) {
                    document.getElementById('text-color-picker').value = style.textColor;
                }
                
                // Appliquer les polices
                ['H1', 'H2', 'H3', 'Body', 'Accent'].forEach(type => {
                    const key = `font${type}`;
                    if (style[key]) {
                        const select = document.getElementById(`font-family-${type.toLowerCase()}-select`);
                        if (select) select.value = style[key];
                    }
                });

                // Appliquer le style de titre
                if (style.titleStyle) {
                    document.querySelectorAll('.section-title-style-btn').forEach(btn => btn.classList.remove('active'));
                    const titleBtn = document.querySelector(`[data-title-style="${style.titleStyle}"]`);
                    if (titleBtn) titleBtn.classList.add('active');
                }

                // Appliquer les effets
                if (style.effects) {
                    Object.keys(style.effects).forEach(effect => {
                        const checkbox = document.getElementById(`global-${effect}`);
                        if (checkbox) checkbox.checked = style.effects[effect];
                    });
                }

                updateStylesInPreview();
            }

            function updateLayoutInPreview() {
                // Mise √† jour du layout dans la pr√©visualisation
                const preview = document.getElementById('cv-preview');
                if (preview) {
                    // Appliquer les styles de layout
                    const root = document.documentElement;
                    const columnGap = document.getElementById('column-gap-slider')?.value || 20;
                    const sectionSpacing = document.getElementById('section-spacing-slider')?.value || 20;
                    
                    root.style.setProperty('--column-gap', `${columnGap}px`);
                    root.style.setProperty('--section-spacing', `${sectionSpacing}px`);
                    
                    ['top', 'bottom', 'left', 'right'].forEach(side => {
                        const value = document.getElementById(`margin-${side}-slider`)?.value || 20;
                        root.style.setProperty(`--margin-${side}`, `${value}px`);
                    });
                }
            }

            function updateStylesInPreview() {
                // Mise √† jour des styles dans la pr√©visualisation
                const root = document.documentElement;
                
                // Appliquer les couleurs
                ['primary', 'secondary', 'accent', 'neutral', 'background', 'text'].forEach(color => {
                    const picker = document.getElementById(`${color}-color-picker`);
                    if (picker) {
                        root.style.setProperty(`--color-${color}`, picker.value);
                    }
                });

                // Appliquer les polices
                ['h1', 'h2', 'h3', 'body', 'accent'].forEach(type => {
                    const select = document.getElementById(`font-family-${type}-select`);
                    if (select && select.value) {
                        root.style.setProperty(`--font-${type}`, select.value);
                    }
                });
            }

            // Fonctions utilitaires suppl√©mentaires pour les styles
            function applyPredefinedPalette(paletteName) {
                const palettes = {
                    ocean: {
                        primaryColor: '#0ea5e9',
                        secondaryColor: '#06b6d4',
                        accentColor: '#10b981',
                        neutralColor: '#64748b',
                        backgroundColor: '#f0f9ff',
                        textColor: '#0f172a'
                    },
                    sunset: {
                        primaryColor: '#f59e0b',
                        secondaryColor: '#ef4444',
                        accentColor: '#ec4899',
                        neutralColor: '#6b7280',
                        backgroundColor: '#fffbeb',
                        textColor: '#1c1917'
                    },
                    forest: {
                        primaryColor: '#16a34a',
                        secondaryColor: '#84cc16',
                        accentColor: '#65a30d',
                        neutralColor: '#78716c',
                        backgroundColor: '#f7fee7',
                        textColor: '#1c1917'
                    },
                    royal: {
                        primaryColor: '#7c3aed',
                        secondaryColor: '#a855f7',
                        accentColor: '#3b82f6',
                        neutralColor: '#64748b',
                        backgroundColor: '#faf5ff',
                        textColor: '#1e1b4b'
                    },
                    autumn: {
                        primaryColor: '#dc2626',
                        secondaryColor: '#ea580c',
                        accentColor: '#d97706',
                        neutralColor: '#78716c',
                        backgroundColor: '#fef2f2',
                        textColor: '#1c1917'
                    },
                    mono: {
                        primaryColor: '#374151',
                        secondaryColor: '#6b7280',
                        accentColor: '#9ca3af',
                        neutralColor: '#d1d5db',
                        backgroundColor: '#ffffff',
                        textColor: '#111827'
                    },
                    pastel: {
                        primaryColor: '#fbbf24',
                        secondaryColor: '#f472b6',
                        accentColor: '#a78bfa',
                        neutralColor: '#9ca3af',
                        backgroundColor: '#fefce8',
                        textColor: '#1f2937'
                    },
                    neon: {
                        primaryColor: '#06ffa5',
                        secondaryColor: '#00d4ff',
                        accentColor: '#ff006e',
                        neutralColor: '#64748b',
                        backgroundColor: '#0f0f23',
                        textColor: '#f1f5f9'
                    }
                };

                const palette = palettes[paletteName];
                if (palette) {
                    applyStyleSettings(palette);
                    showToast(`Palette ${paletteName} appliqu√©e üé®`, "success");
                }
            }

            function applyBackgroundPattern(patternName) {
                const root = document.documentElement;
                const patterns = {
                    none: 'none',
                    dots: 'radial-gradient(circle, var(--color-neutral) 1px, transparent 1px)',
                    lines: 'linear-gradient(90deg, var(--color-neutral) 1px, transparent 1px)',
                    grid: 'linear-gradient(var(--color-neutral) 1px, transparent 1px), linear-gradient(90deg, var(--color-neutral) 1px, transparent 1px)',
                    waves: 'repeating-linear-gradient(45deg, transparent, transparent 10px, var(--color-neutral) 10px, var(--color-neutral) 20px)',
                    geometric: 'repeating-conic-gradient(var(--color-neutral) 0% 25%, transparent 0% 50%)'
                };

                root.style.setProperty('--background-pattern', patterns[patternName] || 'none');
                showToast(`Motif ${patternName} appliqu√©`, "success");
            }

            async function generateHarmoniousColors() {
                const fallbackFunction = () => {
                    // Palettes harmonieuses pr√©-d√©finies
                    const harmoniousPalettes = [
                        { primaryColor: '#2563eb', secondaryColor: '#1e40af', accentColor: '#3b82f6', neutralColor: '#64748b', backgroundColor: '#f8fafc', textColor: '#1e293b' },
                        { primaryColor: '#dc2626', secondaryColor: '#b91c1c', accentColor: '#ef4444', neutralColor: '#6b7280', backgroundColor: '#fef2f2', textColor: '#1f2937' },
                        { primaryColor: '#059669', secondaryColor: '#047857', accentColor: '#10b981', neutralColor: '#6b7280', backgroundColor: '#f0fdf4', textColor: '#1f2937' },
                        { primaryColor: '#7c3aed', secondaryColor: '#6d28d9', accentColor: '#8b5cf6', neutralColor: '#6b7280', backgroundColor: '#faf5ff', textColor: '#1f2937' }
                    ];
                    const randomPalette = harmoniousPalettes[Math.floor(Math.random() * harmoniousPalettes.length)];
                    applyStyleSettings(randomPalette);
                    return "Couleurs harmonieuses appliqu√©es (mode fallback)";
                };

                try {
                    const prompt = "G√©n√®re une palette de 6 couleurs harmonieuses pour un CV professionnel. R√©ponds avec un objet JSON contenant: primaryColor, secondaryColor, accentColor, neutralColor, backgroundColor, textColor (toutes en hex).";
                    const response = await callAIWithFallback(prompt, fallbackFunction);
                    if (typeof response === 'string' && response.includes('fallback')) {
                        showToast(response, "success");
                    } else {
                        const colors = JSON.parse(response);
                        applyStyleSettings(colors);
                        showToast("Couleurs harmonieuses g√©n√©r√©es par IA üé®", "success");
                    }
                } catch (error) {
                    console.error('Erreur g√©n√©ration couleurs:', error);
                    fallbackFunction();
                    showToast("Couleurs harmonieuses appliqu√©es (fallback) üé®", "success");
                }
            }

            async function generateContrastColors() {
                const fallbackFunction = () => {
                    // Palettes √† fort contraste pr√©-d√©finies
                    const contrastPalettes = [
                        { primaryColor: '#000000', secondaryColor: '#ffffff', accentColor: '#ff0000', neutralColor: '#808080', backgroundColor: '#ffffff', textColor: '#000000' },
                        { primaryColor: '#ffffff', secondaryColor: '#000000', accentColor: '#00ff00', neutralColor: '#808080', backgroundColor: '#000000', textColor: '#ffffff' },
                        { primaryColor: '#ffff00', secondaryColor: '#000080', accentColor: '#ff00ff', neutralColor: '#808080', backgroundColor: '#ffffff', textColor: '#000000' }
                    ];
                    const randomPalette = contrastPalettes[Math.floor(Math.random() * contrastPalettes.length)];
                    applyStyleSettings(randomPalette);
                    return "Couleurs contrast√©es appliqu√©es (mode fallback)";
                };

                try {
                    const prompt = "G√©n√®re une palette de 6 couleurs √† fort contraste pour un CV moderne et impactant. R√©ponds avec un objet JSON contenant: primaryColor, secondaryColor, accentColor, neutralColor, backgroundColor, textColor (toutes en hex).";
                    const response = await callAIWithFallback(prompt, fallbackFunction);
                    if (typeof response === 'string' && response.includes('fallback')) {
                        showToast(response, "success");
                    } else {
                        const colors = JSON.parse(response);
                        applyStyleSettings(colors);
                        showToast("Couleurs contrast√©es g√©n√©r√©es par IA ‚ö°", "success");
                    }
                } catch (error) {
                    console.error('Erreur g√©n√©ration couleurs:', error);
                    fallbackFunction();
                    showToast("Couleurs contrast√©es appliqu√©es (fallback) ‚ö°", "success");
                }
            }

            function generateRandomPalette() {
                const colors = ['#ef4444', '#f97316', '#eab308', '#22c55e', '#06b6d4', '#3b82f6', '#8b5cf6', '#ec4899', '#f43f5e', '#10b981', '#f59e0b', '#84cc16', '#06b6d4', '#6366f1', '#8b5cf6', '#d946ef'];
                const randomColors = {
                    primaryColor: colors[Math.floor(Math.random() * colors.length)],
                    secondaryColor: colors[Math.floor(Math.random() * colors.length)],
                    accentColor: colors[Math.floor(Math.random() * colors.length)],
                    neutralColor: '#6b7280',
                    backgroundColor: '#ffffff',
                    textColor: '#1f2937'
                };
                applyStyleSettings(randomColors);
                showToast("Palette al√©atoire appliqu√©e üé≤", "success");
            }

            async function generateAIFontPairing() {
                const fallbackFunction = () => {
                    // Combinaisons de polices pr√©-d√©finies harmonieuses
                    const fontPairings = [
                        { fontH1: 'Playfair Display', fontH2: 'Source Sans Pro', fontH3: 'Source Sans Pro', fontBody: 'Source Sans Pro', fontAccent: 'Playfair Display' },
                        { fontH1: 'Merriweather', fontH2: 'Open Sans', fontH3: 'Open Sans', fontBody: 'Open Sans', fontAccent: 'Merriweather' },
                        { fontH1: 'Cormorant Garamond', fontH2: 'Lato', fontH3: 'Lato', fontBody: 'Lato', fontAccent: 'Cormorant Garamond' },
                        { fontH1: 'Crimson Text', fontH2: 'Nunito', fontH3: 'Nunito', fontBody: 'Nunito', fontAccent: 'Crimson Text' }
                    ];
                    const randomPairing = fontPairings[Math.floor(Math.random() * fontPairings.length)];
                    applyStyleSettings(randomPairing);
                    return "Pairing de polices appliqu√© (mode fallback)";
                };

                try {
                    const fontList = fonts.map(f => f.name).join(', ');
                    const prompt = `Choisir une combinaison harmonieuse de 5 polices pour un CV professionnel parmi: ${fontList}. R√©ponds avec un objet JSON contenant: fontH1, fontH2, fontH3, fontBody, fontAccent.`;
                    const response = await callAIWithFallback(prompt, fallbackFunction);
                    if (typeof response === 'string' && response.includes('fallback')) {
                        showToast(response, "success");
                    } else {
                        const fontPairing = JSON.parse(response);
                        applyStyleSettings(fontPairing);
                        showToast("Pairing de polices g√©n√©r√© par IA ü§ñ", "success");
                    }
                } catch (error) {
                    console.error('Erreur g√©n√©ration polices:', error);
                    fallbackFunction();
                    showToast("Pairing de polices appliqu√© (fallback) ü§ñ", "success");
                }
            }
            
            // Basculer la visibilit√© de la cl√©
            function toggleApiKeyVisibility() {
                if (!controls.geminiApiKey || !controls.toggleApiKeyVisibility) return;
                
                if (controls.geminiApiKey.type === 'password') {
                    controls.geminiApiKey.type = 'text';
                    controls.toggleApiKeyVisibility.innerHTML = '<i class="fa-solid fa-eye-slash"></i>';
                } else {
                    controls.geminiApiKey.type = 'password';
                    controls.toggleApiKeyVisibility.innerHTML = '<i class="fa-solid fa-eye"></i>';
                }
            }
            
            // Mettre √† jour le statut de l'API
            function updateApiStatus(type, message) {
                if (!controls.apiStatus) return;
                
                controls.apiStatus.classList.remove('hidden');
                
                const statusConfig = {
                    'saved': { color: 'text-green-700 bg-green-100 border-green-200', icon: 'fa-check-circle text-green-600' },
                    'loaded': { color: 'text-blue-700 bg-blue-100 border-blue-200', icon: 'fa-info-circle text-blue-600' },
                    'testing': { color: 'text-yellow-700 bg-yellow-100 border-yellow-200', icon: 'fa-spinner fa-spin text-yellow-600' },
                    'success': { color: 'text-green-700 bg-green-100 border-green-200', icon: 'fa-check-circle text-green-600' },
                    'error': { color: 'text-red-700 bg-red-100 border-red-200', icon: 'fa-exclamation-circle text-red-600' }
                };
                
                const config = statusConfig[type] || statusConfig.error;
                controls.apiStatus.className = `p-3 rounded-md border ${config.color}`;
                controls.apiStatusIcon.className = `fas ${config.icon}`;
                controls.apiStatusText.textContent = message;
                
                // Mettre √† jour le quota en m√™me temps
                updateQuotaStatus();
            }

            // Mettre √† jour le statut du quota
            function updateQuotaStatus() {
                const quotaStatusEl = document.getElementById('quota-status');
                const quotaDetailsEl = document.getElementById('quota-details');
                const quotaResetInfoEl = document.getElementById('quota-reset-info');
                const quotaResetTimeEl = document.getElementById('quota-reset-time');
                
                if (!quotaStatusEl) return;

                if (isQuotaExceeded()) {
                    const retryAfter = localStorage.getItem('gemini-retry-after');
                    if (retryAfter) {
                        const retryTime = new Date(parseInt(retryAfter));
                        const now = new Date();
                        const diffHours = Math.ceil((retryTime - now) / (1000 * 60 * 60));
                        
                        quotaStatusEl.textContent = 'Quota D√©pass√©';
                        quotaStatusEl.className = 'text-xs px-2 py-1 rounded-full bg-red-100 text-red-700';
                        
                        if (quotaDetailsEl) quotaDetailsEl.classList.remove('hidden');
                        if (quotaResetInfoEl) {
                            quotaResetInfoEl.classList.remove('hidden');
                            if (quotaResetTimeEl) {
                                quotaResetTimeEl.textContent = `${retryTime.toLocaleString()} (dans ${diffHours}h)`;
                            }
                        }
                    }
                } else {
                    quotaStatusEl.textContent = 'Disponible';
                    quotaStatusEl.className = 'text-xs px-2 py-1 rounded-full bg-green-100 text-green-700';
                    
                    if (quotaDetailsEl) quotaDetailsEl.classList.remove('hidden');
                    if (quotaResetInfoEl) quotaResetInfoEl.classList.add('hidden');
                }
            }

            // V√©rifier le statut du quota
            async function checkQuotaStatus() {
                const checkBtn = document.getElementById('check-quota-status');
                if (checkBtn) {
                    checkBtn.disabled = true;
                    checkBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> V√©rification...';
                }

                try {
                    if (isQuotaExceeded()) {
                        showNotification('‚ö†Ô∏è Quota API encore d√©pass√©. Mode fallback actif.', 'warning');
                    } else {
                        // Faire un test l√©ger pour v√©rifier le quota
                        await callGeminiAPI('Test quota', { maxTokens: 10 });
                        showNotification('‚úÖ Quota API disponible', 'success');
                    }
                } catch (error) {
                    if (error.message === 'QUOTA_EXCEEDED' || error.message.includes('QUOTA_EXCEEDED')) {
                        showNotification('‚ùå Quota API d√©pass√©. Utilisation du mode fallback.', 'error');
                    } else {
                        showNotification(`‚ùå Erreur API: ${error.message}`, 'error');
                    }
                } finally {
                    updateQuotaStatus();
                    if (checkBtn) {
                        checkBtn.disabled = false;
                        checkBtn.innerHTML = '<i class="fas fa-chart-line"></i> V√©rifier Quota';
                    }
                }
            }
            
            // Appel √† l'API Gemini avec gestion avanc√©e des erreurs
            async function callGeminiAPI(prompt, options = {}) {
                const apiKey = localStorage.getItem('gemini-api-key');
                if (!apiKey) {
                    throw new Error('Cl√© API non configur√©e');
                }

                // V√©rifier si le quota est encore d√©pass√©
                if (isQuotaExceeded()) {
                    const retryAfter = localStorage.getItem('gemini-retry-after');
                    const retryTime = new Date(parseInt(retryAfter));
                    throw new Error(`QUOTA_EXCEEDED: Quota d√©pass√©. Prochaine tentative possible √† ${retryTime.toLocaleString()}`);
                }
                
                const model = options.model || controls.aiModelSelect?.value || 'gemini-1.5-flash';
                const temperature = options.temperature || parseFloat(controls.aiTemperature?.value || '0.7');
                const maxTokens = options.maxTokens || parseInt(controls.aiMaxTokens?.value || '1000');
                const retries = options.retries || 3;
                
                const modelName = GEMINI_CONFIG.models[model] || model;
                const url = `${GEMINI_CONFIG.baseUrl}${modelName}:generateContent?key=${apiKey}`;
                
                const requestBody = {
                    contents: [{
                        parts: [{ text: prompt }]
                    }],
                    generationConfig: {
                        temperature: temperature,
                        maxOutputTokens: maxTokens,
                        topP: 0.95,
                        topK: 64,
                    },
                    safetySettings: [
                        {
                            category: "HARM_CATEGORY_HARASSMENT",
                            threshold: "BLOCK_MEDIUM_AND_ABOVE"
                        },
                        {
                            category: "HARM_CATEGORY_HATE_SPEECH",
                            threshold: "BLOCK_MEDIUM_AND_ABOVE"
                        },
                        {
                            category: "HARM_CATEGORY_SEXUALLY_EXPLICIT",
                            threshold: "BLOCK_MEDIUM_AND_ABOVE"
                        },
                        {
                            category: "HARM_CATEGORY_DANGEROUS_CONTENT",
                            threshold: "BLOCK_MEDIUM_AND_ABOVE"
                        }
                    ]
                };

                for (let attempt = 1; attempt <= retries; attempt++) {
                    try {
                        const response = await fetch(url, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(requestBody)
                        });

                        if (!response.ok) {
                            const errorData = await response.text();
                            let errorObj;
                            try {
                                errorObj = JSON.parse(errorData);
                            } catch (e) {
                                errorObj = { error: { message: errorData } };
                            }

                            // Gestion sp√©cifique des erreurs de quota
                            if (response.status === 429) {
                                const retryAfter = extractRetryAfter(errorObj) || 86400000; // 24h par d√©faut
                                localStorage.setItem('gemini-quota-exceeded', Date.now().toString());
                                localStorage.setItem('gemini-retry-after', (Date.now() + retryAfter).toString());
                                
                                const quotaError = new Error('QUOTA_EXCEEDED');
                                quotaError.originalError = errorObj;
                                quotaError.retryAfter = retryAfter;
                                throw quotaError;
                            }

                            throw new Error(`Erreur API: ${response.status} - ${errorObj.error?.message || errorData}`);
                        }

                        const data = await response.json();
                        
                        if (!data.candidates || !data.candidates[0]?.content?.parts?.[0]?.text) {
                            throw new Error('R√©ponse invalide de l\'API');
                        }

                        return data.candidates[0].content.parts[0].text;
                    } catch (error) {
                        console.error(`Tentative ${attempt} √©chou√©e:`, error);
                        
                        // Si c'est une erreur de quota, ne pas retry
                        if (error.message === 'QUOTA_EXCEEDED') {
                            throw error;
                        }
                        
                        if (attempt === retries) {
                            throw error;
                        }
                        
                        // Attendre avant de r√©essayer (backoff exponentiel)
                        await new Promise(resolve => setTimeout(resolve, 1000 * Math.pow(2, attempt - 1)));
                    }
                }
            }

            // Fonction pour extraire le d√©lai de retry des erreurs de quota
            function extractRetryAfter(errorObj) {
                if (errorObj?.error?.details) {
                    for (const detail of errorObj.error.details) {
                        if (detail['@type'] === 'type.googleapis.com/google.rpc.RetryInfo' && detail.retryDelay) {
                            const delay = detail.retryDelay;
                            if (delay.endsWith('s')) {
                                return parseInt(delay.slice(0, -1)) * 1000; // Convertir en millisecondes
                            }
                        }
                    }
                }
                return 86400000; // 24h par d√©faut
            }

            // V√©rifier si le quota est encore d√©pass√©
            function isQuotaExceeded() {
                const quotaExceeded = localStorage.getItem('gemini-quota-exceeded');
                const retryAfter = localStorage.getItem('gemini-retry-after');
                
                if (!quotaExceeded || !retryAfter) return false;
                
                const now = Date.now();
                const retryTime = parseInt(retryAfter);
                
                if (now >= retryTime) {
                    // Le d√©lai est √©coul√©, nettoyer le localStorage
                    localStorage.removeItem('gemini-quota-exceeded');
                    localStorage.removeItem('gemini-retry-after');
                    return false;
                }
                
                return true;
            }

            // Fonction wrapper avec fallback automatique
            async function callAIWithFallback(prompt, fallbackFunction = null, options = {}) {
                try {
                    return await callGeminiAPI(prompt, options);
                } catch (error) {
                    console.error('Erreur API Gemini:', error);
                    
                    if (error.message === 'QUOTA_EXCEEDED' || error.message.includes('QUOTA_EXCEEDED')) {
                        const retryAfter = error.retryAfter ? Math.ceil(error.retryAfter / 1000 / 60) : 1440; // en minutes
                        showNotification(`‚ö†Ô∏è Quota API d√©pass√©. Prochaine tentative dans ${retryAfter} minutes. Mode fallback activ√©.`, 'warning');
                    } else {
                        showNotification(`‚ùå Erreur IA: ${error.message}. Mode fallback activ√©.`, 'error');
                    }
                    
                    // Ex√©cuter la fonction fallback si fournie
                    if (fallbackFunction && typeof fallbackFunction === 'function') {
                        showToast("Mode fallback activ√© - g√©n√©ration alternative", "info");
                        return fallbackFunction();
                    }
                    
                    throw error;
                }
            }
            
            // Tester la connexion API
            async function testGeminiApi() {
                if (!controls.testGeminiApi) return;
                
                updateApiStatus('testing', 'Test de la connexion en cours...');
                
                try {
                    const testPrompt = "R√©ponds simplement 'Test r√©ussi' si tu re√ßois ce message.";
                    const result = await callGeminiAPI(testPrompt);
                    
                    if (result.toLowerCase().includes('test')) {
                        updateApiStatus('success', 'Connexion API r√©ussie !');
                        showNotification('API Gemini connect√©e avec succ√®s', 'success');
                    } else {
                        updateApiStatus('success', 'API connect√©e (r√©ponse inattendue)');
                        showNotification('API connect√©e mais r√©ponse inattendue', 'warning');
                    }
                } catch (error) {
                    updateApiStatus('error', `Erreur: ${error.message}`);
                    showNotification(`Erreur de connexion: ${error.message}`, 'error');
                }
            }
            
            // Test personnalis√©
            async function runCustomTest() {
                const prompt = controls.testPrompt?.value?.trim();
                if (!prompt) {
                    showNotification('Veuillez saisir un prompt de test', 'error');
                    return;
                }
                
                if (!controls.testResults || !controls.testOutput) return;
                
                controls.testResults.classList.remove('hidden');
                controls.testOutput.textContent = 'Ex√©cution du test...';
                
                try {
                    const result = await callGeminiAPI(prompt);
                    controls.testOutput.textContent = result;
                    showNotification('Test ex√©cut√© avec succ√®s', 'success');
                } catch (error) {
                    controls.testOutput.textContent = `Erreur: ${error.message}`;
                    showNotification(`Erreur lors du test: ${error.message}`, 'error');
                }
            }
            
            // R√©initialiser les param√®tres API
            function resetApiSettings() {
                if (controls.aiModelSelect) controls.aiModelSelect.value = 'gemini-1.5-flash';
                if (controls.aiTemperature) {
                    controls.aiTemperature.value = '0.7';
                    if (controls.temperatureValue) controls.temperatureValue.textContent = '0.7';
                }
                if (controls.aiMaxTokens) {
                    controls.aiMaxTokens.value = '1000';
                    if (controls.maxTokensValue) controls.maxTokensValue.textContent = '1000';
                }
                showNotification('Param√®tres r√©initialis√©s', 'success');
            }
            
            // Int√©gration avec les fonctions IA existantes
            async function generateAIContent(prompt, type = 'general') {
                try {
                    showLoader(`G√©n√©ration ${type} en cours...`);
                    
                    const apiKey = localStorage.getItem('gemini-api-key');
                    if (!apiKey) {
                        throw new Error('Cl√© API non configur√©e');
                    }
                    
                    const model = controls.aiModelSelect?.value || 'gemini-1.5-flash';
                    const temperature = parseFloat(controls.aiTemperature?.value || '0.7');
                    const maxTokens = parseInt(controls.aiMaxTokens?.value || '1000');
                    
                    const modelName = GEMINI_CONFIG.models[model] || model;
                    const url = `${GEMINI_CONFIG.baseUrl}${modelName}:generateContent?key=${apiKey}`;
                    
                    const requestBody = {
                        contents: [{
                            parts: [{ text: prompt }]
                        }],
                        generationConfig: {
                            temperature: temperature,
                            maxOutputTokens: maxTokens
                        }
                    };
                    
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(requestBody)
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(errorData.error?.message || `Erreur API: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    
                    if (!data.candidates || !data.candidates[0]?.content?.parts?.[0]?.text) {
                        throw new Error('R√©ponse invalide de l\'API');
                    }
                    
                    const result = data.candidates[0].content.parts[0].text;
                    hideLoader();
                    return result;
                } catch (error) {
                    hideLoader();
                    showNotification(`Erreur lors de la g√©n√©ration: ${error.message}`, 'error');
                    throw error;
                }
            }
            
            function showConfirmModal(title, text) {
                return new Promise((resolve) => {
                    controls.confirmModal.title.textContent = title;
                    controls.confirmModal.text.innerHTML = text;
                    controls.confirmModal.overlay.classList.add('active');

                    const cleanup = (result) => {
                        controls.confirmModal.overlay.classList.remove('active');
                        controls.confirmModal.okBtn.onclick = null;
                        controls.confirmModal.cancelBtn.onclick = null;
                        resolve(result);
                    };

                    controls.confirmModal.okBtn.onclick = () => cleanup(true);
                    controls.confirmModal.cancelBtn.onclick = () => cleanup(false);
                });
            }


            // --- HISTORY (UNDO/REDO) SYSTEM ---
            // History is not saved, so this is a simple implementation
            function undo() { showNotification("Fonctionnalit√© non disponible en mode hors ligne.", "error"); }
            function redo() { showNotification("Fonctionnalit√© non disponible en mode hors ligne.", "error"); }
            
            // --- DRAG & DROP & RESIZE ---
            let activeResizer = null;
            let activeContainer = null;
            let activeCol1 = null;
            let initialX = 0;
            let initialCol1Width = 0;

            function initResize(e) {
                e.preventDefault();
                activeResizer = e.target;
                activeContainer = activeResizer.parentElement;
                const columns = activeContainer.querySelectorAll('.cv-column');
                activeCol1 = columns[0];
                initialX = e.clientX;
                initialCol1Width = activeCol1.offsetWidth;

                document.addEventListener('mousemove', doResize);
                document.addEventListener('mouseup', stopResize);
                document.body.classList.add('is-resizing');
            }

            function doResize(e) {
                if (!activeResizer) return;
                const dx = e.clientX - initialX;
                const newCol1Width = initialCol1Width + dx;
                const containerWidth = activeContainer.offsetWidth;
                
                if (newCol1Width < 50 || newCol1Width > containerWidth - 50) return;

                const newCol1Percent = (newCol1Width / containerWidth) * 100;
                const newCol2Percent = 100 - newCol1Percent;

                activeContainer.classList.remove('layout-2-col-33-67', 'layout-2-col-50-50', 'layout-2-col-67-33');
                activeContainer.style.gridTemplateColumns = `${newCol1Percent}% ${newCol2Percent}%`;
                activeResizer.style.left = `${newCol1Percent}%`;
            }

            function stopResize() {
                document.removeEventListener('mousemove', doResize);
                document.removeEventListener('mouseup', stopResize);
                document.body.classList.remove('is-resizing');
                activeResizer = null;
                activeContainer = null;
                activeCol1 = null;
            }

            function setupAllResizers() {
                document.querySelectorAll('.a4-page').forEach(page => {
                    const container = page.querySelector('.cv-body-container');
                    const oldResizer = container.querySelector('.column-resizer');
                    if (oldResizer) oldResizer.remove();

                    const columns = container.querySelectorAll('.cv-column');
                    if (columns.length === 2 && getComputedStyle(container).gridTemplateColumns.split(' ').length === 2) {
                        const resizer = document.createElement('div');
                        resizer.className = 'column-resizer';
                        container.appendChild(resizer);
                        const col1 = columns[0];
                        const col1WidthPercent = parseFloat(getComputedStyle(col1).width) / parseFloat(getComputedStyle(container).width) * 100;
                        resizer.style.left = col1WidthPercent + '%';
                        resizer.addEventListener('mousedown', initResize);
                    }
                });
            }

            function initializeSortableForPage(pageId) {
                const col1 = document.getElementById(`cv-col-${pageId}-1`);
                const col2 = document.getElementById(`cv-col-${pageId}-2`);
                const onEnd = () => { checkAllPagesOverflow(); };
                if (col1) new Sortable(col1, { group: 'cv-modules', animation: 150, handle: '.drag-handle', ghostClass: 'sortable-ghost', onEnd });
                if (col2) new Sortable(col2, { group: 'cv-modules', animation: 150, handle: '.drag-handle', ghostClass: 'sortable-ghost', onEnd });
            }

            function initializeSkillSorting() {
                const skillLists = document.querySelectorAll('#cv-competences-preview ul');
                skillLists.forEach(list => {
                    new Sortable(list, {
                        group: 'skills', animation: 150, ghostClass: 'skills-ghost',
                        onEnd: function () {
                            syncFormFromPreview(document.getElementById('cv-competences-preview'));
                        }
                    });
                });
            }

            // --- PAGE & OVERFLOW MANAGEMENT ---
            function checkPageOverflow(page) {
                requestAnimationFrame(() => {
                    // Using a 1px tolerance for floating point inaccuracies
                    const isOverflowing = page.scrollHeight > page.clientHeight + 1;
                    page.classList.toggle('is-overflowing', isOverflowing);
                });
            }

            function checkAllPagesOverflow() {
                document.querySelectorAll('.a4-page').forEach(checkPageOverflow);
            }

            function setupOverflowObserver(pageElement) {
                const observer = new ResizeObserver(() => {
                    checkPageOverflow(pageElement);
                });
                // Observe the page element itself and its direct content container
                observer.observe(pageElement);
                const bodyContainer = pageElement.querySelector('.cv-body-container');
                if (bodyContainer) {
                    observer.observe(bodyContainer);
                }
            }
            
            function addNewPage() {
                pageCounter++;
                const newPageContainer = document.createElement('div');
                newPageContainer.className = 'a4-page-container';
                const layoutClass = document.querySelector('.layout-btn.active')?.dataset.layout || 'layout-1-col';
                
                newPageContainer.innerHTML = `
                    <div id="page-${pageCounter}" class="a4-page">
                        <div class="cv-body-container ${layoutClass}">
                            <div id="cv-col-${pageCounter}-1" class="cv-column"></div>
                            <div id="cv-col-${pageCounter}-2" class="cv-column"></div>
                        </div>
                    </div>
                    <button class="remove-page-btn no-print"><i class="fas fa-trash-can"></i></button>
                `;
                
                const addBtnWrapper = document.getElementById('add-page-btn-wrapper');
                preview.previewWrapper.insertBefore(newPageContainer, addBtnWrapper);
                
                const newPageElement = document.getElementById(`page-${pageCounter}`);
                setupOverflowObserver(newPageElement);

                initializeSortableForPage(pageCounter);
                setupAllResizers();
                checkAllPagesOverflow();
            }


            // --- DYNAMIC CONTENT ---
            function createDynamicItem(container, fields, data = {}, index = -1) {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'p-2 border rounded-md bg-white relative';
                
                fields.forEach(field => {
                    const isTextarea = field.type === 'textarea';
                    const input = document.createElement(isTextarea ? 'textarea' : 'input');
                    
                    if (!isTextarea) input.type = 'text';
                    
                    input.placeholder = field.placeholder;
                    input.className = `cv-input w-full p-1 border rounded-sm mb-1 data-${field.key}`;
                    if(isTextarea) input.rows = 3;
                    input.value = data[field.key] || '';
                    itemDiv.appendChild(input);
                });

                const removeBtn = document.createElement('button');
                removeBtn.innerHTML = '<i class="fas fa-times-circle text-red-400 hover:text-red-600"></i>';
                removeBtn.className = 'absolute top-1 right-1 remove-dynamic-item-btn';
                itemDiv.appendChild(removeBtn);
                
                if (index !== -1 && index < container.children.length) {
                    container.insertBefore(itemDiv, container.children[index]);
                } else {
                    container.appendChild(itemDiv);
                }
                
                updatePreview('form');
                const firstInput = itemDiv.querySelector('input, textarea');
                if (firstInput) firstInput.focus();
            }

            function getDynamicData(container) {
                return Array.from(container.children).map(itemDiv => ({
                    title: itemDiv.querySelector('.data-title')?.value || '',
                    meta: itemDiv.querySelector('.data-meta')?.value || '',
                    desc: itemDiv.querySelector('.data-desc')?.value || '',
                }));
            }
            
            // --- SKILLS RENDERING ---
            function renderSkillsAsTags(text) {
                let html = '';
                const sections = text.split('\n').filter(Boolean);
                sections.forEach(section => {
                    const parts = section.split(':');
                    if (parts.length === 2 && parts[0].trim() !== '') {
                        html += `<h3 class="skill-category" contenteditable="true">${parts[0].trim()}</h3>`;
                        html += `<ul>${parts[1].split(',').map(item => item.trim().replace(/\s*\(.*\)/, '')).filter(Boolean).map(item => `<li class="skill-item" contenteditable="false">${item}<span class="delete-skill-btn">&times;</span></li>`).join('')}</ul>`;
                    } else {
                        html += `<ul>${section.split(',').map(item => item.trim().replace(/\s*\(.*\)/, '')).filter(Boolean).map(item => `<li class="skill-item" contenteditable="false">${item}<span class="delete-skill-btn">&times;</span></li>`).join('')}</ul>`;
                    }
                });
                return html;
            }

            function renderSkillsAsLevels() {
                let html = '';
                const gaugeStyle = document.querySelector('.gauge-style-btn.active')?.dataset.gaugeStyle || 'bar';
                const skillItems = controls.skillsLevelList.querySelectorAll('.skill-level-item');

                skillItems.forEach(item => {
                    const name = item.querySelector('.skill-name-input').value;
                    const level = item.querySelector('.skill-level-input').value;
                    if (!name) return;

                    html += `<div class="skill-level">
                                        <div class="skill-level-label" contenteditable="true">${name}</div>
                                        <div class="gauge-container">${renderGauge(level, gaugeStyle)}</div>
                                    </div>`;
                });
                return html;
            }
            
            function renderGauge(level, style) {
                const max = 5;
                let gaugeHtml = '';
                switch (style) {
                    case 'dots':
                        gaugeHtml = `<div class="gauge-dots">`;
                        for (let i = 1; i <= max; i++) gaugeHtml += `<span class="${i <= level ? 'filled' : ''}">‚óè</span>`;
                        gaugeHtml += `</div>`;
                        break;
                    case 'stars':
                        gaugeHtml = `<div class="gauge-stars">`;
                        for (let i = 1; i <= max; i++) gaugeHtml += `<i class="${i <= level ? 'fas' : 'far'} fa-star ${i <= level ? 'filled' : ''}"></i>`;
                        gaugeHtml += `</div>`;
                        break;
                    case 'squares':
                         gaugeHtml = `<div class="gauge-squares">`;
                        for (let i = 1; i <= max; i++) gaugeHtml += `<span class="${i <= level ? 'filled' : ''}">‚ñ†</span>`;
                        gaugeHtml += `</div>`;
                        break;
                    case 'number':
                        gaugeHtml = `<div class="gauge-number">${level}/${max}</div>`;
                        break;
                    case 'bar':
                    default:
                        const width = (level / max) * 100;
                        gaugeHtml = `<div class="gauge-bar-bg"><div class="gauge-bar-fill" style="width: ${width}%;"></div></div>`;
                        break;
                }
                return gaugeHtml;
            }

            function renderSkillsAsSimple(text) {
                let html = '<ul>';
                const skills = text.split(/,|\n/).map(s => s.trim().replace(/\s*\(.*\)/, '')).filter(Boolean);
                skills.forEach(skill => {
                    html += `<li>${skill}</li>`;
                });
                html += '</ul>';
                return html;
            }

            function createSkillLevelItem(name = '', level = 3) {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'skill-level-item flex items-center gap-2';
                itemDiv.innerHTML = `
                    <input type="text" placeholder="Comp√©tence" value="${name}" class="skill-name-input cv-input flex-grow p-1 border rounded-sm">
                    <input type="range" value="${level}" min="1" max="5" class="skill-level-input w-24">
                    <span class="skill-level-value text-sm font-mono">${level}/5</span>
                    <button class="remove-skill-level-btn text-red-400 hover:text-red-600"><i class="fas fa-times-circle"></i></button>
                `;
                controls.skillsLevelList.appendChild(itemDiv);
                updatePreview('form');
            }

            // --- UPDATES & FORMATTING ---
            function updateBannerBackground() {
                const opacity = controls.bannerBgOpacity.value;
                const blur = controls.bannerBgBlur.value;
                const grayscale = controls.bannerBgGrayscale.checked;

                controls.bannerBgOpacityValue.textContent = opacity;
                controls.bannerBgBlurValue.textContent = blur;

                preview.bannerBgImg.style.opacity = opacity;
                preview.bannerBgImg.style.filter = `blur(${blur}px) grayscale(${grayscale ? 1 : 0})`;
            }

            function updatePreview(source = 'form') {
                if (source === 'form' || source === 'banner-style' || source === 'theme' || source === 'state') {
                    preview.cvNomPrenom.textContent = `${controls.prenom.value} ${controls.nom.value}`.trim() || 'Pr√©nom NOM';
                    preview.cvPoste.textContent = controls.poste.value || 'Poste Recherch√©';
                    preview.cvDescription.innerHTML = `<div class="editable-wrapper"><p contenteditable="true">${controls.description.value.replace(/\n/g, '<br>') || '&nbsp;'}</p><span class="delete-line-btn"><i class="fas fa-times"></i></span></div>`;
                    
                    const renderDynamicList = (previewContainer, controlContainer, type) => {
                        previewContainer.innerHTML = '';
                        const data = getDynamicData(controlContainer);

                        const createInsertButton = (type, index) => {
                            const wrapper = document.createElement('div');
                            wrapper.className = 'insert-line-wrapper';
                            wrapper.innerHTML = `<button class="add-line-preview-btn" data-type="${type}" data-index="${index}" title="Ins√©rer un nouveau bloc ici"><i class="fas fa-plus"></i></button>`;
                            return wrapper;
                        };

                        const createItemContainer = (item, i) => {
                            const itemContainer = document.createElement('div');
                            itemContainer.className = 'dynamic-item-container';
                            itemContainer.dataset.index = i;
                            itemContainer.dataset.type = type;

                            const itemContent = document.createElement('div');
                            itemContent.className = "dynamic-preview-item";
                            itemContent.innerHTML = `<button class="delete-block-btn" title="Supprimer le bloc"><i class="fas fa-trash-alt"></i></button>`;

                            if (type === 'experience') {
                                const titleHTML = `<div class="editable-wrapper"><p class="item-title" contenteditable="true">${item.title || '&nbsp;'}</p><span class="delete-line-btn"><i class="fas fa-times"></i></span></div>`;
                                const metaHTML = `<div class="editable-wrapper"><p class="item-meta" contenteditable="true">${item.meta || '&nbsp;'}</p><span class="delete-line-btn"><i class="fas fa-times"></i></span></div>`;
                                const descHTML = `<div class="editable-wrapper"><p class="mt-1" contenteditable="true">${item.desc.replace(/\n/g, '<br>') || '&nbsp;'}</p><span class="delete-line-btn"><i class="fas fa-times"></i></span></div>`;
                                const addButtonHTML = `<button class="add-desc-line-btn"><i class="fas fa-plus mr-1"></i> Ajouter une mission</button>`;
                                itemContent.innerHTML += `${titleHTML}${metaHTML}${descHTML}${addButtonHTML}`;
                            } else { // formation
                                const titleHTML = `<div class="editable-wrapper"><p class="item-title" contenteditable="true">${item.title || '&nbsp;'}</p><span class="delete-line-btn"><i class="fas fa-times"></i></span></div>`;
                                const metaHTML = `<div class="editable-wrapper"><p class="item-meta" contenteditable="true">${item.meta || '&nbsp;'}</p><span class="delete-line-btn"><i class="fas fa-times"></i></span></div>`;
                                itemContent.innerHTML += `${titleHTML}${metaHTML}`;
                            }
                            
                            itemContainer.appendChild(createInsertButton(type, i));
                            itemContainer.appendChild(itemContent);
                            return itemContainer;
                        };
                        
                        data.forEach((item, i) => {
                            previewContainer.appendChild(createItemContainer(item, i));
                        });
                        const finalButtonWrapper = document.createElement('div');
                        finalButtonWrapper.className = 'dynamic-item-container';
                        finalButtonWrapper.appendChild(createInsertButton(type, data.length));
                        previewContainer.appendChild(finalButtonWrapper);
                    };

                    renderDynamicList(preview.cvExperience, controls.experienceList, 'experience');
                    renderDynamicList(preview.cvFormation, controls.formationList, 'formation');

                    const skillStyle = document.querySelector('.skill-style-btn.active')?.dataset.skillStyle || 'tags';
                    preview.cvCompetences.dataset.style = skillStyle;
                    
                    if (skillStyle === 'tags') {
                        preview.cvCompetences.innerHTML = renderSkillsAsTags(controls.competences.value);
                        initializeSkillSorting(); 
                    } else if (skillStyle === 'levels') {
                        preview.cvCompetences.innerHTML = renderSkillsAsLevels();
                    } else { // simple
                        preview.cvCompetences.innerHTML = renderSkillsAsSimple(controls.competences.value);
                    }

                    document.querySelectorAll('.custom-module-preview').forEach(m => m.remove());
                    Array.from(controls.customSectionsList.children).forEach(div => {
                        const sectionId = div.dataset.sectionId;
                        const title = div.querySelector('input').value;
                        const content = div.querySelector('textarea').value;
                        const iconClass = div.dataset.icon || 'fas fa-puzzle-piece';
                        
                        const moduleDiv = document.createElement('div');
                        moduleDiv.id = sectionId;
                        moduleDiv.className = 'cv-module custom-module-preview'; 
                        moduleDiv.innerHTML = `
                            <div class="drag-handle"><i class="fas fa-grip-vertical"></i></div>
                            <h2 class="section-title" data-section-id="${sectionId}"><i class="${iconClass} section-icon"></i><span contenteditable="true">${title}</span><div class="section-ai-actions"><button class="ai-action-btn toggle-visibility-btn" title="Masquer/Afficher la section"><i class="fas fa-eye"></i></button></div></h2>
                            <div class="dynamic-preview-item">
                                <button class="delete-block-btn" title="Supprimer la section"><i class="fas fa-trash-alt"></i></button>
                                <div class="editable-wrapper">
                                    <div class="custom-content" contenteditable="true">${content.replace(/\n/g, '<br>') || '&nbsp;'}</div>
                                    <span class="delete-line-btn"><i class="fas fa-times"></i></span>
                                </div>
                            </div>
                        `;
                        const lastModule = document.querySelector('#competences-module');
                        if(lastModule && lastModule.parentElement) {
                            lastModule.parentElement.insertBefore(moduleDiv, lastModule.nextSibling);
                        }
                    });
                    
                    preview.bannerNom.textContent = controls.bannerNom.value || "Nom Pr√©nom Recruteur";
                    preview.bannerPoste.textContent = controls.bannerPoste.value || "Poste du Recruteur";
                    preview.bannerEmail.textContent = controls.bannerEmail.value || "email@recruteur.com";
                    preview.bannerTel.textContent = controls.bannerTel.value || "01 23 45 67 89";
                }

                preview.bannerNom.style.fontFamily = controls.bannerNomFont.value;
                preview.bannerNom.style.fontSize = controls.bannerNomSize.value + 'pt';
                preview.bannerNom.style.color = controls.bannerNomColor.value;
                preview.bannerNom.style.fontWeight = controls.bannerNomBold.classList.contains('active') ? 'bold' : 'normal';
                preview.bannerNom.style.fontStyle = controls.bannerNomItalic.classList.contains('active') ? 'italic' : 'normal';
                
                preview.bannerPoste.style.fontSize = controls.bannerPosteSize.value + 'pt';
                preview.bannerPoste.style.color = controls.bannerPosteColor.value;
                preview.bannerPoste.style.fontWeight = controls.bannerPosteBold.classList.contains('active') ? 'bold' : 'normal';
                preview.bannerPoste.style.fontStyle = controls.bannerPosteItalic.classList.contains('active') ? 'italic' : 'normal';

                preview.bannerContact.style.fontSize = controls.bannerContactSize.value + 'pt';
                preview.bannerContact.style.color = controls.bannerContactColor.value;
                preview.bannerContact.style.fontWeight = controls.bannerContactBold.classList.contains('active') ? 'bold' : 'normal';
                preview.bannerContact.style.fontStyle = controls.bannerContactItalic.classList.contains('active') ? 'italic' : 'normal';
                
                const dispo = controls.qualificationDispo.value;
                const salaire = controls.qualificationSalaire.value;
                const loc = controls.qualificationLoc.value;
                let qualHTML = '';
                if (dispo) qualHTML += `<div><i class="fas fa-calendar-check mr-1 text-gray-400"></i> ${dispo}</div>`;
                if (salaire) qualHTML += `<div><i class="fas fa-euro-sign mr-1 text-gray-400"></i> ${salaire}</div>`;
                if (loc) qualHTML += `<div><i class="fas fa-map-marker-alt mr-1 text-gray-400"></i> ${loc}</div>`;
                preview.qualificationPreview.innerHTML = qualHTML;
                preview.qualificationModule.style.display = (dispo || salaire || loc) ? '' : 'none';

                const isBannerEnabled = controls.toggleBanner.checked;
                const isBannerInTop = preview.fixedBannerTop.contains(preview.banner);
                const isBannerInBottom = preview.fixedBannerBottom.contains(preview.banner);
                const isBannerInModule = preview.bannerModule.contains(preview.banner);
                
                preview.bannerModule.classList.toggle('hidden', !isBannerEnabled || !isBannerInModule);
                preview.fixedBannerTop.style.display = (isBannerEnabled && isBannerInTop) ? 'block' : 'none';
                preview.fixedBannerBottom.style.display = (isBannerEnabled && isBannerInBottom) ? 'block' : 'none';

                checkAllPagesOverflow();
            }
            
            function syncFormFromPreview(element) {
                if (!element) return;
                const id = element.id;

                if (id === 'cv-competences-preview') {
                    const style = preview.cvCompetences.dataset.style;
                    if (style === 'levels') {
                        const skillLabels = preview.cvCompetences.querySelectorAll('.skill-level-label');
                        const controlInputs = controls.skillsLevelList.querySelectorAll('.skill-name-input');
                        skillLabels.forEach((label, index) => {
                            if (controlInputs[index]) {
                                controlInputs[index].value = label.textContent;
                            }
                        });
                    } else { 
                        let result = [];
                        const nodes = Array.from(element.childNodes);
                        for (let i = 0; i < nodes.length; i++) {
                            const node = nodes[i];
                            if (node.nodeName === 'H3' && node.classList.contains('skill-category')) {
                                const categoryName = node.textContent.trim();
                                const nextNode = nodes[i + 1];
                                if (nextNode && nextNode.nodeName === 'UL') {
                                    const skills = Array.from(nextNode.querySelectorAll('li.skill-item')).map(li => li.textContent.replace('√ó', '').trim()).filter(Boolean).join(', ');
                                    if (categoryName && skills) {
                                        result.push(`${categoryName}: ${skills}`);
                                    }
                                    i++; 
                                }
                            } else if (node.nodeName === 'UL') {
                                const skills = Array.from(node.querySelectorAll('li')).map(li => li.textContent.replace('√ó', '').trim()).filter(Boolean).join(', ');
                                if (skills) {
                                    result.push(skills);
                                }
                            }
                        }
                        controls.competences.value = result.join('\n');
                    }
                    return;
                }
                
                let text = element.innerHTML.replace(/<br\s*\/?>/gi, '\n').trim();
                text = new DOMParser().parseFromString(text, "text/html").documentElement.textContent;

                if (id) {
                    switch (id) {
                        case 'cv-nom-prenom-preview': const nameParts = text.trim().split(' '); controls.prenom.value = nameParts.shift() || ''; controls.nom.value = nameParts.join(' ') || ''; break;
                        case 'cv-poste-preview': controls.poste.value = text; break;
                        case 'cv-description-preview': controls.description.value = text; break;
                        case 'banner-nom-preview': controls.bannerNom.value = text; break;
                        case 'banner-poste-preview': controls.bannerPoste.value = text; break;
                        case 'banner-email-preview': controls.bannerEmail.value = text; break;
                        case 'banner-tel-preview': controls.bannerTel.value = text; break;
                    }
                } else {
                    const itemContainer = element.closest('.dynamic-item-container');
                    if (itemContainer) {
                        const index = parseInt(itemContainer.dataset.index, 10);
                        const type = itemContainer.dataset.type;
                        const formList = type === 'experience' ? controls.experienceList : controls.formationList;
                        const formItem = formList.children[index];
                        if (!formItem) return;

                        const title = itemContainer.querySelector('.item-title')?.textContent || '';
                        const meta = itemContainer.querySelector('.item-meta')?.textContent || '';
                        const descEl = itemContainer.querySelector('.mt-1');
                        const desc = descEl ? new DOMParser().parseFromString(descEl.innerHTML.replace(/<br\s*\/?>/gi, '\n'), "text/html").documentElement.textContent : '';

                        if (formItem.querySelector('.data-title')) formItem.querySelector('.data-title').value = title;
                        if (formItem.querySelector('.data-meta')) formItem.querySelector('.data-meta').value = meta;
                        if (formItem.querySelector('.data-desc')) formItem.querySelector('.data-desc').value = desc;

                    } else {
                        const customModule = element.closest('.custom-module-preview');
                        if (customModule) {
                            const sectionId = customModule.id;
                            const controlTitleInput = document.getElementById(`custom-section-title-${sectionId}`);
                            const controlContentTextarea = document.getElementById(`custom-section-content-${sectionId}`);
                            
                            if (element.matches('[contenteditable].section-title span')) {
                               if (controlTitleInput) controlTitleInput.value = element.textContent;
                            }
                            if (element.matches('[contenteditable].custom-content')) {
                               if (controlContentTextarea) controlContentTextarea.value = text;
                            }
                        }
                    }
                }
            }

            function moveBannerTo(destination) {
                const recruiterBanner = preview.banner;
                if (destination === 'top') {
                    preview.fixedBannerTop.appendChild(recruiterBanner);
                } else if (destination === 'bottom') {
                    preview.fixedBannerBottom.appendChild(recruiterBanner);
                } else { // 'modular'
                    preview.bannerModule.querySelector('.drag-handle').insertAdjacentElement('afterend', recruiterBanner);
                }
                const isModular = (destination === 'modular');
                document.getElementById('banner-fix-controls').classList.toggle('hidden', !isModular);
                controls.modularBannerBtn.classList.toggle('hidden', isModular);
                updatePreview('banner-move');
            }

            function addCustomSection(title = 'Nouvelle Section', content = '', id = null, icon = 'fas fa-puzzle-piece') {
                customSectionCounter++;
                const sectionId = id || `custom-module-${Date.now()}-${customSectionCounter}`;
                
                const controlDiv = document.createElement('div');
                controlDiv.className = 'p-2 border rounded-md bg-white relative';
                controlDiv.dataset.sectionId = sectionId;
                controlDiv.dataset.icon = icon;
                controlDiv.innerHTML = `
                    <input type="text" value="${title}" class="w-full p-1 border rounded-sm mb-1 font-semibold custom-section-input" id="custom-section-title-${sectionId}">
                    <textarea rows="4" class="w-full p-1 border rounded-sm mb-1 custom-section-input" id="custom-section-content-${sectionId}" placeholder="Contenu...">${content}</textarea>
                    <button class="absolute top-1 right-1 text-red-400 hover:text-red-600 remove-section-btn"><i class="fas fa-times-circle"></i></button>
                `;
                controls.customSectionsList.appendChild(controlDiv);
                
                updatePreview('form');
                updateAllStyles();
            }

            // === PARSER JSON ROBUSTE ===
            
            function forceParseJson(rawText) {
                console.log("üî• Parser JSON robuste activ√©...");
                
                try {
                    // D'abord essayer le parsing standard
                    return JSON.parse(rawText);
                } catch {
                    console.log("üîß Parsing standard √©chou√©, extraction manuelle...");
                }
                
                // Extraire manuellement chaque champ n√©cessaire
                const result = {
                    nom: extractFieldValue(rawText, 'nom'),
                    prenom: extractFieldValue(rawText, 'prenom'),
                    poste: extractFieldValue(rawText, 'poste'),
                    description: extractFieldValue(rawText, 'description'),
                    experiences: extractExperiencesRobust(rawText),
                    formations: extractFormationsRobust(rawText),
                    competences: extractFieldValue(rawText, 'competences')
                };
                
                console.log("üî• Donn√©es extraites manuellement:", result);
                return result;
            }
            
            function extractFieldValue(text, fieldName) {
                // Plusieurs patterns pour capturer les valeurs
                const patterns = [
                    new RegExp(`"${fieldName}"\\s*:\\s*"([^"]*)"`, 'i'),
                    new RegExp(`${fieldName}\\s*:\\s*"([^"]*)"`, 'i'),
                    new RegExp(`"${fieldName}"\\s*:\\s*'([^']*)'`, 'i'),
                    new RegExp(`${fieldName}\\s*:\\s*'([^']*)'`, 'i')
                ];
                
                for (const pattern of patterns) {
                    const match = text.match(pattern);
                    if (match) {
                        return match[1].trim();
                    }
                }
                
                return '';
            }
            
            function extractExperiencesRobust(text) {
                const experiences = [];
                
                // Chercher le d√©but de l'array experiences
                const expMatch = text.match(/"experiences"\s*:\s*\[(.*?)(?:\]|$)/is);
                if (!expMatch) return experiences;
                
                const expContent = expMatch[1];
                
                // Diviser par les accolades fermantes suivies d'accolades ouvrantes ou fin
                const expItems = expContent.split(/}\s*(?:{|,\s*{|$)/);
                
                for (let item of expItems) {
                    if (item.trim() && item.includes('title')) {
                        const exp = {
                            title: extractFieldValue(item + '}', 'title'),
                            meta: extractFieldValue(item + '}', 'meta'),
                            desc: extractFieldValue(item + '}', 'desc')
                        };
                        
                        if (exp.title || exp.meta || exp.desc) {
                            experiences.push(exp);
                        }
                    }
                }
                
                console.log(`üî• Exp√©riences extraites: ${experiences.length}`);
                return experiences;
            }
            
            function extractFormationsRobust(text) {
                const formations = [];
                
                // Chercher le d√©but de l'array formations
                const formMatch = text.match(/"formations"\s*:\s*\[(.*?)(?:\]|$)/is);
                if (!formMatch) return formations;
                
                const formContent = formMatch[1];
                
                // Diviser par les accolades fermantes suivies d'accolades ouvrantes ou fin
                const formItems = formContent.split(/}\s*(?:{|,\s*{|$)/);
                
                for (let item of formItems) {
                    if (item.trim() && item.includes('title')) {
                        const form = {
                            title: extractFieldValue(item + '}', 'title'),
                            meta: extractFieldValue(item + '}', 'meta')
                        };
                        
                        if (form.title || form.meta) {
                            formations.push(form);
                        }
                    }
                }
                
                console.log(`üî• Formations extraites: ${formations.length}`);
                return formations;
            }

            // === FONCTIONS DE NETTOYAGE JSON ===
            
            function cleanJsonResponse(text) {
                if (!text || typeof text !== 'string') return '{}';
                
                // Supprimer les balises markdown si pr√©sentes
                let cleaned = text.replace(/```json\s*/gi, '').replace(/```\s*/g, '');
                
                // Supprimer les caract√®res de contr√¥le probl√©matiques (sauf \n, \r, \t)
                cleaned = cleaned.replace(/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]/g, '');
                
                // Chercher le premier { et le dernier } pour extraire le JSON
                const firstBrace = cleaned.indexOf('{');
                const lastBrace = cleaned.lastIndexOf('}');
                
                if (firstBrace !== -1 && lastBrace !== -1 && lastBrace > firstBrace) {
                    cleaned = cleaned.substring(firstBrace, lastBrace + 1);
                } else {
                    // Si pas de structure JSON trouv√©e, retourner un objet vide
                    console.warn("‚ö†Ô∏è Pas de structure JSON valide trouv√©e");
                    return '{}';
                }
                
                // Nettoyer les retours √† la ligne dans les valeurs JSON
                cleaned = cleaned.replace(/"\s*\n\s*"/g, '" "');
                
                return cleaned.trim();
            }
            
            function repairJsonResponse(text) {
                let repaired = cleanJsonResponse(text);
                
                if (repaired === '{}') return repaired;
                
                try {
                    // Test si le JSON est d√©j√† valide
                    JSON.parse(repaired);
                    return repaired;
                } catch {
                    // Continuer avec les r√©parations
                }
                
                console.log("üîß D√©but de r√©paration JSON...");
                
                // 1. R√©parer les propri√©t√©s sans guillemets
                repaired = repaired.replace(/([{,]\s*)([a-zA-Z_][a-zA-Z0-9_]*)\s*:/g, '$1"$2":');
                
                // 2. Fermer les cha√Ænes non termin√©es
                repaired = repaired.replace(/: "([^"]*?)(\s*[,}\]])$/gm, ': "$1"$2');
                repaired = repaired.replace(/: "([^"]*?)$/gm, ': "$1"');
                
                // 3. R√©paration sp√©ciale pour les arrays mal format√©s
                console.log("üîß R√©paration des arrays...");
                
                // Ajouter des virgules entre objets cons√©cutifs dans les arrays
                repaired = repaired.replace(/}\s*{/g, '}, {');
                repaired = repaired.replace(/]\s*\[/g, '], [');
                
                // R√©parer sp√©cifiquement les patterns probl√©matiques d'arrays
                repaired = repaired.replace(/}(\s*){"/g, '}, {$1"');  // }{"prop" ‚Üí }, {"prop"
                repaired = repaired.replace(/"(\s*){"/g, '", {$1"');  // "text"{"prop" ‚Üí "text", {"prop"
                repaired = repaired.replace(/}(\s*)"/g, '}, $1"');    // }"text" ‚Üí }, "text"
                
                // Cas sp√©cifiques pour les arrays d'objets
                repaired = repaired.replace(/}(\s+){"title"/g, '}, $1{"title"');
                repaired = repaired.replace(/}(\s+){"meta"/g, '}, $1{"meta"');
                repaired = repaired.replace(/}(\s+){"desc"/g, '}, $1{"desc"');
                
                // Nettoyer les doubles virgules
                repaired = repaired.replace(/,(\s*,)+/g, ',');
                
                // 4. R√©parer les objets dans les arrays - patterns plus g√©n√©riques
                repaired = repaired.replace(/}(\s*){"[^"]+"/g, '}, {$1"');
                
                // 5. G√©rer les guillemets non √©chapp√©s dans les valeurs
                repaired = repaired.replace(/: "([^"]*)"([^",}\]]*)"([^",}\]]*)/g, (match, p1, p2, p3) => {
                    if (p2 && p3) {
                        const escapedValue = (p1 + p2 + p3).replace(/"/g, '\\"');
                        return `: "${escapedValue}"`;
                    }
                    return match;
                });
                
                // 6. Supprimer les retours √† la ligne dans les valeurs JSON
                repaired = repaired.replace(/: "([^"]*)\n([^"]*)"(\s*[,}])/g, ': "$1 $2"$3');
                
                // 7. R√©parer les virgules manquantes entre propri√©t√©s
                repaired = repaired.replace(/}(\s*)"([^"]+)":/g, '},$1"$2":');
                repaired = repaired.replace(/](\s*)"([^"]+)":/g, '],$1"$2":');
                repaired = repaired.replace(/"(\s+)"([^"]+)":/g, '",$1"$2":');
                
                // 8. Supprimer les virgules en trop
                repaired = repaired.replace(/,(\s*[}\]])/g, '$1');
                repaired = repaired.replace(/,(\s*,)/g, ',');
                
                // 9. Ajouter des guillemets manquants aux valeurs
                repaired = repaired.replace(/:\s*([^",{\[\]}\s][^,}\]]*?)(\s*[,}])/g, ': "$1"$2');
                
                // 10. R√©paration sp√©cialis√©e pour les arrays probl√©matiques
                repaired = fixArraySyntax(repaired);
                
                // Test interm√©diaire
                try {
                    JSON.parse(repaired);
                    console.log("‚úÖ JSON r√©par√© avec succ√®s");
                    return repaired;
                } catch (e) {
                    console.log("üîß R√©paration avanc√©e n√©cessaire...", e.message);
                }
                
                // 11. R√©paration drastique - reconstruction manuelle
                try {
                    return reconstructJson(repaired);
                } catch {
                    console.warn("‚ö†Ô∏è Impossible de r√©parer le JSON - retour √† un objet vide");
                    return '{}';
                }
            }
            
            function fixArraySyntax(jsonStr) {
                console.log("üîß R√©paration sp√©cialis√©e des arrays...");
                
                // Trouver tous les arrays et les r√©parer individuellement
                return jsonStr.replace(/"(experiences|formations)"\s*:\s*\[([^\]]*(?:\][^\]]*)*?)\]/g, (match, arrayName, arrayContent) => {
                    console.log(`üîß R√©paration de l'array "${arrayName}"`);
                    
                    // Nettoyer le contenu de l'array
                    let cleaned = arrayContent;
                    
                    // R√©parer les objets cons√©cutifs sans virgules
                    cleaned = cleaned.replace(/}\s*{/g, '}, {');
                    
                    // Ajouter des virgules entre cha√Ænes et objets
                    cleaned = cleaned.replace(/"(\s*){/g, '", {');
                    cleaned = cleaned.replace(/}(\s*)"/g, '}, "');
                    
                    // Nettoyer les virgules multiples
                    cleaned = cleaned.replace(/,(\s*,)+/g, ',');
                    
                    // Supprimer les virgules avant la fermeture
                    cleaned = cleaned.replace(/,(\s*)$/g, '');
                    
                    return `"${arrayName}": [${cleaned}]`;
                });
            }
            
            function reconstructJson(brokenJson) {
                console.log("üèóÔ∏è Reconstruction manuelle du JSON...");
                
                // Extraire les principales donn√©es m√™me si le JSON est cass√©
                const data = {
                    nom: extractValue(brokenJson, 'nom'),
                    prenom: extractValue(brokenJson, 'prenom'),
                    poste: extractValue(brokenJson, 'poste'),
                    description: extractValue(brokenJson, 'description'),
                    experiences: extractArray(brokenJson, 'experiences'),
                    formations: extractArray(brokenJson, 'formations'),
                    competences: extractValue(brokenJson, 'competences')
                };
                
                return JSON.stringify(data);
            }
            
            function extractValue(text, key) {
                const regex = new RegExp(`"${key}"\\s*:\\s*"([^"]*)"`, 'i');
                const match = text.match(regex);
                return match ? match[1] : '';
            }
            
            function extractArray(text, key) {
                const regex = new RegExp(`"${key}"\\s*:\\s*\\[([^\\]]*(?:\\][^\\]]*)*?)\\]`, 'i');
                const match = text.match(regex);
                if (!match) return [];
                
                const arrayContent = match[1];
                const items = [];
                
                // Extraction simple d'objets dans l'array
                const objectRegex = /{[^{}]*}/g;
                let objectMatch;
                
                while ((objectMatch = objectRegex.exec(arrayContent)) !== null) {
                    try {
                        const cleaned = objectMatch[0]
                            .replace(/([{,]\s*)([a-zA-Z_][a-zA-Z0-9_]*)\s*:/g, '$1"$2":')
                            .replace(/,(\s*[}])/g, '$1');
                        
                        const parsed = JSON.parse(cleaned);
                        items.push(parsed);
                    } catch {
                        // Si impossible de parser, extraire les valeurs manuellement
                        const obj = {};
                        obj.title = extractValue(objectMatch[0], 'title');
                        obj.meta = extractValue(objectMatch[0], 'meta');
                        obj.desc = extractValue(objectMatch[0], 'desc');
                        if (obj.title || obj.meta || obj.desc) {
                            items.push(obj);
                        }
                    }
                }
                
                return items;
            }
            
            // Fonction fallback sans schema JSON
            async function callGeminiFallback(originalPrompt) {
                const apiKey = localStorage.getItem('gemini-api-key');
                if (!apiKey) return null;
                
                const simplePrompt = `${originalPrompt}

R√âPONDRE EN JSON SIMPLE ET VALIDE UNIQUEMENT. Format exact attendu :
{
  "nom": "nom de famille",
  "prenom": "pr√©nom",
  "poste": "titre du poste",
  "description": "description professionnelle courte",
  "experiences": [
    {"title": "poste", "meta": "entreprise - dates", "desc": "description courte"}
  ],
  "formations": [
    {"title": "dipl√¥me", "meta": "√©cole - ann√©e"}
  ],
  "competences": "competence1, competence2, competence3"
}`;

                const model = controls.aiModelSelect?.value || 'gemini-1.5-flash';
                const modelName = GEMINI_CONFIG.models[model] || model;
                const url = `${GEMINI_CONFIG.baseUrl}${modelName}:generateContent?key=${apiKey}`;
                
                const payload = {
                    contents: [{ parts: [{ text: simplePrompt }] }],
                    generationConfig: {
                        temperature: 0.3, // Plus d√©terministe pour le JSON
                        maxOutputTokens: parseInt(controls.aiMaxTokens?.value || '1000')
                    }
                };

                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) return null;

                const data = await response.json();
                
                if (data.candidates && data.candidates.length > 0 && 
                    data.candidates[0].content && data.candidates[0].content.parts) {
                    const text = data.candidates[0].content.parts[0].text;
                    const cleaned = cleanJsonResponse(text);
                    return JSON.parse(cleaned);
                }
                
                return null;
            }

            // Fonction legacy mise √† jour pour utiliser la nouvelle API
            async function callGeminiAPI(prompt, schema) {
                try {
                    showLoader("L'IA r√©fl√©chit...");
                    
                    let result;
                    if (schema) {
                        // Pour les sch√©mas JSON, utiliser l'API avec responseSchema
                        const apiKey = localStorage.getItem('gemini-api-key');
                        if (!apiKey) {
                            throw new Error('Cl√© API non configur√©e');
                        }
                        
                        const model = controls.aiModelSelect?.value || 'gemini-1.5-flash';
                        const modelName = GEMINI_CONFIG.models[model] || model;
                        const url = `${GEMINI_CONFIG.baseUrl}${modelName}:generateContent?key=${apiKey}`;
                        
                        const payload = {
                            contents: [{ role: "user", parts: [{ text: prompt }] }],
                            generationConfig: { 
                                responseMimeType: "application/json", 
                                responseSchema: schema,
                                temperature: parseFloat(controls.aiTemperature?.value || '0.7'),
                                maxOutputTokens: parseInt(controls.aiMaxTokens?.value || '1000')
                            }
                        };

                        const response = await fetch(url, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (!response.ok) {
                            const errorBody = await response.text();
                            throw new Error(`Erreur API: ${response.status} ${response.statusText} - ${errorBody}`);
                        }

                        const data = await response.json();
                        
                        if (data.candidates && data.candidates.length > 0) {
                            if (data.candidates[0].finishReason !== "STOP" && data.candidates[0].finishReason !== "MAX_TOKENS") {
                                throw new Error(`L'IA a √©t√© bloqu√©e (raison: ${data.candidates[0].finishReason}). Veuillez reformuler votre demande.`);
                            }
                            if (data.candidates[0].content && data.candidates[0].content.parts && data.candidates[0].content.parts.length > 0) {
                                const rawText = data.candidates[0].content.parts[0].text;
                                console.log("üîç R√©ponse brute de l'IA:", rawText);
                                
                                // Nettoyer et valider le JSON
                                try {
                                    const cleanedJson = cleanJsonResponse(rawText);
                                    console.log("üßπ JSON nettoy√©:", cleanedJson);
                                    result = JSON.parse(cleanedJson);
                                    console.log("‚úÖ JSON pars√© avec succ√®s:", result);
                                } catch (parseError) {
                                    console.error("‚ùå Erreur de parsing JSON:", parseError);
                                    console.log("ÔøΩ Activation du parser robuste...");
                                    
                                    // Utiliser le parser robuste en premier
                                    try {
                                        result = forceParseJson(rawText);
                                        console.log("üî•‚úÖ Parser robuste r√©ussi:", result);
                                    } catch (robustError) {
                                        console.error("‚ùå Parser robuste √©chou√©:", robustError);
                                        console.log("ÔøΩ Activation mode fallback direct...");
                                        
                                        // Mode fallback direct sans tentatives de r√©paration
                                        try {
                                            const fallbackResult = await callGeminiFallback(prompt);
                                            if (fallbackResult) {
                                                result = fallbackResult;
                                                console.log("üîÑ‚úÖ Mode fallback r√©ussi:", result);
                                            } else {
                                                throw new Error(`√âchec total : ${parseError.message}`);
                                            }
                                        } catch (fallbackError) {
                                            throw new Error(`√âchec complet de l'analyse: ${fallbackError.message}`);
                                        }
                                    }
                                }
                            }
                        }
                    } else {
                        // Pour les prompts simples, utiliser directement notre fonction API
                        const apiKey = localStorage.getItem('gemini-api-key');
                        if (!apiKey) {
                            throw new Error('Cl√© API non configur√©e');
                        }
                        
                        const model = controls.aiModelSelect?.value || 'gemini-1.5-flash';
                        const temperature = parseFloat(controls.aiTemperature?.value || '0.7');
                        const maxTokens = parseInt(controls.aiMaxTokens?.value || '1000');
                        
                        const modelName = GEMINI_CONFIG.models[model] || model;
                        const url = `${GEMINI_CONFIG.baseUrl}${modelName}:generateContent?key=${apiKey}`;
                        
                        const requestBody = {
                            contents: [{
                                parts: [{ text: prompt }]
                            }],
                            generationConfig: {
                                temperature: temperature,
                                maxOutputTokens: maxTokens
                            }
                        };
                        
                        const response = await fetch(url, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(requestBody)
                        });
                        
                        if (!response.ok) {
                            const errorData = await response.json().catch(() => ({}));
                            throw new Error(errorData.error?.message || `Erreur API: ${response.status}`);
                        }
                        
                        const data = await response.json();
                        
                        if (!data.candidates || !data.candidates[0]?.content?.parts?.[0]?.text) {
                            throw new Error('R√©ponse invalide de l\'API');
                        }
                        
                        result = data.candidates[0].content.parts[0].text;
                    }
                    
                    hideLoader();
                    return result;
                    
                } catch (error) {
                    hideLoader();
                    console.error("Erreur d√©taill√©e de l'IA:", error);
                    showNotification(`Erreur de l'IA : ${error.message}`, 'error', 5000);
                    return null;
                }
            }
            
            function updateAllStyles() {
                // V√©rifications de null pour √©viter les erreurs TypeError
                try {
                    if (controls.primaryColorPicker && controls.primaryColorPicker.value) {
                        root.style.setProperty('--primary-color', controls.primaryColorPicker.value);
                    }
                    if (controls.secondaryColorPicker && controls.secondaryColorPicker.value) {
                        root.style.setProperty('--secondary-color', controls.secondaryColorPicker.value);
                    }
                    if (controls.bodyTextColorPicker && controls.bodyTextColorPicker.value) {
                        root.style.setProperty('--body-text-color', controls.bodyTextColorPicker.value);
                    }
                    if (controls.fontFamilyH1Select && controls.fontFamilyH1Select.value) {
                        root.style.setProperty('--font-family-h1', controls.fontFamilyH1Select.value);
                    }
                    if (controls.fontFamilyH2Select && controls.fontFamilyH2Select.value) {
                        root.style.setProperty('--font-family-h2', controls.fontFamilyH2Select.value);
                    }
                    if (controls.fontFamilyBodySelect && controls.fontFamilyBodySelect.value) {
                        root.style.setProperty('--font-family-body', controls.fontFamilyBodySelect.value);
                    }

                    const activeStyle = document.querySelector('.section-title-style-btn.active')?.dataset.titleStyle || 'style-underline';
                    document.querySelectorAll('.section-title').forEach(title => {
                        title.classList.remove('style-underline', 'style-side-line', 'style-background', 'style-boxed');
                        title.classList.add(activeStyle);
                    });
                } catch (error) {
                    console.warn('Erreur dans updateAllStyles:', error);
                }
                
                const banner = preview.banner;
                const newBannerStyle = controls.bannerStyleSelect.value;
                const newAlign = document.querySelector('.banner-align-btn.active')?.dataset.bannerAlign || 'left';
                const isInverted = controls.bannerInvertBtn.classList.contains('active');

                const classesToRemove = Array.from(banner.classList).filter(c => c.startsWith('banner-style-'));
                if (classesToRemove.length > 0) banner.classList.remove(...classesToRemove);

                if (newBannerStyle) banner.classList.add(newBannerStyle);
                
                const contentWrapper = banner.querySelector('.banner-content-wrapper');
                contentWrapper.className = 'banner-content-wrapper'; // Reset classes
                contentWrapper.classList.add(`banner-align-${newAlign}`);
                if (isInverted) contentWrapper.classList.add('banner-layout-inverted');
                
                checkAllPagesOverflow();
            }

            function populateFontSelectors() {
                const fonts = [
                    { name: 'Lato', value: "'Lato', sans-serif" },
                    { name: 'Montserrat', value: "'Montserrat', sans-serif" },
                    { name: 'Roboto Mono', value: "'Roboto Mono', monospace" },
                    { name: 'Playfair Display', value: "'Playfair Display', serif" },
                    { name: 'Merriweather', value: "'Merriweather', serif" },
                    { name: 'Oswald', value: "'Oswald', sans-serif" },
                    { name: 'Open Sans', value: "'Open Sans', sans-serif" },
                    { name: 'Source Sans Pro', value: "'Source Sans Pro', sans-serif" },
                    { name: 'Nunito Sans', value: "'Nunito Sans', sans-serif" },
                    { name: 'Cormorant Garamond', value: "'Cormorant Garamond', serif" },
                ];
                const selects = [controls.fontFamilyH1Select, controls.fontFamilyH2Select, controls.fontFamilyBodySelect, controls.bannerNomFont];
                selects.forEach(select => {
                    if (!select) return;
                    select.innerHTML = '';
                    fonts.forEach(font => {
                        const option = document.createElement('option');
                        option.value = font.value;
                        option.textContent = font.name;
                        select.appendChild(option);
                    });
                });
            }
            
            function populateIconPicker() {
                const icons = ["fa-user-circle", "fa-briefcase", "fa-graduation-cap", "fa-star", "fa-puzzle-piece", "fa-globe", "fa-paint-brush", "fa-certificate", "fa-lightbulb", "fa-heart", "fa-cogs", "fa-code", "fa-chart-line", "fa-comments", "fa-bullhorn", "fa-trophy", "fa-book", "fa-wrench", "fa-users", "fa-award", "fa-phone", "fa-envelope", "fa-map-marker-alt", "fa-linkedin", "fa-github"];
                controls.iconPickerGrid.innerHTML = '';
                icons.forEach(iconClass => {
                    const iconEl = document.createElement('i');
                    iconEl.className = `fas ${iconClass}`;
                    iconEl.dataset.icon = `fas ${iconClass}`;
                    controls.iconPickerGrid.appendChild(iconEl);
                });
            }

            function resetCVToDefault() {
                document.querySelectorAll('.cv-input, .banner-input, .custom-section-input').forEach(input => {
                    if(input.type === 'checkbox') input.checked = false;
                    else if (input.type !== 'range' && input.type !== 'color') input.value = '';
                });
                
                controls.experienceList.innerHTML = '';
                controls.formationList.innerHTML = '';
                controls.customSectionsList.innerHTML = '';
                controls.skillsLevelList.innerHTML = '';
                
                document.querySelectorAll('.custom-module-preview').forEach(m => m.remove());
                
                setDefaultRecruiterInfo();
                
                // S'assurer que les contr√¥les de th√®me sont disponibles avant d'appliquer le th√®me
                if (controls.primaryColorPicker && controls.secondaryColorPicker && controls.bodyTextColorPicker) {
                    applyTheme('professional');
                } else {
                    console.warn('Contr√¥les de th√®me non disponibles, applyTheme report√©');
                }
                
                document.querySelector('.layout-btn[data-layout="layout-1-col"]')?.click();
                document.querySelector('.skill-style-btn[data-skill-style="tags"]')?.click();
                
                Object.values(sliders).forEach(config => {
                    if (config.el && config.valueEl) {
                        const defaultValue = config.el.defaultValue;
                        config.el.value = defaultValue;
                        config.valueEl.textContent = defaultValue;
                        root.style.setProperty(config.property, `${defaultValue}${config.unit}`);
                    } else {
                        console.warn('Slider element not found in resetCVToDefault:', config);
                    }
                });
                
                moveBannerTo('modular');
                removeBannerBackground();

                document.querySelectorAll('.completion-checkbox').forEach(cb => {
                    cb.checked = false;
                    cb.closest('details').open = true;
                });
                updateProgressBar();
                
                updatePreview('form');
                updateAllStyles();
                showNotification("Le CV a √©t√© r√©initialis√©.", "success");
            }

            function applyTheme(themeName) {
                const theme = themes[themeName];
                if (!theme) return;

                // V√©rifications de null pour √©viter les erreurs TypeError
                if (controls.primaryColorPicker) controls.primaryColorPicker.value = theme.primaryColor;
                if (controls.secondaryColorPicker) controls.secondaryColorPicker.value = theme.secondaryColor;
                if (controls.bodyTextColorPicker) controls.bodyTextColorPicker.value = theme.bodyTextColor;
                if (controls.fontFamilyH1Select) controls.fontFamilyH1Select.value = theme.fontH1;
                if (controls.fontFamilyH2Select) controls.fontFamilyH2Select.value = theme.fontH2;
                if (controls.fontFamilyBodySelect) controls.fontFamilyBodySelect.value = theme.fontBody;

                document.querySelectorAll('.theme-btn').forEach(b => b.classList.remove('active'));
                document.querySelector(`.theme-btn[data-theme="${themeName}"]`)?.classList.add('active');

                updateAllStyles();
                updatePreview('theme');
            }
            
            async function handleAIAction(action, moduleElement) {
                let prompt = '';
                let targetControl = null;

                switch (action) {
                    case 'rewrite-profile':
                        const profileText = controls.description.value;
                        if (!profileText) { showNotification("Le profil est vide.", "error"); return; }
                        prompt = `En tant qu'expert en recrutement, r√©√©cris ce profil de CV pour qu'il soit plus percutant et professionnel, en utilisant des verbes d'action forts. Garde une longueur similaire et un ton professionnel. Ne retourne que le paragraphe final r√©√©crit, sans aucun commentaire. Le profil actuel est : "${profileText}"`;
                        targetControl = controls.description;
                        const newProfile = await callGeminiAPI(prompt);
                        if (newProfile && targetControl) {
                            targetControl.value = newProfile;
                            showNotification("Profil am√©lior√© par l'IA.", "success");
                        }
                        break;
                    case 'summarize-experience':
                        await summarizeAllExperiencesAI();
                        break;
                    case 'rewrite-formation':
                        const formations = getDynamicData(controls.formationList);
                        if (formations.length === 0) { showNotification("Aucune formation √† am√©liorer.", "error"); return; }
                        const formationSchema = { type: "ARRAY", items: { type: "OBJECT", properties: { title: { type: "STRING" }, meta: { type: "STRING" } } } };
                        const formationPrompt = `En tant qu'expert RH, am√©liore la formulation de ces entr√©es de formation pour un CV. Rends les titres plus percutants et les descriptions plus claires si n√©cessaire. Ne retourne que le r√©sultat final sous forme de tableau JSON \`[{"title": "...", "meta": "..."}]\` sans aucun commentaire ou texte additionnel. Voici les donn√©es actuelles : ${JSON.stringify(formations.map(f => ({ title: f.title, meta: f.meta })))}`;
                        const newFormations = await callGeminiAPI(formationPrompt, formationSchema);
                        if (newFormations && Array.isArray(newFormations)) {
                            controls.formationList.innerHTML = '';
                            newFormations.forEach(form => createDynamicItem(controls.formationList, [{ key: 'title', placeholder: 'Nom du dipl√¥me' }, { key: 'meta', placeholder: '√âtablissement & Ann√©e' }], form));
                            showNotification("Formations am√©lior√©es par l'IA.", "success");
                        }
                        break;
                    case 'rewrite-skills':
                        await synthesizeSkillsWithAI();
                        break;
                    default:
                        return;
                }
                updatePreview('form');
            }
            
            function setDefaultRecruiterInfo() {
                controls.bannerNom.value = "Lyes AMARA";
                controls.bannerPoste.value = "Responsable d‚Äôactivit√© recrutement ‚Äì BTP ‚Äì France";
                controls.bannerEmail.value = "l.amara@ltd-international.com";
                controls.bannerTel.value = "01 56 02 12 25 / 06 34 25 32 96";
            }

            function anonymizeCV() {
                if (isAnonymized) {
                    controls.nom.value = originalData.nom;
                    controls.prenom.value = originalData.prenom;
                    
                    controls.anonymizeBtn.innerHTML = '<i class="fa-solid fa-user-secret"></i> Anonymiser le CV';
                    isAnonymized = false;
                    showNotification("CV d√©sanonymis√©.", "success");
                } else {
                    originalData = {
                        nom: controls.nom.value,
                        prenom: controls.prenom.value,
                    };
                    
                    const firstLetter = originalData.nom ? originalData.nom.charAt(0) + '.' : '';
                    controls.nom.value = firstLetter;
                    controls.prenom.value = originalData.prenom;
                    
                    controls.anonymizeBtn.innerHTML = '<i class="fa-solid fa-user-check"></i> D√©sanonymiser le CV';
                    isAnonymized = true;
                    showNotification("CV anonymis√©.", "success");
                }
                updatePreview('form');
            }

            async function summarizeAllExperiencesAI() {
                const experienceItems = controls.experienceList.querySelectorAll('.data-desc');
                if (experienceItems.length === 0) {
                    showNotification("Aucune exp√©rience √† r√©sumer.", "error");
                    return;
                }

                showLoader("Synth√®se des exp√©riences...");
                for (let i = 0; i < experienceItems.length; i++) {
                    const textarea = experienceItems[i];
                    const originalText = textarea.value;
                    if (originalText) {
                        const prompt = `R√©sume la description de cette mission professionnelle en 5 lignes maximum. Utilise des verbes d'action et un format de liste √† puces (chaque point commen√ßant par '‚Ä¢ '). Ne retourne que le texte final format√© en liste √† puces, sans aucune phrase d'introduction, de conclusion ou de commentaire. Voici la description : "${originalText}"`;
                        const summary = await callGeminiAPI(prompt);
                        if (summary) {
                            textarea.value = summary;
                        }
                    }
                }
                hideLoader();
                updatePreview('form');
                showNotification("Toutes les exp√©riences ont √©t√© synth√©tis√©es.", "success");
            }

            async function synthesizeSkillsWithAI() {
                const currentSkills = controls.competences.value;
                if (!currentSkills) {
                    showNotification("La liste de comp√©tences est vide.", "error");
                    return;
                }
                const prompt = `Analyse cette liste de comp√©tences de CV: "${currentSkills}". Regroupe-les par cat√©gories pertinentes (ex: Langages, Frameworks, Outils, Logiciels, Langues, etc.). Retourne le r√©sultat sous la forme "Cat√©gorie 1: comp√©tence A, comp√©tence B\nCat√©gorie 2: comp√©tence C, comp√©tence D". Ne retourne que le texte final format√©, sans aucune phrase d'introduction, de conclusion ou de commentaire.`;

                const organizedSkills = await callGeminiAPI(prompt);
                if (organizedSkills) {
                    controls.competences.value = organizedSkills;
                    updatePreview('form');
                    showNotification("Comp√©tences organis√©es par l'IA.", "success");
                }
            }

            async function limitSkillsWithAI() {
                const currentSkills = controls.competences.value;
                const jobTitle = controls.poste.value;
                if (!currentSkills) {
                    showNotification("La liste de comp√©tences est vide.", "error");
                    return;
                }
                if (!jobTitle) {
                    showNotification("Veuillez renseigner le 'Poste recherch√©' pour de meilleurs r√©sultats.", "error");
                    return;
                }
                const prompt = `√Ä partir de cette liste de comp√©tences: "${currentSkills}", s√©lectionne les 10 comp√©tences les plus importantes et pertinentes pour un poste de "${jobTitle}". Retourne uniquement la liste des 10 comp√©tences, s√©par√©es par des virgules, sans aucune phrase d'introduction, de conclusion ou de commentaire.`;

                const limitedSkills = await callGeminiAPI(prompt);
                if (limitedSkills) {
                    controls.competences.value = limitedSkills;
                    updatePreview('form');
                    showNotification("Comp√©tences limit√©es √† 10 par l'IA.", "success");
                }
            }
            
            function removeBannerBackground() {
                preview.bannerBgImg.src = '';
                controls.bannerBgImage.value = ''; // Reset file input
                controls.bannerBgOpacity.value = 1;
                controls.bannerBgBlur.value = 0;
                controls.bannerBgGrayscale.checked = false;
                updateBannerBackground();
            }

            // NEW: Progress Bar Update Function
            function updateProgressBar() {
                const checkboxes = document.querySelectorAll('.completion-checkbox');
                const total = checkboxes.length;
                const completed = document.querySelectorAll('.completion-checkbox:checked').length;
                const percentage = total > 0 ? (completed / total) * 100 : 0;

                const progressBar = document.getElementById('progress-bar');
                const progressText = document.getElementById('progress-text');

                if(progressBar) progressBar.style.width = `${percentage}%`;
                if(progressText) progressText.textContent = `${completed}/${total} sections compl√©t√©es`;
            }

            function populateLevelsFromText() {
                const text = controls.competences.value;
                const skills = text
                    .replace(/.*:/g, '') // Remove category labels like "Langages:"
                    .split(/,|\n/)
                    .map(s => s.trim())
                    .filter(Boolean);

                controls.skillsLevelList.innerHTML = '';
                skills.forEach(skill => createSkillLevelItem(skill, 3));
            }

            // --- INITIALIZATION FUNCTION ---
            function initializeAll() {
                console.log("Initializing UI components and event listeners...");
                
                reinitializePreviewSelectors();
                initializeSortableForPage(1);
                
                populateFontSelectors();
                populateIconPicker();

                // --- EVENT LISTENERS ---

                const tabNavigation = document.getElementById('tab-navigation');
                const tabPanels = document.querySelectorAll('.tab-panel');
                const tabButtons = document.querySelectorAll('.tab-btn');
                
                tabNavigation.addEventListener('click', (e) => {
                    const tabBtn = e.target.closest('.tab-btn');
                    if (!tabBtn) return;
                    tabPanels.forEach(panel => panel.classList.add('hidden'));
                    tabButtons.forEach(btn => {
                        btn.classList.remove('border-blue-600', 'text-blue-600');
                        btn.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
                    });
                    const targetPanelId = tabBtn.dataset.target;
                    document.querySelector(targetPanelId).classList.remove('hidden');
                    tabBtn.classList.add('border-blue-600', 'text-blue-600');
                    tabBtn.classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
                });
                tabButtons[0].click();

                controls.undoBtn.addEventListener('click', undo);
                controls.redoBtn.addEventListener('click', redo);
                document.addEventListener('keydown', (e) => {
                    if (e.ctrlKey && e.key === 'z') { e.preventDefault(); undo(); }
                    if (e.ctrlKey && e.key === 'y') { e.preventDefault(); redo(); }
                });

                controls.addExperienceBtn.addEventListener('click', () => createDynamicItem(controls.experienceList, [{ key: 'title', placeholder: 'Titre du poste' }, { key: 'meta', placeholder: 'Entreprise & Dates' }, { key: 'desc', placeholder: 'Description des missions', type: 'textarea' }]));
                controls.addFormationBtn.addEventListener('click', () => createDynamicItem(controls.formationList, [{ key: 'title', placeholder: 'Nom du dipl√¥me' }, { key: 'meta', placeholder: '√âtablissement & Ann√©e' }]));
                
                const controlsPanel = document.getElementById('controls');
                controlsPanel.addEventListener('input', (e) => {
                    if (e.target.matches('.cv-input, .banner-input, .custom-section-input, #banner-bg-opacity, #banner-bg-blur, #banner-bg-grayscale')) {
                        if (e.target.matches('#banner-bg-opacity, #banner-bg-blur, #banner-bg-grayscale')) {
                             updateBannerBackground();
                        } else {
                             updatePreview('form');
                             updateAllStyles();
                        }
                    }
                    if(e.target.matches('.completion-checkbox')) {
                        updateProgressBar();
                    }
                     if(e.target.matches('.skill-level-input')) {
                         e.target.nextElementSibling.textContent = `${e.target.value}/5`;
                         updatePreview('form');
                     }
                });
                 controlsPanel.addEventListener('change', (e) => {
                    if (e.target.matches('.cv-input, .banner-input, .custom-section-input')) {
                        updatePreview('form');
                        updateAllStyles();
                    }
                });

                controls.bannerImage.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (event) => { preview.bannerImg.src = event.target.result; };
                        reader.readAsDataURL(file);
                    }
                });
                
                controls.bannerBgImage.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (event) => {
                            preview.bannerBgImg.src = event.target.result;
                            updateBannerBackground();
                        };
                        reader.readAsDataURL(file);
                    }
                });

                preview.previewWrapper.addEventListener('input', (e) => {
                    if (e.target.hasAttribute('contenteditable')) {
                        syncFormFromPreview(e.target);
                    }
                });

                preview.previewWrapper.addEventListener('click', (e) => {
                    const target = e.target;
                    
                    const visibilityBtn = target.closest('.toggle-visibility-btn');
                    if (visibilityBtn) {
                        const moduleElement = visibilityBtn.closest('.cv-module');
                        const icon = visibilityBtn.querySelector('i');
                        if (moduleElement) {
                            moduleElement.classList.toggle('section-hidden');
                            const isHidden = moduleElement.classList.contains('section-hidden');
                            if (icon) {
                                icon.className = `fas ${isHidden ? 'fa-eye-slash' : 'fa-eye'}`;
                            }
                        }
                        return;
                    }

                    const aiBtn = target.closest('.ai-action-btn');
                    if (aiBtn) {
                        const action = aiBtn.dataset.action;
                        if (action) {
                            handleAIAction(action);
                        }
                        return;
                    }

                    const deleteBlockBtn = target.closest('.delete-block-btn');
                    if (deleteBlockBtn) {
                        const itemContainer = deleteBlockBtn.closest('.dynamic-item-container');
                        if (itemContainer) {
                            const index = parseInt(itemContainer.dataset.index, 10);
                            const type = itemContainer.dataset.type;
                            const formList = type === 'experience' ? controls.experienceList : controls.formationList;
                            if (formList.children[index]) {
                                formList.children[index].remove();
                                updatePreview('form');
                            }
                        } else {
                            const customModule = deleteBlockBtn.closest('.custom-module-preview');
                            if(customModule) {
                                const controlItem = controls.customSectionsList.querySelector(`[data-section-id="${customModule.id}"]`);
                                if(controlItem) controlItem.remove();
                                customModule.remove();
                            }
                        }
                        return;
                    }

                    const addLineBtn = target.closest('.add-line-preview-btn');
                    if (addLineBtn) {
                        const index = parseInt(addLineBtn.dataset.index, 10);
                        const type = addLineBtn.dataset.type;
                        if (type === 'experience') createDynamicItem(controls.experienceList, [{ key: 'title', placeholder: 'Titre du poste' }, { key: 'meta', placeholder: 'Entreprise & Dates' }, { key: 'desc', placeholder: 'Description des missions', type: 'textarea' }], {}, index);
                        else if (type === 'formation') createDynamicItem(controls.formationList, [{ key: 'title', placeholder: 'Nom du dipl√¥me' }, { key: 'meta', placeholder: '√âtablissement & Ann√©e' }], {}, index);
                        return;
                    }

                    const deleteLineBtn = target.closest('.delete-line-btn');
                    if (deleteLineBtn) {
                        const wrapper = deleteLineBtn.closest('.editable-wrapper');
                        if (wrapper) {
                            wrapper.remove();
                            syncFormFromPreview(wrapper.closest('.dynamic-preview-item') || document.getElementById('cv-description-preview'));
                        }
                        return;
                    }
                    
                    const removePageBtn = target.closest('.remove-page-btn');
                    if (removePageBtn) {
                        const pageContainer = removePageBtn.closest('.a4-page-container');
                        if (pageContainer) {
                            pageContainer.remove();
                            checkAllPagesOverflow();
                        }
                        return;
                    }
                });

                controlsPanel.addEventListener('click', (e) => {
                    const target = e.target;
                    
                    const removeBtn = target.closest('.remove-dynamic-item-btn, .remove-skill-level-btn');
                    if (removeBtn) {
                        removeBtn.parentElement.remove();
                        updatePreview('form');
                        return;
                    }
                    const removeSectionBtn = target.closest('.remove-section-btn');
                    if (removeSectionBtn) {
                        const sectionDiv = removeSectionBtn.closest('[data-section-id]');
                        const sectionId = sectionDiv.dataset.sectionId;
                        sectionDiv.remove();
                        const previewModule = document.getElementById(sectionId);
                        if(previewModule) previewModule.remove();
                        return;
                    }
                    
                    const layoutBtn = target.closest('.layout-btn');
                    if (layoutBtn) {
                        const layout = layoutBtn.dataset.layout;
                        document.querySelectorAll('.layout-btn').forEach(b => b.classList.remove('active'));
                        layoutBtn.classList.add('active');
                        document.querySelectorAll('.cv-body-container').forEach(container => {
                           container.className = `cv-body-container ${layout}`;
                           if (layout === 'layout-1-col') {
                               const col2 = container.querySelector('.cv-column:nth-child(2)');
                               const col1 = container.querySelector('.cv-column:nth-child(1)');
                               if (col2 && col1) Array.from(col2.children).forEach(module => col1.appendChild(module));
                           }
                           container.style.gridTemplateColumns = '';
                        });
                        setupAllResizers();
                        checkAllPagesOverflow();
                        return;
                    }

                    const titleStyleBtn = target.closest('.section-title-style-btn');
                    if (titleStyleBtn) {
                        document.querySelectorAll('.section-title-style-btn').forEach(b => b.classList.remove('active'));
                        titleStyleBtn.classList.add('active');
                        updateAllStyles();
                        return;
                    }
                    
                    const themeBtn = target.closest('.theme-btn');
                    if (themeBtn) {
                        applyTheme(themeBtn.dataset.theme);
                        return;
                    }

                    const logoSizeBtn = target.closest('.logo-size-btn');
                    if (logoSizeBtn) {
                        document.querySelectorAll('.logo-size-btn').forEach(b => b.classList.remove('active'));
                        logoSizeBtn.classList.add('active');
                        preview.bannerImg.className = `logo-${logoSizeBtn.dataset.logoSize}`;
                        return;
                    }

                    const skillStyleBtn = target.closest('.skill-style-btn');
                    if (skillStyleBtn) {
                        document.querySelectorAll('.skill-style-btn').forEach(b => b.classList.remove('active'));
                        skillStyleBtn.classList.add('active');
                        const style = skillStyleBtn.dataset.skillStyle;
                        controls.skillsTextControls.classList.toggle('hidden', style === 'levels');
                        controls.skillsLevelControls.classList.toggle('hidden', style !== 'levels');
                        if (style === 'levels') {
                            populateLevelsFromText();
                        }
                        updatePreview('form');
                        return;
                    }
                    
                    const gaugeStyleBtn = target.closest('.gauge-style-btn');
                    if (gaugeStyleBtn) {
                        document.querySelectorAll('.gauge-style-btn').forEach(b => b.classList.remove('active'));
                        gaugeStyleBtn.classList.add('active');
                        updatePreview('form');
                        return;
                    }

                    const styleToggleBtn = target.closest('.style-toggle-btn');
                    if (styleToggleBtn) {
                        styleToggleBtn.classList.toggle('active');
                        updatePreview('form');
                        return;
                    }
                });

                // Fonction de nettoyage du texte d'entr√©e
                function cleanInputText(rawText) {
                    let cleaned = rawText;
                    
                    // Nettoyer les caract√®res d'√©chappement
                    cleaned = cleaned.replace(/\\r\\n/g, ' ');
                    cleaned = cleaned.replace(/\\n/g, ' ');
                    cleaned = cleaned.replace(/\\r/g, ' ');
                    cleaned = cleaned.replace(/\r\n/g, ' ');
                    cleaned = cleaned.replace(/\n/g, ' ');
                    cleaned = cleaned.replace(/\r/g, ' ');
                    
                    // Nettoyer les espaces multiples
                    cleaned = cleaned.replace(/\s+/g, ' ');
                    
                    // Nettoyer les caract√®res sp√©ciaux probl√©matiques
                    cleaned = cleaned.replace(/[""]/g, '"');
                    cleaned = cleaned.replace(/['']/g, "'");
                    
                    // Ajouter des points pour s√©parer les phrases qui se suivent
                    cleaned = cleaned.replace(/([a-z])([A-Z])/g, '$1. $2');
                    
                    return cleaned.trim();
                }

                Object.values(sliders).forEach(config => {
                    if (config.el && config.valueEl) {
                        config.el.addEventListener('input', () => {
                            config.valueEl.textContent = config.el.value;
                            root.style.setProperty(config.property, `${config.el.value}${config.unit}`);
                            checkAllPagesOverflow();
                        });
                    } else {
                        console.warn('Slider element not found:', config);
                    }
                });
                
                // Fonction de post-traitement des donn√©es extraites
                function postProcessExtractedData(data) {
                    const cleaned = { ...data };
                    
                    // Nettoyer les champs texte
                    if (cleaned.nom) cleaned.nom = cleanTextValue(cleaned.nom);
                    if (cleaned.prenom) cleaned.prenom = cleanTextValue(cleaned.prenom);
                    if (cleaned.poste) cleaned.poste = cleanTextValue(cleaned.poste);
                    if (cleaned.description) cleaned.description = cleanTextValue(cleaned.description);
                    if (cleaned.competences) cleaned.competences = cleanTextValue(cleaned.competences);
                    
                    // Nettoyer les exp√©riences
                    if (cleaned.experiences && Array.isArray(cleaned.experiences)) {
                        cleaned.experiences = cleaned.experiences.map(exp => ({
                            title: cleanTextValue(exp.title || ''),
                            meta: cleanTextValue(exp.meta || ''),
                            desc: cleanTextValue(exp.desc || '')
                        })).filter(exp => exp.title || exp.meta || exp.desc);
                    }
                    
                    // Nettoyer les formations
                    if (cleaned.formations && Array.isArray(cleaned.formations)) {
                        cleaned.formations = cleaned.formations.map(form => ({
                            title: cleanTextValue(form.title || ''),
                            meta: cleanTextValue(form.meta || '')
                        })).filter(form => form.title || form.meta);
                    }
                    
                    // Si pas de nom/pr√©nom mais du contenu, sugg√©rer un placeholder
                    if (!cleaned.nom && !cleaned.prenom && (cleaned.experiences?.length > 0 || cleaned.description)) {
                        console.log("üí° Suggestion: Ajoutez manuellement nom et pr√©nom");
                        showNotification("‚úÖ CV analys√© ! N'oubliez pas d'ajouter votre nom et pr√©nom.", "info");
                    }
                    
                    return cleaned;
                }
                
                function cleanTextValue(text) {
                    if (!text) return '';
                    
                    let cleaned = text.toString();
                    
                    // Supprimer les caract√®res d'√©chappement restants
                    cleaned = cleaned.replace(/\\r\\n/g, ' ');
                    cleaned = cleaned.replace(/\\n/g, ' ');
                    cleaned = cleaned.replace(/\\"/g, '"');
                    
                    // Nettoyer les espaces multiples
                    cleaned = cleaned.replace(/\s+/g, ' ');
                    
                    // Premi√®re lettre en majuscule pour les noms
                    cleaned = cleaned.charAt(0).toUpperCase() + cleaned.slice(1);
                    
                    return cleaned.trim();
                }
                
                controls.analyzeBtn.addEventListener('click', async () => {
                    let text = controls.aiInput.value;
                    if (!text) { showNotification("Veuillez coller du texte √† analyser.", "error"); return; }
                    
                    // Nettoyage pr√©alable du texte
                    text = cleanInputText(text);
                    console.log("üßπ Texte nettoy√©:", text);
                    
                    // V√©rification de la cl√© API
                    const apiKey = localStorage.getItem('gemini-api-key');
                    if (!apiKey) {
                        showNotification("‚ö†Ô∏è Cl√© API non configur√©e ! Allez dans l'onglet API pour configurer votre cl√© Gemini.", "error");
                        return;
                    }
                    
                    const schema = {
                        type: "OBJECT",
                        properties: {
                            nom: { type: "STRING" }, 
                            prenom: { type: "STRING" }, 
                            poste: { type: "STRING" }, 
                            description: { type: "STRING" },
                            experiences: { 
                                type: "ARRAY", 
                                items: { 
                                    type: "OBJECT", 
                                    properties: { 
                                        title: { type: "STRING" }, 
                                        meta: { type: "STRING" }, 
                                        desc: { type: "STRING" } 
                                    } 
                                } 
                            },
                            formations: { 
                                type: "ARRAY", 
                                items: { 
                                    type: "OBJECT", 
                                    properties: { 
                                        title: { type: "STRING" }, 
                                        meta: { type: "STRING" } 
                                    } 
                                } 
                            },
                            competences: { type: "STRING" }
                        }
                    };
                    
                    const prompt = `Tu es un expert en analyse de CV et de textes professionnels. Analyse le texte suivant et extrais INTELLIGEMMENT toutes les informations disponibles :

R√àGLES D'EXTRACTION :

1. INFORMATIONS PERSONNELLES :
   - nom : nom de famille (si absent, laisse vide)
   - prenom : pr√©nom (si absent, laisse vide)  
   - poste : d√©duis le poste principal √† partir du contexte professionnel (ex: "Directeur R√©gional", "Manager", "Responsable")

2. DESCRIPTION PROFESSIONNELLE :
   - description : r√©sume en 2-3 phrases le profil professionnel bas√© sur les exp√©riences d√©crites

3. EXPERIENCES PROFESSIONNELLES :
   ANALYSE INTELLIGENTE du texte pour identifier et structurer les exp√©riences :
   - Divise le texte en blocs logiques d'exp√©riences professionnelles
   - Pour chaque exp√©rience identifi√©e :
     * title : titre du poste ou fonction principale
     * meta : entreprise + p√©riode (si trouv√©e) ou "P√©riode non pr√©cis√©e"
     * desc : missions et responsabilit√©s (nettoie et structure le texte)

4. FORMATIONS : 
   - Cherche toute mention de dipl√¥mes, formations, √©tudes
   - Si aucune formation explicite, laisse le tableau vide

5. COMPETENCES :
   - Extrais TOUTES les comp√©tences mentionn√©es : techniques, manag√©riales, sectorielles
   - D√©duis les comp√©tences implicites √† partir des missions d√©crites

TRAITEMENT DU TEXTE :
- Nettoie les caract√®res d'√©chappement (\\r\\n, \\n)
- Structure les phrases qui se suivent
- Identifie les activit√©s principales m√™me si mal format√©es
- Groupe les activit√©s similaires

GESTION DES CAS PARTICULIERS :
- Si nom/pr√©nom absents : laisse vides mais remplis le reste
- Si le texte est une liste d'activit√©s : structure en exp√©riences logiques
- Si entreprises multiples : cr√©e une exp√©rience par entreprise
- Si p√©riode continue : groupe les activit√©s sous une m√™me exp√©rience

FORMAT DE SORTIE :
JSON STRICT sans texte suppl√©mentaire. Nettoie tous les \\r\\n et caract√®res sp√©ciaux.

Texte √† analyser :
"""${text}"""`;
                    
                    console.log("ü§ñ Prompt envoy√© √† l'IA:", prompt);
                    const extractedData = await callGeminiAPI(prompt, schema);
                    console.log("üì• Donn√©es extraites par l'IA:", extractedData);
                    
                    if (extractedData) {
                        // Post-traitement des donn√©es extraites
                        const cleanedData = postProcessExtractedData(extractedData);
                        
                        controls.nom.value = cleanedData.nom || '';
                        controls.prenom.value = cleanedData.prenom || '';
                        controls.poste.value = cleanedData.poste || '';
                        controls.description.value = cleanedData.description || '';
                        controls.competences.value = cleanedData.competences || '';
                        
                        // Nettoyer et remplir les exp√©riences
                        controls.experienceList.innerHTML = '';
                        if (cleanedData.experiences && cleanedData.experiences.length > 0) {
                            console.log("üìã Ajout de", cleanedData.experiences.length, "exp√©riences");
                            cleanedData.experiences.forEach(exp => {
                                createDynamicItem(controls.experienceList, [
                                    { key: 'title', placeholder: 'Titre du poste' }, 
                                    { key: 'meta', placeholder: 'Entreprise & Dates' }, 
                                    { key: 'desc', placeholder: 'Description', type: 'textarea' }
                                ], exp);
                            });
                        } else {
                            console.log("‚ö†Ô∏è Aucune exp√©rience extraite");
                        }
                        
                        // Nettoyer et remplir les formations
                        controls.formationList.innerHTML = '';
                        if (cleanedData.formations && cleanedData.formations.length > 0) {
                            console.log("üéì Ajout de", cleanedData.formations.length, "formations");
                            cleanedData.formations.forEach(form => {
                                createDynamicItem(controls.formationList, [
                                    { key: 'title', placeholder: 'Nom du dipl√¥me' }, 
                                    { key: 'meta', placeholder: '√âtablissement & Ann√©e' }
                                ], form);
                            });
                        } else {
                            console.log("‚ö†Ô∏è Aucune formation extraite");
                        }

                        updatePreview('form');
                        showNotification("CV rempli par l'IA !", "success");
                    } else {
                        showNotification("Erreur : L'IA n'a pas pu extraire les donn√©es", "error");
                    }
                });
                
                // === GESTIONNAIRES D'√âV√âNEMENTS API ===
                
                // Sauvegarde cl√© API
                if (controls.saveGeminiApiKey) {
                    controls.saveGeminiApiKey.addEventListener('click', saveGeminiApiKey);
                }
                
                // Basculer visibilit√© cl√©
                if (controls.toggleApiKeyVisibility) {
                    controls.toggleApiKeyVisibility.addEventListener('click', toggleApiKeyVisibility);
                }
                
                // Test de l'API
                if (controls.testGeminiApi) {
                    controls.testGeminiApi.addEventListener('click', testGeminiApi);
                }
                
                // Test personnalis√©
                if (controls.runCustomTest) {
                    controls.runCustomTest.addEventListener('click', runCustomTest);
                }
                
                // R√©initialiser param√®tres
                if (controls.resetApiSettings) {
                    controls.resetApiSettings.addEventListener('click', resetApiSettings);
                }
                
                // Mise √† jour des valeurs de curseurs
                if (controls.aiTemperature && controls.temperatureValue) {
                    controls.aiTemperature.addEventListener('input', () => {
                        controls.temperatureValue.textContent = controls.aiTemperature.value;
                    });
                }
                
                if (controls.aiMaxTokens && controls.maxTokensValue) {
                    controls.aiMaxTokens.addEventListener('input', () => {
                        controls.maxTokensValue.textContent = controls.aiMaxTokens.value;
                    });
                }
                
                // Charger la cl√© API au d√©marrage
                loadGeminiApiKey();
                
                // Mettre √† jour le statut du quota au d√©marrage
                updateQuotaStatus();
                
                controls.generateMailBtn.addEventListener('click', async () => {
                    const nomCandidat = `${controls.prenom.value} ${controls.nom.value}`.trim();
                    const posteCandidat = controls.poste.value;
                    const dispoCandidat = controls.qualificationDispo.value;
                    const salaireCandidat = controls.qualificationSalaire.value;
                    const profilCandidat = controls.description.value;
                    const nomRecruteur = controls.bannerNom.value || "votre consultant";
                    const posteRecruteur = controls.bannerPoste.value || "cabinet de recrutement";

                    if (!nomCandidat || !posteCandidat) {
                        showNotification("Veuillez renseigner au moins le nom, pr√©nom et poste du candidat.", "error");
                        return;
                    }

                    const prompt = `En tant que consultant en recrutement pour un cabinet, r√©dige un e-mail de vente percutant destin√© √† un client pour lui pr√©senter un excellent candidat.
                    
                    **Ton Persona:** Tu es ${nomRecruteur}, ${posteRecruteur}. Tu es proactif, professionnel et tu connais bien ton march√©.
                    **Objectif:** Convaincre le client de l'ad√©quation du profil avec ses besoins potentiels et l'inciter √† en savoir plus.
                    
                    **Informations sur le candidat √† int√©grer:**
                    - Nom du candidat: ${nomCandidat}
                    - Poste cibl√©: ${posteCandidat}
                    - Disponibilit√©: ${dispoCandidat || '√† discuter'}
                    - Pr√©tentions salariales: ${salaireCandidat || '√† discuter'}
                    - R√©sum√© du profil: "${profilCandidat}"

                    **Structure de l'e-mail:**
                    1.  **Objet accrocheur:** Ex: "Profil - [Poste du candidat]" ou "Opportunit√©: Un [Poste du candidat] pour vos √©quipes".
                    2.  **Introduction:** Commence par une formule de politesse professionnelle (ex: "Bonjour,"). Mentionne que tu le contactes pour lui pr√©senter un profil qui pourrait l'int√©resser.
                    3.  **Pr√©sentation du profil:** Met en avant les points forts du candidat en te basant sur son r√©sum√©. Sois concis et impactant. Mentionne le poste, et √©ventuellement une ou deux comp√©tences cl√©s si elles sont √©videntes.
                    4.  **Informations pratiques:** Indique sa disponibilit√© et ses pr√©tentions salariales de mani√®re professionnelle.
                    5.  **Call to action:** Propose d'envoyer le CV complet et/ou de planifier un bref appel pour discuter plus en d√©tail du profil.
                    6.  **Conclusion:** Termine par une formule de politesse et ta signature (${nomRecruteur}).

                    **Important:** Ne retourne QUE le texte de l'e-mail (objet inclus, sous la forme "Objet: ..."), sans aucune phrase d'introduction ou de conclusion de ta part. Le ton doit √™tre celui d'un partenaire commercial, pas celui du candidat.`;

                    const mailContent = await callGeminiAPI(prompt);
                    if (mailContent) {
                        controls.recruiterMailContent.value = mailContent;
                        showNotification("E-mail de pr√©sentation client g√©n√©r√©.", "success");
                    }
                });

                // Function to generate PDF with selectable text using jsPDF - Single Page Version
                function generateSelectablePDF() {
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF();
                    
                    const margin = 15;
                    const pageWidth = pdf.internal.pageSize.getWidth();
                    const pageHeight = pdf.internal.pageSize.getHeight();
                    const contentWidth = pageWidth - (margin * 2);
                    const maxContentHeight = pageHeight - (margin * 2);
                    
                    // Collect all content first to calculate total height needed
                    const contentSections = [];
                    
                    // Helper function to prepare content sections
                    function addContentSection(text, fontSize, isBold = false, color = [0, 0, 0], spacing = 5) {
                        if (!text || !text.trim()) return;
                        
                        contentSections.push({
                            text: text.trim(),
                            fontSize,
                            isBold,
                            color,
                            spacing
                        });
                    }
                    
                    // Collect all content with safety checks
                    const nom = (controls.prenom?.value || '') + ' ' + (controls.nom?.value || '');
                    const poste = controls.poste?.value || '';
                    
                    // Header
                    if (nom.trim()) addContentSection(nom.trim(), 18, true, [0, 0, 139], 3);
                    if (poste.trim()) addContentSection(poste, 12, false, [100, 100, 100], 8);
                    
                    // Contact info
                    let contactInfo = [];
                    if (controls.bannerEmail?.value) contactInfo.push(controls.bannerEmail.value);
                    if (controls.bannerTel?.value) contactInfo.push(controls.bannerTel.value);
                    if (contactInfo.length > 0) {
                        addContentSection(contactInfo.join(' | '), 9, false, [100, 100, 100], 8);
                    }
                    
                    // Profile/Description
                    if (controls.description?.value) {
                        addContentSection('PROFIL', 12, true, [0, 0, 0], 3);
                        addContentSection(controls.description.value, 9, false, [0, 0, 0], 8);
                    }
                    
                    // Experiences
                    const experiences = document.querySelectorAll('#cv-experience-preview .experience-item');
                    if (experiences.length > 0) {
                        addContentSection('EXP√âRIENCE PROFESSIONNELLE', 12, true, [0, 0, 0], 3);
                        experiences.forEach((exp, index) => {
                            const periode = exp.querySelector('.experience-period')?.textContent || '';
                            const posteExp = exp.querySelector('.experience-poste')?.textContent || '';
                            const entreprise = exp.querySelector('.experience-entreprise')?.textContent || '';
                            const description = exp.querySelector('.experience-description')?.textContent || '';
                            
                            if (periode) addContentSection(periode, 8, false, [100, 100, 100], 2);
                            if (posteExp) addContentSection(posteExp, 10, true, [0, 0, 0], 1);
                            if (entreprise) addContentSection(entreprise, 9, false, [0, 0, 139], 1);
                            if (description) addContentSection(description, 8, false, [0, 0, 0], index < experiences.length - 1 ? 5 : 3);
                        });
                    }
                    
                    // Formation
                    const formations = document.querySelectorAll('#cv-formation-preview .formation-item');
                    if (formations.length > 0) {
                        addContentSection('FORMATION', 12, true, [0, 0, 0], 3);
                        formations.forEach((form, index) => {
                            const periode = form.querySelector('.formation-period')?.textContent || '';
                            const diplome = form.querySelector('.formation-diplome')?.textContent || '';
                            const etablissement = form.querySelector('.formation-etablissement')?.textContent || '';
                            
                            if (periode) addContentSection(periode, 8, false, [100, 100, 100], 2);
                            if (diplome) addContentSection(diplome, 10, true, [0, 0, 0], 1);
                            if (etablissement) addContentSection(etablissement, 9, false, [0, 0, 139], index < formations.length - 1 ? 4 : 3);
                        });
                    }
                    
                    // Competences
                    const competences = document.querySelector('#cv-competences-preview')?.textContent;
                    if (competences && competences.trim()) {
                        addContentSection('COMP√âTENCES', 12, true, [0, 0, 0], 3);
                        addContentSection(competences.trim(), 9, false, [0, 0, 0], 3);
                    }
                    
                    // Custom sections
                    const customSections = document.querySelectorAll('.custom-section-preview');
                    customSections.forEach((section, index) => {
                        const title = section.querySelector('.section-title')?.textContent || '';
                        const content = section.querySelector('.section-content')?.textContent || '';
                        
                        if (title) addContentSection(title.toUpperCase(), 12, true, [0, 0, 0], 3);
                        if (content) addContentSection(content, 9, false, [0, 0, 0], index < customSections.length - 1 ? 8 : 3);
                    });
                    
                    // Calculate total height needed and scale factor
                    let totalHeight = 0;
                    contentSections.forEach(section => {
                        const tempPdf = new jsPDF(); // Temporary PDF for calculations
                        tempPdf.setFontSize(section.fontSize);
                        const lines = tempPdf.splitTextToSize(section.text, contentWidth);
                        totalHeight += lines.length * section.fontSize * 0.4 + section.spacing;
                    });
                    
                    // Calculate scale factor to fit everything on one page
                    const scaleFactor = totalHeight > maxContentHeight ? maxContentHeight / totalHeight : 1;
                    
                    // Apply content with scaling
                    let yPosition = margin;
                    
                    contentSections.forEach(section => {
                        const adjustedFontSize = Math.max(6, section.fontSize * scaleFactor); // Minimum font size of 6
                        const adjustedSpacing = section.spacing * scaleFactor;
                        
                        pdf.setFontSize(adjustedFontSize);
                        pdf.setFont("helvetica", section.isBold ? "bold" : "normal");
                        pdf.setTextColor(...section.color);
                        
                        const lines = pdf.splitTextToSize(section.text, contentWidth);
                        pdf.text(lines, margin, yPosition);
                        yPosition += lines.length * adjustedFontSize * 0.4 + adjustedSpacing;
                    });
                    
                    // Ensure we only have one page by deleting any additional pages
                    const totalPages = pdf.getNumberOfPages();
                    for (let i = totalPages; i > 1; i--) {
                        pdf.deletePage(i);
                    }
                    
                    // Save the PDF
                    const prenomValue = controls.prenom?.value || 'Prenom';
                    const nomValue = controls.nom?.value || 'Nom';
                    const filename = `CV_${prenomValue}_${nomValue}.pdf`.replace(/ /g, '_');
                    pdf.save(filename);
                }

                controls.downloadPdfBtn.addEventListener('click', async () => {
                    // Use the new selectable text PDF generator
                    generateSelectablePDF();
                    showNotification("PDF avec texte s√©lectionnable g√©n√©r√© !", "success");
                });

                controls.resetCvBtn.addEventListener('click', async () => {
                    const confirmed = await showConfirmModal("Nouveau CV", "√ätes-vous s√ªr de vouloir r√©initialiser compl√®tement le CV ?");
                    if (confirmed) resetCVToDefault();
                });
                
                controls.togglePresentationModeBtn.addEventListener('click', () => {
                    document.body.classList.toggle('presentation-mode');
                    const isActive = document.body.classList.contains('presentation-mode');
                    controls.togglePresentationModeBtn.innerHTML = `<i class="fa-solid ${isActive ? 'fa-eye-slash' : 'fa-eye'}"></i> ${isActive ? 'Quitter Pr√©sentation' : 'Mode Pr√©sentation'}`;
                });
                
                controls.toggleOverflowBtn.addEventListener('click', (e) => {
                    document.body.classList.toggle('overflow-check-active');
                    e.currentTarget.classList.toggle('active');
                    checkAllPagesOverflow();
                });

                // Collapse all details/expand functionality
                controls.collapseAllBtn.addEventListener('click', () => {
                    // S√©lectionner tous les d√©tails dans tous les onglets (IA, API, Contenu, Layout, Styles, Recrutement, Param√®tres)
                    const allDetails = document.querySelectorAll('details.control-group');
                    const collapseIcon = document.getElementById('collapse-icon');
                    const collapseText = document.getElementById('collapse-text');
                    
                    console.log(`Trouv√© ${allDetails.length} √©l√©ments details.control-group dans tous les onglets`);
                    
                    // Check current state - if any detail is open, collapse all
                    const hasOpenDetails = Array.from(allDetails).some(detail => detail.open);
                    
                    if (hasOpenDetails) {
                        // Collapse all
                        allDetails.forEach(detail => {
                            detail.open = false;
                        });
                        collapseIcon.className = 'fa-solid fa-expand';
                        collapseText.textContent = 'D√©plier tous les volets';
                        controls.collapseAllBtn.classList.remove('bg-gray-100', 'hover:bg-gray-200');
                        controls.collapseAllBtn.classList.add('bg-blue-100', 'hover:bg-blue-200', 'text-blue-700');
                        console.log('Tous les volets repli√©s');
                    } else {
                        // Expand all
                        allDetails.forEach(detail => {
                            detail.open = true;
                        });
                        collapseIcon.className = 'fa-solid fa-compress';
                        collapseText.textContent = 'Replier tous les volets';
                        controls.collapseAllBtn.classList.remove('bg-blue-100', 'hover:bg-blue-200', 'text-blue-700');
                        controls.collapseAllBtn.classList.add('bg-gray-100', 'hover:bg-gray-200');
                        console.log('Tous les volets d√©pli√©s');
                    }
                });

                // Gestionnaires d'√©v√©nements avec v√©rification d'existence
                if (controls.aiSummarizeBtn) {
                    controls.aiSummarizeBtn.addEventListener('click', summarizeAllExperiencesAI);
                }
                if (controls.aiSynthesizeSkillsBtn) {
                    controls.aiSynthesizeSkillsBtn.addEventListener('click', synthesizeSkillsWithAI);
                }
                if (controls.aiLimitSkillsBtn) {
                    controls.aiLimitSkillsBtn.addEventListener('click', limitSkillsWithAI);
                }
                if (controls.anonymizeBtn) {
                    controls.anonymizeBtn.addEventListener('click', anonymizeCV);
                }
                if (controls.resetRecruiterBtn) {
                    controls.resetRecruiterBtn.addEventListener('click', () => { setDefaultRecruiterInfo(); updatePreview('form'); });
                }
                if (controls.addPageBtn) {
                    controls.addPageBtn.addEventListener('click', () => addNewPage());
                }
                if (controls.removeBannerBgBtn) {
                    controls.removeBannerBgBtn.addEventListener('click', () => removeBannerBackground());
                }
                if (controls.addSectionBtn && controls.newSectionTitleInput) {
                    controls.addSectionBtn.addEventListener('click', () => {
                        const title = controls.newSectionTitleInput.value.trim();
                        if(title) {
                            addCustomSection(title);
                            controls.newSectionTitleInput.value = '';
                        } else {
                            showNotification("Veuillez entrer un titre pour la nouvelle section.", "error");
                        }
                    });
                }
                if (controls.sectionSuggestionSelect && controls.newSectionTitleInput) {
                    controls.sectionSuggestionSelect.addEventListener('change', (e) => {
                        if(e.target.value) controls.newSectionTitleInput.value = e.target.value;
                    });
                }
                if (controls.fixBannerTopBtn) {
                    controls.fixBannerTopBtn.addEventListener('click', () => moveBannerTo('top'));
                }
                if (controls.fixBannerBottomBtn) {
                    controls.fixBannerBottomBtn.addEventListener('click', () => moveBannerTo('bottom'));
                }
                if (controls.modularBannerBtn) {
                    controls.modularBannerBtn.addEventListener('click', () => moveBannerTo('modular'));
                }
                if (controls.addSkillLevelBtn) {
                    controls.addSkillLevelBtn.addEventListener('click', () => createSkillLevelItem());
                }

                document.querySelectorAll('.a4-page').forEach(setupOverflowObserver);
                
                // === INITIALISATION API ===
                initializeApiTab();
            }
            
            // Fonction d'initialisation compl√®te de l'onglet API
            function initializeApiTab() {
                // Charger la cl√© API sauvegard√©e
                loadGeminiApiKey();
                
                // Afficher un message d'information si aucune cl√© n'est configur√©e
                const savedKey = localStorage.getItem('gemini-api-key');
                if (!savedKey) {
                    updateApiStatus('error', 'Aucune cl√© API configur√©e. Veuillez saisir votre cl√© Gemini.');
                } else {
                    updateApiStatus('loaded', 'Cl√© API charg√©e depuis le stockage local');
                }
                
                // Initialiser les valeurs des curseurs
                if (controls.aiTemperature && controls.temperatureValue) {
                    controls.temperatureValue.textContent = controls.aiTemperature.value;
                }
                if (controls.aiMaxTokens && controls.maxTokensValue) {
                    controls.maxTokensValue.textContent = controls.aiMaxTokens.value;
                }
                
                // Masquer les r√©sultats de test au d√©marrage
                if (controls.testResults) {
                    controls.testResults.classList.add('hidden');
                }
                
                // Message d'accueil dans l'onglet API
                console.log('ü§ñ Onglet API Gemini initialis√© avec succ√®s');
                console.log('üìã Fonctionnalit√©s disponibles:');
                console.log('   - Gestion des cl√©s API avec sauvegarde locale');
                console.log('   - Test de connexion et validation');
                console.log('   - Configuration avanc√©e (mod√®le, temp√©rature, tokens)');
                console.log('   - Interface de test personnalis√©');
                console.log('   - Int√©gration compl√®te avec toutes les fonctions IA');
            }

            // ==============================================
            // AI GENERATORS EVENT LISTENERS
            // ==============================================

            // AI Layout Generators
            const aiLayoutProfessional = document.getElementById('ai-layout-professional');
            if (aiLayoutProfessional) {
                aiLayoutProfessional.addEventListener('click', () => {
                    const professionalLayout = {
                        columns: 2,
                        columnGap: 30,
                        sectionSpacing: 25,
                        marginTop: 30,
                        marginBottom: 30,
                        marginLeft: 25,
                        marginRight: 25,
                        fontSize: 'medium',
                        lineHeight: 'normal',
                        alignment: 'left',
                        indentation: 0
                    };
                    applyLayoutSettings(professionalLayout);
                    showToast("Layout professionnel appliqu√© par IA ü§ñ", "success");
                });
            }

            const aiLayoutCreative = document.getElementById('ai-layout-creative');
            if (aiLayoutCreative) {
                aiLayoutCreative.addEventListener('click', () => {
                    const creativeLayout = {
                        columns: 1,
                        columnGap: 40,
                        sectionSpacing: 35,
                        marginTop: 20,
                        marginBottom: 20,
                        marginLeft: 30,
                        marginRight: 30,
                        fontSize: 'large',
                        lineHeight: 'relaxed',
                        alignment: 'center',
                        indentation: 10
                    };
                    applyLayoutSettings(creativeLayout);
                    showToast("Layout cr√©atif appliqu√© par IA üé®", "success");
                });
            }

            const aiLayoutModern = document.getElementById('ai-layout-modern');
            if (aiLayoutModern) {
                aiLayoutModern.addEventListener('click', () => {
                    const modernLayout = {
                        columns: 3,
                        columnGap: 20,
                        sectionSpacing: 30,
                        marginTop: 15,
                        marginBottom: 15,
                        marginLeft: 20,
                        marginRight: 20,
                        fontSize: 'small',
                        lineHeight: 'tight',
                        alignment: 'justify',
                        indentation: 5
                    };
                    applyLayoutSettings(modernLayout);
                    showToast("Layout moderne appliqu√© par IA üöÄ", "success");
                });
            }

            const aiLayoutRandom = document.getElementById('ai-layout-random');
            if (aiLayoutRandom) {
                aiLayoutRandom.addEventListener('click', async () => {
                    const fallbackFunction = () => {
                        // Fallback: layout al√©atoire sans IA
                        const randomLayout = {
                            columns: Math.floor(Math.random() * 4) + 1,
                            columnGap: Math.floor(Math.random() * 40) + 10,
                            sectionSpacing: Math.floor(Math.random() * 25) + 15,
                            marginTop: Math.floor(Math.random() * 30) + 10,
                            marginBottom: Math.floor(Math.random() * 30) + 10,
                            marginLeft: Math.floor(Math.random() * 30) + 10,
                            marginRight: Math.floor(Math.random() * 30) + 10,
                            fontSize: ['small', 'medium', 'large', 'xlarge'][Math.floor(Math.random() * 4)],
                            lineHeight: ['tight', 'normal', 'relaxed', 'loose'][Math.floor(Math.random() * 4)],
                            alignment: ['left', 'center', 'right', 'justify'][Math.floor(Math.random() * 4)],
                            indentation: Math.floor(Math.random() * 20)
                        };
                        applyLayoutSettings(randomLayout);
                        return "Layout al√©atoire appliqu√© (mode fallback)";
                    };

                    try {
                        const prompt = `G√©n√®re un layout de CV unique et cr√©atif avec ces param√®tres:
                        - Nombre de colonnes (1-4)
                        - Espacement entre colonnes (10-50px)
                        - Espacement entre sections (15-40px) 
                        - Marges (10-40px)
                        - Taille de police (small/medium/large/xlarge)
                        - Hauteur de ligne (tight/normal/relaxed/loose)
                        - Alignement (left/center/right/justify)
                        - Indentation (0-20px)
                        
                        R√©ponds uniquement avec un objet JSON valide.`;
                        
                        const response = await callAIWithFallback(prompt, fallbackFunction);
                        if (typeof response === 'string' && response.includes('fallback')) {
                            showToast(response, "success");
                        } else {
                            const layout = JSON.parse(response);
                            applyLayoutSettings(layout);
                            showToast("Layout al√©atoire g√©n√©r√© par IA ‚ú®", "success");
                        }
                    } catch (error) {
                        console.error('Erreur g√©n√©ration layout IA:', error);
                        fallbackFunction();
                        showToast("Layout al√©atoire appliqu√© (fallback) ‚ú®", "success");
                    }
                });
            }

            // AI Style Generators
            const aiStyleProfessional = document.getElementById('ai-style-professional');
            if (aiStyleProfessional) {
                aiStyleProfessional.addEventListener('click', () => {
                    const professionalStyle = {
                        primaryColor: '#1e40af',
                        secondaryColor: '#374151',
                        accentColor: '#3b82f6',
                        neutralColor: '#6b7280',
                        backgroundColor: '#ffffff',
                        textColor: '#1f2937',
                        fontH1: 'Merriweather',
                        fontH2: 'Source Sans Pro',
                        fontH3: 'Source Sans Pro',
                        fontBody: 'Source Sans Pro',
                        fontAccent: 'Merriweather',
                        titleStyle: 'style-underline',
                        effects: { shadows: true, gradients: false, borders: true, rounded: false }
                    };
                    applyStyleSettings(professionalStyle);
                    showToast("Style professionnel appliqu√© par IA üíº", "success");
                });
            }

            const aiStyleCreative = document.getElementById('ai-style-creative');
            if (aiStyleCreative) {
                aiStyleCreative.addEventListener('click', () => {
                    const creativeStyle = {
                        primaryColor: '#8b5cf6',
                        secondaryColor: '#ec4899',
                        accentColor: '#f59e0b',
                        neutralColor: '#6b7280',
                        backgroundColor: '#fefbff',
                        textColor: '#1e293b',
                        fontH1: 'Playfair Display',
                        fontH2: 'Nunito',
                        fontH3: 'Nunito',
                        fontBody: 'Nunito',
                        fontAccent: 'Dancing Script',
                        titleStyle: 'style-gradient',
                        effects: { shadows: true, gradients: true, borders: false, rounded: true }
                    };
                    applyStyleSettings(creativeStyle);
                    showToast("Style cr√©atif appliqu√© par IA üé®", "success");
                });
            }

            const aiStyleMinimalist = document.getElementById('ai-style-minimalist');
            if (aiStyleMinimalist) {
                aiStyleMinimalist.addEventListener('click', () => {
                    const minimalistStyle = {
                        primaryColor: '#374151',
                        secondaryColor: '#6b7280',
                        accentColor: '#9ca3af',
                        neutralColor: '#d1d5db',
                        backgroundColor: '#ffffff',
                        textColor: '#111827',
                        fontH1: 'Inter',
                        fontH2: 'Inter',
                        fontH3: 'Inter',
                        fontBody: 'Inter',
                        fontAccent: 'Inter',
                        titleStyle: 'style-side-line',
                        effects: { shadows: false, gradients: false, borders: false, rounded: false }
                    };
                    applyStyleSettings(minimalistStyle);
                    showToast("Style minimaliste appliqu√© par IA ‚ö™", "success");
                });
            }

            const aiStyleLuxury = document.getElementById('ai-style-luxury');
            if (aiStyleLuxury) {
                aiStyleLuxury.addEventListener('click', () => {
                    const luxuryStyle = {
                        primaryColor: '#d97706',
                        secondaryColor: '#92400e',
                        accentColor: '#fbbf24',
                        neutralColor: '#78716c',
                        backgroundColor: '#fffbeb',
                        textColor: '#1c1917',
                        fontH1: 'Cormorant Garamond',
                        fontH2: 'Lora',
                        fontH3: 'Lora',
                        fontBody: 'Crimson Text',
                        fontAccent: 'Italianno',
                        titleStyle: 'style-3d',
                        effects: { shadows: true, gradients: true, borders: true, rounded: false }
                    };
                    applyStyleSettings(luxuryStyle);
                    showToast("Style luxe appliqu√© par IA üëë", "success");
                });
            }

            const aiStyleRandom = document.getElementById('ai-style-random');
            if (aiStyleRandom) {
                aiStyleRandom.addEventListener('click', async () => {
                    const fallbackFunction = () => {
                        // Fallback: style al√©atoire sans IA
                        const colors = ['#ef4444', '#f97316', '#eab308', '#22c55e', '#06b6d4', '#3b82f6', '#8b5cf6', '#ec4899', '#f43f5e', '#10b981', '#f59e0b', '#84cc16'];
                        const randomStyle = {
                            primaryColor: colors[Math.floor(Math.random() * colors.length)],
                            secondaryColor: colors[Math.floor(Math.random() * colors.length)],
                            accentColor: colors[Math.floor(Math.random() * colors.length)],
                            neutralColor: '#6b7280',
                            backgroundColor: '#ffffff',
                            textColor: '#1f2937',
                            fontH1: fonts[Math.floor(Math.random() * fonts.length)].name,
                            fontH2: fonts[Math.floor(Math.random() * fonts.length)].name,
                            fontH3: fonts[Math.floor(Math.random() * fonts.length)].name,
                            fontBody: fonts[Math.floor(Math.random() * fonts.length)].name,
                            fontAccent: fonts[Math.floor(Math.random() * fonts.length)].name,
                            titleStyle: ['style-underline', 'style-side-line', 'style-background', 'style-boxed', 'style-gradient', 'style-shadow', 'style-3d', 'style-neon'][Math.floor(Math.random() * 8)],
                            effects: {
                                shadows: Math.random() > 0.5,
                                gradients: Math.random() > 0.5,
                                borders: Math.random() > 0.5,
                                rounded: Math.random() > 0.5
                            }
                        };
                        applyStyleSettings(randomStyle);
                        return "Style surprise appliqu√© (mode fallback)";
                    };

                    try {
                        const fontList = fonts.map(f => f.name).join(', ');
                        const prompt = `G√©n√®re un style de CV unique et harmonieux avec:
                        - Palette de couleurs coh√©rente (6 couleurs en hex: primaryColor, secondaryColor, accentColor, neutralColor, backgroundColor, textColor)
                        - Combinaison de polices professionnelles (fontH1, fontH2, fontH3, fontBody, fontAccent parmi: ${fontList})
                        - Style de titre (titleStyle: style-underline/style-side-line/style-background/style-boxed/style-gradient/style-shadow/style-3d/style-neon)
                        - Effets visuels (effects: {shadows: boolean, gradients: boolean, borders: boolean, rounded: boolean})
                        
                        R√©ponds avec un objet JSON valide uniquement.`;
                        
                        const response = await callAIWithFallback(prompt, fallbackFunction);
                        if (typeof response === 'string' && response.includes('fallback')) {
                            showToast(response, "success");
                        } else {
                            const style = JSON.parse(response);
                            applyStyleSettings(style);
                            showToast("Style surprise g√©n√©r√© par IA ‚ú®", "success");
                        }
                    } catch (error) {
                        console.error('Erreur g√©n√©ration style IA:', error);
                        fallbackFunction();
                        showToast("Style surprise appliqu√© (fallback) ‚ú®", "success");
                    }
                });
            }

            // Additional Style Controls Event Listeners
            const paletteButtons = document.querySelectorAll('.palette-btn');
            paletteButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    const palette = btn.dataset.palette;
                    applyPredefinedPalette(palette);
                });
            });

            // Pattern controls
            const patternButtons = document.querySelectorAll('.pattern-btn');
            patternButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    const pattern = btn.dataset.pattern;
                    applyBackgroundPattern(pattern);
                });
            });

            // Additional AI color generators
            const aiHarmoniousColors = document.getElementById('ai-harmonious-colors');
            if (aiHarmoniousColors) {
                aiHarmoniousColors.addEventListener('click', generateHarmoniousColors);
            }

            const aiContrastColors = document.getElementById('ai-contrast-colors');
            if (aiContrastColors) {
                aiContrastColors.addEventListener('click', generateContrastColors);
            }

            const randomPalette = document.getElementById('random-palette');
            if (randomPalette) {
                randomPalette.addEventListener('click', generateRandomPalette);
            }

            // Font pairing AI
            const aiFontPairing = document.getElementById('ai-font-pairing');
            if (aiFontPairing) {
                aiFontPairing.addEventListener('click', generateAIFontPairing);
            }

            // Quota status checker
            const checkQuotaBtn = document.getElementById('check-quota-status');
            if (checkQuotaBtn) {
                checkQuotaBtn.addEventListener('click', checkQuotaStatus);
            }

            // ==============================================
            // END AI GENERATORS EVENT LISTENERS
            // ==============================================
            
            // --- START THE APP ---
            initializeAll();
            
            // S'assurer que tous les √©l√©ments de contr√¥le sont disponibles avant de r√©initialiser
            setTimeout(() => {
                resetCVToDefault(); // Start with a clean slate
            }, 100);
        });

    </script>
</body>
</html>
